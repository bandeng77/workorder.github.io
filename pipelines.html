<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Order Pipelines</title>
    
    <!-- Load Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* ==================== VARIABLES ==================== */
        :root {
            /* Color Palette - Modern & Professional */
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
            
            --secondary-50: #fdf2f8;
            --secondary-100: #fce7f3;
            --secondary-200: #fbcfe8;
            --secondary-300: #f9a8d4;
            --secondary-400: #f472b6;
            --secondary-500: #ec4899;
            --secondary-600: #db2777;
            --secondary-700: #be185d;
            --secondary-800: #9d174d;
            --secondary-900: #831843;
            
            --accent-50: #f0fdf4;
            --accent-100: #dcfce7;
            --accent-200: #bbf7d0;
            --accent-300: #86efac;
            --accent-400: #4ade80;
            --accent-500: #22c55e;
            --accent-600: #16a34a;
            --accent-700: #15803d;
            --accent-800: #166534;
            --accent-900: #14532d;
            
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;
            
            /* Pipeline Status Colors */
            --pipeline-open: #22c55e;
            --pipeline-close: #64748b;
            
            /* Priority Colors */
            --priority-high: #f87171;
            --priority-urgent: #ef4444;
            --priority-normal: #3b82f6;
            --priority-low: #94a3b8;
            
            /* UI Variables */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ==================== BASE STYLES ==================== */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--neutral-50) 0%, #ffffff 100%);
            min-height: 100vh;
            color: var(--neutral-800);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* ==================== AUTO-COMPLETE SEARCH STYLES ==================== */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            background: white;
            transition: var(--transition-base);
            color: var(--neutral-800);
            padding-right: 3.5rem;
        }

        .autocomplete-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .autocomplete-add-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-500);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.875rem;
        }

        .autocomplete-add-btn:hover {
            background: var(--primary-600);
            transform: translateY(-50%) scale(1.05);
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            margin-top: 0.25rem;
            animation: fadeIn 0.2s ease-out;
        }

        .autocomplete-suggestions.show {
            display: block;
        }

        .autocomplete-suggestion {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition-fast);
            border-bottom: 1px solid var(--neutral-100);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .autocomplete-suggestion:hover {
            background: var(--primary-50);
            color: var(--primary-700);
        }

        .autocomplete-suggestion.selected {
            background: var(--primary-100);
            color: var(--primary-800);
            font-weight: 600;
            border-left: 3px solid var(--primary-500);
        }

        .autocomplete-suggestion-icon {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: var(--radius-sm);
            background: var(--primary-100);
            color: var(--primary-600);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .autocomplete-no-results {
            padding: 1.5rem 1rem;
            text-align: center;
            color: var(--neutral-500);
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .autocomplete-no-results-icon {
            font-size: 1.5rem;
            opacity: 0.5;
        }

        /* ==================== PIPELINE BOARD STYLES ==================== */
        .pipeline-board {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            padding: 1rem;
            min-height: calc(100vh - 300px);
            height: 600px;
            overflow: hidden;
        }

        .pipeline-column {
            background: var(--neutral-100);
            border-radius: var(--radius-xl);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--neutral-200);
            overflow: hidden;
            height: 100%;
        }

        .pipeline-column-header {
            padding: 0.75rem 1rem;
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }

        .pipeline-column-open {
            background: linear-gradient(135deg, var(--pipeline-open), #16a34a);
        }

        .pipeline-column-close {
            background: linear-gradient(135deg, var(--pipeline-close), #475569);
        }

        .pipeline-items-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
            min-height: 0;
        }

        .pipeline-item {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--neutral-200);
            cursor: grab;
            transition: var(--transition-base);
            position: relative;
        }

        .pipeline-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--neutral-300);
        }

        .pipeline-item:active {
            cursor: grabbing;
        }

        .pipeline-item.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }

        .pipeline-item-over {
            border: 2px dashed var(--primary-500);
            background: var(--primary-50);
        }

        /* ==================== PIPELINE ITEM STYLES ==================== */
        .pipeline-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .pipeline-open-badge {
            background: linear-gradient(135deg, #dcfce7, #f0fdf4);
            color: var(--pipeline-open);
            border: 1px solid #86efac;
        }

        .pipeline-close-badge {
            background: linear-gradient(135deg, #f1f5f9, #f8fafc);
            color: var(--pipeline-close);
            border: 1px solid #cbd5e1;
        }

        /* ==================== GRADIENT BACKGROUNDS ==================== */
        .gradient-bg-primary {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-700) 100%);
        }

        .gradient-bg-secondary {
            background: linear-gradient(135deg, var(--secondary-500) 0%, var(--secondary-700) 100%);
        }

        .gradient-bg-accent {
            background: linear-gradient(135deg, var(--accent-500) 0%, var(--accent-700) 100%);
        }

        /* ==================== ELEGANT HEADER ==================== */
        .app-header {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-800) 100%);
            color: white;
            padding: 1.5rem 0;
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        .app-logo {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .app-title {
            font-weight: 800;
            font-size: 2.25rem;
            letter-spacing: -0.025em;
            background: linear-gradient(135deg, #ffffff 0%, rgba(255,255,255,0.9) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .app-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            font-weight: 500;
        }

        /* ==================== COLORFUL BUTTONS ==================== */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            font-size: 0.875rem;
            transition: var(--transition-base);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-slow);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-500) 0%, var(--secondary-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-500) 0%, var(--accent-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-500);
            color: var(--primary-600);
        }

        .btn-outline:hover {
            background: var(--primary-500);
            color: white;
        }

        /* ==================== COLORFUL CARDS ==================== */
        .card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--secondary-500), var(--accent-500));
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        /* ==================== USER INFO CARD ==================== */
        .user-card {
            background: linear-gradient(135deg, var(--primary-50), var(--secondary-50));
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--primary-200);
            transition: var(--transition-base);
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-300);
        }

        .user-avatar {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            box-shadow: var(--shadow-md);
        }

        .user-avatar.admin {
            background: linear-gradient(135deg, var(--secondary-500), var(--secondary-600));
        }

        .user-avatar.manager {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        }

        .user-avatar.user {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-600));
        }

        /* ==================== SEARCH BOX ==================== */
        .search-box {
            position: relative;
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            transition: var(--transition-base);
        }

        .search-box:focus-within {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-500);
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3.5rem;
            border: none;
            border-radius: var(--radius-xl);
            font-size: 0.95rem;
            background: transparent;
            outline: none;
            color: var(--neutral-800);
        }

        .search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-500);
            font-size: 1.25rem;
        }

        /* ==================== FORM STYLES ==================== */
        .form-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            position: relative;
            overflow: hidden;
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-500), var(--secondary-500));
        }

        .form-section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--neutral-700);
            font-size: 0.9rem;
            transition: var(--transition-fast);
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            background: white;
            transition: var(--transition-base);
            color: var(--neutral-800);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* ==================== CURRENCY INPUT STYLES ==================== */
        .currency-input-group {
            position: relative;
        }

        .currency-prefix {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--neutral-600);
            font-weight: 600;
        }

        .currency-input {
            padding-left: 3.5rem !important;
        }

        /* ==================== MODIFIED MODAL STYLES WITH STICKY HEADER & FOOTER ==================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary-500), var(--secondary-500), var(--accent-500));
        }

        .modal-header {
            padding: 0.5rem 2rem;
            background: linear-gradient(135deg, var(--neutral-800), var(--neutral-900));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            flex-shrink: 0;
            z-index: 10;
        }

        .modal-header.sticky-top {
            position: sticky;
            top: 0;
        }

        .modal-header.sticky-bottom {
            position: sticky;
            bottom: 0;
            background: linear-gradient(135deg, var(--neutral-800), var(--neutral-900));
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 2rem;
            right: 2rem;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, rgba(255,255,255,0.9));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        /* ==================== TOAST NOTIFICATIONS ==================== */
        .toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            background: white;
            color: var(--neutral-800);
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 320px;
            transform: translateX(100%);
            opacity: 0;
            transition: var(--transition-base);
            border-left: 4px solid var(--primary-500);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left-color: var(--accent-500);
        }

        .toast.warning {
            border-left-color: var(--warning-500);
        }

        .toast.error {
            border-left-color: var(--danger-500);
        }

        .toast.info {
            border-left-color: var(--info-500);
        }

        .toast-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .toast-icon.success {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-600));
        }

        .toast-icon.warning {
            background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
        }

        .toast-icon.error {
            background: linear-gradient(135deg, var(--danger-500), var(--danger-600));
        }

        .toast-icon.info {
            background: linear-gradient(135deg, var(--info-500), var(--info-600));
        }

        /* ==================== LOADING OVERLAY ==================== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .loading-spinner {
            width: 5rem;
            height: 5rem;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-500);
            animation: spin 1s linear infinite;
            position: relative;
        }

        .loading-spinner::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: var(--secondary-500);
            animation: spin 1.5s linear infinite reverse;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== CUSTOM SCROLLBAR ==================== */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--neutral-100);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, var(--primary-400), var(--secondary-400));
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, var(--primary-500), var(--secondary-500));
        }

        /* ==================== ANIMATIONS ==================== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-slide-in-right {
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* ==================== UTILITY CLASSES ==================== */
        .hidden {
            display: none !important;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .text-gradient {
            background: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ==================== RESPONSIVE DESIGN ==================== */
        @media (max-width: 768px) {
            .pipeline-board {
                grid-template-columns: 1fr;
                height: auto;
                min-height: auto;
            }
            
            .pipeline-column {
                height: 400px;
            }
            
            .app-title {
                font-size: 1.75rem;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
            
            .form-section {
                padding: 1.5rem;
            }
            
            .autocomplete-suggestions {
                position: fixed;
                top: 50%;
                left: 1rem;
                right: 1rem;
                transform: translateY(-50%);
                max-height: 70vh;
                z-index: 10000;
            }
            
            .modal-header {
                padding: 1.25rem 1.5rem;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
        }

        @media (max-width: 640px) {
            .btn {
                padding: 0.75rem 1rem;
            }
            
            .card {
                padding: 1.25rem;
            }
            
            .modal-header {
                padding: 1rem 1.25rem;
            }
            
            .modal-title {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <!-- Main Application Page -->
    <div id="appPage">
        <!-- App Header -->
        <div class="app-header">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-8">
                    <div class="flex-1">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="app-logo">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <div>
                                <h1 class="app-title">Work Order Pipelines</h1>
                                <p class="app-subtitle">Visual Pipeline Management System</p>
                            </div>
                        </div>
                        
                        <!-- User Info Card -->
                        <div class="user-card inline-block">
                            <div class="flex items-center gap-4">
                                <div class="user-avatar user" id="userAvatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm text-purple-600 font-medium mb-1">Welcome to Pipelines</p>
                                    <p id="userWelcome" class="font-semibold text-gray-900 truncate"></p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="userRoleBadge" class="badge-primary">
                                        <i class="fas fa-user-tag"></i>
                                        <span>User</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-2" id="actionButtons">
                        <button id="newPipelineItemBtn" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i>
                            <span>New Pipeline Item</span>
                        </button>
                        <button id="backToDashboardBtn" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i>
                            <span>Back to Dashboard</span>
                        </button>
                        <button id="pipelinesAnalyticsBtn" class="btn btn-info hidden">
                            <i class="fas fa-chart-bar"></i>
                            <span>Pipeline Analytics</span>
                        </button>
                        <button id="authButton" class="btn btn-danger">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
                
                <!-- Search and Filter Box -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="search-box">
                        <i class="search-icon fas fa-search"></i>
                        <input type="text" 
                               id="searchPipelineItems" 
                               placeholder="Search pipeline items..."
                               class="search-input">
                    </div>
                    <div>
                        <select id="filterByCompany" class="form-input w-full">
                            <option value="">All Companies</option>
                            <option value="Genetek">Genetek</option>
                            <option value="Effrensindo">Effrensindo</option>
                        </select>
                    </div>
                    <div>
                        <select id="filterByStatus" class="form-input w-full">
                            <option value="">All Status</option>
                            <option value="Open">Open</option>
                            <option value="Close">Close</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pipeline Board -->
        <div class="max-w-7xl mx-auto px-4 py-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-2 gap-4 mb-8">
                <div class="card text-center">
                    <div class="text-2xl font-bold text-green-600" id="openCount">0</div>
                    <div class="text-sm text-gray-600 mt-1">Open</div>
                </div>
                <div class="card text-center">
                    <div class="text-2xl font-bold text-gray-600" id="closeCount">0</div>
                    <div class="text-sm text-gray-600 mt-1">Close</div>
                </div>
            </div>
            
            <!-- Pipeline Board -->
            <div class="pipeline-board">
                <!-- Open Column -->
                <div class="pipeline-column" data-status="Open">
                    <div class="pipeline-column-header pipeline-column-open">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-folder-open"></i>
                            <span>Open</span>
                        </div>
                        <span class="text-white bg-white/20 px-2 py-1 rounded text-sm" id="openBadge">0</span>
                    </div>
                    <div class="pipeline-items-container custom-scrollbar" id="openItems">
                        <!-- Open items will be loaded here -->
                    </div>
                </div>
                
                <!-- Close Column -->
                <div class="pipeline-column" data-status="Close">
                    <div class="pipeline-column-header pipeline-column-close">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-folder"></i>
                            <span>Close</span>
                        </div>
                        <span class="text-white bg-white/20 px-2 py-1 rounded text-sm" id="closeBadge">0</span>
                    </div>
                    <div class="pipeline-items-container custom-scrollbar" id="closeItems">
                        <!-- Close items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Pipeline Item Modal -->
    <div id="pipelineItemModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-4xl">
            <!-- Sticky Header -->
            <div class="modal-header sticky-top">
                <div>
                    <h2 class="modal-title" id="pipelineModalTitle">New Pipeline Item</h2>
                    <p class="text-gray-300 mt-1">Create or edit pipeline item</p>
                </div>
                <button id="closePipelineModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Scrollable Body -->
            <div class="modal-body custom-scrollbar">
                <form id="pipelineItemForm" class="space-y-8">
                    <input type="hidden" id="pipelineItemId">
                    <input type="hidden" id="originalPipelineStatus">
                    
                    <!-- Section 1: Basic Information -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-primary">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <span>Basic Information</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label required-field" for="pipelineNo">
                                    No
                                </label>
                                <input type="number" 
                                       id="pipelineNo" 
                                       class="form-input"
                                       required
                                       placeholder="Nomor urut akan di-generate otomatis"
                                       readonly>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineQuotation">
                                    No. Quotation
                                </label>
                                <input type="text" 
                                       id="pipelineQuotation" 
                                       class="form-input bg-gray-50"
                                       required
                                       readonly
                                       placeholder="Akan digenerate otomatis">
                                <p class="text-xs text-gray-500 mt-1">Format: 001/GI/FAS/I/2026 (auto-generated)</p>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineCompany">
                                    Company
                                </label>
                                <select id="pipelineCompany" class="form-input" required onchange="updateQuotationNumber()">
                                    <option value="">Select Company</option>
                                    <option value="Genetek">Genetek</option>
                                    <option value="Effrensindo">Effrensindo</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineSOW">
                                    SOW
                                </label>
                                <select id="pipelineSOW" class="form-input" required onchange="updateQuotationNumber()">
                                    <option value="">Select SOW</option>
                                    <option value="FAS">FAS</option>
                                    <option value="Vesda">Vesda</option>
                                    <option value="FSS">FSS</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 2: PIC and Customer -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-secondary">
                                <i class="fas fa-users"></i>
                            </div>
                            <span>Person In Charge & Customer</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label required-field" for="pipelinePIC">
                                    PIC
                                </label>
                                <div class="autocomplete-container">
                                    <input type="text" 
                                           id="pipelinePIC" 
                                           class="autocomplete-input form-input"
                                           required
                                           placeholder="Type to search or add PIC"
                                           autocomplete="off">
                                    <button type="button" 
                                            class="autocomplete-add-btn"
                                            id="addPICBtn"
                                            title="Add new PIC">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <div class="autocomplete-suggestions" id="picSuggestions"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Start typing to see suggestions, or click + to add new</p>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineCustomer">
                                    Customer
                                </label>
                                <div class="autocomplete-container">
                                    <input type="text" 
                                           id="pipelineCustomer" 
                                           class="autocomplete-input form-input"
                                           required
                                           placeholder="Type to search or add customer"
                                           autocomplete="off">
                                    <button type="button" 
                                            class="autocomplete-add-btn"
                                            id="addCustomerBtn"
                                            title="Add new customer">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <div class="autocomplete-suggestions" id="customerSuggestions"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Start typing to see suggestions, or click + to add new</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 3: Project and Status -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-success">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <span>Project & Status</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label required-field" for="pipelineProject">
                                    Project
                                </label>
                                <input type="text" 
                                       id="pipelineProject" 
                                       class="form-input"
                                       required
                                       placeholder="Enter project name">
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineStatus">
                                    Status
                                </label>
                                <select id="pipelineStatus" class="form-input" required>
                                    <option value="Open">Open</option>
                                    <option value="Close">Close</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 4: Financial Information -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-warning">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <span>Financial Information</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label required-field" for="pipelineValueQuotation">
                                    Value Quotation
                                </label>
                                <div class="currency-input-group">
                                    <span class="currency-prefix">IDR</span>
                                    <input type="text" 
                                           id="pipelineValueQuotation" 
                                           class="form-input currency-input"
                                           required
                                           placeholder="Enter quotation value"
                                           data-thousands-separator=".">
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineValuePO">
                                    Value PO
                                </label>
                                <div class="currency-input-group">
                                    <span class="currency-prefix">IDR</span>
                                    <input type="text" 
                                           id="pipelineValuePO" 
                                           class="form-input currency-input"
                                           required
                                           placeholder="Enter PO value"
                                           data-thousands-separator=".">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 5: Description -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-info">
                                <i class="fas fa-align-left"></i>
                            </div>
                            <span>Description</span>
                        </div>
                        
                        <div>
                            <label class="form-label" for="pipelineDescription">
                                Description
                            </label>
                            <textarea id="pipelineDescription" 
                                      class="form-input" 
                                      rows="6"
                                      placeholder="Describe the pipeline item..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Section 6: Progress & Notes -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-info">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <span>Progress & Notes</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label" for="pipelineProgress">
                                    Progress (%)
                                </label>
                                <input type="range" 
                                       id="pipelineProgress" 
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                       min="0" 
                                       max="100" 
                                       value="0">
                                <div class="flex justify-between text-sm text-gray-600 mt-2">
                                    <span>0%</span>
                                    <span id="progressValue">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label" for="pipelineNotes">
                                    Notes
                                </label>
                                <textarea id="pipelineNotes" 
                                          class="form-input" 
                                          rows="3"
                                          placeholder="Additional notes..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Sticky Footer -->
            <div class="modal-header sticky-bottom">
                <div></div>
                <div class="flex gap-3">
                    <button id="cancelPipelineBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" form="pipelineItemForm" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Save Pipeline Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New PIC Modal -->
    <div id="addPICModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-md">
            <div class="modal-header sticky-top">
                <div>
                    <h2 class="modal-title">Add New PIC</h2>
                    <p class="text-gray-300 mt-1">Add new Person In Charge</p>
                </div>
                <button id="closeAddPICModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body custom-scrollbar">
                <form id="addPICForm" class="space-y-6">
                    <div>
                        <label class="form-label required-field" for="newPICName">
                            PIC Name
                        </label>
                        <input type="text" 
                               id="newPICName" 
                               class="form-input"
                               required
                               placeholder="Enter PIC name">
                    </div>
                    
                    <div>
                        <label class="form-label" for="newPICEmail">
                            Email
                        </label>
                        <input type="email" 
                               id="newPICEmail" 
                               class="form-input"
                               placeholder="Enter email address">
                    </div>
                    
                    <div>
                        <label class="form-label" for="newPICPhone">
                            Phone Number
                        </label>
                        <input type="text" 
                               id="newPICPhone" 
                               class="form-input"
                               placeholder="Enter phone number">
                    </div>
                </form>
            </div>
            <div class="modal-header sticky-bottom">
                <div></div>
                <div class="flex gap-3">
                    <button id="cancelAddPICBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" form="addPICForm" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Add PIC
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Customer Modal -->
    <div id="addCustomerModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-md">
            <div class="modal-header sticky-top">
                <div>
                    <h2 class="modal-title">Add New Customer</h2>
                    <p class="text-gray-300 mt-1">Add new customer to the list</p>
                </div>
                <button id="closeAddCustomerModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body custom-scrollbar">
                <form id="addCustomerForm" class="space-y-6">
                    <div>
                        <label class="form-label required-field" for="newCustomerName">
                            Customer Name
                        </label>
                        <input type="text" 
                               id="newCustomerName" 
                               class="form-input"
                               required
                               placeholder="Enter customer name">
                    </div>
                    
                    <div>
                        <label class="form-label" for="newCustomerAddress">
                            Address
                        </label>
                        <textarea id="newCustomerAddress" 
                                  class="form-input" 
                                  rows="3"
                                  placeholder="Enter customer address"></textarea>
                    </div>
                    
                    <div>
                        <label class="form-label" for="newCustomerContact">
                            Contact Person
                        </label>
                        <input type="text" 
                               id="newCustomerContact" 
                               class="form-input"
                               placeholder="Enter contact person">
                    </div>
                </form>
            </div>
            <div class="modal-header sticky-bottom">
                <div></div>
                <div class="flex gap-3">
                    <button id="cancelAddCustomerBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" form="addCustomerForm" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Add Customer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Analytics Modal -->
    <div id="pipelinesAnalyticsModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="modal-header sticky-top">
                <div>
                    <h2 class="modal-title">Pipeline Analytics</h2>
                    <p class="text-gray-300 mt-1">Pipeline performance and insights</p>
                </div>
                <button id="closePipelinesAnalyticsModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body custom-scrollbar">
                <div class="flex justify-between items-center mb-8">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        Data updated: <span id="pipelinesDataUpdatedTime"></span>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="card">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center">
                                <i class="fas fa-chart-pie text-green-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">Status Distribution</h3>
                                <p class="text-sm text-gray-600">Open vs Close items</p>
                            </div>
                        </div>
                        <canvas id="pipelineStatusChart"></canvas>
                    </div>
                    
                    <div class="card">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center">
                                <i class="fas fa-chart-bar text-blue-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">Company Distribution</h3>
                                <p class="text-sm text-gray-600">By company</p>
                            </div>
                        </div>
                        <canvas id="pipelineCompanyChart"></canvas>
                    </div>
                    
                    <div class="card lg:col-span-2">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center">
                                <i class="fas fa-chart-line text-purple-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">Revenue Flow</h3>
                                <p class="text-sm text-gray-600">Value Quotation vs Value PO</p>
                            </div>
                        </div>
                        <canvas id="pipelineRevenueChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-yellow-100 to-yellow-200 flex items-center justify-center">
                            <i class="fas fa-tachometer-alt text-yellow-600"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900">Performance Metrics</h3>
                            <p class="text-sm text-gray-600">Key pipeline performance indicators</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-green-50 rounded-xl">
                            <div class="text-2xl font-bold text-green-700" id="totalOpenItems">0</div>
                            <div class="text-sm text-green-600 mt-1">Open Items</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div class="text-2xl font-bold text-gray-700" id="totalCloseItems">0</div>
                            <div class="text-sm text-gray-600 mt-1">Close Items</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-xl">
                            <div class="text-2xl font-bold text-blue-700" id="totalQuotationValue">0</div>
                            <div class="text-sm text-blue-600 mt-1">Total Quotation Value</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-xl">
                            <div class="text-2xl font-bold text-purple-700" id="totalPOValue">0</div>
                            <div class="text-sm text-purple-600 mt-1">Total PO Value</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-header sticky-bottom">
                <div></div>
                <div>
                    <button id="closePipelinesAnalyticsModalBottom" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-white text-lg font-medium">Loading Pipelines...</p>
        </div>
    </div>

<script>
        // ==================== GLOBAL VARIABLES ====================
        let db, auth, pipelinesCollection, pipelineHistoryCollection, usersCollection, customersCollection, picsCollection;
        let currentUser = null;
        let currentUserRole = 'user';
        let pipelineItems = [];
        let filteredPipelineItems = [];
        let draggedItem = null;
        let charts = {};
        
        // Data for autocomplete
        let PIC_LIST = [];
        let CUSTOMER_LIST = [];
        
        // Pipeline statuses configuration
        const pipelineStatuses = [
            { id: 'Open', name: 'Open', icon: 'fa-folder-open', color: 'green' },
            { id: 'Close', name: 'Close', icon: 'fa-folder', color: 'gray' }
        ];

        // ==================== INITIALIZE FIREBASE ====================
        function initializeFirebase() {
            try {
                console.log('Initializing Firebase for Pipelines...');
                
                const firebaseConfig = {
                    apiKey: "AIzaSyAwXNGrJsBqQ2RslAkdWWPSOubUw13QcRI",
                    authDomain: "workorder-mon.firebaseapp.com",
                    projectId: "workorder-mon",
                    storageBucket: "workorder-mon.firebasestorage.app",
                    messagingSenderId: "226391173482",
                    appId: "1:226391173482:web:9ea9c68c1e31c84f50dd13"
                };

                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore(app);
                auth = firebase.auth(app);
                
                pipelinesCollection = db.collection('pipelines');
                pipelineHistoryCollection = db.collection('pipelineHistory');
                usersCollection = db.collection('users');
                customersCollection = db.collection('customers');
                picsCollection = db.collection('pics');
                
                console.log('Firebase initialized successfully for Pipelines');
                return true;
                
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                showToast('Firebase initialization failed. Please check console.', 'error');
                return false;
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatDate(date) {
            if (!date) return '-';
            try {
                if (date.toDate) {
                    date = date.toDate();
                }
                return date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            } catch (e) {
                return '-';
            }
        }

        function formatDateTime(date) {
            if (!date) return '-';
            try {
                if (date.toDate) {
                    date = date.toDate();
                }
                return date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return '-';
            }
        }

        function formatTimeAgo(date) {
            if (!date) return 'Just now';
            try {
                if (date.toDate) {
                    date = date.toDate();
                }
                const now = new Date();
                const diffMs = now - date;
                const diffSec = Math.floor(diffMs / 1000);
                const diffMin = Math.floor(diffSec / 60);
                const diffHour = Math.floor(diffMin / 60);
                const diffDay = Math.floor(diffHour / 24);
                
                if (diffSec < 60) return 'Just now';
                if (diffMin < 60) return `${diffMin}m ago`;
                if (diffHour < 24) return `${diffHour}h ago`;
                if (diffDay < 7) return `${diffDay}d ago`;
                return formatDate(date);
            } catch (e) {
                return 'Some time ago';
            }
        }

        function formatCurrency(value) {
            if (!value) return '0';
            const num = parseInt(value.toString().replace(/\./g, ''));
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function parseCurrency(value) {
            if (!value) return 0;
            return parseInt(value.toString().replace(/\./g, '')) || 0;
        }

        function formatCurrencyInput(value) {
            // Remove all non-digit characters
            let num = value.replace(/\D/g, '');
            
            // Format with thousand separators
            if (num.length > 3) {
                num = num.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }
            
            return num;
        }

        function formatCurrencyDisplay(value) {
            if (!value) return 'IDR 0';
            return 'IDR ' + formatCurrency(value);
        }

        function showToast(message, type = 'info', duration = 3000) {
            console.log(`Toast [${type}]:`, message);
            
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const colors = {
                success: 'linear-gradient(135deg, #22c55e, #16a34a)',
                error: 'linear-gradient(135deg, #ef4444, #dc2626)',
                warning: 'linear-gradient(135deg, #f59e0b, #d97706)',
                info: 'linear-gradient(135deg, #3b82f6, #2563eb)'
            };
            
            toast.innerHTML = `
                <div class="toast-icon ${type}" style="background: ${colors[type] || colors.info}">
                    <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
                </div>
                <div>
                    <p class="font-medium">${message}</p>
                    <p class="text-sm text-gray-600 mt-1">${new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}</p>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
        }

        // ==================== AUTO-COMPLETE SEARCH FUNCTIONS ====================
        function setupAutoCompleteSearch() {
            const picInput = document.getElementById('pipelinePIC');
            const customerInput = document.getElementById('pipelineCustomer');
            const addPICBtn = document.getElementById('addPICBtn');
            const addCustomerBtn = document.getElementById('addCustomerBtn');
            
            // Load initial data
            loadPICList();
            loadCustomerList();
            
            // Setup PIC autocomplete
            if (picInput) {
                let picSearchTimeout;
                
                picInput.addEventListener('input', function() {
                    clearTimeout(picSearchTimeout);
                    const searchTerm = this.value.trim();
                    
                    picSearchTimeout = setTimeout(() => {
                        if (searchTerm.length >= 2) {
                            searchPICSuggestions(searchTerm);
                        } else {
                            hideSuggestions('picSuggestions');
                        }
                    }, 300);
                });
                
                picInput.addEventListener('focus', function() {
                    const searchTerm = this.value.trim();
                    if (searchTerm.length >= 2) {
                        searchPICSuggestions(searchTerm);
                    }
                });
                
                picInput.addEventListener('blur', function() {
                    // Hide suggestions after a short delay
                    setTimeout(() => {
                        hideSuggestions('picSuggestions');
                    }, 200);
                });
                
                // Enter key to select first suggestion
                picInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const suggestions = document.querySelectorAll('#picSuggestions .autocomplete-suggestion');
                        if (suggestions.length > 0) {
                            suggestions[0].click();
                        }
                    }
                });
            }
            
            // Setup Customer autocomplete
            if (customerInput) {
                let customerSearchTimeout;
                
                customerInput.addEventListener('input', function() {
                    clearTimeout(customerSearchTimeout);
                    const searchTerm = this.value.trim();
                    
                    customerSearchTimeout = setTimeout(() => {
                        if (searchTerm.length >= 2) {
                            searchCustomerSuggestions(searchTerm);
                        } else {
                            hideSuggestions('customerSuggestions');
                        }
                    }, 300);
                });
                
                customerInput.addEventListener('focus', function() {
                    const searchTerm = this.value.trim();
                    if (searchTerm.length >= 2) {
                        searchCustomerSuggestions(searchTerm);
                    }
                });
                
                customerInput.addEventListener('blur', function() {
                    // Hide suggestions after a short delay
                    setTimeout(() => {
                        hideSuggestions('customerSuggestions');
                    }, 200);
                });
                
                // Enter key to select first suggestion
                customerInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const suggestions = document.querySelectorAll('#customerSuggestions .autocomplete-suggestion');
                        if (suggestions.length > 0) {
                            suggestions[0].click();
                        }
                    }
                });
            }
            
            // Setup add buttons
            if (addPICBtn) {
                addPICBtn.addEventListener('click', openAddPICModal);
            }
            
            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', openAddCustomerModal);
            }
            
            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    hideAllSuggestions();
                }
            });
            
            // Close suggestions on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideAllSuggestions();
                }
            });
        }

        async function loadPICList() {
            try {
                console.log('Loading PIC list from Firestore...');
                
                const querySnapshot = await picsCollection.orderBy('name').get();
                PIC_LIST = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    PIC_LIST.push({
                        id: doc.id,
                        name: data.name,
                        email: data.email || '',
                        phone: data.phone || '',
                        createdAt: data.createdAt
                    });
                });
                
                // If no PICs in Firestore, use default list
                if (PIC_LIST.length === 0) {
                    console.log('No PICs in Firestore, using default list');
                    const defaultPICs = [
                        "Wahyu Sujoko",
                        "Proboadi hariyo wicaksono", 
                        "Fiki hernawan",
                        "Indra kurniawan",
                        "Aries A Bastian",
                        "Mochammad Gorwantoro Putra", 
                        "Yudiyono", 
                        "Muhamad husni", 
                        "edwin qomarudin", 
                        "Edy Amin",
                        "Heksi Prasetyo", 
                        "Hery Syah Putra"
                    ];
                    
                    defaultPICs.forEach(name => {
                        PIC_LIST.push({
                            id: name.toLowerCase().replace(/\s+/g, '_'),
                            name: name,
                            email: '',
                            phone: '',
                            createdAt: new Date()
                        });
                    });
                }
                
                console.log('PIC list loaded:', PIC_LIST.length);
                
            } catch (error) {
                console.error('Error loading PIC list:', error);
                showToast('Failed to load PIC list', 'error');
            }
        }

        async function loadCustomerList() {
            try {
                console.log('Loading customer list from Firestore...');
                
                const querySnapshot = await customersCollection.orderBy('name').get();
                CUSTOMER_LIST = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    CUSTOMER_LIST.push({
                        id: doc.id,
                        name: data.name,
                        address: data.address || '',
                        contact: data.contact || '',
                        createdAt: data.createdAt
                    });
                });
                
                // If no customers in Firestore, use default list
                if (CUSTOMER_LIST.length === 0) {
                    console.log('No customers in Firestore, using default list');
                    const defaultCustomers = [
                        "PT. GUDANG GARAM Tbk",
                        "PERSEROAN TERBATAS BADAN BANK CENTRAL ASIA TBK",
                        "PT. FRISIAN FLAG INDONESIA",
                        "PT. GRIYA SIRA INDAH",
                        "PT. PUTRA SINAR PERMAJA",
                        "PT. PLAZA INDONESIA REALTY Tbk",
                        "CV. KROSS SARANA TEKNIK",
                        "PT. GEMILANG CIPTA ABADI",
                        "PT. MARYO MAKMUR TEHNIK",
                        "PT. SOUTH PACIFIC VISCOSE",
                        "PT. HOTEL CANDI BARU",
                        "PT. SMILE BRIGHT WHITE (LAND OF SMILES CLINIC)",
                        "PT. PURI MATAHARI",
                        "PT. MENARA ASTRA",
                        "PT. PLAZA INDONESIA MANDIRI",
                        "PT. WYNNCOR BALI",
                        "PT. JONES LANG LASALLE",
                        "PT. SATAHI CIPTA MANDIRI",
                        "YAYASAN BUDDHA TZU CHI MEDIKA INDONESIA",
                        "PT. INDONESIA MOC SERVICE",
                        "PT. RAMA KUTA HOTEL",
                        "PT. HANDAL UTAMA BUANA",
                        "PT. SURYA MARGA LUHUR",
                        "PT. GRAHA SIDANG PRATAMA",
                        "PT. LASALLEFOOD INDONESIA",
                        "SARULLA OPERATIONS LTD",
                        "SHM FIRE SAFETY Pte.Ltd",
                        "PT. WAHANA NUSANTARA",
                        "PT. YOGYA CENTRAL TERPADU",
                        "PT. DONGGI SENORO LNG",
                        "PT. PT. INDONESIA MOROWALI INDUSTRIAL PARK"
                    ];
                    
                    defaultCustomers.forEach(name => {
                        CUSTOMER_LIST.push({
                            id: name.toLowerCase().replace(/\s+/g, '_'),
                            name: name,
                            address: '',
                            contact: '',
                            createdAt: new Date()
                        });
                    });
                }
                
                console.log('Customer list loaded:', CUSTOMER_LIST.length);
                
            } catch (error) {
                console.error('Error loading customer list:', error);
                showToast('Failed to load customer list', 'error');
            }
        }

        function searchPICSuggestions(searchTerm) {
            const suggestionsContainer = document.getElementById('picSuggestions');
            if (!suggestionsContainer) return;
            
            const searchTermLower = searchTerm.toLowerCase();
            const filteredPICs = PIC_LIST.filter(pic => 
                pic.name.toLowerCase().includes(searchTermLower)
            );
            
            showSuggestions(suggestionsContainer, filteredPICs, 'pic', searchTerm);
        }

        function searchCustomerSuggestions(searchTerm) {
            const suggestionsContainer = document.getElementById('customerSuggestions');
            if (!suggestionsContainer) return;
            
            const searchTermLower = searchTerm.toLowerCase();
            const filteredCustomers = CUSTOMER_LIST.filter(customer => 
                customer.name.toLowerCase().includes(searchTermLower)
            );
            
            showSuggestions(suggestionsContainer, filteredCustomers, 'customer', searchTerm);
        }

        function showSuggestions(container, items, type, searchTerm) {
            container.innerHTML = '';
            
            if (items.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'autocomplete-no-results';
                noResults.innerHTML = `
                    <div class="autocomplete-no-results-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <p>No ${type} found for "${searchTerm}"</p>
                    <p class="text-xs">Click + button to add new</p>
                `;
                container.appendChild(noResults);
            } else {
                items.forEach(item => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'autocomplete-suggestion';
                    suggestion.dataset.id = item.id;
                    suggestion.dataset.name = item.name;
                    
                    suggestion.innerHTML = `
                        <div class="autocomplete-suggestion-icon">
                            <i class="fas fa-${type === 'pic' ? 'user' : 'building'}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium truncate">${item.name}</div>
                            ${item.email ? `<div class="text-xs text-gray-500 truncate">${item.email}</div>` : ''}
                            ${item.phone ? `<div class="text-xs text-gray-500">${item.phone}</div>` : ''}
                        </div>
                    `;
                    
                    suggestion.addEventListener('click', function() {
                        const inputField = type === 'pic' ? document.getElementById('pipelinePIC') : document.getElementById('pipelineCustomer');
                        if (inputField) {
                            inputField.value = this.dataset.name;
                        }
                        hideAllSuggestions();
                    });
                    
                    container.appendChild(suggestion);
                });
            }
            
            container.classList.add('show');
        }

        function hideSuggestions(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.classList.remove('show');
            }
        }

        function hideAllSuggestions() {
            hideSuggestions('picSuggestions');
            hideSuggestions('customerSuggestions');
        }

        // ==================== CURRENCY INPUT HANDLING ====================
        function setupCurrencyInputs() {
            const quotationInput = document.getElementById('pipelineValueQuotation');
            const poInput = document.getElementById('pipelineValuePO');
            
            if (quotationInput) {
                quotationInput.addEventListener('input', function() {
                    this.value = formatCurrencyInput(this.value);
                });
                
                quotationInput.addEventListener('blur', function() {
                    if (this.value) {
                        this.value = formatCurrencyInput(this.value);
                    }
                });
            }
            
            if (poInput) {
                poInput.addEventListener('input', function() {
                    this.value = formatCurrencyInput(this.value);
                });
                
                poInput.addEventListener('blur', function() {
                    if (this.value) {
                        this.value = formatCurrencyInput(this.value);
                    }
                });
            }
        }

        // ==================== NUMBERING SYSTEM FUNCTIONS ====================
        function getCompanyCode(company) {
            switch(company) {
                case 'Genetek': return 'GI';
                case 'Effrensindo': return 'EFK';
                default: return 'XX';
            }
        }

        function getSOWCode(sow) {
            switch(sow) {
                case 'FAS': return 'FAS';
                case 'Vesda': return 'VESDA';
                case 'FSS': return 'FSS';
                default: return 'GEN';
            }
        }

        function getRomanMonth(month) {
            const romanNumerals = {
                1: 'I', 2: 'II', 3: 'III', 4: 'IV', 5: 'V', 6: 'VI',
                7: 'VII', 8: 'VIII', 9: 'IX', 10: 'X', 11: 'XI', 12: 'XII'
            };
            return romanNumerals[month] || 'I';
        }

        async function getNextQuotationNumber() {
            try {
                // Get the last pipeline item to determine next number
                const querySnapshot = await pipelinesCollection
                    .orderBy('no', 'desc')
                    .limit(1)
                    .get();
                
                let nextNumber = 1;
                
                if (!querySnapshot.empty) {
                    const lastItem = querySnapshot.docs[0].data();
                    nextNumber = (lastItem.no || 0) + 1;
                }
                
                return nextNumber;
                
            } catch (error) {
                console.error('Error getting next quotation number:', error);
                return 1;
            }
        }

        function updateQuotationNumber() {
            const company = document.getElementById('pipelineCompany').value;
            const sow = document.getElementById('pipelineSOW').value;
            
            if (!company || !sow) {
                return;
            }
            
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            
            const companyCode = getCompanyCode(company);
            const sowCode = getSOWCode(sow);
            const romanMonth = getRomanMonth(month);
            
            // Format will be updated when modal opens
            console.log(`Quotation format: ${companyCode}/${sowCode}/${romanMonth}/${year}`);
        }

        async function generateQuotationNumber(nextNumber, company, sow) {
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            
            const companyCode = getCompanyCode(company);
            const sowCode = getSOWCode(sow);
            const romanMonth = getRomanMonth(month);
            
            // Format number with leading zeros
            const formattedNumber = nextNumber.toString().padStart(3, '0');
            
            return `${formattedNumber}/${companyCode}/${sowCode}/${romanMonth}/${year}`;
        }

        // ==================== PIPELINE FUNCTIONS ====================
        async function loadPipelineItems() {
            console.log('Loading pipeline items...');
            
            showLoading();
            try {
                const querySnapshot = await pipelinesCollection.orderBy('no', 'desc').get();
                pipelineItems = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    pipelineItems.push({
                        id: doc.id,
                        ...data,
                        // Ensure all fields exist
                        no: data.no || 0,
                        quotation: data.quotation || '',
                        company: data.company || '',
                        sow: data.sow || '',
                        pic: data.pic || '',
                        customer: data.customer || '',
                        project: data.project || '',
                        status: data.status || 'Open',
                        valueQuotation: data.valueQuotation || 0,
                        valuePO: data.valuePO || 0,
                        description: data.description || '',
                        notes: data.notes || '',
                        progress: data.progress || 0,
                        updatedAt: data.updatedAt || new Date(),
                        updatedBy: data.updatedBy || ''
                    });
                });

                filteredPipelineItems = [...pipelineItems];
                updatePipelineStats();
                renderPipelineBoard();
                
                console.log('Pipeline items loaded:', pipelineItems.length);
                
            } catch (error) {
                console.error('Error loading pipeline items:', error);
                showToast('Failed to load pipeline items', 'error');
            } finally {
                hideLoading();
            }
        }

        function updatePipelineStats() {
            // Update count badges
            const openCount = pipelineItems.filter(item => item.status === 'Open').length;
            const closeCount = pipelineItems.filter(item => item.status === 'Close').length;
            
            document.getElementById('openCount').textContent = openCount;
            document.getElementById('closeCount').textContent = closeCount;
            document.getElementById('openBadge').textContent = openCount;
            document.getElementById('closeBadge').textContent = closeCount;
        }

        function filterPipelineItems() {
            const searchTerm = document.getElementById('searchPipelineItems').value.toLowerCase();
            const companyFilter = document.getElementById('filterByCompany').value;
            const statusFilter = document.getElementById('filterByStatus').value;
            
            let filtered = [...pipelineItems];
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    (item.quotation && item.quotation.toLowerCase().includes(searchTerm)) ||
                    (item.customer && item.customer.toLowerCase().includes(searchTerm)) ||
                    (item.project && item.project.toLowerCase().includes(searchTerm)) ||
                    (item.pic && item.pic.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply company filter
            if (companyFilter) {
                filtered = filtered.filter(item => item.company === companyFilter);
            }
            
            // Apply status filter
            if (statusFilter) {
                filtered = filtered.filter(item => item.status === statusFilter);
            }
            
            filteredPipelineItems = filtered;
            renderPipelineBoard();
        }

        function renderPipelineBoard() {
            // Clear all columns
            pipelineStatuses.forEach(status => {
                const container = document.getElementById(`${status.id.toLowerCase()}Items`);
                if (container) {
                    container.innerHTML = '';
                }
            });
            
            // Add items to respective columns
            filteredPipelineItems.forEach(item => {
                const pipelineItem = createPipelineItemElement(item);
                const container = document.getElementById(`${item.status.toLowerCase()}Items`);
                if (container) {
                    container.appendChild(pipelineItem);
                }
            });
            
            // Update stats
            updatePipelineStats();
        }

        function createPipelineItemElement(item) {
            const div = document.createElement('div');
            div.className = 'pipeline-item animate-fade-in';
            div.dataset.id = item.id;
            div.draggable = true;
            
            const badgeClass = getPipelineBadgeClass(item.status);
            const timeAgo = formatTimeAgo(item.updatedAt);
            const progress = item.progress || 0;
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-gray-900 text-sm truncate" title="${item.project}">${item.project}</h4>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs font-medium text-gray-600">#${item.no}</span>
                            ${item.quotation ? `<span class="text-xs text-gray-500">${item.quotation}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="pipeline-badge ${badgeClass}">
                            ${item.status}
                        </span>
                        ${item.company ? `<span class="text-xs text-gray-600">${item.company}</span>` : ''}
                    </div>
                </div>
                
                <div class="space-y-2 mb-3">
                    ${item.customer ? `
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-building text-blue-600 text-xs"></i>
                        </div>
                        <span class="text-xs text-gray-600 truncate">${item.customer}</span>
                    </div>` : ''}
                    
                    ${item.pic ? `
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center">
                            <i class="fas fa-user text-green-600 text-xs"></i>
                        </div>
                        <span class="text-xs text-gray-600">${item.pic}</span>
                    </div>` : ''}
                    
                    ${item.sow ? `
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-yellow-100 flex items-center justify-center">
                            <i class="fas fa-tag text-yellow-600 text-xs"></i>
                        </div>
                        <span class="text-xs text-gray-600">${item.sow}</span>
                    </div>` : ''}
                </div>
                
                ${item.description ? `<p class="text-xs text-gray-700 mb-3 line-clamp-2">${item.description}</p>` : ''}
                
                <div class="space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="text-center p-2 bg-blue-50 rounded">
                            <div class="text-xs font-medium text-blue-700">Quotation</div>
                            <div class="text-sm font-bold text-blue-900">${formatCurrencyDisplay(item.valueQuotation)}</div>
                        </div>
                        <div class="text-center p-2 bg-green-50 rounded">
                            <div class="text-xs font-medium text-green-700">PO</div>
                            <div class="text-sm font-bold text-green-900">${formatCurrencyDisplay(item.valuePO)}</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500">
                            <i class="far fa-clock mr-1"></i>
                            ${timeAgo}
                        </div>
                        <div class="text-xs font-medium ${progress >= 100 ? 'text-green-600' : 'text-blue-600'}">
                            ${progress}%
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                        <div class="bg-blue-600 h-1.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-2 mt-3 pt-3 border-t border-gray-100">
                    <button class="view-pipeline-item-btn text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="edit-pipeline-item-btn text-green-600 hover:text-green-800 text-sm">
                        <i class="fas fa-edit"></i>
                    </button>
                    ${currentUserRole === 'admin' ? `
                    <button class="delete-pipeline-item-btn text-red-600 hover:text-red-800 text-sm">
                        <i class="fas fa-trash"></i>
                    </button>` : ''}
                </div>
            `;
            
            // Add event listeners
            const viewBtn = div.querySelector('.view-pipeline-item-btn');
            const editBtn = div.querySelector('.edit-pipeline-item-btn');
            const deleteBtn = div.querySelector('.delete-pipeline-item-btn');
            
            if (viewBtn) {
                viewBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openPipelineItemDetail(item.id);
                });
            }
            
            if (editBtn) {
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openPipelineItemModal(item.id);
                });
            }
            
            if (deleteBtn && currentUserRole === 'admin') {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deletePipelineItem(item.id);
                });
            }
            
            // Drag and drop events
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
            div.addEventListener('click', () => {
                openPipelineItemDetail(item.id);
            });
            
            return div;
        }

        function getPipelineBadgeClass(status) {
            switch(status) {
                case 'Open': return 'pipeline-open-badge';
                case 'Close': return 'pipeline-close-badge';
                default: return 'pipeline-open-badge';
            }
        }

        // ==================== DRAG AND DROP FUNCTIONS ====================
        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.id);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedItem = null;
            
            // Remove overlay class from all columns
            document.querySelectorAll('.pipeline-column').forEach(col => {
                col.classList.remove('pipeline-item-over');
            });
        }

        function setupDragAndDrop() {
            const columns = document.querySelectorAll('.pipeline-column');
            
            columns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    column.classList.add('pipeline-item-over');
                });
                
                column.addEventListener('dragleave', () => {
                    column.classList.remove('pipeline-item-over');
                });
                
                column.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    column.classList.remove('pipeline-item-over');
                    
                    if (draggedItem) {
                        const itemId = draggedItem.dataset.id;
                        const newStatus = column.dataset.status;
                        
                        try {
                            await updatePipelineItemStatus(itemId, newStatus);
                        } catch (error) {
                            console.error('Error updating pipeline item status:', error);
                            showToast('Failed to move item', 'error');
                        }
                    }
                });
            });
        }

        // ==================== PIPELINE ITEM MANAGEMENT ====================
        async function updatePipelineItemStatus(itemId, newStatus) {
            try {
                showLoading();
                
                const item = pipelineItems.find(i => i.id === itemId);
                if (!item) {
                    throw new Error('Item not found');
                }
                
                const oldStatus = item.status;
                
                // Update in Firebase
                await pipelinesCollection.doc(itemId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.email
                });
                
                // Log status change
                await logPipelineStatusChange(itemId, item.project, oldStatus, newStatus);
                
                // Reload items
                await loadPipelineItems();
                
                showToast(`Moved to ${newStatus}`, 'success');
                
            } catch (error) {
                console.error('Error updating pipeline item status:', error);
                showToast('Failed to move item', 'error');
            } finally {
                hideLoading();
            }
        }

        async function logPipelineStatusChange(itemId, title, oldStatus, newStatus) {
            try {
                if (!currentUser) return;
                
                const historyData = {
                    pipelineItemId: itemId,
                    pipelineItemTitle: title,
                    oldStatus: oldStatus,
                    newStatus: newStatus,
                    changedBy: currentUser.email,
                    userRole: currentUserRole,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await pipelineHistoryCollection.add(historyData);
                
            } catch (error) {
                console.error('Error logging pipeline status change:', error);
            }
        }

        // ==================== MODAL FUNCTIONS ====================
        async function createNewPipelineItem() {
            console.log('Creating new pipeline item');
            
            if (!canCreatePipelineItem()) {
                showToast('You do not have permission to create pipeline items', 'warning');
                return;
            }
            
            openPipelineItemModal();
        }

        async function openPipelineItemModal(itemId = null) {
            console.log('Opening pipeline item modal:', itemId ? 'edit' : 'create');
            
            const modal = document.getElementById('pipelineItemModal');
            const modalTitle = document.getElementById('pipelineModalTitle');
            
            // Reset form
            document.getElementById('pipelineItemForm').reset();
            document.getElementById('pipelineItemId').value = '';
            document.getElementById('originalPipelineStatus').value = '';
            document.getElementById('progressValue').textContent = '0%';
            hideAllSuggestions();
            
            // Reset all fields
            document.getElementById('pipelineNo').value = '';
            document.getElementById('pipelineQuotation').value = '';
            document.getElementById('pipelineCompany').value = '';
            document.getElementById('pipelineSOW').value = '';
            document.getElementById('pipelinePIC').value = '';
            document.getElementById('pipelineCustomer').value = '';
            document.getElementById('pipelineProject').value = '';
            document.getElementById('pipelineStatus').value = 'Open';
            document.getElementById('pipelineValueQuotation').value = '';
            document.getElementById('pipelineValuePO').value = '';
            document.getElementById('pipelineDescription').value = '';
            document.getElementById('pipelineNotes').value = '';
            document.getElementById('pipelineProgress').value = 0;
            
            if (itemId && !canEditPipelineItem()) {
                showToast('You do not have permission to edit pipeline items', 'warning');
                return;
            }
            
            if (itemId) {
                modalTitle.textContent = 'Edit Pipeline Item';
                const item = pipelineItems.find(i => i.id === itemId);
                if (item) {
                    populatePipelineModalForm(item);
                    document.getElementById('originalPipelineStatus').value = item.status;
                }
            } else {
                modalTitle.textContent = 'New Pipeline Item';
                document.getElementById('pipelineStatus').value = 'Open';
                document.getElementById('pipelineProgress').value = 0;
                
                // Generate new number for new item
                try {
                    const nextNumber = await getNextQuotationNumber();
                    document.getElementById('pipelineNo').value = nextNumber;
                    
                    // Generate quotation number preview
                    const company = document.getElementById('pipelineCompany').value;
                    const sow = document.getElementById('pipelineSOW').value;
                    
                    if (company && sow) {
                        const quotationNumber = await generateQuotationNumber(nextNumber, company, sow);
                        document.getElementById('pipelineQuotation').value = quotationNumber;
                    }
                } catch (error) {
                    console.error('Error generating quotation number:', error);
                }
            }
            
            // Setup progress slider
            const progressSlider = document.getElementById('pipelineProgress');
            const progressValue = document.getElementById('progressValue');
            
            if (progressSlider && progressValue) {
                // Remove existing event listener
                const newSlider = progressSlider.cloneNode(true);
                progressSlider.parentNode.replaceChild(newSlider, progressSlider);
                
                // Add new event listener
                newSlider.addEventListener('input', function() {
                    progressValue.textContent = `${this.value}%`;
                });
            }
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        async function populatePipelineModalForm(item) {
            document.getElementById('pipelineItemId').value = item.id;
            document.getElementById('pipelineNo').value = item.no || '';
            document.getElementById('pipelineQuotation').value = item.quotation || '';
            document.getElementById('pipelineCompany').value = item.company || '';
            document.getElementById('pipelineSOW').value = item.sow || '';
            document.getElementById('pipelinePIC').value = item.pic || '';
            document.getElementById('pipelineCustomer').value = item.customer || '';
            document.getElementById('pipelineProject').value = item.project || '';
            document.getElementById('pipelineStatus').value = item.status || 'Open';
            document.getElementById('pipelineValueQuotation').value = item.valueQuotation ? formatCurrency(item.valueQuotation) : '';
            document.getElementById('pipelineValuePO').value = item.valuePO ? formatCurrency(item.valuePO) : '';
            document.getElementById('pipelineDescription').value = item.description || '';
            document.getElementById('pipelineNotes').value = item.notes || '';
            document.getElementById('pipelineProgress').value = item.progress || 0;
            document.getElementById('progressValue').textContent = `${item.progress || 0}%`;
        }

        function closePipelineItemModal() {
            hideAllSuggestions();
            document.getElementById('pipelineItemModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function savePipelineItem() {
            const form = document.getElementById('pipelineItemForm');
            if (!form.checkValidity()) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            const itemId = document.getElementById('pipelineItemId').value;
            const originalStatus = document.getElementById('originalPipelineStatus').value;
            const isEdit = !!itemId;
            
            const company = document.getElementById('pipelineCompany').value;
            const sow = document.getElementById('pipelineSOW').value;
            let no = parseInt(document.getElementById('pipelineNo').value) || 0;
            
            // Generate quotation number if creating new item
            let quotationNumber = document.getElementById('pipelineQuotation').value.trim();
            
            if (!isEdit && company && sow && no > 0) {
                // For new items, generate the quotation number
                quotationNumber = await generateQuotationNumber(no, company, sow);
            }
            
            const pipelineData = {
                no: no,
                quotation: quotationNumber,
                company: company,
                sow: sow,
                pic: document.getElementById('pipelinePIC').value.trim(),
                customer: document.getElementById('pipelineCustomer').value.trim(),
                project: document.getElementById('pipelineProject').value.trim(),
                status: document.getElementById('pipelineStatus').value,
                valueQuotation: parseCurrency(document.getElementById('pipelineValueQuotation').value),
                valuePO: parseCurrency(document.getElementById('pipelineValuePO').value),
                description: document.getElementById('pipelineDescription').value.trim() || '',
                notes: document.getElementById('pipelineNotes').value.trim() || '',
                progress: parseInt(document.getElementById('pipelineProgress').value) || 0,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser.email
            };
            
            try {
                showLoading();
                
                if (isEdit) {
                    await pipelinesCollection.doc(itemId).update(pipelineData);
                    
                    const newStatus = pipelineData.status;
                    if (originalStatus !== newStatus) {
                        await logPipelineStatusChange(itemId, pipelineData.project, originalStatus, newStatus);
                    }
                    
                    showToast('Pipeline item updated successfully', 'success');
                } else {
                    pipelineData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    pipelineData.createdBy = currentUser.email;
                    const result = await pipelinesCollection.add(pipelineData);
                    
                    await logPipelineStatusChange(result.id, pipelineData.project, 'New', pipelineData.status);
                    
                    showToast('Pipeline item created successfully', 'success');
                }
                
                await loadPipelineItems();
                closePipelineItemModal();
                
            } catch (error) {
                console.error('Error saving pipeline item:', error);
                showToast('Failed to save pipeline item', 'error');
            } finally {
                hideLoading();
            }
        }

        function openPipelineItemDetail(itemId) {
            console.log('Opening pipeline item detail:', itemId);
            
            // For now, we'll just open the edit modal
            // In a complete implementation, you might want a separate detail modal
            openPipelineItemModal(itemId);
        }

        async function deletePipelineItem(itemId) {
            if (!canDeletePipelineItem()) {
                showToast('Only admins can delete pipeline items', 'warning');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this pipeline item?')) return;
            
            try {
                showLoading();
                await pipelinesCollection.doc(itemId).delete();
                showToast('Pipeline item deleted successfully', 'success');
                await loadPipelineItems();
            } catch (error) {
                console.error('Error deleting pipeline item:', error);
                showToast('Failed to delete pipeline item', 'error');
            } finally {
                hideLoading();
            }
        }

        // ==================== ADD PIC MODAL FUNCTIONS ====================
        function openAddPICModal() {
            document.getElementById('addPICForm').reset();
            document.getElementById('addPICModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeAddPICModal() {
            document.getElementById('addPICModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function saveNewPIC() {
            const form = document.getElementById('addPICForm');
            if (!form.checkValidity()) {
                showToast('Please fill in PIC name', 'warning');
                return;
            }
            
            const picData = {
                name: document.getElementById('newPICName').value.trim(),
                email: document.getElementById('newPICEmail').value.trim() || '',
                phone: document.getElementById('newPICPhone').value.trim() || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.email
            };
            
            try {
                showLoading();
                
                // Check if PIC already exists
                const existingPIC = await picsCollection
                    .where('name', '==', picData.name)
                    .get();
                
                if (!existingPIC.empty) {
                    showToast('PIC already exists', 'warning');
                    return;
                }
                
                // Add new PIC to Firestore
                await picsCollection.add(picData);
                
                // Add to local list
                PIC_LIST.push({
                    id: picData.name.toLowerCase().replace(/\s+/g, '_'),
                    name: picData.name,
                    email: picData.email,
                    phone: picData.phone,
                    createdAt: picData.createdAt
                });
                
                showToast('PIC added successfully', 'success');
                
                // Set the new PIC as selected
                document.getElementById('pipelinePIC').value = picData.name;
                
                closeAddPICModal();
                
            } catch (error) {
                console.error('Error adding new PIC:', error);
                showToast('Failed to add PIC', 'error');
            } finally {
                hideLoading();
            }
        }

        // ==================== ADD CUSTOMER MODAL FUNCTIONS ====================
        function openAddCustomerModal() {
            document.getElementById('addCustomerForm').reset();
            document.getElementById('addCustomerModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function saveNewCustomer() {
            const form = document.getElementById('addCustomerForm');
            if (!form.checkValidity()) {
                showToast('Please fill in customer name', 'warning');
                return;
            }
            
            const customerData = {
                name: document.getElementById('newCustomerName').value.trim(),
                address: document.getElementById('newCustomerAddress').value.trim() || '',
                contact: document.getElementById('newCustomerContact').value.trim() || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.email
            };
            
            try {
                showLoading();
                
                // Check if customer already exists
                const existingCustomer = await customersCollection
                    .where('name', '==', customerData.name)
                    .get();
                
                if (!existingCustomer.empty) {
                    showToast('Customer already exists', 'warning');
                    return;
                }
                
                // Add new customer to Firestore
                await customersCollection.add(customerData);
                
                // Add to local list
                CUSTOMER_LIST.push({
                    id: customerData.name.toLowerCase().replace(/\s+/g, '_'),
                    name: customerData.name,
                    address: customerData.address,
                    contact: customerData.contact,
                    createdAt: customerData.createdAt
                });
                
                showToast('Customer added successfully', 'success');
                
                // Set the new customer as selected
                document.getElementById('pipelineCustomer').value = customerData.name;
                
                closeAddCustomerModal();
                
            } catch (error) {
                console.error('Error adding new customer:', error);
                showToast('Failed to add customer', 'error');
            } finally {
                hideLoading();
            }
        }

        // ==================== PIPELINE ANALYTICS ====================
        function openPipelinesAnalytics() {
            console.log('Opening pipeline analytics');
            
            if (!canViewPipelineAnalytics()) {
                showToast('You do not have permission to view pipeline analytics', 'warning');
                return;
            }
            
            document.getElementById('pipelinesAnalyticsModal').classList.remove('hidden');
            loadPipelineAnalytics();
        }

        function closePipelinesAnalyticsModal() {
            document.getElementById('pipelinesAnalyticsModal').classList.add('hidden');
            
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
        }

        async function loadPipelineAnalytics() {
            console.log('Loading pipeline analytics...');
            showLoading();
            
            try {
                const querySnapshot = await pipelinesCollection.get();
                const allItems = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allItems.push({
                        id: doc.id,
                        ...data
                    });
                });

                document.getElementById('pipelinesDataUpdatedTime').textContent = new Date().toLocaleString('id-ID');
                generatePipelineStatusChart(allItems);
                generatePipelineCompanyChart(allItems);
                generatePipelineRevenueChart(allItems);
                updatePipelineMetrics(allItems);
                
                showToast('Pipeline analytics loaded successfully', 'success');
                
            } catch (error) {
                console.error('Error loading pipeline analytics:', error);
                showToast('Failed to load pipeline analytics', 'error');
            } finally {
                hideLoading();
            }
        }

        function generatePipelineStatusChart(pipelineItems) {
            const ctx = document.getElementById('pipelineStatusChart');
            if (!ctx) return;
            
            if (charts.pipelineStatusChart) {
                charts.pipelineStatusChart.destroy();
            }
            
            const openCount = pipelineItems.filter(item => item.status === 'Open').length;
            const closeCount = pipelineItems.filter(item => item.status === 'Close').length;
            
            charts.pipelineStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Open', 'Close'],
                    datasets: [{
                        data: [openCount, closeCount],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.9)',    // Green
                            'rgba(100, 116, 139, 0.9)'    // Gray
                        ],
                        borderColor: [
                            'rgb(34, 197, 94)',
                            'rgb(100, 116, 139)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 11
                                },
                                padding: 15
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        function generatePipelineCompanyChart(pipelineItems) {
            const ctx = document.getElementById('pipelineCompanyChart');
            if (!ctx) return;
            
            if (charts.pipelineCompanyChart) {
                charts.pipelineCompanyChart.destroy();
            }
            
            const companyCounts = {
                'Genetek': 0,
                'Effrensindo': 0,
                'Other': 0
            };
            
            pipelineItems.forEach(item => {
                if (item.company === 'Genetek') {
                    companyCounts['Genetek']++;
                } else if (item.company === 'Effrensindo') {
                    companyCounts['Effrensindo']++;
                } else {
                    companyCounts['Other']++;
                }
            });
            
            charts.pipelineCompanyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(companyCounts),
                    datasets: [{
                        label: 'Items',
                        data: Object.values(companyCounts),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.9)',    // Blue
                            'rgba(139, 92, 246, 0.9)',    // Purple
                            'rgba(148, 163, 184, 0.9)'    // Gray
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(139, 92, 246)',
                            'rgb(148, 163, 184)'
                        ],
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Items',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function generatePipelineRevenueChart(pipelineItems) {
            const ctx = document.getElementById('pipelineRevenueChart');
            if (!ctx) return;
            
            if (charts.pipelineRevenueChart) {
                charts.pipelineRevenueChart.destroy();
            }
            
            // Group by month
            const monthlyData = {};
            pipelineItems.forEach(item => {
                if (item.createdAt) {
                    const date = item.createdAt.toDate();
                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            quotation: 0,
                            po: 0
                        };
                    }
                    
                    monthlyData[monthKey].quotation += (item.valueQuotation || 0);
                    monthlyData[monthKey].po += (item.valuePO || 0);
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const last6Months = sortedMonths.slice(-6);
            
            charts.pipelineRevenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last6Months.map(month => {
                        const [year, m] = month.split('-');
                        return `${m}/${year.slice(-2)}`;
                    }),
                    datasets: [
                        {
                            label: 'Quotation Value',
                            data: last6Months.map(month => monthlyData[month].quotation),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.15)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'PO Value',
                            data: last6Months.map(month => monthlyData[month].po),
                            borderColor: 'rgb(139, 92, 246)',
                            backgroundColor: 'rgba(139, 92, 246, 0.15)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value (IDR)',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePipelineMetrics(pipelineItems) {
            const openItems = pipelineItems.filter(item => item.status === 'Open').length;
            const closeItems = pipelineItems.filter(item => item.status === 'Close').length;
            
            let totalQuotationValue = 0;
            let totalPOValue = 0;
            
            pipelineItems.forEach(item => {
                totalQuotationValue += (item.valueQuotation || 0);
                totalPOValue += (item.valuePO || 0);
            });
            
            document.getElementById('totalOpenItems').textContent = openItems;
            document.getElementById('totalCloseItems').textContent = closeItems;
            document.getElementById('totalQuotationValue').textContent = formatCurrencyDisplay(totalQuotationValue);
            document.getElementById('totalPOValue').textContent = formatCurrencyDisplay(totalPOValue);
        }

        // ==================== USER MANAGEMENT ====================
        async function getUserRoleFromFirestore(userId) {
            console.log('Getting user role for:', userId);
            
            try {
                const userDoc = await usersCollection.doc(userId).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role || 'user';
                    console.log('User role from Firestore:', currentUserRole);
                    
                    await usersCollection.doc(userId).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    console.log('Creating new user document...');
                    let defaultRole = 'user';
                    const userEmail = currentUser.email;
                    
                    if (userEmail === 'admin@genetek.co.id') {
                        defaultRole = 'admin';
                    } else if (userEmail === 'm_husni@genetek.co.id') {
                        defaultRole = 'manager';
                    } else if (userEmail === 'galih@genetek.co.id') {
                        defaultRole = 'user';
                    }
                    
                    await usersCollection.doc(userId).set({
                        email: userEmail,
                        role: defaultRole,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    currentUserRole = defaultRole;
                    console.log('Created new user with role:', currentUserRole);
                }
                
                return currentUserRole;
                
            } catch (error) {
                console.error('Error getting user role:', error);
                currentUserRole = 'user';
                return 'user';
            }
        }

        function setupUserRolePermissions() {
            console.log('Setting up pipeline permissions for role:', currentUserRole);
            
            const newPipelineBtn = document.getElementById('newPipelineItemBtn');
            const analyticsBtn = document.getElementById('pipelinesAnalyticsBtn');
            
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.className = 'user-avatar';
                if (currentUserRole === 'admin') {
                    userAvatar.classList.add('admin');
                } else if (currentUserRole === 'manager') {
                    userAvatar.classList.add('manager');
                } else {
                    userAvatar.classList.add('user');
                }
            }
            
            const roleBadge = document.getElementById('userRoleBadge');
            if (roleBadge) {
                roleBadge.className = `badge badge-${currentUserRole === 'admin' ? 'secondary' : currentUserRole === 'manager' ? 'primary' : 'info'}`;
                roleBadge.innerHTML = `<i class="fas fa-user-tag"></i><span>${currentUserRole.charAt(0).toUpperCase() + currentUserRole.slice(1)}</span>`;
            }
            
            if (newPipelineBtn) newPipelineBtn.classList.remove('hidden');
            if (analyticsBtn) analyticsBtn.classList.add('hidden');
            
            switch(currentUserRole) {
                case 'admin':
                case 'manager':
                    if (analyticsBtn) analyticsBtn.classList.remove('hidden');
                    break;
                case 'user':
                    // Users can view and create items
                    break;
                default:
                    break;
            }
            
            console.log('Pipeline permissions set for role:', currentUserRole);
        }

        function canCreatePipelineItem() {
            return currentUserRole === 'admin' || currentUserRole === 'manager' || currentUserRole === 'user';
        }

        function canEditPipelineItem() {
            return currentUserRole === 'admin' || currentUserRole === 'manager' || currentUserRole === 'user';
        }

        function canDeletePipelineItem() {
            return currentUserRole === 'admin';
        }

        function canViewPipelineAnalytics() {
            return currentUserRole === 'admin' || currentUserRole === 'manager';
        }

        // ==================== AUTH FUNCTIONS ====================
        function setupAuthStateObserver() {
            if (!auth) {
                console.error('Auth not available');
                return;
            }

            console.log('Setting up auth state observer for Pipelines...');
            
            auth.onAuthStateChanged(async (user) => {
                console.log('Auth state changed:', user ? 'User logged in' : 'User logged out');
                
                if (user) {
                    currentUser = user;
                    
                    try {
                        await getUserRoleFromFirestore(user.uid);
                        
                        document.getElementById('userWelcome').textContent = user.email;
                        setupUserRolePermissions();
                        
                        // Initialize the app
                        initPipelinesApp();
                        showToast('Welcome to Pipelines!', 'success');
                        
                    } catch (error) {
                        console.error('Error in auth observer:', error);
                        showToast('Error loading user data', 'error');
                    }
                } else {
                    console.log('User signed out - redirecting to login');
                    // Redirect back to main app for login
                    window.location.href = 'index.html';
                }
            }, (error) => {
                console.error('Auth observer error:', error);
            });
        }

        function logout() {
            console.log('Logging out from Pipelines...');
            
            if (auth && currentUser) {
                auth.signOut().then(() => {
                    console.log('Logout successful');
                    showToast('Logged out successfully', 'success');
                }).catch(error => {
                    console.error('Logout error:', error);
                    showToast('Error signing out', 'error');
                });
            }
        }

        function backToDashboard() {
            console.log('Returning to main dashboard...');
            window.location.href = 'index.html';
        }

        // ==================== EVENT LISTENERS ====================
        function initPipelinesApp() {
            console.log('Initializing Pipelines app...');
            
            loadPipelineItems();
            setupDragAndDrop();
            setupAutoCompleteSearch();
            setupCurrencyInputs();
            
            // Add event listeners for quotation number generation
            document.getElementById('pipelineCompany').addEventListener('change', async function() {
                await updateQuotationPreview();
            });
            
            document.getElementById('pipelineSOW').addEventListener('change', async function() {
                await updateQuotationPreview();
            });
            
            // Add event listeners
            document.getElementById('newPipelineItemBtn').addEventListener('click', createNewPipelineItem);
            document.getElementById('backToDashboardBtn').addEventListener('click', backToDashboard);
            document.getElementById('pipelinesAnalyticsBtn').addEventListener('click', openPipelinesAnalytics);
            document.getElementById('authButton').addEventListener('click', logout);
            
            document.getElementById('searchPipelineItems').addEventListener('input', filterPipelineItems);
            document.getElementById('filterByCompany').addEventListener('change', filterPipelineItems);
            document.getElementById('filterByStatus').addEventListener('change', filterPipelineItems);
            
            document.getElementById('closePipelineModal').addEventListener('click', closePipelineItemModal);
            document.getElementById('cancelPipelineBtn').addEventListener('click', closePipelineItemModal);
            document.getElementById('pipelineItemForm').addEventListener('submit', function(e) {
                e.preventDefault();
                savePipelineItem();
            });
            
            document.getElementById('closePipelinesAnalyticsModal').addEventListener('click', closePipelinesAnalyticsModal);
            document.getElementById('closePipelinesAnalyticsModalBottom').addEventListener('click', closePipelinesAnalyticsModal);
            
            // Add PIC modal event listeners
            document.getElementById('closeAddPICModal').addEventListener('click', closeAddPICModal);
            document.getElementById('cancelAddPICBtn').addEventListener('click', closeAddPICModal);
            document.getElementById('addPICForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveNewPIC();
            });
            
            // Add customer modal event listeners
            document.getElementById('closeAddCustomerModal').addEventListener('click', closeAddCustomerModal);
            document.getElementById('cancelAddCustomerBtn').addEventListener('click', closeAddCustomerModal);
            document.getElementById('addCustomerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveNewCustomer();
            });
            
            console.log('Pipelines app initialization complete');
        }

        async function updateQuotationPreview() {
            const company = document.getElementById('pipelineCompany').value;
            const sow = document.getElementById('pipelineSOW').value;
            const noInput = document.getElementById('pipelineNo');
            
            if (company && sow && noInput && noInput.value) {
                const no = parseInt(noInput.value);
                if (!isNaN(no) && no > 0) {
                    const quotationNumber = await generateQuotationNumber(no, company, sow);
                    document.getElementById('pipelineQuotation').value = quotationNumber;
                }
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Work Order Pipelines initializing...');
            
            const firebaseInitialized = initializeFirebase();
            
            if (!firebaseInitialized) {
                showToast('Firebase initialization failed. Please check console.', 'error');
                return;
            }
            
            setupAuthStateObserver();
            
            console.log('Pipelines initialization complete');
        });

    </script>
</body>
</html>
