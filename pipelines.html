<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Order Pipelines - Admin Sales View</title>
    
    <!-- Load Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* ==================== VARIABLES ==================== */
        :root {
            /* Color Palette - Modern & Professional */
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
            
            --secondary-50: #fdf2f8;
            --secondary-100: #fce7f3;
            --secondary-200: #fbcfe8;
            --secondary-300: #f9a8d4;
            --secondary-400: #f472b6;
            --secondary-500: #ec4899;
            --secondary-600: #db2777;
            --secondary-700: #be185d;
            --secondary-800: #9d174d;
            --secondary-900: #831843;
            
            --accent-50: #f0fdf4;
            --accent-100: #dcfce7;
            --accent-200: #bbf7d0;
            --accent-300: #86efac;
            --accent-400: #4ade80;
            --accent-500: #22c55e;
            --accent-600: #16a34a;
            --accent-700: #15803d;
            --accent-800: #166534;
            --accent-900: #14532d;
            
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;
            
            /* Pipeline Status Colors */
            --pipeline-open: #22c55e;
            --pipeline-close: #64748b;
            
            /* Priority Colors */
            --priority-high: #f87171;
            --priority-urgent: #ef4444;
            --priority-normal: #3b82f6;
            --priority-low: #94a3b8;
            
            /* Kriteria Colors */
            --kriteria-followup: #f59e0b;
            --kriteria-win: #22c55e;
            --kriteria-lose: #ef4444;
            
            /* Admin Sales Color */
            --adminsales-500: #6366f1;
            --adminsales-600: #4f46e5;
            
            /* UI Variables */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ==================== BASE STYLES ==================== */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--neutral-50) 0%, #ffffff 100%);
            min-height: 100vh;
            color: var(--neutral-800);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* ==================== AUTO-COMPLETE SEARCH STYLES ==================== */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            background: white;
            transition: var(--transition-base);
            color: var(--neutral-800);
            padding-right: 3.5rem;
        }

        .autocomplete-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .autocomplete-add-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-500);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.875rem;
        }

        .autocomplete-add-btn:hover {
            background: var(--primary-600);
            transform: translateY(-50%) scale(1.05);
        }

        .autocomplete-add-btn.hidden {
            display: none;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            margin-top: 0.25rem;
            animation: fadeIn 0.2s ease-out;
        }

        .autocomplete-suggestions.show {
            display: block;
        }

        .autocomplete-suggestion {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition-fast);
            border-bottom: 1px solid var(--neutral-100);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .autocomplete-suggestion:hover {
            background: var(--primary-50);
            color: var(--primary-700);
        }

        .autocomplete-suggestion.selected {
            background: var(--primary-100);
            color: var(--primary-800);
            font-weight: 600;
            border-left: 3px solid var(--primary-500);
        }

        .autocomplete-suggestion-icon {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: var(--radius-sm);
            background: var(--primary-100);
            color: var(--primary-600);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .autocomplete-no-results {
            padding: 1.5rem 1rem;
            text-align: center;
            color: var(--neutral-500);
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .autocomplete-no-results-icon {
            font-size: 1.5rem;
            opacity: 0.5;
        }

        /* ==================== CAMERA STYLES ==================== */
        .camera-preview {
            width: 100%;
            height: 300px;
            background: var(--neutral-900);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 1rem;
            position: relative;
        }

        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: var(--neutral-900);
        }

        .camera-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .camera-btn {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-base);
            border: none;
            box-shadow: var(--shadow-md);
        }

        .camera-btn-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
        }

        .camera-btn-secondary {
            background: linear-gradient(135deg, var(--secondary-500), var(--secondary-600));
            color: white;
        }

        .camera-btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .camera-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1rem;
            pointer-events: none;
        }

        .camera-status {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            align-self: center;
        }

        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-preview-item {
            position: relative;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: var(--transition-base);
        }

        .image-preview-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .image-preview-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .image-preview-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            opacity: 0;
            transition: var(--transition-fast);
        }

        .image-preview-item:hover .image-preview-actions {
            opacity: 1;
        }

        .image-action-btn {
            width: 2rem;
            height: 2rem;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .image-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* ==================== PIPELINE BOARD STYLES ==================== */
        .pipeline-board {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            padding: 1rem;
            min-height: calc(100vh - 300px);
            height: 600px;
            overflow: hidden;
        }

        .pipeline-column {
            background: var(--neutral-100);
            border-radius: var(--radius-xl);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--neutral-200);
            overflow: hidden;
            height: 100%;
        }

        .pipeline-column-header {
            padding: 0.75rem 1rem;
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }

        .pipeline-column-open {
            background: linear-gradient(135deg, var(--pipeline-open), #16a34a);
        }

        .pipeline-column-close {
            background: linear-gradient(135deg, var(--pipeline-close), #475569);
        }

        .pipeline-items-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
            min-height: 0;
        }

        .pipeline-item {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--neutral-200);
            cursor: grab;
            transition: var(--transition-base);
            position: relative;
        }

        .pipeline-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--neutral-300);
        }

        .pipeline-item:active {
            cursor: grabbing;
        }

        .pipeline-item.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }

        .pipeline-item-over {
            border: 2px dashed var(--primary-500);
            background: var(--primary-50);
        }

        .pipeline-item-disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .pipeline-item-disabled:hover {
            transform: none;
            box-shadow: var(--shadow-sm);
        }

        /* Admin Sales specific styles */
        .pipeline-item-view-only {
            cursor: pointer;
        }

        .pipeline-item-view-only:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .pipeline-item-view-only:active {
            cursor: pointer;
        }

        /* ==================== PIPELINE ITEM STYLES ==================== */
        .pipeline-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .pipeline-open-badge {
            background: linear-gradient(135deg, #dcfce7, #f0fdf4);
            color: var(--pipeline-open);
            border: 1px solid #86efac;
        }

        .pipeline-close-badge {
            background: linear-gradient(135deg, #f1f5f9, #f8fafc);
            color: var(--pipeline-close);
            border: 1px solid #cbd5e1;
        }
        
        /* Kriteria Badges */
        .kriteria-followup-badge {
            background: linear-gradient(135deg, #fef3c7, #fffbeb);
            color: var(--kriteria-followup);
            border: 1px solid #fcd34d;
        }
        
        .kriteria-win-badge {
            background: linear-gradient(135deg, #dcfce7, #f0fdf4);
            color: var(--kriteria-win);
            border: 1px solid #86efac;
        }
        
        .kriteria-lose-badge {
            background: linear-gradient(135deg, #fee2e2, #fef2f2);
            color: var(--kriteria-lose);
            border: 1px solid #fca5a5;
        }

        /* ==================== BADGE STYLES ==================== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-primary {
            background: linear-gradient(135deg, var(--primary-100), var(--primary-50));
            color: var(--primary-700);
            border: 1px solid var(--primary-300);
        }

        .badge-secondary {
            background: linear-gradient(135deg, var(--secondary-100), var(--secondary-50));
            color: var(--secondary-700);
            border: 1px solid var(--secondary-300);
        }

        .badge-success {
            background: linear-gradient(135deg, var(--accent-100), var(--accent-50));
            color: var(--accent-700);
            border: 1px solid var(--accent-300);
        }

        .badge-info {
            background: linear-gradient(135deg, #dbeafe, #eff6ff);
            color: #1d4ed8;
            border: 1px solid #93c5fd;
        }

        .badge-warning {
            background: linear-gradient(135deg, #fef3c7, #fffbeb);
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .badge-danger {
            background: linear-gradient(135deg, #fee2e2, #fef2f2);
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .badge-adminsales {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            color: var(--adminsales-600);
            border: 1px solid #a5b4fc;
        }

        /* ==================== GRADIENT BACKGROUNDS ==================== */
        .gradient-bg-primary {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-700) 100%);
        }

        .gradient-bg-secondary {
            background: linear-gradient(135deg, var(--secondary-500) 0%, var(--secondary-700) 100%);
        }

        .gradient-bg-accent {
            background: linear-gradient(135deg, var(--accent-500) 0%, var(--accent-700) 100%);
        }

        .gradient-bg-adminsales {
            background: linear-gradient(135deg, var(--adminsales-500) 0%, var(--adminsales-600) 100%);
        }

        /* ==================== ELEGANT HEADER ==================== */
        .app-header {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-800) 100%);
            color: white;
            padding: 1.5rem 0;
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        .app-logo {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .app-title {
            font-weight: 800;
            font-size: 2.25rem;
            letter-spacing: -0.025em;
            background: linear-gradient(135deg, #ffffff 0%, rgba(255,255,255,0.9) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .app-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            font-weight: 500;
        }

        /* ==================== COLORFUL BUTTONS ==================== */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            font-size: 0.875rem;
            transition: var(--transition-base);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-slow);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-500) 0%, var(--secondary-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-500) 0%, var(--accent-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-excel {
            background: linear-gradient(135deg, #217346 0%, #1e5c3a 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-camera {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-view {
            background: linear-gradient(135deg, var(--adminsales-500) 0%, var(--adminsales-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-500);
            color: var(--primary-600);
        }

        .btn-outline:hover {
            background: var(--primary-500);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ==================== COLORFUL CARDS ==================== */
        .card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--secondary-500), var(--accent-500));
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        /* ==================== USER INFO CARD ==================== */
        .user-card {
            background: linear-gradient(135deg, var(--primary-50), var(--secondary-50));
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--primary-200);
            transition: var(--transition-base);
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-300);
        }

        .user-avatar {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            box-shadow: var(--shadow-md);
        }

        .user-avatar.admin {
            background: linear-gradient(135deg, var(--secondary-500), var(--secondary-600));
        }

        .user-avatar.manager {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        }

        .user-avatar.user {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-600));
        }

        .user-avatar.adminsales {
            background: linear-gradient(135deg, var(--adminsales-500), var(--adminsales-600));
        }

        /* ==================== SEARCH BOX ==================== */
        .search-box {
            position: relative;
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            transition: var(--transition-base);
        }

        .search-box:focus-within {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-500);
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3.5rem;
            border: none;
            border-radius: var(--radius-xl);
            font-size: 0.95rem;
            background: transparent;
            outline: none;
            color: var(--neutral-800);
        }

        .search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-500);
            font-size: 1.25rem;
        }

        /* ==================== FORM STYLES ==================== */
        .form-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            position: relative;
            overflow: hidden;
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-500), var(--secondary-500));
        }

        .form-section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-section-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .form-section-icon-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        }

        .form-section-icon-secondary {
            background: linear-gradient(135deg, var(--secondary-500), var(--secondary-600));
        }

        .form-section-icon-success {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-600));
        }

        .form-section-icon-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .form-section-icon-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--neutral-700);
            font-size: 0.9rem;
            transition: var(--transition-fast);
        }

        .required-field::after {
            content: ' *';
            color: #ef4444;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            background: white;
            transition: var(--transition-base);
            color: var(--neutral-800);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input:disabled {
            background: var(--neutral-100);
            cursor: not-allowed;
        }

        /* ==================== CURRENCY INPUT STYLES ==================== */
        .currency-input-group {
            position: relative;
        }

        .currency-prefix {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--neutral-600);
            font-weight: 600;
        }

        .currency-input {
            padding-left: 3.5rem !important;
        }

        /* ==================== SECTION 2 PADDING ==================== */
        .pic-customer-section {
            padding-bottom: 320px !important;
        }

        /* ==================== MODIFIED MODAL STYLES WITH STICKY HEADER & FOOTER ==================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary-500), var(--secondary-500), var(--accent-500));
        }

        .modal-header {
            padding: 0.5rem 2rem;
            background: linear-gradient(135deg, var(--neutral-800), var(--neutral-900));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            flex-shrink: 0;
            z-index: 10;
        }

        .modal-header.sticky-top {
            position: sticky;
            top: 0;
        }

        .modal-header.sticky-bottom {
            position: sticky;
            bottom: 0;
            background: linear-gradient(135deg, var(--neutral-800), var(--neutral-900));
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 2rem;
            right: 2rem;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, rgba(255,255,255,0.9));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        /* Detail Information Styles */
        .detail-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--neutral-200);
            position: relative;
            overflow: hidden;
        }

        .detail-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-500), var(--secondary-500));
        }

        .detail-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .detail-section-icon {
            width: 2rem;
            height: 2rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .detail-section-icon-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        }

        .detail-section-icon-secondary {
            background: linear-gradient(135deg, var(--secondary-500), var(--secondary-600));
        }

        .detail-section-icon-success {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-600));
        }

        .detail-section-icon-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .detail-section-icon-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .detail-item {
            display: flex;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed var(--neutral-200);
        }

        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .detail-label {
            width: 120px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--neutral-600);
            flex-shrink: 0;
        }

        .detail-value {
            flex: 1;
            font-size: 0.95rem;
            color: var(--neutral-800);
        }

        .detail-value-highlight {
            font-weight: 700;
            color: var(--primary-700);
        }

        /* ==================== TOAST NOTIFICATIONS ==================== */
        .toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            background: white;
            color: var(--neutral-800);
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 320px;
            transform: translateX(100%);
            opacity: 0;
            transition: var(--transition-base);
            border-left: 4px solid var(--primary-500);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left-color: var(--accent-500);
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.info {
            border-left-color: #3b82f6;
        }

        .toast-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .toast-icon.success {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-600));
        }

        .toast-icon.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .toast-icon.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .toast-icon.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        /* ==================== LOADING OVERLAY ==================== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .loading-spinner {
            width: 5rem;
            height: 5rem;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-500);
            animation: spin 1s linear infinite;
            position: relative;
        }

        .loading-spinner::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: var(--secondary-500);
            animation: spin 1.5s linear infinite reverse;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== CUSTOM SCROLLBAR ==================== */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--neutral-100);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, var(--primary-400), var(--secondary-400));
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, var(--primary-500), var(--secondary-500));
        }

        /* ==================== ANIMATIONS ==================== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-slide-in-right {
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* ==================== UTILITY CLASSES ==================== */
        .hidden {
            display: none !important;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .text-gradient {
            background: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ==================== RESPONSIVE DESIGN ==================== */
        @media (max-width: 768px) {
            .pipeline-board {
                grid-template-columns: 1fr;
                height: auto;
                min-height: auto;
            }
            
            .pipeline-column {
                height: 400px;
            }
            
            .app-title {
                font-size: 1.75rem;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
            
            .form-section {
                padding: 1.5rem;
            }
            
            .autocomplete-suggestions {
                position: fixed;
                top: 50%;
                left: 1rem;
                right: 1rem;
                transform: translateY(-50%);
                max-height: 70vh;
                z-index: 10000;
            }
            
            .modal-header {
                padding: 1.25rem 1.5rem;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
            
            .camera-preview {
                height: 250px;
            }
            
            .camera-controls {
                flex-wrap: wrap;
            }
            
            .image-preview-container {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .detail-item {
                flex-direction: column;
            }
            
            .detail-label {
                width: 100%;
                margin-bottom: 0.25rem;
            }
        }

        @media (max-width: 640px) {
            .btn {
                padding: 0.75rem 1rem;
            }
            
            .card {
                padding: 1.25rem;
            }
            
            .modal-header {
                padding: 1rem 1.25rem;
            }
            
            .modal-title {
                font-size: 1.25rem;
            }
            
            .camera-preview {
                height: 200px;
            }
            
            .image-preview-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Main Application Page -->
    <div id="appPage">
        <!-- App Header -->
        <div class="app-header">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-8">
                    <div class="flex-1">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="app-logo">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <div>
                                <h1 class="app-title">Work Order Pipelines</h1>
                                <p class="app-subtitle">Visual Pipeline Management System</p>
                            </div>
                        </div>
                        
                        <!-- User Info Card -->
                        <div class="user-card inline-block">
                            <div class="flex items-center gap-4">
                                <div class="user-avatar user" id="userAvatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm text-purple-600 font-medium mb-1">Welcome to Pipelines</p>
                                    <p id="userWelcome" class="font-semibold text-gray-900 truncate"></p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="userRoleBadge" class="badge badge-info">
                                        <i class="fas fa-user-tag"></i>
                                        <span>Loading...</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons - Will be dynamically shown/hidden based on role -->
                    <div class="flex flex-wrap gap-2" id="actionButtons">
                        <button id="newPipelineItemBtn" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i>
                            <span>New Pipeline Item</span>
                        </button>
                        <button id="takePictureBtn" class="btn btn-camera">
                            <i class="fas fa-camera"></i>
                            <span>Ambil Gambar</span>
                        </button>
                        <button id="exportExcelBtn" class="btn btn-excel">
                            <i class="fas fa-file-excel"></i>
                            <span>Export to Excel</span>
                        </button>
                        <button id="pipelinesAnalyticsBtn" class="btn btn-info">
                            <i class="fas fa-chart-bar"></i>
                            <span>Pipeline Analytics</span>
                        </button>
                        <button id="backToDashboardBtn" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i>
                            <span>Back to Dashboard</span>
                        </button>
                        <button id="authButton" class="btn btn-danger">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
                
                <!-- Search and Filter Box -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="search-box">
                        <i class="search-icon fas fa-search"></i>
                        <input type="text" 
                               id="searchPipelineItems" 
                               placeholder="Search pipeline items..."
                               class="search-input">
                    </div>
                    <div>
                        <select id="filterByCompany" class="form-input w-full">
                            <option value="">All Companies</option>
                            <option value="Genetek">Genetek</option>
                            <option value="Effrensindo">Effrensindo</option>
                        </select>
                    </div>
                    <div>
                        <select id="filterByStatus" class="form-input w-full">
                            <option value="">All Status</option>
                            <option value="Open">Open</option>
                            <option value="Close">Close</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pipeline Board -->
        <div class="max-w-7xl mx-auto px-4 py-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-2 gap-4 mb-8">
                <div class="card text-center">
                    <div class="text-2xl font-bold text-green-600" id="openCount">0</div>
                    <div class="text-sm text-gray-600 mt-1">Open</div>
                </div>
                <div class="card text-center">
                    <div class="text-2xl font-bold text-gray-600" id="closeCount">0</div>
                    <div class="text-sm text-gray-600 mt-1">Close</div>
                </div>
            </div>
            
            <!-- Pipeline Board -->
            <div class="pipeline-board">
                <!-- Open Column -->
                <div class="pipeline-column" data-status="Open">
                    <div class="pipeline-column-header pipeline-column-open">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-folder-open"></i>
                            <span>Open</span>
                        </div>
                        <span class="text-white bg-white/20 px-2 py-1 rounded text-sm" id="openBadge">0</span>
                    </div>
                    <div class="pipeline-items-container custom-scrollbar" id="openItems">
                        <!-- Open items will be loaded here -->
                    </div>
                </div>
                
                <!-- Close Column -->
                <div class="pipeline-column" data-status="Close">
                    <div class="pipeline-column-header pipeline-column-close">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-folder"></i>
                            <span>Close</span>
                        </div>
                        <span class="text-white bg-white/20 px-2 py-1 rounded text-sm" id="closeBadge">0</span>
                    </div>
                    <div class="pipeline-items-container custom-scrollbar" id="closeItems">
                        <!-- Close items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Pipeline Item Modal (Create/Edit) -->
    <div id="pipelineItemModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-4xl">
            <!-- Sticky Header -->
            <div class="modal-header sticky-top">
                <div>
                    <h2 class="modal-title" id="pipelineModalTitle">New Pipeline Item</h2>
                    <p class="text-gray-300 mt-1">Create or edit pipeline item</p>
                </div>
                <button id="closePipelineModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Scrollable Body -->
            <div class="modal-body custom-scrollbar">
                <form id="pipelineItemForm" class="space-y-8">
                    <input type="hidden" id="pipelineItemId">
                    <input type="hidden" id="originalPipelineStatus">
                    
                    <!-- Section 1: Basic Information -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-primary">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <span>Basic Information</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label required-field" for="pipelineNo">
                                    No
                                </label>
                                <input type="number" 
                                       id="pipelineNo" 
                                       class="form-input"
                                       required
                                       placeholder="Nomor urut akan di-generate otomatis"
                                       readonly>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineQuotation">
                                    No. Quotation
                                </label>
                                <input type="text" 
                                       id="pipelineQuotation" 
                                       class="form-input bg-gray-50"
                                       required
                                       readonly
                                       placeholder="Akan digenerate otomatis">
                                <p class="text-xs text-gray-500 mt-1">Format: 001/GI/FAS/I/2026 (auto-generated)</p>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineDate">
                                    Tanggal
                                </label>
                                <input type="date" 
                                       id="pipelineDate" 
                                       class="form-input"
                                       required
                                       onchange="updateQuotationPreview()">
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineCompany">
                                    Company
                                </label>
                                <select id="pipelineCompany" class="form-input" required onchange="updateQuotationPreview()">
                                    <option value="">Select Company</option>
                                    <option value="Genetek">Genetek</option>
                                    <option value="Effrensindo">Effrensindo</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineSOW">
                                    SOW
                                </label>
                                <select id="pipelineSOW" class="form-input" required onchange="updateCategoryOptions()">
                                    <option value="">Select SOW</option>
                                    <option value="FAS">FAS</option>
                                    <option value="Vesda">Vesda</option>
                                    <option value="FSS">FSS</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineCategory">
                                    Category
                                </label>
                                <select id="pipelineCategory" class="form-input" required disabled>
                                    <option value="">Select Category</option>
                                    <!-- Options will be populated dynamically based on SOW selection -->
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Select SOW first to see available categories</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 2: PIC and Customer -->
                    <div class="form-section pic-customer-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-secondary">
                                <i class="fas fa-users"></i>
                            </div>
                            <span>Person In Charge & Customer</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label required-field" for="pipelinePIC">
                                    PIC
                                </label>
                                <div class="autocomplete-container">
                                    <input type="text" 
                                           id="pipelinePIC" 
                                           class="autocomplete-input form-input"
                                           required
                                           placeholder="Type to search or add PIC"
                                           autocomplete="off">
                                    <button type="button" 
                                            class="autocomplete-add-btn hidden"
                                            id="addPICBtn"
                                            title="Add new PIC">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <div class="autocomplete-suggestions" id="picSuggestions"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Start typing to see suggestions</p>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineCustomer">
                                    Customer
                                </label>
                                <div class="autocomplete-container">
                                    <input type="text" 
                                           id="pipelineCustomer" 
                                           class="autocomplete-input form-input"
                                           required
                                           placeholder="Type to search or add customer"
                                           autocomplete="off">
                                    <button type="button" 
                                            class="autocomplete-add-btn hidden"
                                            id="addCustomerBtn"
                                            title="Add new customer">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <div class="autocomplete-suggestions" id="customerSuggestions"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Start typing to see suggestions</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 3: Project, Status, and Kriteria -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-success">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <span>Project & Status</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div>
                                <label class="form-label required-field" for="pipelineProject">
                                    Project
                                </label>
                                <input type="text" 
                                       id="pipelineProject" 
                                       class="form-input"
                                       required
                                       placeholder="Enter project name">
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineStatus">
                                    Status
                                </label>
                                <select id="pipelineStatus" class="form-input" required>
                                    <option value="Open">Open</option>
                                    <option value="Close">Close</option>
                                </select>
                            </div>
                            
                            <!-- KRITERIA DROPDOWN - BARU -->
                            <div>
                                <label class="form-label required-field" for="pipelineKriteria">
                                    Kriteria
                                </label>
                                <select id="pipelineKriteria" class="form-input" required onchange="updateProgressFromKriteria()">
                                    <option value="">Pilih Kriteria</option>
                                    <option value="Follow Up">Follow Up</option>
                                    <option value="Win">Win</option>
                                    <option value="Lose">Lose</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Progress akan otomatis terisi berdasarkan kriteria</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 4: Financial Information -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-warning">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <span>Financial Information</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label required-field" for="pipelineValueQuotation">
                                    Value Quotation
                                </label>
                                <div class="currency-input-group">
                                    <span class="currency-prefix">IDR</span>
                                    <input type="text" 
                                           id="pipelineValueQuotation" 
                                           class="form-input currency-input"
                                           required
                                           placeholder="Enter quotation value"
                                           data-thousands-separator=".">
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="pipelineValuePO">
                                    Value PO
                                </label>
                                <div class="currency-input-group">
                                    <span class="currency-prefix">IDR</span>
                                    <input type="text" 
                                           id="pipelineValuePO" 
                                           class="form-input currency-input"
                                           required
                                           placeholder="Enter PO value"
                                           data-thousands-separator=".">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 5: Description -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-info">
                                <i class="fas fa-align-left"></i>
                            </div>
                            <span>Description</span>
                        </div>
                        
                        <div>
                            <label class="form-label" for="pipelineDescription">
                                Description
                            </label>
                            <textarea id="pipelineDescription" 
                                      class="form-input" 
                                      rows="6"
                                      placeholder="Describe the pipeline item..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Section 6: Progress & Notes -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-info">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <span>Progress & Notes</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label" for="pipelineProgress">
                                    Progress (%)
                                </label>
                                <input type="range" 
                                       id="pipelineProgress" 
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                       min="0" 
                                       max="100" 
                                       value="0">
                                <div class="flex justify-between text-sm text-gray-600 mt-2">
                                    <span>0%</span>
                                    <span id="progressValue">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label" for="pipelineNotes">
                                    Notes
                                </label>
                                <textarea id="pipelineNotes" 
                                          class="form-input" 
                                          rows="3"
                                          placeholder="Additional notes..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Section 7: Attached Images (New Section) -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-warning">
                                <i class="fas fa-images"></i>
                            </div>
                            <span>Attached Images</span>
                        </div>
                        
                        <div id="pipelineImagesContainer">
                            <!-- Images will be loaded here -->
                            <div class="text-center py-8 text-gray-500" id="noImagesMessage">
                                <i class="fas fa-images text-4xl mb-3"></i>
                                <p>No images attached to this pipeline item</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Sticky Footer -->
            <div class="modal-header sticky-bottom">
                <div></div>
                <div class="flex gap-3">
                    <button id="cancelPipelineBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" form="pipelineItemForm" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Save Pipeline Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AMBIL GAMBAR -->
    <div id="takePictureModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-4xl">
            <div class="modal-header sticky-top">
                <div>
                    <h2 class="modal-title">Ambil Gambar</h2>
                    <p class="text-gray-300 mt-1">Ambil gambar untuk dilampirkan ke pipeline</p>
                </div>
                <button id="closeTakePictureModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body custom-scrollbar">
                <!-- Section 1: Pilih Pipeline -->
                <div class="form-section mb-6">
                    <div class="form-section-title">
                        <div class="form-section-icon form-section-icon-primary">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <span>Pilih Pipeline</span>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label required-field" for="searchPipelineForCamera">
                            Cari Pipeline Item
                        </label>
                        <div class="autocomplete-container">
                            <input type="text" 
                                   id="searchPipelineForCamera" 
                                   class="autocomplete-input form-input"
                                   required
                                   placeholder="Ketik untuk mencari pipeline item..."
                                   autocomplete="off">
                            <button type="button" 
                                    class="autocomplete-add-btn"
                                    id="refreshPipelineListBtn"
                                    title="Refresh list">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <div class="autocomplete-suggestions" id="pipelineSuggestions"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Pilih pipeline item untuk melampirkan gambar</p>
                    </div>
                    
                    <!-- Selected Pipeline Info -->
                    <div id="selectedPipelineInfo" class="hidden p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-bold text-blue-800" id="selectedPipelineTitle">Pipeline Item</h4>
                            <span class="pipeline-badge pipeline-open-badge" id="selectedPipelineStatus">Open</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="text-gray-600">No:</div>
                            <div class="font-medium" id="selectedPipelineNo">-</div>
                            
                            <div class="text-gray-600">Quotation:</div>
                            <div class="font-medium" id="selectedPipelineQuotation">-</div>
                            
                            <div class="text-gray-600">Customer:</div>
                            <div class="font-medium" id="selectedPipelineCustomer">-</div>
                            
                            <div class="text-gray-600">PIC:</div>
                            <div class="font-medium" id="selectedPipelinePIC">-</div>
                            
                            <div class="text-gray-600">Kriteria:</div>
                            <div class="font-medium" id="selectedPipelineKriteria">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Section 2: Kamera & Preview -->
                <div class="form-section mb-6">
                    <div class="form-section-title">
                        <div class="form-section-icon form-section-icon-success">
                            <i class="fas fa-camera"></i>
                        </div>
                        <span>Kamera & Preview</span>
                    </div>
                    
                    <div class="mb-4">
                        <div class="camera-preview" id="cameraPreview">
                            <div class="camera-overlay">
                                <div class="camera-status" id="cameraStatus">
                                    <i class="fas fa-camera mr-2"></i>
                                    <span>Kamera siap</span>
                                </div>
                            </div>
                            <video id="cameraVideo" autoplay playsinline></video>
                            <canvas id="cameraCanvas" class="hidden"></canvas>
                            <img id="capturedImage" class="hidden" alt="Captured Image">
                        </div>
                        
                        <div class="camera-controls">
                            <button id="startCameraBtn" class="camera-btn camera-btn-primary" title="Start Camera">
                                <i class="fas fa-play"></i>
                            </button>
                            <button id="stopCameraBtn" class="camera-btn camera-btn-secondary hidden" title="Stop Camera">
                                <i class="fas fa-stop"></i>
                            </button>
                            <button id="captureBtn" class="camera-btn camera-btn-success hidden" title="Capture Image">
                                <i class="fas fa-camera"></i>
                            </button>
                            <button id="retakeBtn" class="camera-btn camera-btn-warning hidden" title="Retake">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button id="saveImageBtn" class="camera-btn camera-btn-primary hidden" title="Save Image">
                                <i class="fas fa-save"></i>
                            </button>
                        </div>
                        
                        <div class="text-center mt-4">
                            <label class="btn btn-outline cursor-pointer">
                                <i class="fas fa-upload mr-2"></i>
                                Upload Gambar
                                <input type="file" 
                                       id="uploadImageInput" 
                                       class="hidden" 
                                       accept="image/*" 
                                       capture="environment">
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Section 3: Gambar yang Telah Diambil -->
                <div class="form-section">
                    <div class="form-section-title">
                        <div class="form-section-icon form-section-icon-info">
                            <i class="fas fa-images"></i>
                        </div>
                        <span>Gambar yang Telah Diambil</span>
                    </div>
                    
                    <div id="capturedImagesContainer" class="image-preview-container">
                        <!-- Captured images will be shown here -->
                        <div class="text-center col-span-full py-8 text-gray-500">
                            <i class="fas fa-images text-4xl mb-3"></i>
                            <p>Belum ada gambar yang diambil</p>
                            <p class="text-sm">Gunakan kamera atau upload gambar untuk melampirkan</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-sm text-gray-600">
                        <p><i class="fas fa-info-circle mr-2"></i> Gambar akan disimpan sebagai Base64 dan dilampirkan ke pipeline item</p>
                    </div>
                </div>
            </div>
            
            <div class="modal-header sticky-bottom">
                <div>
                    <div class="text-sm text-gray-300" id="imageCountInfo">0 gambar tersedia</div>
                </div>
                <div class="flex gap-3">
                    <button id="cancelTakePictureBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button id="attachToPipelineBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-paperclip"></i>
                        Lampirkan ke Pipeline
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New PIC Modal -->
    <div id="addPICModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-md">
            <div class="modal-header sticky-top">
                <div>
                    <h2 class="modal-title">Add New PIC</h2>
                    <p class="text-gray-300 mt-1">Add new Person In Charge</p>
                </div>
                <button id="closeAddPICModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body custom-scrollbar">
                <form id="addPICForm" class="space-y-6">
                    <div>
                        <label class="form-label required-field" for="newPICName">
                            PIC Name
                        </label>
                        <input type="text" 
                               id="newPICName" 
                               class="form-input"
                               required
                               placeholder="Enter PIC name">
                    </div>
                    
                    <div>
                        <label class="form-label" for="newPICEmail">
                            Email
                        </label>
                        <input type="email" 
                               id="newPICEmail" 
                               class="form-input"
                               placeholder="Enter email address">
                    </div>
                    
                    <div>
                        <label class="form-label" for="newPICPhone">
                            Phone Number
                        </label>
                        <input type="text" 
                               id="newPICPhone" 
                               class="form-input"
                               placeholder="Enter phone number">
                    </div>
                </form>
            </div>
            <div class="modal-header sticky-bottom">
                <div></div>
                <div class="flex gap-3">
                    <button id="cancelAddPICBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" form="addPICForm" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Add PIC
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Customer Modal -->
    <div id="addCustomerModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-md">
            <div class="modal-header sticky-top">
                <div>
                    <h2 class="modal-title">Add New Customer</h2>
                    <p class="text-gray-300 mt-1">Add new customer to the list</p>
                </div>
                <button id="closeAddCustomerModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body custom-scrollbar">
                <form id="addCustomerForm" class="space-y-6">
                    <div>
                        <label class="form-label required-field" for="newCustomerName">
                            Customer Name
                        </label>
                        <input type="text" 
                               id="newCustomerName" 
                               class="form-input"
                               required
                               placeholder="Enter customer name">
                    </div>
                    
                    <div>
                        <label class="form-label" for="newCustomerAddress">
                            Address
                        </label>
                        <textarea id="newCustomerAddress" 
                                  class="form-input" 
                                  rows="3"
                                  placeholder="Enter customer address"></textarea>
                    </div>
                    
                    <div>
                        <label class="form-label" for="newCustomerContact">
                            Contact Person
                        </label>
                        <input type="text" 
                               id="newCustomerContact" 
                               class="form-input"
                               placeholder="Enter contact person">
                    </div>
                </form>
            </div>
            <div class="modal-header sticky-bottom">
                <div></div>
                <div class="flex gap-3">
                    <button id="cancelAddCustomerBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" form="addCustomerForm" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Add Customer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div id="exportOptionsModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-md">
            <div class="modal-header sticky-top">
                <div>
                    <h2 class="modal-title">Export to Excel</h2>
                    <p class="text-gray-300 mt-1">Choose export options</p>
                </div>
                <button id="closeExportOptionsModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body custom-scrollbar">
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Export Scope</h3>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="exportScope" value="all" class="w-4 h-4 text-green-600" checked>
                                <div>
                                    <div class="font-medium">All Pipeline Items</div>
                                    <p class="text-sm text-gray-500">Export all pipeline items regardless of filters</p>
                                </div>
                            </label>
                            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="exportScope" value="filtered" class="w-4 h-4 text-green-600">
                                <div>
                                    <div class="font-medium">Filtered Items Only</div>
                                    <p class="text-sm text-gray-500">Export only items matching current search/filters</p>
                                </div>
                            </label>
                            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="exportScope" value="status" class="w-4 h-4 text-green-600">
                                <div>
                                    <div class="font-medium">By Status</div>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center gap-2">
                                            <input type="checkbox" id="exportOpen" class="w-4 h-4 text-green-600" checked>
                                            <span class="text-sm">Open Items</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="checkbox" id="exportClose" class="w-4 h-4 text-green-600" checked>
                                            <span class="text-sm">Close Items</span>
                                        </label>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Export Format</h3>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="exportFormat" value="detailed" class="w-4 h-4 text-blue-600" checked>
                                <div>
                                    <div class="font-medium">Detailed Export</div>
                                    <p class="text-sm text-gray-500">Include all fields with formatting</p>
                                </div>
                            </label>
                            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="exportFormat" value="summary" class="w-4 h-4 text-blue-600">
                                <div>
                                    <div class="font-medium">Summary Export</div>
                                    <p class="text-sm text-gray-500">Basic fields only for quick review</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Export Options</h3>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" id="includeTimestamp" class="w-4 h-4 text-blue-600" checked>
                                <div>
                                    <div class="font-medium">Include Timestamp</div>
                                    <p class="text-sm text-gray-500">Add export date and time to filename</p>
                                </div>
                            </label>
                            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" id="includeFilters" class="w-4 h-4 text-blue-600" checked>
                                <div>
                                    <div class="font-medium">Include Filter Info</div>
                                    <p class="text-sm text-gray-500">Add current filter settings to sheet</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-info-circle text-blue-600 text-lg"></i>
                            <div>
                                <div class="font-medium text-blue-800">Export Information</div>
                                <p class="text-sm text-blue-600 mt-1">
                                    The export will include all pipeline data in a formatted Excel file. 
                                    Currency values will be properly formatted and columns will be auto-sized.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-header sticky-bottom">
                <div>
                    <div class="text-sm text-gray-300" id="exportItemCount">0 items will be exported</div>
                </div>
                <div class="flex gap-3">
                    <button id="cancelExportBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button id="confirmExportBtn" class="btn btn-excel">
                        <i class="fas fa-file-excel"></i>
                        Export to Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Analytics Modal -->
    <div id="pipelinesAnalyticsModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="modal-header sticky-top">
                <div>
                    <h2 class="modal-title">Pipeline Analytics</h2>
                    <p class="text-gray-300 mt-1">Pipeline performance and insights</p>
                </div>
                <button id="closePipelinesAnalyticsModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body custom-scrollbar">
                <div class="flex justify-between items-center mb-8">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        Data updated: <span id="pipelinesDataUpdatedTime"></span>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="card">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center">
                                <i class="fas fa-chart-pie text-green-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">Status Distribution</h3>
                                <p class="text-sm text-gray-600">Open vs Close items</p>
                            </div>
                        </div>
                        <canvas id="pipelineStatusChart"></canvas>
                    </div>
                    
                    <div class="card">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center">
                                <i class="fas fa-chart-bar text-blue-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">Company Distribution</h3>
                                <p class="text-sm text-gray-600">By company</p>
                            </div>
                        </div>
                        <canvas id="pipelineCompanyChart"></canvas>
                    </div>
                    
                    <div class="card lg:col-span-2">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center">
                                <i class="fas fa-chart-line text-purple-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">Revenue Flow</h3>
                                <p class="text-sm text-gray-600">Value Quotation vs Value PO</p>
                            </div>
                        </div>
                        <canvas id="pipelineRevenueChart"></canvas>
                    </div>
                    
                    <div class="card lg:col-span-2">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-red-100 to-red-200 flex items-center justify-center">
                                <i class="fas fa-users text-red-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">PIC Performance</h3>
                                <p class="text-sm text-gray-600">Progress by Person In Charge</p>
                            </div>
                            <div class="ml-auto">
                                <select id="picChartSort" class="form-input text-sm">
                                    <option value="name">Sort by Name</option>
                                    <option value="items">Sort by Item Count</option>
                                    <option value="progress">Sort by Average Progress</option>
                                </select>
                            </div>
                        </div>
                        <canvas id="pipelinePICChart"></canvas>
                        <div class="mt-4 text-sm text-gray-600" id="picChartInfo"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-yellow-100 to-yellow-200 flex items-center justify-center">
                            <i class="fas fa-tachometer-alt text-yellow-600"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900">Performance Metrics</h3>
                            <p class="text-sm text-gray-600">Key pipeline performance indicators</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="text-center p-4 bg-green-50 rounded-xl">
                            <div class="text-2xl font-bold text-green-700" id="totalOpenItems">0</div>
                            <div class="text-sm text-green-600 mt-1">Open Items</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div class="text-2xl font-bold text-gray-700" id="totalCloseItems">0</div>
                            <div class="text-sm text-gray-600 mt-1">Close Items</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-xl">
                            <div class="text-2xl font-bold text-blue-700" id="totalQuotationValue">0</div>
                            <div class="text-sm text-blue-600 mt-1">Total Quotation Value</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-xl">
                            <div class="text-2xl font-bold text-purple-700" id="totalPOValue">0</div>
                            <div class="text-sm text-purple-600 mt-1">Total PO Value</div>
                        </div>
                        <div class="text-center p-4 bg-gradient-to-r from-pink-50 to-rose-50 rounded-xl">
                            <div class="text-2xl font-bold text-rose-700" id="bestPICName">-</div>
                            <div class="text-sm text-rose-600 mt-1" id="bestPICProgress">Best PIC</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-header sticky-bottom">
                <div></div>
                <div>
                    <button id="closePipelinesAnalyticsModalBottom" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Detail Modal (For View Only) -->
    <div id="pipelineDetailModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-4xl">
            <!-- Sticky Header -->
            <div class="modal-header sticky-top">
                <div>
                    <h2 class="modal-title" id="pipelineDetailTitle">Pipeline Item Details</h2>
                    <p class="text-gray-300 mt-1" id="pipelineDetailSubtitle">View pipeline item information</p>
                </div>
                <button id="closePipelineDetailModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Scrollable Body -->
            <div class="modal-body custom-scrollbar">
                <div class="space-y-6">
                    <!-- Header with badges -->
                    <div class="flex flex-wrap justify-between items-start gap-4 mb-6">
                        <div>
                            <span class="text-sm text-gray-600">Pipeline Item #</span>
                            <span class="text-xl font-bold text-gray-900" id="detailNo"></span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <span id="detailStatusBadge" class="pipeline-badge"></span>
                            <span id="detailKriteriaBadge" class="pipeline-badge hidden"></span>
                        </div>
                    </div>
                    
                    <!-- Section 1: Basic Information -->
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <div class="detail-section-icon detail-section-icon-primary">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <span>Basic Information</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div class="detail-item">
                                <div class="detail-label">No. Quotation</div>
                                <div class="detail-value" id="detailQuotation">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Tanggal</div>
                                <div class="detail-value" id="detailDate">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Company</div>
                                <div class="detail-value" id="detailCompany">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">SOW</div>
                                <div class="detail-value" id="detailSOW">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Category</div>
                                <div class="detail-value" id="detailCategory">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 2: PIC and Customer -->
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <div class="detail-section-icon detail-section-icon-secondary">
                                <i class="fas fa-users"></i>
                            </div>
                            <span>Person In Charge & Customer</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div class="detail-item">
                                <div class="detail-label">PIC</div>
                                <div class="detail-value" id="detailPIC">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Customer</div>
                                <div class="detail-value" id="detailCustomer">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 3: Project & Status -->
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <div class="detail-section-icon detail-section-icon-success">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <span>Project & Status</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <div class="detail-item lg:col-span-3">
                                <div class="detail-label">Project</div>
                                <div class="detail-value font-medium" id="detailProject">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Status</div>
                                <div class="detail-value" id="detailStatus">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Kriteria</div>
                                <div class="detail-value" id="detailKriteria">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Progress</div>
                                <div class="detail-value" id="detailProgress">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 4: Financial Information -->
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <div class="detail-section-icon detail-section-icon-warning">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <span>Financial Information</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div class="detail-item">
                                <div class="detail-label">Value Quotation</div>
                                <div class="detail-value detail-value-highlight" id="detailValueQuotation">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Value PO</div>
                                <div class="detail-value detail-value-highlight" id="detailValuePO">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 5: Description -->
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <div class="detail-section-icon detail-section-icon-info">
                                <i class="fas fa-align-left"></i>
                            </div>
                            <span>Description</span>
                        </div>
                        
                        <div class="detail-item">
                            <div class="detail-label">Description</div>
                            <div class="detail-value" id="detailDescription">-</div>
                        </div>
                    </div>
                    
                    <!-- Section 6: Notes -->
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <div class="detail-section-icon detail-section-icon-info">
                                <i class="fas fa-sticky-note"></i>
                            </div>
                            <span>Notes</span>
                        </div>
                        
                        <div class="detail-item">
                            <div class="detail-label">Notes</div>
                            <div class="detail-value" id="detailNotes">-</div>
                        </div>
                    </div>
                    
                    <!-- Section 7: Attached Images -->
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <div class="detail-section-icon detail-section-icon-warning">
                                <i class="fas fa-images"></i>
                            </div>
                            <span>Attached Images</span>
                            <span id="detailImagesCount" class="ml-auto text-sm bg-gray-200 px-2 py-1 rounded">0 images</span>
                        </div>
                        
                        <div id="detailImagesContainer" class="image-preview-container">
                            <!-- Images will be loaded here -->
                            <div class="text-center col-span-full py-8 text-gray-500" id="detailNoImagesMessage">
                                <i class="fas fa-images text-4xl mb-3"></i>
                                <p>No images attached to this pipeline item</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 8: Metadata -->
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <div class="detail-section-icon detail-section-icon-info">
                                <i class="fas fa-history"></i>
                            </div>
                            <span>System Information</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div class="detail-item">
                                <div class="detail-label">Created By</div>
                                <div class="detail-value text-sm" id="detailCreatedBy">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Created At</div>
                                <div class="detail-value text-sm" id="detailCreatedAt">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Updated By</div>
                                <div class="detail-value text-sm" id="detailUpdatedBy">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Updated At</div>
                                <div class="detail-value text-sm" id="detailUpdatedAt">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sticky Footer -->
            <div class="modal-header sticky-bottom">
                <div></div>
                <div class="flex gap-3">
                    <button id="closePipelineDetailBottomBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Image Modal -->
    <div id="previewImageModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-4xl">
            <div class="modal-header sticky-top">
                <div>
                    <h2 class="modal-title">Preview Gambar</h2>
                    <p class="text-gray-300 mt-1" id="previewImageInfo"></p>
                </div>
                <button id="closePreviewImageModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body custom-scrollbar">
                <div class="flex justify-center items-center min-h-[400px]">
                    <img id="previewImage" src="" alt="Preview" class="max-w-full max-h-[70vh] object-contain rounded-lg">
                </div>
                <div class="mt-4 text-center">
                    <button id="downloadImageBtn" class="btn btn-primary">
                        <i class="fas fa-download"></i>
                        Download Gambar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-white text-lg font-medium">Loading Pipelines...</p>
        </div>
    </div>

<script>
        // ==================== GLOBAL VARIABLES ====================
        let db, auth, pipelinesCollection, pipelineHistoryCollection, usersCollection, customersCollection, picsCollection;
        let currentUser = null;
        let currentUserRole = 'user';
        let pipelineItems = [];
        let filteredPipelineItems = [];
        let draggedItem = null;
        let charts = {};
        
        // Variables for camera
        let cameraStream = null;
        let selectedPipelineItem = null;
        let capturedImages = []; // Array to store base64 images
        let currentPipelineImages = []; // Images for current pipeline item in modal
        
        // Data for autocomplete (static data)
        const PIC_LIST_STATIC = [
            "Wahyu Sujoko",
            "Proboadi hariyo wicaksono", 
            "Fiki hernawan",
            "Indra kurniawan",
            "Aries A Bastian",
            "Mochammad Gorwantoro Putra", 
            "Yudiyono", 
            "Muhamad husni", 
            "edwin qomarudin", 
            "Edy Amin",
            "Heksi Prasetyo", 
            "Hery Syah Putra"
        ];
        
        const CUSTOMER_LIST_STATIC = [
            "PT. GUDANG GARAM Tbk",
            "PERSEROAN TERBATAS BADAN BANK CENTRAL ASIA TBK",
            "PT. FRISIAN FLAG INDONESIA",
            "PT. GRIYA SIRA INDAH",
            "PT. PUTRA SINAR PERMAJA",
            "PT. PLAZA INDONESIA REALTY Tbk",
            "CV. KROSS SARANA TEKNIK",
            "PT. GEMILANG CIPTA ABADI",
            "PT. MARYO MAKMUR TEHNIK",
            "PT. SOUTH PACIFIC VISCOSE",
            "PT. HOTEL CANDI BARU",
            "PT. SMILE BRIGHT WHITE (LAND OF SMILES CLINIC)",
            "PT. PURI MATAHARI",
            "PT. MENARA ASTRA",
            "PT. PLAZA INDONESIA MANDIRI",
            "PT. WYNNCOR BALI",
            "PT. JONES LANG LASALLE",
            "PT. SATAHI CIPTA MANDIRI",
            "YAYASAN BUDDHA TZU CHI MEDIKA INDONESIA",
            "PT. INDONESIA MOC SERVICE",
            "PT. RAMA KUTA HOTEL",
            "PT. HANDAL UTAMA BUANA",
            "PT. SURYA MARGA LUHUR",
            "PT. GRAHA SIDANG PRATAMA",
            "PT. LASALLEFOOD INDONESIA",
            "SARULLA OPERATIONS LTD",
            "SHM FIRE SAFETY Pte.Ltd",
            "PT. WAHANA NUSANTARA",
            "PT. YOGYA CENTRAL TERPADU",
            "PT. DONGGI SENORO LNG",
            "PT. PT. INDONESIA MOROWALI INDUSTRIAL PARK",
            "CAKRA NUSA UTAMA",
            "PT. BIMANTARA CITRA",
            "PT. ALAM BALI INTERNATIONAL",
            "PT. ASIA PROPERTINDO BUILDING",
            "P3SRS-KC KERATON APARTMENT PLAZA INDONESIA",
            "PT. TRIGUNA MANDALA",
            "PT. PATRA JASA",
            "PT. TOTAL FIRE INDONESIA",
            "PERHIMPUNAN PEMILIK DAN PENGHUNI SATUAN RUMAH SUSUN APARTEMEN CIPUTRA WORLD 2 JAKARTA",
            "PT. SPECTRO PRATAMA INDONESIA",
            "PT. PAKUWON PERMAI",
            "PT. BINA GRAHA MAKMUR",
            "PT. JAFA KARYA TEKNIK",
            "PT. MINH GIA CONSORSIUM",
            "PERHIMPUNAN PENGHUNI APARTEMEN BATAVIA",
            "PT. SURYA ANDALAN BUMI PERSADA",
            "PT. SINAR CEMERLANG GEMILANG",
            "PT. SINAR GALAXY",
            "PT. MELFICON PERSADA ABADI",
            "PT. APICAL KAO CHEMICAL",
            "PT. GRAHA BENGKULU MAKMUR",
            "PT. VOPAK TERMINAL MERAK",
            "PT. PLAZA LIFESTYLE PRIMA",
            "PT. BLUEMOON INTERNASIONAL",
            "PT. HONEYWELL INDONESIA",
            "PT. BUNGASARI FLOUR MILLS INDONESIA",
            "PT. ROYAL PACIFIC NUSANTARA",
            "PT. IDEA SEJAHTERA INDONESIA",
            "PT. BERCA MANDIRI PERKASA",
            "PT. LAX TEKNOLOGI INDONESIA",
            "MU RESEARCH AND CONSULTING INDONESIA",
            "PT. PROMATRIX FACILITIES MANAGEMENT",
            "PT. JISK PERSADA SOLUSI",
            "PT. SEMEN INDONESIA LOGISTIK",
            "PT. MANE INDONESIA",
            "PT. JGC INDONESIA",
            "PT. JOHNSON CONTROLS INDONESIA",
            "PT. WIFGASINDO DINAMIKA INSTRUMENT ENGINEERING",
            "PT. BAHANASEMESTA CITRANUSANTARA",
            "PT. INDOKO PERKASA PRIMA",
            "PT. ARKADIA SINERGI INDONESIA",
            "PT. NURBAIZ RIZKY SEJAHTERA",
            "PT. PILAR GARBA INTI",
            "PT. CITRA PUTRA REALTY",
            "JADESTONE ENERGY (LEMANG) PTE LTD",
            "PT. LANGGENG KREASI JAYA PRIMA",
            "RUMAH SAKIT JANTUNG HARAPAN KITA JAKARTA DITJEN PELAYANAN KESEHATAN KEMENTRIAN KESEHATAN",
            "PT. GELYN SIDNI",
            "YUSKITAMA LESTARI",
            "PPPSRS APARTEMEN THE ELEMENTS",
            "PPPSRS PERKANTORAN EKSEKUTIF SATRIO TOWER",
            "PT. BORNEO PROPERTINDO MANDIRI",
            "PT. KARTA WADANA ABADI",
            "PT. KUSUMA INTI ABADI",
            "PT. HANJAYA MANDALA SAMPOERNA TBK",
            "PT. SENA AVINDO",
            "PT. INDOSAFE TIRTA MAKMUR",
            "PT. INDONESIA ANEKATAMA MANDIRI",
            "PT. JAYA BONS ABADI",
            "PT. GRAHA ALAM LESTARI",
            "PT. MEGA HOTEL LESTARI",
            "PT. PARA BALI PROPERTINDO",
            "PT. MATTEL INDONESIA",
            "PT. GRAHA WAHANA NUSANTARA",
            "PT. BINARA GUNA MEDIKTAMA",
            "PT. SODEXO SINERGI INDONESIA",
            "PT. MULIA KARYA GEMILANG",
            "PT. RAMAYANA HARTA PRATAMA",
            "PT. SIMEX PHARMACEUTICAL INDONESIA",
            "PT. MIRAMA WISATA",
            "PPPSRS THE PAKUBUWON VIEW",
            "PT. MUTIARA PERMATA MULIA",
            "PT. CBRE CONSULTANCY SERVICES",
            "PT. KARANG MAS SEJAHTERA",
            "PT. RUMAH SAKIT PONDOK INDAH",
            "PT. YUSKITAMA LESTARI",
            "PT. TAIYO SINAR RAYA TEKNIK",
            "PT. SHR HOTEL INDONESIA",
            "PPRSH FOUR SEASONS REGENT RESIDENCES",
            "PP THE PAKUBUWON RESIDENCE",
            "PT. SARIARTHAMAS HOTEL INTERNATIONAL",
            "PT. PT. BENTENG TEGUH PERKASA",
            "BHUMI PRAMA ARJASA",
            "PT. AFG VENTURA TEKNOLOGI",
            "PT. TARANA REKSA CIPTAKARYA",
            "MARS SYMBIOSCIENCE INDONESIA",
            "PT. KREASI CIPTA KARSA",
            "PT. WIRA EKA BHAKTI",
            "PERKUMPULAN PENGHUNI RUMAH SUSUN REGATTA-VB",
            "CV. ZULFIRA KREASINDO",
            "PT. REICON WIRAINDO PRATAMA",
            "PT. PURI ZUQNI",
            "PT. SILOAM INTERNATIONAL HOSPITALS Tbk",
            "PT. KARUNIA ARTHA PRATAMA",
            "PT. KAWASAN MANDIRI BERSAMA",
            "PT. JAYA BINARA MEDIKTAMA",
            "PT. CENTRE POINT MEDAN",
            "PT. SRIBOGA FLOUR MILL",
            "HYUNDAI ENGINEERING & CONSTRUCTION CO,LTD",
            "PT. EPCON GRAHA GUNA",
            "PT. YAS KONSULTAN INDONESIA",
            "PT. KARYA PROPERTINDO INVESTAMA",
            "PT. BUMI SERPONG DAMAI",
            "PT. PAKUWON PERMAI",
            "PT. API METRA GRAHA",
            "EUROASIATIC JAYA",
            "PT. MUSTIKA MEMADATA",
            "PT. ISS INDONESIA",
            "PERHIMPUNAN PENGHUNI PERKANTORAN PLAZA ASIA",
            "PT. EMPAT PILAR ADIDAYA",
            "PT. SUMBER MESIN RAYA",
            "PT. SARANA UTAMA ADIMANDIRI",
            "PT. BARNABY KONSTRUKSI SEJAHTERA",
            "CV. ANEKA MANDIRI",
            "PERKUMPULAN HUSADA",
            "PT. FINUSOLPRIMA FARMA INTERNASIONAL",
            "CV. LENTERA TILAS TEHNIK",
            "PT. VILLAS HOTEL",
            "PT. ARISTA PRATAMA JAYA",
            "PT. WIKA REALTY MINOR DEVELOPMENT",
            "PT. INTEGRA METRICON MANDIRI",
            "PT. SENTRATEK ADIPRESTASI",
            "PT. PT. BANK CENTRAL ASIA TBK",
            "PT. HARAPAN GLOBAL NIAGA",
            "PT. PAKUWON JATI TBK",
            "PERHIMPUNAN PEMILIK DAN PENGHUNI SATUAN RUMAH SUSUN SEMENTARA CIPUTRA INTERNATIONAL - 1",
            "BPK. ROHMADI",
            "PT. DUA CAHAYA SAKTI",
            "PT. CIPTAKARYA MANDIRI JAYA",
            "PT. MANGGALA GELORA PERKASA",
            "PT. SAMAMANTAP SEJAHTERA",
            "PT. TELKOM LANDMARK TOWER",
            "PT. ANUMANA GRAHA CANTIKA",
            "PT. PRIMA PRATAMA CITRA",
            "RS EVASARI",
            "PT. DUTA ANGGADA REALTY TBK",
            "PT. TIGA DUA DELAPAN",
            "PT. DWITAMA ALAM SEJAHTERA",
            "PT. WAHANA ADIREKSA PRATAMA",
            "PERSEROAN TERBATAS - BADAN SURYA BAYU SAKTI",
            "PT. PANTRAYA",
            "PT. KIEVIT INDONESIA",
            "PT. ALLTECH SOLUSINDO",
            "PT. KALBE FARMA TBK",
            "PT. SURYA GRAHA PERTIWI",
            "PT. ANDAL MAKMUR AGUNG",
            "KAP PAUL HADIWINATA, HIDAJAT, ARSONO, RETNO, PALILINGAN & REKAN",
            "PT. ALFA PRIMA TEHNINDO",
            "PT. BUMITANGERANG MESINDOTAMA",
            "PT. SETYA SOLUSI SEJAHTERA",
            "PT. ADITYRA ROKKO KENCANA",
            "PT. MANDIRI ANDAL SEJAHTERA",
            "PT. GRHA HATTEN DUASATU",
            "PT. SEMESTA INDAH PERMATA",
            "PT. GEMA GRAHA SARANA",
            "PERSEK. OENTOENG SURIA & PARTNERS",
            "PT. METROPOLITAN KENTJANA TBK",
            "PT. DUTA ANGGADA REALTY - CHASE PLAZA",
            "PT. CIPUTRA RESIDENCE",
            "PT. GENTAMULIA INFRA",
            "PT. KAMADJAJA LOGISTICS",
            "PT. PESONA PURI PROPERTI",
            "PT. HEXALINDO MITRA PERKASA",
            "PT. SUMMARECON HOTELINDO",
            "PT. KUSUMA INTI ABADI",
            "PT. JELL ENGINEERING KARYA",
            "PT. SURYAMAS DUTA MAKMUR TBK",
            "PT. CENTRAL TEHNIK SOLUSINDO",
            "PT. SINAR MAS AGRO RESOURCES AND TECHNOLOGY TBK",
            "PT. UNITA BRANINDO",
            "PT. PENGELOLA LANDMARK PLUIT",
            "PT. GRAHA LAYAR PRIMA TBK",
            "DASATRIA UTAMA",
            "PT. KIDE INTERNATIONAL INDONESIA",
            "PT. PRIMASATYA REKSACIPTA TEHNIKA",
            "PT. CONSTRUCTA BUILDERS",
            "PT. PUTERA SAMPOERNA",
            "PT. TOTALFIRE INDONESIA",
            "PT. OPHTHALINDO JAYA",
            "PT. BUANA MITRA GLOBALINDO",
            "PT. TEKNIKA INTI PERKASA",
            "PT. MEGA MULIA MULTIABADI",
            "PT. SANGGRAHA DHIKA",
            "PT. AZBIL BERCA INDONESIA",
            "PT. ESPANIKA DWI SENTA",
            "PPPSRS HUNIAN APARTEMEN SOUTH HILLS",
            "PERSEROAN TERBATAS BADAN GRAHA SENGGIGI (ARUNA SENGGIGI RESORT & CONVENTION)",
            "PT. SUCCESS VENTURE HOTEL INVESTMENTS",
            "PT. SUCCESS VENTURE SERVICED SUITES INVESTMENTS",
            "PT. SURYA INTER WISESA",
            "PT. MHG BALANGAN",
            "PT. TOA COATING INDONESIA",
            "PT. GEMA INTERMULIA SEJAHTERA",
            "PT. PARIDAN INTI SOLUSI PERSADA",
            "PT. SANTOS JAYA ABADI",
            "PT. SUPRA BOGA LESTARI TBk",
            "PT. YESTAR KARYA UTAMA",
            "PT. JON MERELL JAYA",
            "PT. INDOAGRI DAITOCACAO",
            "PT. OCS GLOBAL SERVICES",
            "PT. ADEMCO SECURITY INDONESIA",
            "PERHIMPUNAN PENGHUNI RUMAH SUSUN (SEMENTARA) APARTEMEN PURI ORCHARD",
            "PT. KIAN MULIA MANUNGGAL",
            "BPK. LIE EDDY"
        ];
        
        // Combined data for autocomplete
        let PIC_LIST = [];
        let CUSTOMER_LIST = [];
        
        // Pipeline statuses configuration
        const pipelineStatuses = [
            { id: 'Open', name: 'Open', icon: 'fa-folder-open', color: 'green' },
            { id: 'Close', name: 'Close', icon: 'fa-folder', color: 'gray' }
        ];

        // Kriteria options
        const KRITERIA_OPTIONS = ['Follow Up', 'Win', 'Lose'];

        // Category options based on SOW
        const CATEGORY_OPTIONS = {
            'FAS': ['Spare Part', 'Maintenance', 'Project'],
            'Vesda': ['Spare Part', 'Maintenance', 'Project'],
            'FSS': ['Spare Part', 'Maintenance', 'Project']
        };

        // Progress mapping based on kriteria
        const KRITERIA_PROGRESS_MAPPING = {
            'Follow Up': 50,
            'Win': 100,
            'Lose': 100
        };

        // ==================== INITIALIZE FIREBASE ====================
        function initializeFirebase() {
            try {
                console.log('Initializing Firebase for Pipelines...');
                
                const firebaseConfig = {
                    apiKey: "AIzaSyAwXNGrJsBqQ2RslAkdWWPSOubUw13QcRI",
                    authDomain: "workorder-mon.firebaseapp.com",
                    projectId: "workorder-mon",
                    storageBucket: "workorder-mon.firebasestorage.app",
                    messagingSenderId: "226391173482",
                    appId: "1:226391173482:web:9ea9c68c1e31c84f50dd13"
                };

                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore(app);
                auth = firebase.auth(app);
                
                pipelinesCollection = db.collection('pipelines');
                pipelineHistoryCollection = db.collection('pipelineHistory');
                usersCollection = db.collection('users');
                customersCollection = db.collection('customers');
                picsCollection = db.collection('pics');
                
                console.log('Firebase initialized successfully for Pipelines');
                return true;
                
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                showToast('Firebase initialization failed. Please check console.', 'error');
                return false;
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatDate(date) {
            if (!date) return '-';
            try {
                if (date.toDate) {
                    date = date.toDate();
                }
                return date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            } catch (e) {
                return '-';
            }
        }

        function formatDateTime(date) {
            if (!date) return '-';
            try {
                if (date.toDate) {
                    date = date.toDate();
                }
                return date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return '-';
            }
        }

        function formatTimeAgo(date) {
            if (!date) return 'Just now';
            try {
                if (date.toDate) {
                    date = date.toDate();
                }
                const now = new Date();
                const diffMs = now - date;
                const diffSec = Math.floor(diffMs / 1000);
                const diffMin = Math.floor(diffSec / 60);
                const diffHour = Math.floor(diffMin / 60);
                const diffDay = Math.floor(diffHour / 24);
                
                if (diffSec < 60) return 'Just now';
                if (diffMin < 60) return `${diffMin}m ago`;
                if (diffHour < 24) return `${diffHour}h ago`;
                if (diffDay < 7) return `${diffDay}d ago`;
                return formatDate(date);
            } catch (e) {
                return 'Some time ago';
            }
        }

        function formatCurrency(value) {
            if (!value) return '0';
            const num = parseInt(value.toString().replace(/\./g, ''));
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function parseCurrency(value) {
            if (!value) return 0;
            return parseInt(value.toString().replace(/\./g, '')) || 0;
        }

        function formatCurrencyInput(value) {
            // Remove all non-digit characters
            let num = value.replace(/\D/g, '');
            
            // Format with thousand separators
            if (num.length > 3) {
                num = num.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }
            
            return num;
        }

        function formatCurrencyDisplay(value) {
            if (!value) return 'IDR 0';
            return 'IDR ' + formatCurrency(value);
        }

        function showToast(message, type = 'info', duration = 3000) {
            console.log(`Toast [${type}]:`, message);
            
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const colors = {
                success: 'linear-gradient(135deg, #22c55e, #16a34a)',
                error: 'linear-gradient(135deg, #ef4444, #dc2626)',
                warning: 'linear-gradient(135deg, #f59e0b, #d97706)',
                info: 'linear-gradient(135deg, #3b82f6, #2563eb)'
            };
            
            toast.innerHTML = `
                <div class="toast-icon ${type}" style="background: ${colors[type] || colors.info}">
                    <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
                </div>
                <div>
                    <p class="font-medium">${message}</p>
                    <p class="text-sm text-gray-600 mt-1">${new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}</p>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
        }

        // ==================== CATEGORY MANAGEMENT FUNCTIONS ====================
        function updateCategoryOptions() {
            const sowSelect = document.getElementById('pipelineSOW');
            const categorySelect = document.getElementById('pipelineCategory');
            const selectedSOW = sowSelect.value;
            
            // Clear existing options except the first one
            while (categorySelect.options.length > 1) {
                categorySelect.remove(1);
            }
            
            if (selectedSOW && CATEGORY_OPTIONS[selectedSOW]) {
                // Enable the select
                categorySelect.disabled = false;
                
                // Add options based on selected SOW
                CATEGORY_OPTIONS[selectedSOW].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            } else {
                // Disable the select if no SOW is selected
                categorySelect.disabled = true;
                categorySelect.value = '';
            }
        }

        // ==================== KRITERIA FUNCTIONS ====================
        function updateProgressFromKriteria() {
            const kriteriaSelect = document.getElementById('pipelineKriteria');
            const progressSlider = document.getElementById('pipelineProgress');
            const progressValue = document.getElementById('progressValue');
            
            if (!kriteriaSelect || !progressSlider || !progressValue) return;
            
            const selectedKriteria = kriteriaSelect.value;
            
            if (selectedKriteria && KRITERIA_PROGRESS_MAPPING[selectedKriteria] !== undefined) {
                const progress = KRITERIA_PROGRESS_MAPPING[selectedKriteria];
                progressSlider.value = progress;
                progressValue.textContent = `${progress}%`;
                
                // Disable progress slider if kriteria is Win or Lose (100%)
                if (selectedKriteria === 'Win' || selectedKriteria === 'Lose') {
                    progressSlider.disabled = true;
                } else {
                    progressSlider.disabled = false;
                }
            } else {
                progressSlider.disabled = false;
            }
        }

        function getKriteriaBadgeClass(kriteria) {
            switch(kriteria) {
                case 'Follow Up': return 'kriteria-followup-badge';
                case 'Win': return 'kriteria-win-badge';
                case 'Lose': return 'kriteria-lose-badge';
                default: return 'badge-info';
            }
        }

        // ==================== PERMISSION FUNCTIONS ====================
        function canCreatePipelineItem() {
            return currentUserRole === 'admin' || currentUserRole === 'manager' || currentUserRole === 'user';
        }

        function canEditPipelineItem(item) {
            if (currentUserRole === 'admin' || currentUserRole === 'manager') {
                return true;
            }
            if (currentUserRole === 'user') {
                // User hanya bisa edit item yang mereka buat sendiri
                return item.createdBy === currentUser.email;
            }
            return false;
        }

        function canDeletePipelineItem(item) {
            if (currentUserRole === 'admin') {
                return true;
            }
            if (currentUserRole === 'manager') {
                // Manager tidak bisa hapus sama sekali
                return false;
            }
            if (currentUserRole === 'user') {
                // User tidak bisa hapus sama sekali
                return false;
            }
            return false;
        }

        function canDragAndDrop() {
            // Hanya admin dan manager yang bisa drag & drop
            return currentUserRole === 'admin' || currentUserRole === 'manager';
        }

        function canViewPipelineAnalytics() {
            return currentUserRole === 'admin' || currentUserRole === 'manager';
        }

        function canAddPIC() {
            return currentUserRole === 'admin' || currentUserRole === 'manager';
        }

        function canAddCustomer() {
            return currentUserRole === 'admin' || currentUserRole === 'manager';
        }

        function canExportAll() {
            // Admin sales bisa export semua
            return currentUserRole === 'admin' || currentUserRole === 'manager' || currentUserRole === 'adminsales';
        }

        // ==================== ADMIN SALES PERMISSION FUNCTIONS ====================
        function isAdminSales() {
            return currentUserRole === 'adminsales';
        }

        function canViewAllPipelineItems() {
            // Admin sales bisa melihat semua items
            return true;
        }

        function canViewImages() {
            // Admin sales bisa melihat attachment
            return true;
        }

        function canDownloadImages() {
            // Admin sales bisa mendownload gambar
            return true;
        }

        function canExportExcel() {
            // Admin sales bisa export excel
            return true;
        }

        // ==================== FITUR AMBIL GAMBAR - AKSES PENUH UNTUK REGULER USER ====================
        function canTakePicturesForPipeline(pipelineItem) {
            // Admin sales TIDAK bisa mengambil gambar
            if (isAdminSales()) return false;
            
            // Semua user (admin, manager, user) bisa mengambil gambar
            if (!pipelineItem) return false;
            
            // Jika user reguler, hanya bisa untuk pipeline mereka sendiri
            if (currentUserRole === 'user') {
                return pipelineItem.createdBy === currentUser.email;
            }
            
            // Admin dan manager bisa untuk semua pipeline
            return currentUserRole === 'admin' || currentUserRole === 'manager';
        }

        function canAttachImagesToPipeline(pipelineItem) {
            // Admin sales TIDAK bisa melampirkan gambar
            if (isAdminSales()) return false;
            
            // Sama seperti canTakePicturesForPipeline
            return canTakePicturesForPipeline(pipelineItem);
        }

        // ==================== CAMERA FUNCTIONS ====================
        async function startCamera() {
            // Admin sales tidak bisa menggunakan kamera
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk menggunakan kamera', 'warning');
                return;
            }
            
            try {
                const video = document.getElementById('cameraVideo');
                const status = document.getElementById('cameraStatus');
                
                if (!video) {
                    showToast('Camera video element not found', 'error');
                    return;
                }
                
                status.innerHTML = '<i class="fas fa-camera mr-2"></i><span>Memulai kamera...</span>';
                
                // Get camera stream
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                video.srcObject = cameraStream;
                video.classList.remove('hidden');
                
                // Show camera controls
                document.getElementById('startCameraBtn').classList.add('hidden');
                document.getElementById('stopCameraBtn').classList.remove('hidden');
                document.getElementById('captureBtn').classList.remove('hidden');
                
                status.innerHTML = '<i class="fas fa-check-circle mr-2"></i><span>Kamera aktif</span>';
                showToast('Kamera berhasil diaktifkan', 'success');
                
            } catch (error) {
                console.error('Error starting camera:', error);
                showToast('Gagal mengakses kamera: ' + error.message, 'error');
                document.getElementById('cameraStatus').innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i><span>Gagal mengakses kamera</span>';
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            const video = document.getElementById('cameraVideo');
            if (video) {
                video.srcObject = null;
                video.classList.add('hidden');
            }
            
            // Reset camera controls
            document.getElementById('startCameraBtn').classList.remove('hidden');
            document.getElementById('stopCameraBtn').classList.add('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('saveImageBtn').classList.add('hidden');
            
            // Hide captured image
            const capturedImage = document.getElementById('capturedImage');
            if (capturedImage) {
                capturedImage.classList.add('hidden');
                capturedImage.src = '';
            }
            
            document.getElementById('cameraStatus').innerHTML = '<i class="fas fa-camera mr-2"></i><span>Kamera dimatikan</span>';
        }

        function captureImage() {
            // Admin sales tidak bisa mengambil gambar
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk mengambil gambar', 'warning');
                return;
            }
            
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const capturedImage = document.getElementById('capturedImage');
            const status = document.getElementById('cameraStatus');
            
            if (!video || !canvas || !capturedImage) {
                showToast('Camera elements not found', 'error');
                return;
            }
            
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to base64 image
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            capturedImage.src = imageData;
            capturedImage.classList.remove('hidden');
            video.classList.add('hidden');
            
            // Show retake and save buttons
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
            document.getElementById('saveImageBtn').classList.remove('hidden');
            
            status.innerHTML = '<i class="fas fa-check-circle mr-2"></i><span>Gambar berhasil diambil</span>';
        }

        function retakeImage() {
            // Admin sales tidak bisa mengambil gambar
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk mengambil gambar', 'warning');
                return;
            }
            
            const video = document.getElementById('cameraVideo');
            const capturedImage = document.getElementById('capturedImage');
            
            if (video && capturedImage) {
                capturedImage.classList.add('hidden');
                capturedImage.src = '';
                video.classList.remove('hidden');
                
                // Show capture button again
                document.getElementById('captureBtn').classList.remove('hidden');
                document.getElementById('retakeBtn').classList.add('hidden');
                document.getElementById('saveImageBtn').classList.add('hidden');
                
                document.getElementById('cameraStatus').innerHTML = '<i class="fas fa-check-circle mr-2"></i><span>Kamera aktif</span>';
            }
        }

        function saveCapturedImage() {
            // Admin sales tidak bisa menyimpan gambar
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk menyimpan gambar', 'warning');
                return;
            }
            
            const capturedImage = document.getElementById('capturedImage');
            
            if (!capturedImage || !capturedImage.src) {
                showToast('Tidak ada gambar yang diambil', 'warning');
                return;
            }
            
            if (!selectedPipelineItem) {
                showToast('Pilih pipeline item terlebih dahulu', 'warning');
                return;
            }
            
            // Cek apakah user boleh melampirkan gambar ke pipeline ini
            if (!canAttachImagesToPipeline(selectedPipelineItem)) {
                showToast('Anda tidak memiliki izin untuk melampirkan gambar ke pipeline ini', 'warning');
                return;
            }
            
            // Create image object with metadata
            const imageData = {
                id: 'img_' + Date.now(),
                base64: capturedImage.src,
                timestamp: new Date().toISOString(),
                pipelineId: selectedPipelineItem.id,
                pipelineNo: selectedPipelineItem.no,
                pipelineProject: selectedPipelineItem.project,
                takenBy: currentUser.email,
                description: `Gambar untuk ${selectedPipelineItem.project}`
            };
            
            // Add to captured images array
            capturedImages.push(imageData);
            
            // Update UI
            updateCapturedImagesUI();
            
            // Show success message
            showToast('Gambar berhasil disimpan', 'success');
            
            // Reset camera for next capture
            retakeImage();
        }

        function updateCapturedImagesUI() {
            const container = document.getElementById('capturedImagesContainer');
            const imageCount = document.getElementById('imageCountInfo');
            const attachBtn = document.getElementById('attachToPipelineBtn');
            
            if (!container || !imageCount || !attachBtn) return;
            
            container.innerHTML = '';
            
            if (capturedImages.length === 0) {
                container.innerHTML = `
                    <div class="text-center col-span-full py-8 text-gray-500">
                        <i class="fas fa-images text-4xl mb-3"></i>
                        <p>Belum ada gambar yang diambil</p>
                        <p class="text-sm">Gunakan kamera atau upload gambar untuk melampirkan</p>
                    </div>
                `;
                imageCount.textContent = '0 gambar tersedia';
                attachBtn.disabled = true;
            } else {
                capturedImages.forEach((image, index) => {
                    const imageCard = document.createElement('div');
                    imageCard.className = 'image-preview-item';
                    
                    const date = new Date(image.timestamp);
                    const timeString = date.toLocaleTimeString('id-ID', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    imageCard.innerHTML = `
                        <img src="${image.base64}" alt="Captured image ${index + 1}" 
                             onclick="previewImage('${image.id}')">
                        <div class="image-preview-actions">
                            <button class="image-action-btn" onclick="previewImage('${image.id}')" title="Preview">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="image-action-btn" onclick="removeImage('${image.id}')" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded">
                            ${timeString}
                        </div>
                    `;
                    
                    container.appendChild(imageCard);
                });
                
                imageCount.textContent = `${capturedImages.length} gambar tersedia`;
                attachBtn.disabled = false;
            }
        }

        function previewImage(imageId) {
            const image = capturedImages.find(img => img.id === imageId);
            if (!image) return;
            
            const modal = document.getElementById('previewImageModal');
            const previewImage = document.getElementById('previewImage');
            const previewInfo = document.getElementById('previewImageInfo');
            
            if (modal && previewImage && previewInfo) {
                previewImage.src = image.base64;
                previewInfo.textContent = `Pipeline: ${image.pipelineProject} (No. ${image.pipelineNo})`;
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        function removeImage(imageId) {
            // Admin sales tidak bisa menghapus gambar
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk menghapus gambar', 'warning');
                return;
            }
            
            if (!confirm('Hapus gambar ini?')) return;
            
            capturedImages = capturedImages.filter(img => img.id !== imageId);
            updateCapturedImagesUI();
            showToast('Gambar berhasil dihapus', 'success');
        }

        function closePreviewImageModal() {
            document.getElementById('previewImageModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function downloadImage() {
            const previewImage = document.getElementById('previewImage');
            if (!previewImage || !previewImage.src) return;
            
            const link = document.createElement('a');
            link.href = previewImage.src;
            link.download = `pipeline_image_${Date.now()}.jpg`;
            link.click();
            
            showToast('Gambar berhasil didownload', 'success');
        }

        function uploadImage(event) {
            // Admin sales tidak bisa upload gambar
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk upload gambar', 'warning');
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            if (!selectedPipelineItem) {
                showToast('Pilih pipeline item terlebih dahulu', 'warning');
                return;
            }
            
            // Cek apakah user boleh melampirkan gambar ke pipeline ini
            if (!canAttachImagesToPipeline(selectedPipelineItem)) {
                showToast('Anda tidak memiliki izin untuk melampirkan gambar ke pipeline ini', 'warning');
                return;
            }
            
            // Check if file is an image
            if (!file.type.match('image.*')) {
                showToast('File harus berupa gambar', 'error');
                return;
            }
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Ukuran file maksimal 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = {
                    id: 'upload_' + Date.now(),
                    base64: e.target.result,
                    timestamp: new Date().toISOString(),
                    pipelineId: selectedPipelineItem.id,
                    pipelineNo: selectedPipelineItem.no,
                    pipelineProject: selectedPipelineItem.project,
                    takenBy: currentUser.email,
                    description: `Uploaded image for ${selectedPipelineItem.project}`,
                    filename: file.name
                };
                
                capturedImages.push(imageData);
                updateCapturedImagesUI();
                showToast('Gambar berhasil diupload', 'success');
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        async function attachImagesToPipeline() {
            // Admin sales tidak bisa melampirkan gambar
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk melampirkan gambar', 'warning');
                return;
            }
            
            if (!selectedPipelineItem || capturedImages.length === 0) {
                showToast('Tidak ada gambar untuk dilampirkan', 'warning');
                return;
            }
            
            // Cek apakah user boleh melampirkan gambar ke pipeline ini
            if (!canAttachImagesToPipeline(selectedPipelineItem)) {
                showToast('Anda tidak memiliki izin untuk melampirkan gambar ke pipeline ini', 'warning');
                return;
            }
            
            try {
                showLoading();
                
                // Get current pipeline item
                const pipelineRef = pipelinesCollection.doc(selectedPipelineItem.id);
                const pipelineDoc = await pipelineRef.get();
                
                if (!pipelineDoc.exists) {
                    throw new Error('Pipeline item tidak ditemukan');
                }
                
                const pipelineData = pipelineDoc.data();
                const currentImages = pipelineData.images || [];
                
                // Add new images to pipeline
                const newImages = capturedImages.map(img => ({
                    base64: img.base64,
                    timestamp: img.timestamp,
                    takenBy: img.takenBy,
                    description: img.description
                }));
                
                const updatedImages = [...currentImages, ...newImages];
                
                // Update pipeline item with images
                await pipelineRef.update({
                    images: updatedImages,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.email
                });
                
                showToast(`${capturedImages.length} gambar berhasil dilampirkan ke pipeline`, 'success');
                
                // Reset and close modal
                capturedImages = [];
                selectedPipelineItem = null;
                closeTakePictureModal();
                
                // Reload pipeline items to reflect changes
                await loadPipelineItems();
                
            } catch (error) {
                console.error('Error attaching images to pipeline:', error);
                showToast('Gagal melampirkan gambar: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function updatePipelineImagesUI(pipelineItem) {
            const container = document.getElementById('pipelineImagesContainer');
            const noImagesMessage = document.getElementById('noImagesMessage');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!pipelineItem.images || pipelineItem.images.length === 0) {
                if (noImagesMessage) {
                    container.appendChild(noImagesMessage.cloneNode(true));
                }
                return;
            }
            
            // Remove no images message
            if (noImagesMessage) {
                noImagesMessage.classList.add('hidden');
            }
            
            // Create images grid
            const grid = document.createElement('div');
            grid.className = 'image-preview-container';
            
            pipelineItem.images.forEach((image, index) => {
                const imageCard = document.createElement('div');
                imageCard.className = 'image-preview-item';
                
                const date = new Date(image.timestamp);
                const timeString = date.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                imageCard.innerHTML = `
                    <img src="${image.base64}" alt="Pipeline image ${index + 1}" 
                         onclick="previewPipelineImage('${pipelineItem.id}', ${index})">
                    <div class="image-preview-actions">
                        <button class="image-action-btn" onclick="previewPipelineImage('${pipelineItem.id}', ${index})" title="Preview">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${!isAdminSales() ? `
                        <button class="image-action-btn" onclick="removePipelineImage('${pipelineItem.id}', ${index})" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                        <button class="image-action-btn" onclick="downloadPipelineImage('${pipelineItem.id}', ${index})" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <div class="absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded">
                        ${timeString}
                    </div>
                    <div class="absolute bottom-2 left-2 right-2 text-xs text-white truncate">
                        ${image.takenBy || ''}
                    </div>
                `;
                
                grid.appendChild(imageCard);
            });
            
            container.appendChild(grid);
        }

        function previewPipelineImage(pipelineId, imageIndex) {
            const pipeline = pipelineItems.find(p => p.id === pipelineId);
            if (!pipeline || !pipeline.images || !pipeline.images[imageIndex]) return;
            
            const image = pipeline.images[imageIndex];
            openPreviewImageModal(image, `Pipeline: ${pipeline.project} (No. ${pipeline.no})`);
        }

        function downloadPipelineImage(pipelineId, imageIndex) {
            const pipeline = pipelineItems.find(p => p.id === pipelineId);
            if (!pipeline || !pipeline.images || !pipeline.images[imageIndex]) return;
            
            const image = pipeline.images[imageIndex];
            
            const link = document.createElement('a');
            link.href = image.base64;
            link.download = `pipeline_${pipeline.no}_${imageIndex + 1}_${Date.now()}.jpg`;
            link.click();
            
            showToast('Gambar berhasil didownload', 'success');
        }

        async function removePipelineImage(pipelineId, imageIndex) {
            // Admin sales tidak bisa menghapus gambar
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk menghapus gambar dari pipeline ini', 'warning');
                return;
            }
            
            if (!confirm('Hapus gambar ini dari pipeline?')) return;
            
            try {
                const pipeline = pipelineItems.find(p => p.id === pipelineId);
                if (!pipeline || !pipeline.images) return;
                
                // Cek apakah user boleh menghapus gambar
                if (currentUserRole === 'user' && pipeline.createdBy !== currentUser.email) {
                    showToast('Anda tidak memiliki izin untuk menghapus gambar dari pipeline ini', 'warning');
                    return;
                }
                
                // Remove image from array
                const updatedImages = [...pipeline.images];
                updatedImages.splice(imageIndex, 1);
                
                // Update pipeline in Firestore
                await pipelinesCollection.doc(pipelineId).update({
                    images: updatedImages,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.email
                });
                
                showToast('Gambar berhasil dihapus dari pipeline', 'success');
                
                // Reload pipeline items
                await loadPipelineItems();
                
                // Update UI if modal is open
                if (document.getElementById('pipelineItemModal').classList.contains('hidden') === false) {
                    const currentItemId = document.getElementById('pipelineItemId').value;
                    if (currentItemId === pipelineId) {
                        const updatedItem = pipelineItems.find(p => p.id === pipelineId);
                        if (updatedItem) {
                            updatePipelineImagesUI(updatedItem);
                        }
                    }
                }
                
                // Update UI if detail modal is open
                if (document.getElementById('pipelineDetailModal').classList.contains('hidden') === false) {
                    const detailNo = document.getElementById('detailNo').textContent;
                    if (detailNo == pipeline.no) {
                        const updatedItem = pipelineItems.find(p => p.id === pipelineId);
                        if (updatedItem) {
                            updateDetailImagesUI(updatedItem);
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error removing pipeline image:', error);
                showToast('Gagal menghapus gambar', 'error');
            }
        }

        // ==================== TAKE PICTURE MODAL FUNCTIONS ====================
        function openTakePictureModal() {
            // Admin sales tidak bisa membuka modal kamera
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk mengambil gambar', 'warning');
                return;
            }
            
            console.log('Opening take picture modal');
            
            // Reset modal state
            capturedImages = [];
            selectedPipelineItem = null;
            
            // Reset UI
            const pipelineInfo = document.getElementById('selectedPipelineInfo');
            if (pipelineInfo) pipelineInfo.classList.add('hidden');
            
            document.getElementById('searchPipelineForCamera').value = '';
            document.getElementById('attachToPipelineBtn').disabled = true;
            
            // Stop camera if running
            stopCamera();
            
            // Hide suggestions
            hideSuggestions('pipelineSuggestions');
            
            // Clear captured images container
            updateCapturedImagesUI();
            
            // Show modal
            document.getElementById('takePictureModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeTakePictureModal() {
            // Stop camera
            stopCamera();
            
            // Hide modal
            document.getElementById('takePictureModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // ==================== PIPELINE SEARCH FOR CAMERA ====================
        function setupPipelineSearchForCamera() {
            const searchInput = document.getElementById('searchPipelineForCamera');
            const refreshBtn = document.getElementById('refreshPipelineListBtn');
            
            if (searchInput) {
                let searchTimeout;
                
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const searchTerm = this.value.trim();
                    
                    searchTimeout = setTimeout(() => {
                        if (searchTerm.length >= 2) {
                            searchPipelineSuggestionsForCamera(searchTerm);
                        } else {
                            hideSuggestions('pipelineSuggestions');
                        }
                    }, 300);
                });
                
                searchInput.addEventListener('focus', function() {
                    const searchTerm = this.value.trim();
                    if (searchTerm.length >= 2) {
                        searchPipelineSuggestionsForCamera(searchTerm);
                    }
                });
                
                // Enter key to select first suggestion
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const suggestions = document.querySelectorAll('#pipelineSuggestions .autocomplete-suggestion');
                        if (suggestions.length > 0) {
                            suggestions[0].click();
                        }
                    }
                });
            }
            
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    searchPipelineSuggestionsForCamera('');
                    this.querySelector('i').classList.add('fa-spin');
                    setTimeout(() => {
                        this.querySelector('i').classList.remove('fa-spin');
                    }, 500);
                });
            }
            
            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    hideSuggestions('pipelineSuggestions');
                }
            });
        }

        function searchPipelineSuggestionsForCamera(searchTerm) {
            const suggestionsContainer = document.getElementById('pipelineSuggestions');
            if (!suggestionsContainer) return;
            
            const searchTermLower = searchTerm.toLowerCase();
            let filteredPipelines = [...pipelineItems];
            
            // Untuk admin sales, tampilkan semua pipeline
            if (isAdminSales()) {
                // Admin sales bisa melihat semua pipeline
                filteredPipelines = [...pipelineItems];
            }
            // Untuk regular user, hanya tampilkan pipeline yang mereka buat sendiri
            else if (currentUserRole === 'user') {
                filteredPipelines = filteredPipelines.filter(pipeline => 
                    pipeline.createdBy === currentUser.email
                );
            }
            
            if (searchTerm) {
                filteredPipelines = filteredPipelines.filter(pipeline => 
                    (pipeline.project && pipeline.project.toLowerCase().includes(searchTermLower)) ||
                    (pipeline.customer && pipeline.customer.toLowerCase().includes(searchTermLower)) ||
                    (pipeline.quotation && pipeline.quotation.toLowerCase().includes(searchTermLower)) ||
                    (pipeline.pic && pipeline.pic.toLowerCase().includes(searchTermLower))
                );
            }
            
            showPipelineSuggestionsForCamera(suggestionsContainer, filteredPipelines, searchTerm);
        }

        function showPipelineSuggestionsForCamera(container, pipelines, searchTerm) {
            container.innerHTML = '';
            
            if (pipelines.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'autocomplete-no-results';
                noResults.innerHTML = `
                    <div class="autocomplete-no-results-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <p>No pipeline found for "${searchTerm}"</p>
                    ${currentUserRole === 'user' ? '<p class="text-sm">Anda hanya dapat melampirkan gambar ke pipeline yang Anda buat sendiri</p>' : ''}
                `;
                container.appendChild(noResults);
            } else {
                pipelines.forEach(pipeline => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'autocomplete-suggestion';
                    suggestion.dataset.id = pipeline.id;
                    
                    const badgeClass = getPipelineBadgeClass(pipeline.status);
                    const kriteriaBadgeClass = pipeline.kriteria ? getKriteriaBadgeClass(pipeline.kriteria) : '';
                    
                    suggestion.innerHTML = `
                        <div class="autocomplete-suggestion-icon">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium truncate">${pipeline.project}</div>
                            <div class="text-xs text-gray-500 truncate">${pipeline.customer || '-'}</div>
                            <div class="text-xs text-gray-500">${pipeline.quotation || `No. ${pipeline.no}`}</div>
                            ${pipeline.kriteria ? `<div class="text-xs mt-1"><span class="pipeline-badge ${kriteriaBadgeClass} text-xs">${pipeline.kriteria}</span></div>` : ''}
                            ${currentUserRole === 'user' && pipeline.createdBy === currentUser.email ? 
                                '<div class="text-xs text-blue-600 mt-1"><i class="fas fa-user"></i> Milik Anda</div>' : ''}
                            ${isAdminSales() ? 
                                '<div class="text-xs text-indigo-600 mt-1"><i class="fas fa-eye"></i> View Only</div>' : ''}
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="pipeline-badge ${badgeClass} text-xs mb-1">
                                ${pipeline.status}
                            </span>
                            <span class="text-xs text-gray-500">${formatDate(pipeline.date)}</span>
                        </div>
                    `;
                    
                    suggestion.addEventListener('click', function() {
                        selectPipelineForCamera(pipeline.id);
                    });
                    
                    container.appendChild(suggestion);
                });
            }
            
            container.classList.add('show');
        }

        function selectPipelineForCamera(pipelineId) {
            const pipeline = pipelineItems.find(p => p.id === pipelineId);
            if (!pipeline) return;
            
            // Cek apakah user boleh melampirkan gambar ke pipeline ini
            if (!canAttachImagesToPipeline(pipeline)) {
                showToast('Anda tidak memiliki izin untuk melampirkan gambar ke pipeline ini', 'warning');
                return;
            }
            
            selectedPipelineItem = pipeline;
            
            // Update UI
            document.getElementById('searchPipelineForCamera').value = pipeline.project;
            document.getElementById('selectedPipelineTitle').textContent = pipeline.project;
            document.getElementById('selectedPipelineNo').textContent = pipeline.no;
            document.getElementById('selectedPipelineQuotation').textContent = pipeline.quotation || '-';
            document.getElementById('selectedPipelineCustomer').textContent = pipeline.customer || '-';
            document.getElementById('selectedPipelinePIC').textContent = pipeline.pic || '-';
            document.getElementById('selectedPipelineKriteria').textContent = pipeline.kriteria || '-';
            
            const statusBadge = document.getElementById('selectedPipelineStatus');
            statusBadge.className = `pipeline-badge ${getPipelineBadgeClass(pipeline.status)}`;
            statusBadge.textContent = pipeline.status;
            
            document.getElementById('selectedPipelineInfo').classList.remove('hidden');
            hideSuggestions('pipelineSuggestions');
            
            showToast(`Pipeline "${pipeline.project}" dipilih`, 'success');
        }

        // ==================== AUTO-COMPLETE SEARCH FUNCTIONS ====================
        async function setupAutoCompleteSearch() {
            const picInput = document.getElementById('pipelinePIC');
            const customerInput = document.getElementById('pipelineCustomer');
            const addPICBtn = document.getElementById('addPICBtn');
            const addCustomerBtn = document.getElementById('addCustomerBtn');
            
            // Load combined data
            await loadCombinedPICList();
            await loadCombinedCustomerList();
            
            // Setup PIC autocomplete
            if (picInput) {
                let picSearchTimeout;
                
                picInput.addEventListener('input', function() {
                    clearTimeout(picSearchTimeout);
                    const searchTerm = this.value.trim();
                    
                    picSearchTimeout = setTimeout(() => {
                        if (searchTerm.length >= 2) {
                            searchPICSuggestions(searchTerm);
                        } else {
                            hideSuggestions('picSuggestions');
                        }
                    }, 300);
                });
                
                picInput.addEventListener('focus', function() {
                    const searchTerm = this.value.trim();
                    if (searchTerm.length >= 2) {
                        searchPICSuggestions(searchTerm);
                    }
                });
                
                picInput.addEventListener('blur', function() {
                    // Hide suggestions after a short delay
                    setTimeout(() => {
                        hideSuggestions('picSuggestions');
                    }, 200);
                });
                
                // Enter key to select first suggestion
                picInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const suggestions = document.querySelectorAll('#picSuggestions .autocomplete-suggestion');
                        if (suggestions.length > 0) {
                            suggestions[0].click();
                        }
                    }
                });
            }
            
            // Setup Customer autocomplete
            if (customerInput) {
                let customerSearchTimeout;
                
                customerInput.addEventListener('input', function() {
                    clearTimeout(customerSearchTimeout);
                    const searchTerm = this.value.trim();
                    
                    customerSearchTimeout = setTimeout(() => {
                        if (searchTerm.length >= 2) {
                            searchCustomerSuggestions(searchTerm);
                        } else {
                            hideSuggestions('customerSuggestions');
                        }
                    }, 300);
                });
                
                customerInput.addEventListener('focus', function() {
                    const searchTerm = this.value.trim();
                    if (searchTerm.length >= 2) {
                        searchCustomerSuggestions(searchTerm);
                    }
                });
                
                customerInput.addEventListener('blur', function() {
                    // Hide suggestions after a short delay
                    setTimeout(() => {
                        hideSuggestions('customerSuggestions');
                    }, 200);
                });
                
                // Enter key to select first suggestion
                customerInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const suggestions = document.querySelectorAll('#customerSuggestions .autocomplete-suggestion');
                        if (suggestions.length > 0) {
                            suggestions[0].click();
                        }
                    }
                });
            }
            
            // Setup add buttons based on permissions
            if (addPICBtn) {
                if (canAddPIC()) {
                    addPICBtn.classList.remove('hidden');
                    addPICBtn.addEventListener('click', function() {
                        openAddPICModal();
                    });
                } else {
                    addPICBtn.classList.add('hidden');
                }
            }
            
            if (addCustomerBtn) {
                if (canAddCustomer()) {
                    addCustomerBtn.classList.remove('hidden');
                    addCustomerBtn.addEventListener('click', function() {
                        openAddCustomerModal();
                    });
                } else {
                    addCustomerBtn.classList.add('hidden');
                }
            }
            
            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    hideAllSuggestions();
                }
            });
            
            // Close suggestions on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideAllSuggestions();
                }
            });
        }

        async function loadCombinedPICList() {
            try {
                console.log('Loading combined PIC list...');
                
                // Start with static data
                PIC_LIST = PIC_LIST_STATIC.map(name => ({
                    name: name,
                    source: 'static',
                    email: '',
                    phone: '',
                    createdAt: new Date()
                }));
                
                // Load from Firestore
                try {
                    const querySnapshot = await picsCollection.orderBy('name').get();
                    
                    if (!querySnapshot.empty) {
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            const picName = data.name;
                            
                            // Check if already exists in static list
                            const exists = PIC_LIST.some(pic => 
                                pic.name.toLowerCase() === picName.toLowerCase()
                            );
                            
                            if (!exists) {
                                PIC_LIST.push({
                                    name: picName,
                                    source: 'firestore',
                                    email: data.email || '',
                                    phone: data.phone || '',
                                    createdAt: data.createdAt
                                });
                            }
                        });
                    }
                } catch (error) {
                    console.log('No PICs in Firestore or error loading:', error);
                }
                
                // Sort alphabetically
                PIC_LIST.sort((a, b) => a.name.localeCompare(b.name));
                
                console.log('Combined PIC list loaded:', PIC_LIST.length);
                
            } catch (error) {
                console.error('Error loading combined PIC list:', error);
                showToast('Failed to load PIC list', 'error');
            }
        }

        async function loadCombinedCustomerList() {
            try {
                console.log('Loading combined customer list...');
                
                // Start with static data
                CUSTOMER_LIST = CUSTOMER_LIST_STATIC.map(name => ({
                    name: name,
                    source: 'static',
                    address: '',
                    contact: '',
                    createdAt: new Date()
                }));
                
                // Load from Firestore
                try {
                    const querySnapshot = await customersCollection.orderBy('name').get();
                    
                    if (!querySnapshot.empty) {
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            const customerName = data.name;
                            
                            // Check if already exists in static list
                            const exists = CUSTOMER_LIST.some(customer => 
                                customer.name.toLowerCase() === customerName.toLowerCase()
                            );
                            
                            if (!exists) {
                                CUSTOMER_LIST.push({
                                    name: customerName,
                                    source: 'firestore',
                                    address: data.address || '',
                                    contact: data.contact || '',
                                    createdAt: data.createdAt
                                });
                            }
                        });
                    }
                } catch (error) {
                    console.log('No customers in Firestore or error loading:', error);
                }
                
                // Sort alphabetically
                CUSTOMER_LIST.sort((a, b) => a.name.localeCompare(b.name));
                
                console.log('Combined customer list loaded:', CUSTOMER_LIST.length);
                
            } catch (error) {
                console.error('Error loading combined customer list:', error);
                showToast('Failed to load customer list', 'error');
            }
        }

        function searchPICSuggestions(searchTerm) {
            const suggestionsContainer = document.getElementById('picSuggestions');
            if (!suggestionsContainer) return;
            
            const searchTermLower = searchTerm.toLowerCase();
            const filteredPICs = PIC_LIST.filter(pic => 
                pic.name.toLowerCase().includes(searchTermLower)
            );
            
            showSuggestions(suggestionsContainer, filteredPICs, 'pic', searchTerm);
        }

        function searchCustomerSuggestions(searchTerm) {
            const suggestionsContainer = document.getElementById('customerSuggestions');
            if (!suggestionsContainer) return;
            
            const searchTermLower = searchTerm.toLowerCase();
            const filteredCustomers = CUSTOMER_LIST.filter(customer => 
                customer.name.toLowerCase().includes(searchTermLower)
            );
            
            showSuggestions(suggestionsContainer, filteredCustomers, 'customer', searchTerm);
        }

        function showSuggestions(container, items, type, searchTerm) {
            container.innerHTML = '';
            
            if (items.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'autocomplete-no-results';
                noResults.innerHTML = `
                    <div class="autocomplete-no-results-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <p>No ${type} found for "${searchTerm}"</p>
                    ${canAddPIC() && type === 'pic' ? '<p class="text-xs">Click + button to add new</p>' : ''}
                    ${canAddCustomer() && type === 'customer' ? '<p class="text-xs">Click + button to add new</p>' : ''}
                `;
                container.appendChild(noResults);
            } else {
                items.forEach(item => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'autocomplete-suggestion';
                    suggestion.dataset.name = item.name;
                    suggestion.dataset.source = item.source;
                    
                    let sourceBadge = '';
                    if (item.source === 'firestore') {
                        sourceBadge = '<span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded ml-auto">New</span>';
                    }
                    
                    suggestion.innerHTML = `
                        <div class="autocomplete-suggestion-icon">
                            <i class="fas fa-${type === 'pic' ? 'user' : 'building'}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium truncate">${item.name}</div>
                            ${item.email ? `<div class="text-xs text-gray-500 truncate">${item.email}</div>` : ''}
                            ${item.phone ? `<div class="text-xs text-gray-500">${item.phone}</div>` : ''}
                            ${item.address ? `<div class="text-xs text-gray-500 truncate">${item.address}</div>` : ''}
                        </div>
                        ${sourceBadge}
                    `;
                    
                    suggestion.addEventListener('click', function() {
                        const inputField = type === 'pic' ? document.getElementById('pipelinePIC') : document.getElementById('pipelineCustomer');
                        if (inputField) {
                            inputField.value = this.dataset.name;
                        }
                        hideAllSuggestions();
                    });
                    
                    container.appendChild(suggestion);
                });
            }
            
            container.classList.add('show');
        }

        function hideSuggestions(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.classList.remove('show');
            }
        }

        function hideAllSuggestions() {
            hideSuggestions('picSuggestions');
            hideSuggestions('customerSuggestions');
            hideSuggestions('pipelineSuggestions');
        }

        // ==================== CURRENCY INPUT HANDLING ====================
        function setupCurrencyInputs() {
            const quotationInput = document.getElementById('pipelineValueQuotation');
            const poInput = document.getElementById('pipelineValuePO');
            
            if (quotationInput) {
                quotationInput.addEventListener('input', function() {
                    this.value = formatCurrencyInput(this.value);
                });
                
                quotationInput.addEventListener('blur', function() {
                    if (this.value) {
                        this.value = formatCurrencyInput(this.value);
                    }
                });
            }
            
            if (poInput) {
                poInput.addEventListener('input', function() {
                    this.value = formatCurrencyInput(this.value);
                });
                
                poInput.addEventListener('blur', function() {
                    if (this.value) {
                        this.value = formatCurrencyInput(this.value);
                    }
                });
            }
        }

        // ==================== NUMBERING SYSTEM FUNCTIONS ====================
        function getCompanyCode(company) {
            switch(company) {
                case 'Genetek': return 'GI';
                case 'Effrensindo': return 'EFK';
                default: return 'XX';
            }
        }

        function getSOWCode(sow) {
            switch(sow) {
                case 'FAS': return 'FAS';
                case 'Vesda': return 'VESDA';
                case 'FSS': return 'FSS';
                default: return 'GEN';
            }
        }

        function getRomanMonth(month) {
            const romanNumerals = {
                1: 'I', 2: 'II', 3: 'III', 4: 'IV', 5: 'V', 6: 'VI',
                7: 'VII', 8: 'VIII', 9: 'IX', 10: 'X', 11: 'XI', 12: 'XII'
            };
            return romanNumerals[month] || 'I';
        }

        async function getNextQuotationNumber() {
            try {
                // Get the last pipeline item to determine next number
                const querySnapshot = await pipelinesCollection
                    .orderBy('no', 'desc')
                    .limit(1)
                    .get();
                
                let nextNumber = 1;
                
                if (!querySnapshot.empty) {
                    const lastItem = querySnapshot.docs[0].data();
                    nextNumber = (lastItem.no || 0) + 1;
                }
                
                return nextNumber;
                
            } catch (error) {
                console.error('Error getting next quotation number:', error);
                return 1;
            }
        }

        async function generateQuotationNumber(nextNumber, company, sow, date) {
            let month, year;
            
            // If date is provided, use it; otherwise use current date
            if (date) {
                const dateObj = new Date(date);
                month = dateObj.getMonth() + 1;
                year = dateObj.getFullYear();
            } else {
                const now = new Date();
                month = now.getMonth() + 1;
                year = now.getFullYear();
            }
            
            const companyCode = getCompanyCode(company);
            const sowCode = getSOWCode(sow);
            const romanMonth = getRomanMonth(month);
            
            // Format number with leading zeros
            const formattedNumber = nextNumber.toString().padStart(3, '0');
            
            return `${formattedNumber}/${companyCode}/${sowCode}/${romanMonth}/${year}`;
        }

        // ==================== PIPELINE FUNCTIONS ====================
        async function loadPipelineItems() {
            console.log('Loading pipeline items...');
            
            showLoading();
            try {
                const querySnapshot = await pipelinesCollection.orderBy('no', 'desc').get();
                pipelineItems = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    pipelineItems.push({
                        id: doc.id,
                        ...data,
                        // Ensure all fields exist
                        no: data.no || 0,
                        quotation: data.quotation || '',
                        date: data.date || null,
                        company: data.company || '',
                        sow: data.sow || '',
                        category: data.category || '',
                        pic: data.pic || '',
                        customer: data.customer || '',
                        project: data.project || '',
                        status: data.status || 'Open',
                        kriteria: data.kriteria || '', // New field
                        valueQuotation: data.valueQuotation || 0,
                        valuePO: data.valuePO || 0,
                        description: data.description || '',
                        notes: data.notes || '',
                        progress: data.progress || 0,
                        images: data.images || [],
                        updatedAt: data.updatedAt || new Date(),
                        updatedBy: data.updatedBy || '',
                        createdBy: data.createdBy || '',
                        createdAt: data.createdAt || new Date()
                    });
                });

                filteredPipelineItems = [...pipelineItems];
                updatePipelineStats();
                renderPipelineBoard();
                
                console.log('Pipeline items loaded:', pipelineItems.length);
                
            } catch (error) {
                console.error('Error loading pipeline items:', error);
                showToast('Failed to load pipeline items', 'error');
            } finally {
                hideLoading();
            }
        }

        function updatePipelineStats() {
            // Update count badges
            const openCount = pipelineItems.filter(item => item.status === 'Open').length;
            const closeCount = pipelineItems.filter(item => item.status === 'Close').length;
            
            document.getElementById('openCount').textContent = openCount;
            document.getElementById('closeCount').textContent = closeCount;
            document.getElementById('openBadge').textContent = openCount;
            document.getElementById('closeBadge').textContent = closeCount;
        }

        function filterPipelineItems() {
            const searchTerm = document.getElementById('searchPipelineItems').value.toLowerCase();
            const companyFilter = document.getElementById('filterByCompany').value;
            const statusFilter = document.getElementById('filterByStatus').value;
            
            let filtered = [...pipelineItems];
            
            // Untuk admin sales, tampilkan semua items
            if (isAdminSales()) {
                // Admin sales bisa melihat semua items
                filtered = [...pipelineItems];
            }
            // Untuk regular user, hanya tampilkan item yang mereka buat
            else if (currentUserRole === 'user') {
                filtered = filtered.filter(item => item.createdBy === currentUser.email);
            }
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    (item.quotation && item.quotation.toLowerCase().includes(searchTerm)) ||
                    (item.customer && item.customer.toLowerCase().includes(searchTerm)) ||
                    (item.project && item.project.toLowerCase().includes(searchTerm)) ||
                    (item.pic && item.pic.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply company filter
            if (companyFilter) {
                filtered = filtered.filter(item => item.company === companyFilter);
            }
            
            // Apply status filter
            if (statusFilter) {
                filtered = filtered.filter(item => item.status === statusFilter);
            }
            
            filteredPipelineItems = filtered;
            renderPipelineBoard();
        }

        function renderPipelineBoard() {
            // Clear all columns
            pipelineStatuses.forEach(status => {
                const container = document.getElementById(`${status.id.toLowerCase()}Items`);
                if (container) {
                    container.innerHTML = '';
                }
            });
            
            // Add items to respective columns
            filteredPipelineItems.forEach(item => {
                const pipelineItem = createPipelineItemElement(item);
                const container = document.getElementById(`${item.status.toLowerCase()}Items`);
                if (container) {
                    container.appendChild(pipelineItem);
                }
            });
            
            // Update stats
            updatePipelineStats();
        }

        function createPipelineItemElement(item) {
            const div = document.createElement('div');
            
            // Set class berdasarkan role
            if (isAdminSales()) {
                div.className = 'pipeline-item animate-fade-in pipeline-item-view-only';
                div.draggable = false;
            } else {
                div.className = 'pipeline-item animate-fade-in';
                div.draggable = canDragAndDrop();
            }
            
            div.dataset.id = item.id;
            
            const badgeClass = getPipelineBadgeClass(item.status);
            const kriteriaBadgeClass = item.kriteria ? getKriteriaBadgeClass(item.kriteria) : '';
            const timeAgo = formatTimeAgo(item.updatedAt);
            const progress = item.progress || 0;
            const formattedDate = item.date ? formatDate(item.date) : '-';
            const hasImages = item.images && item.images.length > 0;
            
            // Cek apakah user bisa edit item ini
            const canEdit = !isAdminSales() && canEditPipelineItem(item);
            const canDelete = !isAdminSales() && canDeletePipelineItem(item);
            const showEditBtn = canEdit;
            const showDeleteBtn = canDelete;
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-gray-900 text-sm truncate" title="${item.project}">${item.project}</h4>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs font-medium text-gray-600">#${item.no}</span>
                            ${item.quotation ? `<span class="text-xs text-gray-500">${item.quotation}</span>` : ''}
                            ${hasImages ? `<span class="text-xs text-purple-600"><i class="fas fa-camera"></i> ${item.images.length}</span>` : ''}
                            ${item.createdBy && currentUserRole === 'user' ? `<span class="text-xs text-blue-600"><i class="fas fa-user"></i> ${item.createdBy === currentUser.email ? 'Anda' : 'Lain'}</span>` : ''}
                            ${isAdminSales() ? `<span class="text-xs text-indigo-600"><i class="fas fa-eye"></i> View Only</span>` : ''}
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="pipeline-badge ${badgeClass}">
                            ${item.status}
                        </span>
                        ${item.kriteria ? `<span class="pipeline-badge ${kriteriaBadgeClass} text-xs mt-1">${item.kriteria}</span>` : ''}
                        ${item.company ? `<span class="text-xs text-gray-600">${item.company}</span>` : ''}
                        ${item.category ? `<span class="text-xs text-orange-600">${item.category}</span>` : ''}
                    </div>
                </div>
                
                <div class="space-y-2 mb-3">
                    ${item.date ? `
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-purple-100 flex items-center justify-center">
                            <i class="fas fa-calendar text-purple-600 text-xs"></i>
                        </div>
                        <span class="text-xs text-gray-600">${formattedDate}</span>
                    </div>` : ''}
                    
                    ${item.customer ? `
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-building text-blue-600 text-xs"></i>
                        </div>
                        <span class="text-xs text-gray-600 truncate">${item.customer}</span>
                    </div>` : ''}
                    
                    ${item.pic ? `
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center">
                            <i class="fas fa-user text-green-600 text-xs"></i>
                        </div>
                        <span class="text-xs text-gray-600">${item.pic}</span>
                    </div>` : ''}
                    
                    ${item.sow ? `
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-yellow-100 flex items-center justify-center">
                            <i class="fas fa-tag text-yellow-600 text-xs"></i>
                        </div>
                        <span class="text-xs text-gray-600">${item.sow}</span>
                        ${item.category ? `<span class="text-xs text-orange-600 ml-2">(${item.category})</span>` : ''}
                    </div>` : ''}
                </div>
                
                ${item.description ? `<p class="text-xs text-gray-700 mb-3 line-clamp-2">${item.description}</p>` : ''}
                
                <div class="space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="text-center p-2 bg-blue-50 rounded">
                            <div class="text-xs font-medium text-blue-700">Quotation</div>
                            <div class="text-sm font-bold text-blue-900">${formatCurrencyDisplay(item.valueQuotation)}</div>
                        </div>
                        <div class="text-center p-2 bg-green-50 rounded">
                            <div class="text-xs font-medium text-green-700">PO</div>
                            <div class="text-sm font-bold text-green-900">${formatCurrencyDisplay(item.valuePO)}</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500">
                            <i class="far fa-clock mr-1"></i>
                            ${timeAgo}
                        </div>
                        <div class="text-xs font-medium ${progress >= 100 ? 'text-green-600' : 'text-blue-600'}">
                            ${progress}%
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                        <div class="bg-blue-600 h-1.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-2 mt-3 pt-3 border-t border-gray-100">
                    ${isAdminSales() ? `
                    <button class="view-pipeline-detail-btn text-indigo-600 hover:text-indigo-800 text-sm">
                        <i class="fas fa-eye"></i>
                        <span class="ml-1">View Details</span>
                    </button>
                    ` : `
                    <button class="view-pipeline-item-btn text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${showEditBtn ? `
                    <button class="edit-pipeline-item-btn text-green-600 hover:text-green-800 text-sm">
                        <i class="fas fa-edit"></i>
                    </button>` : ''}
                    ${showDeleteBtn ? `
                    <button class="delete-pipeline-item-btn text-red-600 hover:text-red-800 text-sm">
                        <i class="fas fa-trash"></i>
                    </button>` : ''}
                    `}
                </div>
            `;
            
            // Add event listeners
            if (isAdminSales()) {
                const viewDetailBtn = div.querySelector('.view-pipeline-detail-btn');
                if (viewDetailBtn) {
                    viewDetailBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openPipelineDetailModal(item.id);
                    });
                }
            } else {
                const viewBtn = div.querySelector('.view-pipeline-item-btn');
                const editBtn = div.querySelector('.edit-pipeline-item-btn');
                const deleteBtn = div.querySelector('.delete-pipeline-item-btn');
                
                if (viewBtn) {
                    viewBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (isAdminSales()) {
                            openPipelineDetailModal(item.id);
                        } else {
                            openPipelineItemDetail(item.id);
                        }
                    });
                }
                
                if (editBtn) {
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (canEdit) {
                            openPipelineItemModal(item.id);
                        } else {
                            showToast('Anda tidak memiliki izin untuk mengedit item ini', 'warning');
                        }
                    });
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (canDelete) {
                            deletePipelineItem(item.id);
                        } else {
                            showToast('Anda tidak memiliki izin untuk menghapus item ini', 'warning');
                        }
                    });
                }
            }
            
            // Drag and drop events hanya untuk yang memiliki izin
            if (canDragAndDrop()) {
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragend', handleDragEnd);
            }
            
            if (isAdminSales()) {
                div.addEventListener('click', () => {
                    openPipelineDetailModal(item.id);
                });
            } else {
                div.addEventListener('click', () => {
                    openPipelineItemDetail(item.id);
                });
            }
            
            return div;
        }

        function getPipelineBadgeClass(status) {
            switch(status) {
                case 'Open': return 'pipeline-open-badge';
                case 'Close': return 'pipeline-close-badge';
                default: return 'pipeline-open-badge';
            }
        }

        // ==================== DRAG AND DROP FUNCTIONS ====================
        function handleDragStart(e) {
            if (!canDragAndDrop()) {
                e.preventDefault();
                return;
            }
            
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.id);
        }

        function handleDragEnd(e) {
            if (!canDragAndDrop()) return;
            
            this.classList.remove('dragging');
            draggedItem = null;
            
            // Remove overlay class from all columns
            document.querySelectorAll('.pipeline-column').forEach(col => {
                col.classList.remove('pipeline-item-over');
            });
        }

        function setupDragAndDrop() {
            const columns = document.querySelectorAll('.pipeline-column');
            
            columns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    if (!canDragAndDrop()) {
                        e.preventDefault();
                        return;
                    }
                    
                    e.preventDefault();
                    column.classList.add('pipeline-item-over');
                });
                
                column.addEventListener('dragleave', () => {
                    if (!canDragAndDrop()) return;
                    column.classList.remove('pipeline-item-over');
                });
                
                column.addEventListener('drop', async (e) => {
                    if (!canDragAndDrop()) {
                        e.preventDefault();
                        return;
                    }
                    
                    e.preventDefault();
                    column.classList.remove('pipeline-item-over');
                    
                    if (draggedItem) {
                        const itemId = draggedItem.dataset.id;
                        const newStatus = column.dataset.status;
                        
                        try {
                            await updatePipelineItemStatus(itemId, newStatus);
                        } catch (error) {
                            console.error('Error updating pipeline item status:', error);
                            showToast('Failed to move item', 'error');
                        }
                    }
                });
            });
        }

        // ==================== PIPELINE ITEM MANAGEMENT ====================
        async function updatePipelineItemStatus(itemId, newStatus) {
            try {
                showLoading();
                
                const item = pipelineItems.find(i => i.id === itemId);
                if (!item) {
                    throw new Error('Item not found');
                }
                
                const oldStatus = item.status;
                
                // Update in Firebase
                await pipelinesCollection.doc(itemId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.email
                });
                
                // Log status change
                await logPipelineStatusChange(itemId, item.project, oldStatus, newStatus);
                
                // Reload items
                await loadPipelineItems();
                
                showToast(`Moved to ${newStatus}`, 'success');
                
            } catch (error) {
                console.error('Error updating pipeline item status:', error);
                showToast('Failed to move item', 'error');
            } finally {
                hideLoading();
            }
        }

        async function logPipelineStatusChange(itemId, title, oldStatus, newStatus) {
            try {
                if (!currentUser) return;
                
                const historyData = {
                    pipelineItemId: itemId,
                    pipelineItemTitle: title,
                    oldStatus: oldStatus,
                    newStatus: newStatus,
                    changedBy: currentUser.email,
                    userRole: currentUserRole,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await pipelineHistoryCollection.add(historyData);
                
            } catch (error) {
                console.error('Error logging pipeline status change:', error);
            }
        }

        // ==================== MODAL FUNCTIONS ====================
        async function createNewPipelineItem() {
            // Admin sales tidak bisa membuat item baru
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk membuat pipeline item', 'warning');
                return;
            }
            
            console.log('Creating new pipeline item');
            
            if (!canCreatePipelineItem()) {
                showToast('You do not have permission to create pipeline items', 'warning');
                return;
            }
            
            openPipelineItemModal();
        }

        async function openPipelineItemModal(itemId = null) {
            // Admin sales tidak bisa membuka modal edit/create
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk mengedit pipeline item', 'warning');
                return;
            }
            
            console.log('Opening pipeline item modal:', itemId ? 'edit' : 'create');
            
            const modal = document.getElementById('pipelineItemModal');
            const modalTitle = document.getElementById('pipelineModalTitle');
            
            // Reset form
            document.getElementById('pipelineItemForm').reset();
            document.getElementById('pipelineItemId').value = '';
            document.getElementById('originalPipelineStatus').value = '';
            document.getElementById('progressValue').textContent = '0%';
            hideAllSuggestions();
            
            // Reset all fields
            document.getElementById('pipelineNo').value = '';
            document.getElementById('pipelineQuotation').value = '';
            document.getElementById('pipelineDate').value = '';
            document.getElementById('pipelineCompany').value = '';
            document.getElementById('pipelineSOW').value = '';
            document.getElementById('pipelineCategory').value = '';
            document.getElementById('pipelinePIC').value = '';
            document.getElementById('pipelineCustomer').value = '';
            document.getElementById('pipelineProject').value = '';
            document.getElementById('pipelineStatus').value = 'Open';
            document.getElementById('pipelineKriteria').value = '';
            document.getElementById('pipelineValueQuotation').value = '';
            document.getElementById('pipelineValuePO').value = '';
            document.getElementById('pipelineDescription').value = '';
            document.getElementById('pipelineNotes').value = '';
            document.getElementById('pipelineProgress').value = 0;
            document.getElementById('pipelineProgress').disabled = false;
            
            // Update category options based on SOW
            updateCategoryOptions();
            
            // Reset images container
            const imagesContainer = document.getElementById('pipelineImagesContainer');
            const noImagesMessage = document.getElementById('noImagesMessage');
            if (imagesContainer && noImagesMessage) {
                imagesContainer.innerHTML = '';
                imagesContainer.appendChild(noImagesMessage.cloneNode(true));
            }
            
            if (itemId && !canEditPipelineItem(pipelineItems.find(i => i.id === itemId))) {
                showToast('You do not have permission to edit pipeline items', 'warning');
                return;
            }
            
            if (itemId) {
                modalTitle.textContent = 'Edit Pipeline Item';
                const item = pipelineItems.find(i => i.id === itemId);
                if (item) {
                    populatePipelineModalForm(item);
                    document.getElementById('originalPipelineStatus').value = item.status;
                    
                    // Update images UI
                    updatePipelineImagesUI(item);
                }
            } else {
                modalTitle.textContent = 'New Pipeline Item';
                document.getElementById('pipelineStatus').value = 'Open';
                document.getElementById('pipelineProgress').value = 0;
                
                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('pipelineDate').value = today;
                
                // Generate new number for new item
                try {
                    const nextNumber = await getNextQuotationNumber();
                    document.getElementById('pipelineNo').value = nextNumber;
                    
                    // Generate quotation number preview
                    const company = document.getElementById('pipelineCompany').value;
                    const sow = document.getElementById('pipelineSOW').value;
                    const date = document.getElementById('pipelineDate').value;
                    
                    if (company && sow && date) {
                        const quotationNumber = await generateQuotationNumber(nextNumber, company, sow, date);
                        document.getElementById('pipelineQuotation').value = quotationNumber;
                    }
                } catch (error) {
                    console.error('Error generating quotation number:', error);
                }
            }
            
            // Setup progress slider
            const progressSlider = document.getElementById('pipelineProgress');
            const progressValue = document.getElementById('progressValue');
            
            if (progressSlider && progressValue) {
                // Remove existing event listener
                const newSlider = progressSlider.cloneNode(true);
                progressSlider.parentNode.replaceChild(newSlider, progressSlider);
                
                // Add new event listener
                newSlider.addEventListener('input', function() {
                    progressValue.textContent = `${this.value}%`;
                });
            }
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        async function populatePipelineModalForm(item) {
            document.getElementById('pipelineItemId').value = item.id;
            document.getElementById('pipelineNo').value = item.no || '';
            document.getElementById('pipelineQuotation').value = item.quotation || '';
            
            // Format date for input field
            let dateValue = '';
            if (item.date) {
                if (item.date.toDate) {
                    const dateObj = item.date.toDate();
                    dateValue = dateObj.toISOString().split('T')[0];
                } else if (item.date instanceof Date) {
                    dateValue = item.date.toISOString().split('T')[0];
                } else if (typeof item.date === 'string') {
                    dateValue = item.date.split('T')[0];
                }
            }
            document.getElementById('pipelineDate').value = dateValue;
            
            document.getElementById('pipelineCompany').value = item.company || '';
            document.getElementById('pipelineSOW').value = item.sow || '';
            document.getElementById('pipelineCategory').value = item.category || '';
            document.getElementById('pipelinePIC').value = item.pic || '';
            document.getElementById('pipelineCustomer').value = item.customer || '';
            document.getElementById('pipelineProject').value = item.project || '';
            document.getElementById('pipelineStatus').value = item.status || 'Open';
            document.getElementById('pipelineKriteria').value = item.kriteria || '';
            document.getElementById('pipelineValueQuotation').value = item.valueQuotation ? formatCurrency(item.valueQuotation) : '';
            document.getElementById('pipelineValuePO').value = item.valuePO ? formatCurrency(item.valuePO) : '';
            document.getElementById('pipelineDescription').value = item.description || '';
            document.getElementById('pipelineNotes').value = item.notes || '';
            document.getElementById('pipelineProgress').value = item.progress || 0;
            document.getElementById('progressValue').textContent = `${item.progress || 0}%`;
            
            // Disable progress if kriteria is Win or Lose
            if (item.kriteria === 'Win' || item.kriteria === 'Lose') {
                document.getElementById('pipelineProgress').disabled = true;
            } else {
                document.getElementById('pipelineProgress').disabled = false;
            }
        }

        function closePipelineItemModal() {
            hideAllSuggestions();
            document.getElementById('pipelineItemModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function savePipelineItem() {
            // Admin sales tidak bisa menyimpan item
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk menyimpan pipeline item', 'warning');
                return;
            }
            
            const form = document.getElementById('pipelineItemForm');
            if (!form.checkValidity()) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            const itemId = document.getElementById('pipelineItemId').value;
            const originalStatus = document.getElementById('originalPipelineStatus').value;
            const isEdit = !!itemId;
            
            const company = document.getElementById('pipelineCompany').value;
            const sow = document.getElementById('pipelineSOW').value;
            const category = document.getElementById('pipelineCategory').value;
            const date = document.getElementById('pipelineDate').value;
            const kriteria = document.getElementById('pipelineKriteria').value;
            
            if (!kriteria) {
                showToast('Please select Kriteria', 'warning');
                return;
            }
            
            let no = parseInt(document.getElementById('pipelineNo').value) || 0;
            
            // Generate quotation number if creating new item
            let quotationNumber = document.getElementById('pipelineQuotation').value.trim();
            
            if (!isEdit && company && sow && date && no > 0) {
                // For new items, generate the quotation number
                quotationNumber = await generateQuotationNumber(no, company, sow, date);
            } else if (isEdit && company && sow && date && no > 0) {
                // For editing items, regenerate quotation number if date, company, or SOW changed
                const item = pipelineItems.find(i => i.id === itemId);
                if (item) {
                    // Check if date, company, or SOW changed
                    const oldDate = item.date ? (item.date.toDate ? item.date.toDate().toISOString().split('T')[0] : item.date.split('T')[0]) : '';
                    const oldCompany = item.company || '';
                    const oldSOW = item.sow || '';
                    
                    if (date !== oldDate || company !== oldCompany || sow !== oldSOW) {
                        quotationNumber = await generateQuotationNumber(no, company, sow, date);
                    }
                }
            }
            
            // Get progress - either from slider or from kriteria mapping
            let progress = parseInt(document.getElementById('pipelineProgress').value) || 0;
            
            // If kriteria is Win or Lose, ensure progress is 100%
            if (kriteria === 'Win' || kriteria === 'Lose') {
                progress = 100;
            } else if (kriteria === 'Follow Up' && progress < 50) {
                // For Follow Up, if progress is less than 50, set to 50 (minimum)
                progress = 50;
            }
            
            const pipelineData = {
                no: no,
                quotation: quotationNumber,
                date: new Date(date),
                company: company,
                sow: sow,
                category: category,
                pic: document.getElementById('pipelinePIC').value.trim(),
                customer: document.getElementById('pipelineCustomer').value.trim(),
                project: document.getElementById('pipelineProject').value.trim(),
                status: document.getElementById('pipelineStatus').value,
                kriteria: kriteria,
                valueQuotation: parseCurrency(document.getElementById('pipelineValueQuotation').value),
                valuePO: parseCurrency(document.getElementById('pipelineValuePO').value),
                description: document.getElementById('pipelineDescription').value.trim() || '',
                notes: document.getElementById('pipelineNotes').value.trim() || '',
                progress: progress,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser.email
            };
            
            try {
                showLoading();
                
                if (isEdit) {
                    await pipelinesCollection.doc(itemId).update(pipelineData);
                    
                    const newStatus = pipelineData.status;
                    if (originalStatus !== newStatus) {
                        await logPipelineStatusChange(itemId, pipelineData.project, originalStatus, newStatus);
                    }
                    
                    showToast('Pipeline item updated successfully', 'success');
                } else {
                    pipelineData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    pipelineData.createdBy = currentUser.email;
                    const result = await pipelinesCollection.add(pipelineData);
                    
                    await logPipelineStatusChange(result.id, pipelineData.project, 'New', pipelineData.status);
                    
                    showToast('Pipeline item created successfully', 'success');
                }
                
                await loadPipelineItems();
                closePipelineItemModal();
                
            } catch (error) {
                console.error('Error saving pipeline item:', error);
                showToast('Failed to save pipeline item', 'error');
            } finally {
                hideLoading();
            }
        }

        function openPipelineItemDetail(itemId) {
            // Admin sales buka detail modal, bukan edit
            if (isAdminSales()) {
                openPipelineDetailModal(itemId);
                return;
            }
            
            console.log('Opening pipeline item detail:', itemId);
            
            // For now, we'll just open the edit modal
            // In a complete implementation, you might want a separate detail modal
            const item = pipelineItems.find(i => i.id === itemId);
            if (item && canEditPipelineItem(item)) {
                openPipelineItemModal(itemId);
            } else {
                showToast('Anda tidak memiliki izin untuk mengedit item ini', 'warning');
            }
        }

        async function deletePipelineItem(itemId) {
            // Admin sales tidak bisa hapus
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk menghapus item ini', 'warning');
                return;
            }
            
            if (!canDeletePipelineItem(pipelineItems.find(i => i.id === itemId))) {
                showToast('Anda tidak memiliki izin untuk menghapus item ini', 'warning');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this pipeline item?')) return;
            
            try {
                showLoading();
                await pipelinesCollection.doc(itemId).delete();
                showToast('Pipeline item deleted successfully', 'success');
                await loadPipelineItems();
            } catch (error) {
                console.error('Error deleting pipeline item:', error);
                showToast('Failed to delete pipeline item', 'error');
            } finally {
                hideLoading();
            }
        }

        // ==================== DETAIL MODAL FUNCTIONS ====================
        function openPipelineDetailModal(itemId) {
            console.log('Opening pipeline detail modal:', itemId);
            
            const item = pipelineItems.find(i => i.id === itemId);
            if (!item) {
                showToast('Pipeline item not found', 'error');
                return;
            }
            
            populateDetailModal(item);
            
            document.getElementById('pipelineDetailModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function populateDetailModal(item) {
            // Basic info
            document.getElementById('detailNo').textContent = item.no || '-';
            document.getElementById('detailQuotation').textContent = item.quotation || '-';
            document.getElementById('detailDate').textContent = item.date ? formatDate(item.date) : '-';
            document.getElementById('detailCompany').textContent = item.company || '-';
            document.getElementById('detailSOW').textContent = item.sow || '-';
            document.getElementById('detailCategory').textContent = item.category || '-';
            
            // PIC & Customer
            document.getElementById('detailPIC').textContent = item.pic || '-';
            document.getElementById('detailCustomer').textContent = item.customer || '-';
            
            // Project & Status
            document.getElementById('detailProject').textContent = item.project || '-';
            document.getElementById('detailStatus').textContent = item.status || '-';
            document.getElementById('detailKriteria').textContent = item.kriteria || '-';
            document.getElementById('detailProgress').textContent = `${item.progress || 0}%`;
            
            // Financial
            document.getElementById('detailValueQuotation').textContent = formatCurrencyDisplay(item.valueQuotation);
            document.getElementById('detailValuePO').textContent = formatCurrencyDisplay(item.valuePO);
            
            // Description & Notes
            document.getElementById('detailDescription').textContent = item.description || '-';
            document.getElementById('detailNotes').textContent = item.notes || '-';
            
            // Metadata
            document.getElementById('detailCreatedBy').textContent = item.createdBy || '-';
            document.getElementById('detailCreatedAt').textContent = item.createdAt ? formatDateTime(item.createdAt) : '-';
            document.getElementById('detailUpdatedBy').textContent = item.updatedBy || '-';
            document.getElementById('detailUpdatedAt').textContent = item.updatedAt ? formatDateTime(item.updatedAt) : '-';
            
            // Status badges
            const statusBadge = document.getElementById('detailStatusBadge');
            statusBadge.className = `pipeline-badge ${getPipelineBadgeClass(item.status)}`;
            statusBadge.textContent = item.status;
            
            const kriteriaBadge = document.getElementById('detailKriteriaBadge');
            if (item.kriteria) {
                kriteriaBadge.className = `pipeline-badge ${getKriteriaBadgeClass(item.kriteria)}`;
                kriteriaBadge.textContent = item.kriteria;
                kriteriaBadge.classList.remove('hidden');
            } else {
                kriteriaBadge.classList.add('hidden');
            }
            
            // Images
            updateDetailImagesUI(item);
        }

        function updateDetailImagesUI(item) {
            const container = document.getElementById('detailImagesContainer');
            const noImagesMessage = document.getElementById('detailNoImagesMessage');
            const imagesCount = document.getElementById('detailImagesCount');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!item.images || item.images.length === 0) {
                if (noImagesMessage) {
                    container.appendChild(noImagesMessage.cloneNode(true));
                }
                imagesCount.textContent = '0 images';
                return;
            }
            
            imagesCount.textContent = `${item.images.length} image${item.images.length > 1 ? 's' : ''}`;
            
            // Create images grid
            const grid = document.createElement('div');
            grid.className = 'image-preview-container';
            
            item.images.forEach((image, index) => {
                const imageCard = document.createElement('div');
                imageCard.className = 'image-preview-item';
                
                const date = new Date(image.timestamp);
                const timeString = date.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const dateString = formatDate(image.timestamp);
                
                imageCard.innerHTML = `
                    <img src="${image.base64}" alt="Pipeline image ${index + 1}" 
                         onclick="previewImageFromDetail('${item.id}', ${index})">
                    <div class="image-preview-actions">
                        <button class="image-action-btn" onclick="previewImageFromDetail('${item.id}', ${index})" title="Preview">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="image-action-btn" onclick="downloadImageFromDetail('${item.id}', ${index})" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <div class="image-timestamp" title="${dateString} ${timeString}">
                        <i class="far fa-clock mr-1"></i>${timeString}
                    </div>
                `;
                
                grid.appendChild(imageCard);
            });
            
            container.appendChild(grid);
        }

        function closePipelineDetailModal() {
            document.getElementById('pipelineDetailModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function previewImageFromDetail(pipelineId, imageIndex) {
            const pipeline = pipelineItems.find(p => p.id === pipelineId);
            if (!pipeline || !pipeline.images || !pipeline.images[imageIndex]) return;
            
            const image = pipeline.images[imageIndex];
            openPreviewImageModal(image, `Pipeline: ${pipeline.project} (No. ${pipeline.no})`);
        }

        function downloadImageFromDetail(pipelineId, imageIndex) {
            const pipeline = pipelineItems.find(p => p.id === pipelineId);
            if (!pipeline || !pipeline.images || !pipeline.images[imageIndex]) return;
            
            const image = pipeline.images[imageIndex];
            
            const link = document.createElement('a');
            link.href = image.base64;
            link.download = `pipeline_${pipeline.no}_${imageIndex + 1}_${Date.now()}.jpg`;
            link.click();
            
            showToast('Gambar berhasil didownload', 'success');
        }

        // ==================== ADD PIC MODAL FUNCTIONS ====================
        function openAddPICModal() {
            // Admin sales tidak bisa menambah PIC
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk menambah PIC', 'warning');
                return;
            }
            
            if (!canAddPIC()) {
                showToast('Anda tidak memiliki izin untuk menambah PIC', 'warning');
                return;
            }
            
            document.getElementById('addPICForm').reset();
            document.getElementById('addPICModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeAddPICModal() {
            document.getElementById('addPICModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function saveNewPIC() {
            // Admin sales tidak bisa menyimpan PIC
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk menambah PIC', 'warning');
                return;
            }
            
            if (!canAddPIC()) {
                showToast('Anda tidak memiliki izin untuk menambah PIC', 'warning');
                return;
            }
            
            const form = document.getElementById('addPICForm');
            if (!form.checkValidity()) {
                showToast('Please fill in PIC name', 'warning');
                return;
            }
            
            const picData = {
                name: document.getElementById('newPICName').value.trim(),
                email: document.getElementById('newPICEmail').value.trim() || '',
                phone: document.getElementById('newPICPhone').value.trim() || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.email
            };
            
            try {
                showLoading();
                
                // Check if PIC already exists in static list
                const existsInStatic = PIC_LIST_STATIC.some(pic => 
                    pic.toLowerCase() === picData.name.toLowerCase()
                );
                
                if (existsInStatic) {
                    showToast('PIC already exists in default list', 'warning');
                    return;
                }
                
                // Check if PIC already exists in Firestore
                const existingPIC = await picsCollection
                    .where('name', '==', picData.name)
                    .get();
                
                if (!existingPIC.empty) {
                    showToast('PIC already exists in database', 'warning');
                    return;
                }
                
                // Add new PIC to Firestore
                await picsCollection.add(picData);
                
                // Add to combined list
                PIC_LIST.push({
                    name: picData.name,
                    source: 'firestore',
                    email: picData.email,
                    phone: picData.phone,
                    createdAt: picData.createdAt
                });
                
                // Sort alphabetically
                PIC_LIST.sort((a, b) => a.name.localeCompare(b.name));
                
                showToast('PIC added successfully', 'success');
                
                // Set the new PIC as selected
                document.getElementById('pipelinePIC').value = picData.name;
                
                closeAddPICModal();
                
            } catch (error) {
                console.error('Error adding new PIC:', error);
                showToast('Failed to add PIC', 'error');
            } finally {
                hideLoading();
            }
        }

        // ==================== ADD CUSTOMER MODAL FUNCTIONS ====================
        function openAddCustomerModal() {
            // Admin sales tidak bisa menambah customer
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk menambah customer', 'warning');
                return;
            }
            
            if (!canAddCustomer()) {
                showToast('Anda tidak memiliki izin untuk menambah customer', 'warning');
                return;
            }
            
            document.getElementById('addCustomerForm').reset();
            document.getElementById('addCustomerModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function saveNewCustomer() {
            // Admin sales tidak bisa menyimpan customer
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk menambah customer', 'warning');
                return;
            }
            
            if (!canAddCustomer()) {
                showToast('Anda tidak memiliki izin untuk menambah customer', 'warning');
                return;
            }
            
            const form = document.getElementById('addCustomerForm');
            if (!form.checkValidity()) {
                showToast('Please fill in customer name', 'warning');
                return;
            }
            
            const customerData = {
                name: document.getElementById('newCustomerName').value.trim(),
                address: document.getElementById('newCustomerAddress').value.trim() || '',
                contact: document.getElementById('newCustomerContact').value.trim() || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.email
            };
            
            try {
                showLoading();
                
                // Check if customer already exists in static list
                const existsInStatic = CUSTOMER_LIST_STATIC.some(customer => 
                    customer.toLowerCase() === customerData.name.toLowerCase()
                );
                
                if (existsInStatic) {
                    showToast('Customer already exists in default list', 'warning');
                    return;
                }
                
                // Check if customer already exists in Firestore
                const existingCustomer = await customersCollection
                    .where('name', '==', customerData.name)
                    .get();
                
                if (!existingCustomer.empty) {
                    showToast('Customer already exists in database', 'warning');
                    return;
                }
                
                // Add new customer to Firestore
                await customersCollection.add(customerData);
                
                // Add to combined list
                CUSTOMER_LIST.push({
                    name: customerData.name,
                    source: 'firestore',
                    address: customerData.address,
                    contact: customerData.contact,
                    createdAt: customerData.createdAt
                });
                
                // Sort alphabetically
                CUSTOMER_LIST.sort((a, b) => a.name.localeCompare(b.name));
                
                showToast('Customer added successfully', 'success');
                
                // Set the new customer as selected
                document.getElementById('pipelineCustomer').value = customerData.name;
                
                closeAddCustomerModal();
                
            } catch (error) {
                console.error('Error adding new customer:', error);
                showToast('Failed to add customer', 'error');
            } finally {
                hideLoading();
            }
        }

        // ==================== EXPORT TO EXCEL FUNCTIONS ====================
        function openExportOptionsModal() {
            console.log('Opening export options modal');
            
            if (pipelineItems.length === 0) {
                showToast('No pipeline items to export', 'warning');
                return;
            }
            
            // Reset form
            document.querySelectorAll('input[name="exportScope"]')[0].checked = true;
            document.querySelectorAll('input[name="exportFormat"]')[0].checked = true;
            document.getElementById('exportOpen').checked = true;
            document.getElementById('exportClose').checked = true;
            document.getElementById('includeTimestamp').checked = true;
            document.getElementById('includeFilters').checked = true;
            
            // Untuk admin sales, semua opsi export bisa digunakan
            if (isAdminSales()) {
                // Admin sales bisa semua opsi export
                document.querySelectorAll('input[name="exportScope"]').forEach(input => {
                    input.disabled = false;
                });
                document.getElementById('includeFilters').disabled = false;
            }
            // Untuk regular user, batasi opsi export
            else if (currentUserRole === 'user') {
                const allScopeOption = document.querySelector('input[value="all"]');
                const statusScopeOption = document.querySelector('input[value="status"]');
                const includeFiltersCheckbox = document.getElementById('includeFilters');
                
                if (allScopeOption) allScopeOption.disabled = true;
                if (statusScopeOption) statusScopeOption.disabled = true;
                if (includeFiltersCheckbox) includeFiltersCheckbox.disabled = true;
                
                // Otomatis pilih filtered items only
                const filteredOption = document.querySelector('input[value="filtered"]');
                if (filteredOption) filteredOption.checked = true;
            } else {
                // Enable all options for admin/manager
                document.querySelectorAll('input[name="exportScope"]').forEach(input => {
                    input.disabled = false;
                });
                document.getElementById('includeFilters').disabled = false;
            }
            
            // Update item count
            updateExportItemCount();
            
            document.getElementById('exportOptionsModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeExportOptionsModal() {
            document.getElementById('exportOptionsModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function updateExportItemCount() {
            const exportScope = document.querySelector('input[name="exportScope"]:checked')?.value || 'all';
            const exportOpen = document.getElementById('exportOpen').checked;
            const exportClose = document.getElementById('exportClose').checked;
            
            let count = 0;
            let items = [];
            
            // Untuk admin sales, hitung semua items
            if (isAdminSales()) {
                items = pipelineItems;
            }
            // Untuk regular user, hanya hitung item milik sendiri
            else if (currentUserRole === 'user') {
                items = pipelineItems.filter(item => item.createdBy === currentUser.email);
            } else {
                items = pipelineItems;
            }
            
            if (exportScope === 'all') {
                count = items.length;
            } else if (exportScope === 'filtered') {
                // Untuk admin sales, filtered sudah otomatis semua items
                if (isAdminSales()) {
                    count = filteredPipelineItems.length;
                }
                // Untuk regular user, filtered sudah otomatis hanya item milik sendiri
                else if (currentUserRole === 'user') {
                    count = items.length;
                } else {
                    count = filteredPipelineItems.length;
                }
            } else if (exportScope === 'status') {
                if (exportOpen) {
                    count += items.filter(item => item.status === 'Open').length;
                }
                if (exportClose) {
                    count += items.filter(item => item.status === 'Close').length;
                }
            }
            
            document.getElementById('exportItemCount').textContent = `${count} items will be exported`;
        }

        async function exportToExcel() {
            console.log('Exporting to Excel...');
            
            try {
                showLoading();
                
                const exportScope = document.querySelector('input[name="exportScope"]:checked')?.value || 'all';
                const exportFormat = document.querySelector('input[name="exportFormat"]:checked')?.value || 'detailed';
                const exportOpen = document.getElementById('exportOpen').checked;
                const exportClose = document.getElementById('exportClose').checked;
                const includeTimestamp = document.getElementById('includeTimestamp').checked;
                const includeFilters = document.getElementById('includeFilters').checked;
                
                // Get items to export
                let itemsToExport = [];
                
                // Untuk admin sales, bisa export semua items
                if (isAdminSales()) {
                    if (exportScope === 'all') {
                        itemsToExport = [...pipelineItems];
                    } else if (exportScope === 'filtered') {
                        itemsToExport = [...filteredPipelineItems];
                    } else if (exportScope === 'status') {
                        itemsToExport = pipelineItems.filter(item => {
                            if (exportOpen && item.status === 'Open') return true;
                            if (exportClose && item.status === 'Close') return true;
                            return false;
                        });
                    }
                }
                // Untuk user biasa
                else if (currentUserRole === 'user') {
                    const userItems = pipelineItems.filter(item => item.createdBy === currentUser.email);
                    
                    if (exportScope === 'all' || exportScope === 'filtered') {
                        itemsToExport = [...userItems];
                    } else if (exportScope === 'status') {
                        itemsToExport = userItems.filter(item => {
                            if (exportOpen && item.status === 'Open') return true;
                            if (exportClose && item.status === 'Close') return true;
                            return false;
                        });
                    }
                } else {
                    if (exportScope === 'all') {
                        itemsToExport = [...pipelineItems];
                    } else if (exportScope === 'filtered') {
                        itemsToExport = [...filteredPipelineItems];
                    } else if (exportScope === 'status') {
                        itemsToExport = pipelineItems.filter(item => {
                            if (exportOpen && item.status === 'Open') return true;
                            if (exportClose && item.status === 'Close') return true;
                            return false;
                        });
                    }
                }
                
                if (itemsToExport.length === 0) {
                    showToast('No items to export', 'warning');
                    closeExportOptionsModal();
                    return;
                }
                
                // Sort items by number
                itemsToExport.sort((a, b) => a.no - b.no);
                
                // Prepare data for Excel
                const worksheetData = prepareExcelData(itemsToExport, exportFormat, includeFilters);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                
                // Set column widths
                const colWidths = exportFormat === 'detailed' 
                    ? [
                        { wch: 8 },  // No
                        { wch: 25 }, // Quotation
                        { wch: 15 }, // Date
                        { wch: 15 }, // Company
                        { wch: 10 }, // SOW
                        { wch: 15 }, // Category
                        { wch: 20 }, // PIC
                        { wch: 35 }, // Customer
                        { wch: 30 }, // Project
                        { wch: 10 }, // Status
                        { wch: 15 }, // Kriteria
                        { wch: 20 }, // Value Quotation
                        { wch: 20 }, // Value PO
                        { wch: 30 }, // Description
                        { wch: 30 }, // Notes
                        { wch: 10 }, // Progress
                        { wch: 15 }, // Images Count
                        { wch: 20 }, // Updated At
                        { wch: 20 }, // Updated By
                        { wch: 25 }, // Created By
                    ]
                    : [
                        { wch: 8 },  // No
                        { wch: 25 }, // Quotation
                        { wch: 15 }, // Date
                        { wch: 15 }, // Company
                        { wch: 10 }, // SOW
                        { wch: 15 }, // Category
                        { wch: 20 }, // PIC
                        { wch: 35 }, // Customer
                        { wch: 30 }, // Project
                        { wch: 10 }, // Status
                        { wch: 15 }, // Kriteria
                        { wch: 20 }, // Value Quotation
                        { wch: 20 }, // Value PO
                        { wch: 10 }, // Progress
                    ];
                
                ws['!cols'] = colWidths;
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Pipeline Data');
                
                // Generate filename
                let filename = 'Pipeline_Export';
                if (includeTimestamp) {
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                    filename += `_${timestamp}`;
                }
                filename += '.xlsx';
                
                // Export to Excel
                XLSX.writeFile(wb, filename);
                
                showToast(`Exported ${itemsToExport.length} items to Excel`, 'success');
                closeExportOptionsModal();
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showToast('Failed to export to Excel', 'error');
            } finally {
                hideLoading();
            }
        }

        function prepareExcelData(items, format, includeFilters) {
            const data = [];
            
            // Add header
            if (format === 'detailed') {
                data.push([
                    'No', 'No. Quotation', 'Tanggal', 'Company', 'SOW', 'Category', 'PIC', 
                    'Customer', 'Project', 'Status', 'Kriteria', 'Value Quotation', 'Value PO',
                    'Description', 'Notes', 'Progress (%)', 'Images Count', 'Updated At', 'Updated By', 'Created By'
                ]);
            } else {
                data.push([
                    'No', 'No. Quotation', 'Tanggal', 'Company', 'SOW', 'Category', 'PIC', 
                    'Customer', 'Project', 'Status', 'Kriteria', 'Value Quotation', 'Value PO', 'Progress (%)'
                ]);
            }
            
            // Add filter information if requested
            if (includeFilters) {
                const searchTerm = document.getElementById('searchPipelineItems').value;
                const companyFilter = document.getElementById('filterByCompany').value;
                const statusFilter = document.getElementById('filterByStatus').value;
                
                let filterInfo = 'Filters: ';
                const filters = [];
                
                if (searchTerm) filters.push(`Search: "${searchTerm}"`);
                if (companyFilter) filters.push(`Company: ${companyFilter}`);
                if (statusFilter) filters.push(`Status: ${statusFilter}`);
                
                if (filters.length > 0) {
                    filterInfo += filters.join(', ');
                    data.push([filterInfo]);
                    data.push([]); // Empty row
                }
            }
            
            // Add user filter info for regular users
            if (currentUserRole === 'user' && !isAdminSales()) {
                data.push([`Filter: Only items created by ${currentUser.email}`]);
                data.push([]); // Empty row
            }
            
            // Add admin sales note
            if (isAdminSales()) {
                data.push([`Exported by: Admin Sales (${currentUser.email})`]);
                data.push([]); // Empty row
            }
            
            // Add data rows
            items.forEach(item => {
                if (format === 'detailed') {
                    data.push([
                        item.no || '',
                        item.quotation || '',
                        item.date ? formatDate(item.date) : '',
                        item.company || '',
                        item.sow || '',
                        item.category || '',
                        item.pic || '',
                        item.customer || '',
                        item.project || '',
                        item.status || '',
                        item.kriteria || '',
                        formatCurrencyDisplay(item.valueQuotation || 0),
                        formatCurrencyDisplay(item.valuePO || 0),
                        item.description || '',
                        item.notes || '',
                        item.progress || 0,
                        item.images ? item.images.length : 0,
                        item.updatedAt ? formatDateTime(item.updatedAt) : '',
                        item.updatedBy || '',
                        item.createdBy || ''
                    ]);
                } else {
                    data.push([
                        item.no || '',
                        item.quotation || '',
                        item.date ? formatDate(item.date) : '',
                        item.company || '',
                        item.sow || '',
                        item.category || '',
                        item.pic || '',
                        item.customer || '',
                        item.project || '',
                        item.status || '',
                        item.kriteria || '',
                        formatCurrencyDisplay(item.valueQuotation || 0),
                        formatCurrencyDisplay(item.valuePO || 0),
                        item.progress || 0
                    ]);
                }
            });
            
            // Add summary
            data.push([]); // Empty row
            data.push(['Summary Information']);
            data.push(['Total Items:', items.length]);
            data.push(['Open Items:', items.filter(i => i.status === 'Open').length]);
            data.push(['Close Items:', items.filter(i => i.status === 'Close').length]);
            data.push(['Follow Up Items:', items.filter(i => i.kriteria === 'Follow Up').length]);
            data.push(['Win Items:', items.filter(i => i.kriteria === 'Win').length]);
            data.push(['Lose Items:', items.filter(i => i.kriteria === 'Lose').length]);
            
            const totalQuotation = items.reduce((sum, item) => sum + (item.valueQuotation || 0), 0);
            const totalPO = items.reduce((sum, item) => sum + (item.valuePO || 0), 0);
            const totalImages = items.reduce((sum, item) => sum + (item.images ? item.images.length : 0), 0);
            
            data.push(['Total Quotation Value:', formatCurrencyDisplay(totalQuotation)]);
            data.push(['Total PO Value:', formatCurrencyDisplay(totalPO)]);
            data.push(['Total Images:', totalImages]);
            data.push(['Export Date:', new Date().toLocaleString('id-ID')]);
            data.push(['Exported By:', currentUser?.email || 'Unknown']);
            data.push(['User Role:', currentUserRole === 'adminsales' ? 'Admin Sales' : currentUserRole]);
            
            return data;
        }

        // ==================== PIPELINE ANALYTICS ====================
        function openPipelinesAnalytics() {
            console.log('Opening pipeline analytics');
            
            // Admin sales tidak bisa melihat analytics
            if (isAdminSales()) {
                showToast('Anda tidak memiliki izin untuk melihat pipeline analytics', 'warning');
                return;
            }
            
            if (!canViewPipelineAnalytics()) {
                showToast('You do not have permission to view pipeline analytics', 'warning');
                return;
            }
            
            document.getElementById('pipelinesAnalyticsModal').classList.remove('hidden');
            loadPipelineAnalytics();
        }

        function closePipelinesAnalyticsModal() {
            document.getElementById('pipelinesAnalyticsModal').classList.add('hidden');
            
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
        }

        async function loadPipelineAnalytics() {
            console.log('Loading pipeline analytics...');
            showLoading();
            
            try {
                const querySnapshot = await pipelinesCollection.get();
                const allItems = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allItems.push({
                        id: doc.id,
                        ...data
                    });
                });

                document.getElementById('pipelinesDataUpdatedTime').textContent = new Date().toLocaleString('id-ID');
                generatePipelineStatusChart(allItems);
                generatePipelineCompanyChart(allItems);
                generatePipelineRevenueChart(allItems);
                generatePipelinePICChart(allItems);
                updatePipelineMetrics(allItems);
                
                showToast('Pipeline analytics loaded successfully', 'success');
                
            } catch (error) {
                console.error('Error loading pipeline analytics:', error);
                showToast('Failed to load pipeline analytics', 'error');
            } finally {
                hideLoading();
            }
        }

        function generatePipelineStatusChart(pipelineItems) {
            const ctx = document.getElementById('pipelineStatusChart');
            if (!ctx) return;
            
            if (charts.pipelineStatusChart) {
                charts.pipelineStatusChart.destroy();
            }
            
            const openCount = pipelineItems.filter(item => item.status === 'Open').length;
            const closeCount = pipelineItems.filter(item => item.status === 'Close').length;
            
            charts.pipelineStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Open', 'Close'],
                    datasets: [{
                        data: [openCount, closeCount],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.9)',    // Green
                            'rgba(100, 116, 139, 0.9)'    // Gray
                        ],
                        borderColor: [
                            'rgb(34, 197, 94)',
                            'rgb(100, 116, 139)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 11
                                },
                                padding: 15
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        function generatePipelineCompanyChart(pipelineItems) {
            const ctx = document.getElementById('pipelineCompanyChart');
            if (!ctx) return;
            
            if (charts.pipelineCompanyChart) {
                charts.pipelineCompanyChart.destroy();
            }
            
            const companyCounts = {
                'Genetek': 0,
                'Effrensindo': 0,
                'Other': 0
            };
            
            pipelineItems.forEach(item => {
                if (item.company === 'Genetek') {
                    companyCounts['Genetek']++;
                } else if (item.company === 'Effrensindo') {
                    companyCounts['Effrensindo']++;
                } else {
                    companyCounts['Other']++;
                }
            });
            
            charts.pipelineCompanyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(companyCounts),
                    datasets: [{
                        label: 'Items',
                        data: Object.values(companyCounts),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.9)',    // Blue
                            'rgba(139, 92, 246, 0.9)',    // Purple
                            'rgba(148, 163, 184, 0.9)'    // Gray
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(139, 92, 246)',
                            'rgb(148, 163, 184)'
                        ],
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Items',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function generatePipelineRevenueChart(pipelineItems) {
            const ctx = document.getElementById('pipelineRevenueChart');
            if (!ctx) return;
            
            if (charts.pipelineRevenueChart) {
                charts.pipelineRevenueChart.destroy();
            }
            
            // Group by month based on date field
            const monthlyData = {};
            pipelineItems.forEach(item => {
                let date;
                if (item.date) {
                    if (item.date.toDate) {
                        date = item.date.toDate();
                    } else if (item.date instanceof Date) {
                        date = item.date;
                    } else {
                        date = new Date(item.date);
                    }
                } else if (item.createdAt) {
                    date = item.createdAt.toDate();
                }
                
                if (date) {
                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            quotation: 0,
                            po: 0
                        };
                    }
                    
                    monthlyData[monthKey].quotation += (item.valueQuotation || 0);
                    monthlyData[monthKey].po += (item.valuePO || 0);
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const last6Months = sortedMonths.slice(-6);
            
            charts.pipelineRevenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last6Months.map(month => {
                        const [year, m] = month.split('-');
                        return `${m}/${year.slice(-2)}`;
                    }),
                    datasets: [
                        {
                            label: 'Quotation Value',
                            data: last6Months.map(month => monthlyData[month].quotation),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.15)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'PO Value',
                            data: last6Months.map(month => monthlyData[month].po),
                            borderColor: 'rgb(139, 92, 246)',
                            backgroundColor: 'rgba(139, 92, 246, 0.15)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value (IDR)',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function generatePipelinePICChart(pipelineItems) {
            const ctx = document.getElementById('pipelinePICChart');
            if (!ctx) return;
            
            if (charts.pipelinePICChart) {
                charts.pipelinePICChart.destroy();
            }
            
            // Group items by PIC
            const picData = {};
            
            pipelineItems.forEach(item => {
                const pic = item.pic || 'Unassigned';
                
                if (!picData[pic]) {
                    picData[pic] = {
                        items: [],
                        totalProgress: 0,
                        openItems: 0,
                        closeItems: 0,
                        totalQuotation: 0,
                        totalPO: 0,
                        followUpItems: 0,
                        winItems: 0,
                        loseItems: 0
                    };
                }
                
                picData[pic].items.push(item);
                picData[pic].totalProgress += (item.progress || 0);
                picData[pic].totalQuotation += (item.valueQuotation || 0);
                picData[pic].totalPO += (item.valuePO || 0);
                
                if (item.status === 'Open') {
                    picData[pic].openItems++;
                } else if (item.status === 'Close') {
                    picData[pic].closeItems++;
                }
                
                if (item.kriteria === 'Follow Up') {
                    picData[pic].followUpItems++;
                } else if (item.kriteria === 'Win') {
                    picData[pic].winItems++;
                } else if (item.kriteria === 'Lose') {
                    picData[pic].loseItems++;
                }
            });
            
            // Prepare data for chart
            const sortBy = document.getElementById('picChartSort') ? document.getElementById('picChartSort').value : 'name';
            
            let sortedPICs = Object.keys(picData);
            
            if (sortBy === 'name') {
                sortedPICs.sort();
            } else if (sortBy === 'items') {
                sortedPICs.sort((a, b) => picData[b].items.length - picData[a].items.length);
            } else if (sortBy === 'progress') {
                sortedPICs.sort((a, b) => {
                    const avgProgressA = picData[a].items.length > 0 ? picData[a].totalProgress / picData[a].items.length : 0;
                    const avgProgressB = picData[b].items.length > 0 ? picData[b].totalProgress / picData[b].items.length : 0;
                    return avgProgressB - avgProgressA;
                });
            }
            
            // Take top 10 PICs for chart
            const topPICs = sortedPICs.slice(0, 10);
            
            const chartData = {
                labels: topPICs.map(pic => pic.length > 20 ? pic.substring(0, 20) + '...' : pic),
                datasets: [
                    {
                        label: 'Average Progress (%)',
                        data: topPICs.map(pic => {
                            const avgProgress = picData[pic].items.length > 0 
                                ? picData[pic].totalProgress / picData[pic].items.length 
                                : 0;
                            return Math.round(avgProgress);
                        }),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Item Count',
                        data: topPICs.map(pic => picData[pic].items.length),
                        backgroundColor: 'rgba(139, 92, 246, 0.7)',
                        borderColor: 'rgb(139, 92, 246)',
                        borderWidth: 2,
                        yAxisID: 'y1'
                    }
                ]
            };
            
            charts.pipelinePICChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw;
                                    return `${label}: ${value}`;
                                },
                                afterLabel: function(context) {
                                    const pic = topPICs[context.dataIndex];
                                    const data = picData[pic];
                                    const avgProgress = data.items.length > 0 
                                        ? Math.round(data.totalProgress / data.items.length)
                                        : 0;
                                    return [
                                        `PIC: ${pic}`,
                                        `Items: ${data.items.length}`,
                                        `Open: ${data.openItems}, Close: ${data.closeItems}`,
                                        `Follow Up: ${data.followUpItems}, Win: ${data.winItems}, Lose: ${data.loseItems}`,
                                        `Avg Progress: ${avgProgress}%`,
                                        `Total Quotation: ${formatCurrencyDisplay(data.totalQuotation)}`,
                                        `Total PO: ${formatCurrencyDisplay(data.totalPO)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Average Progress (%)',
                                font: {
                                    size: 12
                                }
                            },
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Item Count',
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
            
            // Update chart info
            const chartInfo = document.getElementById('picChartInfo');
            if (chartInfo) {
                const totalPICs = Object.keys(picData).length;
                const totalItems = pipelineItems.length;
                const avgProgressOverall = pipelineItems.length > 0 
                    ? pipelineItems.reduce((sum, item) => sum + (item.progress || 0), 0) / pipelineItems.length 
                    : 0;
                
                // Find best PIC
                let bestPIC = { name: 'None', progress: 0 };
                Object.keys(picData).forEach(pic => {
                    const avgProgress = picData[pic].items.length > 0 
                        ? picData[pic].totalProgress / picData[pic].items.length 
                        : 0;
                    if (avgProgress > bestPIC.progress) {
                        bestPIC = { name: pic, progress: avgProgress };
                    }
                });
                
                chartInfo.innerHTML = `
                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <div>
                            <div class="font-medium">Total PICs</div>
                            <div class="text-lg font-bold">${totalPICs}</div>
                        </div>
                        <div>
                            <div class="font-medium">Total Items</div>
                            <div class="text-lg font-bold">${totalItems}</div>
                        </div>
                        <div>
                            <div class="font-medium">Avg Progress</div>
                            <div class="text-lg font-bold">${Math.round(avgProgressOverall)}%</div>
                        </div>
                        <div>
                            <div class="font-medium">Win Rate</div>
                            <div class="text-lg font-bold">${Math.round(pipelineItems.filter(i => i.kriteria === 'Win').length / (pipelineItems.filter(i => i.kriteria === 'Win' || i.kriteria === 'Lose').length || 1) * 100)}%</div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="font-medium mb-2">Top Performing PICs:</div>
                        <div class="space-y-2">
                            ${sortedPICs.slice(0, 5).map(pic => {
                                const data = picData[pic];
                                const avgProgress = data.items.length > 0 
                                    ? Math.round(data.totalProgress / data.items.length) 
                                    : 0;
                                const winCount = data.winItems || 0;
                                const loseCount = data.loseItems || 0;
                                const winRate = (winCount + loseCount) > 0 ? Math.round(winCount / (winCount + loseCount) * 100) : 0;
                                return `<div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span class="truncate font-medium" title="${pic}">${pic}</span>
                                    <span class="flex items-center gap-2">
                                        <span class="text-xs px-2 py-1 rounded ${avgProgress >= 80 ? 'bg-green-100 text-green-800' : avgProgress >= 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                            ${avgProgress}%
                                        </span>
                                        <span class="text-xs text-gray-600">(${data.items.length} items)</span>
                                        <span class="text-xs ${winRate >= 70 ? 'text-green-600' : winRate >= 40 ? 'text-yellow-600' : 'text-red-600'}">
                                            ${winRate}% win
                                        </span>
                                    </span>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                // Update best PIC in metrics
                document.getElementById('bestPICName').textContent = bestPIC.name.length > 15 
                    ? bestPIC.name.substring(0, 15) + '...' 
                    : bestPIC.name;
                document.getElementById('bestPICProgress').textContent = `Best PIC (${Math.round(bestPIC.progress)}%)`;
            }
            
            // Add event listener for sort change
            const sortSelect = document.getElementById('picChartSort');
            if (sortSelect) {
                // Remove existing listener to avoid duplicates
                const newSortSelect = sortSelect.cloneNode(true);
                sortSelect.parentNode.replaceChild(newSortSelect, sortSelect);
                
                newSortSelect.addEventListener('change', () => {
                    generatePipelinePICChart(pipelineItems);
                });
            }
        }

        function updatePipelineMetrics(pipelineItems) {
            const openItems = pipelineItems.filter(item => item.status === 'Open').length;
            const closeItems = pipelineItems.filter(item => item.status === 'Close').length;
            
            let totalQuotationValue = 0;
            let totalPOValue = 0;
            
            pipelineItems.forEach(item => {
                totalQuotationValue += (item.valueQuotation || 0);
                totalPOValue += (item.valuePO || 0);
            });
            
            // Find best PIC
            const picData = {};
            pipelineItems.forEach(item => {
                const pic = item.pic || 'Unassigned';
                if (!picData[pic]) {
                    picData[pic] = {
                        count: 0,
                        totalProgress: 0
                    };
                }
                picData[pic].count++;
                picData[pic].totalProgress += (item.progress || 0);
            });
            
            let bestPIC = { name: 'None', progress: 0 };
            Object.keys(picData).forEach(pic => {
                const avgProgress = picData[pic].count > 0 
                    ? picData[pic].totalProgress / picData[pic].count 
                    : 0;
                if (avgProgress > bestPIC.progress) {
                    bestPIC = { name: pic, progress: avgProgress };
                }
            });
            
            document.getElementById('totalOpenItems').textContent = openItems;
            document.getElementById('totalCloseItems').textContent = closeItems;
            document.getElementById('totalQuotationValue').textContent = formatCurrencyDisplay(totalQuotationValue);
            document.getElementById('totalPOValue').textContent = formatCurrencyDisplay(totalPOValue);
            document.getElementById('bestPICName').textContent = bestPIC.name.length > 15 
                ? bestPIC.name.substring(0, 15) + '...' 
                : bestPIC.name;
            document.getElementById('bestPICProgress').textContent = `Best PIC (${Math.round(bestPIC.progress)}%)`;
        }

        // ==================== USER MANAGEMENT ====================
        async function getUserRoleFromFirestore(userId) {
            console.log('Getting user role for:', userId);
            
            try {
                const userDoc = await usersCollection.doc(userId).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role || 'user';
                    console.log('User role from Firestore:', currentUserRole);
                    
                    await usersCollection.doc(userId).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    console.log('Creating new user document...');
                    let defaultRole = 'user';
                    const userEmail = currentUser.email;
                    
                    if (userEmail === 'adminsales@genetek.co.id') {
                        defaultRole = 'adminsales';
                    } else if (userEmail === 'admin@genetek.co.id') {
                        defaultRole = 'admin';
                    } else if (userEmail === 'm_husni@genetek.co.id') {
                        defaultRole = 'manager';
                    } else if (userEmail === 'galih@genetek.co.id') {
                        defaultRole = 'user';
                    }
                    
                    await usersCollection.doc(userId).set({
                        email: userEmail,
                        role: defaultRole,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    currentUserRole = defaultRole;
                    console.log('Created new user with role:', currentUserRole);
                }
                
                return currentUserRole;
                
            } catch (error) {
                console.error('Error getting user role:', error);
                currentUserRole = 'user';
                return 'user';
            }
        }

        function setupUserRolePermissions() {
            console.log('Setting up pipeline permissions for role:', currentUserRole);
            
            const newPipelineBtn = document.getElementById('newPipelineItemBtn');
            const takePictureBtn = document.getElementById('takePictureBtn');
            const analyticsBtn = document.getElementById('pipelinesAnalyticsBtn');
            const exportBtn = document.getElementById('exportExcelBtn');
            const backBtn = document.getElementById('backToDashboardBtn');
            const logoutBtn = document.getElementById('authButton');
            
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.className = 'user-avatar';
                if (currentUserRole === 'admin') {
                    userAvatar.classList.add('admin');
                } else if (currentUserRole === 'manager') {
                    userAvatar.classList.add('manager');
                } else if (currentUserRole === 'adminsales') {
                    userAvatar.classList.add('adminsales');
                } else {
                    userAvatar.classList.add('user');
                }
            }
            
            const roleBadge = document.getElementById('userRoleBadge');
            if (roleBadge) {
                let badgeClass = 'badge-info';
                let roleDisplay = currentUserRole;
                
                if (currentUserRole === 'admin') {
                    badgeClass = 'badge-secondary';
                    roleDisplay = 'Admin';
                } else if (currentUserRole === 'manager') {
                    badgeClass = 'badge-primary';
                    roleDisplay = 'Manager';
                } else if (currentUserRole === 'adminsales') {
                    badgeClass = 'badge-adminsales';
                    roleDisplay = 'Admin Sales';
                } else {
                    badgeClass = 'badge-info';
                    roleDisplay = 'User';
                }
                
                roleBadge.className = `badge ${badgeClass}`;
                roleBadge.innerHTML = `<i class="fas fa-user-tag"></i><span>${roleDisplay}</span>`;
            }
            
            // Tampilkan/sembunyikan tombol berdasarkan role
            if (isAdminSales()) {
                // Admin sales: hanya export, back, dan logout
                if (newPipelineBtn) newPipelineBtn.classList.add('hidden');
                if (takePictureBtn) takePictureBtn.classList.add('hidden');
                if (analyticsBtn) analyticsBtn.classList.add('hidden');
                if (exportBtn) exportBtn.classList.remove('hidden');
                if (backBtn) backBtn.classList.remove('hidden');
                if (logoutBtn) logoutBtn.classList.remove('hidden');
            } else {
                // Untuk role lain
                if (newPipelineBtn) newPipelineBtn.classList.remove('hidden');
                if (takePictureBtn) takePictureBtn.classList.remove('hidden');
                if (exportBtn) exportBtn.classList.remove('hidden');
                
                // Tombol yang hanya untuk admin/manager
                if (analyticsBtn) {
                    if (canViewPipelineAnalytics()) {
                        analyticsBtn.classList.remove('hidden');
                    } else {
                        analyticsBtn.classList.add('hidden');
                    }
                }
            }
            
            console.log('Pipeline permissions set for role:', currentUserRole);
        }

        // ==================== AUTH FUNCTIONS ====================
        function setupAuthStateObserver() {
            if (!auth) {
                console.error('Auth not available');
                return;
            }

            console.log('Setting up auth state observer for Pipelines...');
            
            auth.onAuthStateChanged(async (user) => {
                console.log('Auth state changed:', user ? 'User logged in' : 'User logged out');
                
                if (user) {
                    currentUser = user;
                    
                    try {
                        await getUserRoleFromFirestore(user.uid);
                        
                        document.getElementById('userWelcome').textContent = user.email;
                        setupUserRolePermissions();
                        
                        // Initialize the app
                        initPipelinesApp();
                        showToast('Welcome to Pipelines!', 'success');
                        
                    } catch (error) {
                        console.error('Error in auth observer:', error);
                        showToast('Error loading user data', 'error');
                    }
                } else {
                    console.log('User signed out - redirecting to login');
                    // Redirect back to main app for login
                    window.location.href = 'index.html';
                }
            }, (error) => {
                console.error('Auth observer error:', error);
            });
        }

        function logout() {
            console.log('Logging out from Pipelines...');
            
            if (auth && currentUser) {
                auth.signOut().then(() => {
                    console.log('Logout successful');
                    showToast('Logged out successfully', 'success');
                }).catch(error => {
                    console.error('Logout error:', error);
                    showToast('Error signing out', 'error');
                });
            }
        }

        function backToDashboard() {
            console.log('Returning to main dashboard...');
            window.location.href = 'index.html';
        }

        // ==================== EVENT LISTENERS ====================
        async function initPipelinesApp() {
            console.log('Initializing Pipelines app...');
            
            await loadPipelineItems();
            await setupAutoCompleteSearch();
            setupPipelineSearchForCamera();
            setupDragAndDrop();
            setupCurrencyInputs();
            
            // Add event listener for SOW change to update category options
            document.getElementById('pipelineSOW').addEventListener('change', updateCategoryOptions);
            
            // Add event listener for Kriteria change to update progress
            document.getElementById('pipelineKriteria').addEventListener('change', updateProgressFromKriteria);
            
            // Add event listeners for quotation number generation
            document.getElementById('pipelineDate').addEventListener('change', async function() {
                await updateQuotationPreview();
            });
            
            document.getElementById('pipelineCompany').addEventListener('change', async function() {
                await updateQuotationPreview();
            });
            
            document.getElementById('pipelineSOW').addEventListener('change', async function() {
                await updateQuotationPreview();
            });
            
            // Add event listeners for main buttons
            document.getElementById('newPipelineItemBtn').addEventListener('click', createNewPipelineItem);
            document.getElementById('takePictureBtn').addEventListener('click', openTakePictureModal);
            document.getElementById('exportExcelBtn').addEventListener('click', openExportOptionsModal);
            document.getElementById('backToDashboardBtn').addEventListener('click', backToDashboard);
            document.getElementById('pipelinesAnalyticsBtn').addEventListener('click', openPipelinesAnalytics);
            document.getElementById('authButton').addEventListener('click', logout);
            
            // Search and filter listeners
            document.getElementById('searchPipelineItems').addEventListener('input', filterPipelineItems);
            document.getElementById('filterByCompany').addEventListener('change', filterPipelineItems);
            document.getElementById('filterByStatus').addEventListener('change', filterPipelineItems);
            
            // Pipeline modal listeners
            document.getElementById('closePipelineModal').addEventListener('click', closePipelineItemModal);
            document.getElementById('cancelPipelineBtn').addEventListener('click', closePipelineItemModal);
            document.getElementById('pipelineItemForm').addEventListener('submit', function(e) {
                e.preventDefault();
                savePipelineItem();
            });
            
            // Take picture modal listeners
            document.getElementById('closeTakePictureModal').addEventListener('click', closeTakePictureModal);
            document.getElementById('cancelTakePictureBtn').addEventListener('click', closeTakePictureModal);
            document.getElementById('startCameraBtn').addEventListener('click', startCamera);
            document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
            document.getElementById('captureBtn').addEventListener('click', captureImage);
            document.getElementById('retakeBtn').addEventListener('click', retakeImage);
            document.getElementById('saveImageBtn').addEventListener('click', saveCapturedImage);
            document.getElementById('uploadImageInput').addEventListener('change', uploadImage);
            document.getElementById('attachToPipelineBtn').addEventListener('click', attachImagesToPipeline);
            
            // Detail modal listeners
            document.getElementById('closePipelineDetailModal').addEventListener('click', closePipelineDetailModal);
            document.getElementById('closePipelineDetailBottomBtn').addEventListener('click', closePipelineDetailModal);
            
            // Preview image modal listeners
            document.getElementById('closePreviewImageModal').addEventListener('click', closePreviewImageModal);
            document.getElementById('downloadImageBtn').addEventListener('click', downloadImage);
            
            // Export modal event listeners
            document.getElementById('closeExportOptionsModal').addEventListener('click', closeExportOptionsModal);
            document.getElementById('cancelExportBtn').addEventListener('click', closeExportOptionsModal);
            document.getElementById('confirmExportBtn').addEventListener('click', exportToExcel);
            
            // Add event listeners for export options changes
            document.querySelectorAll('input[name="exportScope"]').forEach(input => {
                input.addEventListener('change', updateExportItemCount);
            });
            
            document.getElementById('exportOpen').addEventListener('change', updateExportItemCount);
            document.getElementById('exportClose').addEventListener('change', updateExportItemCount);
            
            // Pipeline analytics listeners
            document.getElementById('closePipelinesAnalyticsModal').addEventListener('click', closePipelinesAnalyticsModal);
            document.getElementById('closePipelinesAnalyticsModalBottom').addEventListener('click', closePipelinesAnalyticsModal);
            
            // Add PIC modal event listeners
            document.getElementById('closeAddPICModal').addEventListener('click', closeAddPICModal);
            document.getElementById('cancelAddPICBtn').addEventListener('click', closeAddPICModal);
            document.getElementById('addPICForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveNewPIC();
            });
            
            // Add customer modal event listeners
            document.getElementById('closeAddCustomerModal').addEventListener('click', closeAddCustomerModal);
            document.getElementById('cancelAddCustomerBtn').addEventListener('click', closeAddCustomerModal);
            document.getElementById('addCustomerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveNewCustomer();
            });
            
            console.log('Pipelines app initialization complete');
        }

        async function updateQuotationPreview() {
            const company = document.getElementById('pipelineCompany').value;
            const sow = document.getElementById('pipelineSOW').value;
            const date = document.getElementById('pipelineDate').value;
            const noInput = document.getElementById('pipelineNo');
            
            if (company && sow && date && noInput && noInput.value) {
                const no = parseInt(noInput.value);
                if (!isNaN(no) && no > 0) {
                    const quotationNumber = await generateQuotationNumber(no, company, sow, date);
                    document.getElementById('pipelineQuotation').value = quotationNumber;
                }
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Work Order Pipelines initializing...');
            
            const firebaseInitialized = initializeFirebase();
            
            if (!firebaseInitialized) {
                showToast('Firebase initialization failed. Please check console.', 'error');
                return;
            }
            
            setupAuthStateObserver();
            
            console.log('Pipelines initialization complete');
        });

    </script>
</body>
</html>
