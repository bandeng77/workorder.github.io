<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Order Management System</title>
    
    <!-- Load Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* LOGIN PAGE STYLES */
        :root {
            --primary-color: #2563eb;
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #10b981;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .neumorphic {
            border-radius: 20px;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 20px 20px 60px #d9d9d9, -20px -20px 60px #ffffff;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shine 8s infinite linear;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .floating-element {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .btn-login {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .btn-login::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        .btn-login:hover::before {
            left: 100%;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
        }

        .form-input {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.875rem 1rem;
            width: 100%;
        }

        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .form-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .form-label {
            position: absolute;
            left: 1rem;
            top: 0.875rem;
            color: #6b7280;
            transition: all 0.3s ease;
            pointer-events: none;
            background: white;
            padding: 0 0.25rem;
        }

        .form-input:focus + .form-label,
        .form-input:not(:placeholder-shown) + .form-label {
            top: -0.5rem;
            left: 0.75rem;
            font-size: 0.75rem;
            color: var(--primary-color);
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* MAIN APP STYLES */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .glass-effect-app {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .neumorphic-inset {
            border-radius: 15px;
            background: #f0f0f0;
            box-shadow: inset 10px 10px 20px #d9d9d9, inset -10px -10px 20px #ffffff;
        }

        .gradient-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%);
        }

        .gradient-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
        }

        .gradient-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
        }

        .gradient-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
        }

        .workorder-container {
            min-height: 480px;
            max-height: 600px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .workorder-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .workorder-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .workorder-header h3 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1f2937;
            flex-shrink: 0;
        }

        .workorder-content {
            flex-grow: 1;
            padding: 1.25rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 100px;
            height: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-content: flex-start;
        }

        .workorder-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            font-size: 0.875rem;
            width: calc(33.333% - 0.666rem);
            min-width: 280px;
            box-sizing: border-box;
            overflow: hidden;
        }

        .workorder-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        .workorder-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .workorder-card.running::before { background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%); }
        .workorder-card.done::before { background: linear-gradient(90deg, #10b981 0%, #34d399 100%); }
        .workorder-card.close::before { background: linear-gradient(90deg, #6b7280 0%, #9ca3af 100%); }

        .workorder-content::-webkit-scrollbar {
            width: 8px;
        }

        .workorder-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .workorder-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 10px;
        }

        .workorder-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #1d4ed8 0%, #059669 100%);
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .modal-content-enter {
            opacity: 0;
            transform: scale(0.95) translateY(-20px);
        }

        .modal-content-enter-active {
            opacity: 1;
            transform: scale(1) translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-content-leave {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        .modal-content-leave-active {
            opacity: 0;
            transform: scale(0.95) translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 4px solid var(--primary-color);
        }

        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--danger-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.info { border-left-color: var(--primary-color); }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast i {
            font-size: 1.25rem;
        }

        /* Status badges */
        .status-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.75rem;
            line-height: 1;
            border-radius: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .status-done { 
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white;
        }
        .status-close { 
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }
        .status-running { 
            background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%);
            color: white;
        }
        .status-pending { 
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
            color: white;
        }

        /* Work order details */
        .workorder-details p {
            font-size: 0.8rem;
            margin-top: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #4b5563;
        }

        .workorder-footer {
            margin-top: 1rem;
            border-top: 1px solid rgba(229, 231, 235, 0.5);
            padding-top: 1rem;
        }

        /* Media Queries */
        @media (max-width: 1200px) {
            .workorder-card {
                width: calc(50% - 0.5rem);
            }
        }

        @media (max-width: 768px) {
            .workorder-card {
                width: 100%;
            }
        }

        /* Modal styles */
        #workorderModalContent {
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 16px;
            box-sizing: border-box;
            padding: 2rem;
            background: white;
            position: relative;
        }

        #workorderModalContent::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 16px 16px 0 0;
        }

        /* Form elements */
        .form-input-app {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #e5e7eb;
            border-radius: 10px;
        }

        .form-input-app:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .form-label-app {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }

        /* Button styles */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
            color: white;
        }

        /* Dashboard cards */
        .dashboard-card {
            border-radius: 16px;
            padding: 1.5rem;
            color: white;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .dashboard-card i {
            font-size: 2rem;
            opacity: 0.8;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            background: #f8fafc;
            padding: 0.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* List view */
        .list-view {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .list-view th {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
        }

        .list-view td {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }

        .list-view tr {
            transition: all 0.2s;
        }

        .list-view tr:hover {
            background-color: #f9fafb;
            transform: translateX(5px);
        }

        .list-view .workorder-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Notes section */
        .notes-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .notes-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .notes-table th,
        .notes-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            background: white;
        }

        .notes-table th {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            font-weight: 600;
            color: #374151;
        }

        /* Man Power Tags */
        .manpower-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .manpower-tag {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .manpower-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .remove-tag {
            cursor: pointer;
            color: var(--danger-color);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.1);
            transition: all 0.2s;
        }

        .remove-tag:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }

        /* Progress bar */
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 3px;
        }

        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 2rem;
            margin: 2rem 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            padding-left: 1rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 2px solid white;
            box-shadow: 0 0 0 3px var(--primary-color);
        }

        .timeline-date {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .timeline-content {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="gradient-bg">
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute top-20 left-10 w-64 h-64 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-spin-slow floating-element"></div>
            <div class="absolute bottom-20 right-10 w-64 h-64 bg-blue-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-spin-slow floating-element" style="animation-delay: -2s;"></div>
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-spin-slow floating-element" style="animation-delay: -4s;"></div>
        </div>

        <div class="relative z-10 w-full max-w-md mx-4">
            <div class="neumorphic p-8 rounded-3xl">
                <div class="text-center mb-10">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                        <i class="fas fa-clipboard-list text-white text-3xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Work Order System</h1>
                    <p class="text-gray-600">Genetek Management Platform</p>
                </div>

                <form id="loginForm" class="space-y-6">
                    <div class="form-group">
                        <input type="email" 
                               id="email" 
                               class="form-input"
                               placeholder=" "
                               required>
                        <label class="form-label" for="email">
                            <i class="fas fa-envelope mr-2"></i>
                            Email Address
                        </label>
                    </div>

                    <div class="form-group">
                        <input type="password" 
                               id="password" 
                               class="form-input"
                               placeholder=" "
                               required>
                        <label class="form-label" for="password">
                            <i class="fas fa-lock mr-2"></i>
                            Password
                        </label>
                    </div>

                    <div id="loginError" class="hidden">
                        <div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg flex items-center">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            <span id="errorMessage">Invalid credentials</span>
                        </div>
                    </div>

                    <button type="submit" class="btn-login w-full flex items-center justify-center">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        <span>Login to System</span>
                    </button>

                    <div class="text-center pt-6 border-t border-gray-200">
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-shield-alt mr-1"></i>
                            Secure Login - Authorized Personnel Only
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Application Page (Hidden Initially) -->
    <div id="appPage" class="hidden">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- Header -->
            <header class="mb-8">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-6">
                    <div class="flex-1">
                        <div class="flex items-center gap-4 mb-2">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-clipboard-list text-white text-xl"></i>
                            </div>
                            <div>
                                <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                                    Work Order Management
                                </h1>
                                <p class="text-gray-600 mt-1">Track and manage all work orders efficiently</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="newWorkOrderBtn" class="btn btn-primary shadow-lg">
                            <i class="fas fa-plus-circle"></i>
                            <span>New Work Order</span>
                        </button>
                        <button id="exportExcelBtn" class="btn btn-success shadow-lg">
                            <i class="fas fa-file-excel"></i>
                            <span>Export Excel</span>
                        </button>
                        <button id="analyticsBtn" class="btn btn-warning shadow-lg">
                            <i class="fas fa-chart-bar"></i>
                            <span>Analytics</span>
                        </button>
                        <button id="activityBtn" class="btn btn-secondary shadow-lg">
                            <i class="fas fa-history"></i>
                            <span>Recent Activity</span>
                        </button>
                        <button id="authButton" class="btn btn-danger shadow-lg">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>

                <!-- User Info & Search -->
                <div class="flex flex-col lg:flex-row gap-4 mb-6">
                    <div class="flex-1">
                        <div class="glass-effect-app rounded-xl p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Welcome back</p>
                                    <p id="userWelcome" class="font-semibold text-gray-900"></p>
                                </div>
                                <div class="ml-auto flex items-center gap-2">
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                                        <i class="fas fa-shield-alt mr-1"></i>
                                        <span id="userRole"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-1">
                        <div class="relative">
                            <input type="text" 
                                   id="searchWorkOrders" 
                                   placeholder="Search work orders..." 
                                   class="w-full p-4 pl-12 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:ring-opacity-50 transition-all duration-300">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <button id="advancedSearchBtn" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-blue-600 hover:text-blue-800">
                                <i class="fas fa-filter"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid mb-8">
                    <div class="stat-card">
                        <div class="stat-icon gradient-primary">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalWorkOrders">0</div>
                            <div class="stat-label">Total Work Orders</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon gradient-success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="completedWorkOrders">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="runningWorkOrders">0</div>
                            <div class="stat-label">Running</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                            <i class="fas fa-user-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="pendingWorkOrders">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Tabs -->
            <div class="tabs mb-8">
                <button class="tab active" data-tab="all">
                    <i class="fas fa-list"></i>
                    <span>All Work Orders</span>
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">0</span>
                </button>
                <button class="tab" data-tab="running">
                    <i class="fas fa-sync-alt"></i>
                    <span>Running</span>
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">0</span>
                </button>
                <button class="tab" data-tab="completed">
                    <i class="fas fa-check-circle"></i>
                    <span>Completed</span>
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">0</span>
                </button>
                <button class="tab" data-tab="closed">
                    <i class="fas fa-times-circle"></i>
                    <span>Closed</span>
                    <span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full">0</span>
                </button>
            </div>

            <!-- Main Content -->
            <main>
                <!-- View Toggle -->
                <div class="flex justify-between items-center mb-6">
                    <div class="view-toggle">
                        <button id="cardViewBtn" class="view-toggle-btn active">
                            <i class="fas fa-th-large"></i>
                            <span>Card View</span>
                        </button>
                        <button id="listViewBtn" class="view-toggle-btn">
                            <i class="fas fa-list"></i>
                            <span>List View</span>
                        </button>
                        <button id="timelineViewBtn" class="view-toggle-btn">
                            <i class="fas fa-stream"></i>
                            <span>Timeline</span>
                        </button>
                    </div>

                    <div class="flex items-center gap-3">
                        <select id="sortBy" class="form-input-app py-2 px-3 text-sm">
                            <option value="createdAt">Sort by Date</option>
                            <option value="workOrderNumber">Sort by WO Number</option>
                            <option value="status">Sort by Status</option>
                            <option value="customer">Sort by Customer</option>
                        </select>
                        <select id="sortOrder" class="form-input-app py-2 px-3 text-sm">
                            <option value="desc">Newest First</option>
                            <option value="asc">Oldest First</option>
                        </select>
                    </div>
                </div>

                <!-- Work Orders Container -->
                <div class="workorder-container animate-fade-in">
                    <div class="workorder-header">
                        <h3>Work Orders</h3>
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <i class="fas fa-info-circle"></i>
                            <span id="workOrderCount">Showing 0 work orders</span>
                        </div>
                    </div>
                    <div id="workorders-stage" class="workorder-content custom-scrollbar">
                        <!-- Work orders will be displayed here -->
                    </div>
                </div>

                <!-- Timeline View (Hidden by default) -->
                <div id="timelineView" class="hidden">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-bold mb-6 text-gray-900">Work Order Timeline</h3>
                        <div class="timeline" id="timelineContent">
                            <!-- Timeline items will be added here -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="w-full max-w-6xl max-h-[90vh] overflow-hidden">
            <div class="bg-white rounded-xl shadow-2xl modal-content-enter" id="analyticsModalContent">
                <div class="sticky top-0 bg-white z-10 border-b">
                    <div class="flex justify-between items-center p-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Work Order Analytics</h2>
                            <p class="text-gray-600 mt-1">Comprehensive analysis and insights</p>
                        </div>
                        <button id="closeAnalyticsModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6 overflow-y-auto max-h-[60vh] custom-scrollbar">
                    <div class="flex justify-between items-center mb-6">
                        <select id="chartTimeRange" class="form-input-app py-2 px-3 text-sm">
                            <option value="week">Last Week</option>
                            <option value="month" selected>Last Month</option>
                            <option value="quarter">Last Quarter</option>
                            <option value="year">Last Year</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="divisionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="companyChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Modal -->
    <div id="activityModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="bg-white rounded-xl shadow-2xl modal-content-enter" id="activityModalContent">
                <div class="sticky top-0 bg-white z-10 border-b">
                    <div class="flex justify-between items-center p-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Recent Activity</h2>
                            <p class="text-gray-600 mt-1">Latest system activities and changes</p>
                        </div>
                        <button id="closeActivityModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6 overflow-y-auto max-h-[60vh] custom-scrollbar">
                    <div id="activityFeed" class="space-y-4">
                        <!-- Activity items will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Work Order Modal -->
    <div id="workorderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="w-full max-w-6xl max-h-[90vh] overflow-hidden">
            <div class="bg-white rounded-xl shadow-2xl modal-content-enter" id="workorderModalContent">
                <div class="sticky top-0 bg-white z-10 border-b">
                    <div class="flex justify-between items-center p-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900" id="modalTitle">Create New Work Order</h2>
                            <p class="text-gray-600 mt-1">Fill in all required information below</p>
                        </div>
                        <button id="closeWorkOrderModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6 overflow-y-auto max-h-[60vh] custom-scrollbar">
                    <form id="workorderForm">
                        <input type="hidden" id="workorderId">
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                            <!-- Column 1 -->
                            <div class="space-y-4">
                                <div class="form-group">
                                    <label class="form-label-app" for="workOrderNumber">
                                        <span class="text-red-500">*</span> No Work Order
                                    </label>
                                    <input type="text" 
                                           id="workOrderNumber" 
                                           class="form-input-app w-full p-3"
                                           required
                                           placeholder="WO-2024-001">
                                </div>

                                <div class="form-group">
                                    <label class="form-label-app" for="soNumber">
                                        Nomor SO
                                    </label>
                                    <input type="text" 
                                           id="soNumber" 
                                           class="form-input-app w-full p-3"
                                           placeholder="SO-2024-001">
                                </div>

                                <div class="form-group">
                                    <label class="form-label-app" for="customer">
                                        <span class="text-red-500">*</span> Customer
                                    </label>
                                    <div class="relative">
                                        <input type="text" 
                                               id="customer" 
                                               class="form-input-app w-full p-3 pr-10"
                                               required
                                               placeholder="Enter customer name">
                                        <button type="button" id="customerHistoryBtn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-600">
                                            <i class="fas fa-history"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label-app" for="building">
                                        <span class="text-red-500">*</span> Gedung
                                    </label>
                                    <div class="relative">
                                        <input type="text" 
                                               id="building" 
                                               class="form-input-app w-full p-3 pr-10"
                                               required
                                               placeholder="Enter building name">
                                        <button type="button" id="buildingHistoryBtn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-600">
                                            <i class="fas fa-history"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Column 2 -->
                            <div class="space-y-4">
                                <div class="form-group">
                                    <label class="form-label-app" for="division">
                                        <span class="text-red-500">*</span> Divisi
                                    </label>
                                    <select id="division" class="form-input-app w-full p-3" required>
                                        <option value="">Select Division</option>
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Testcom">Testcom</option>
                                        <option value="Installation">Installation</option>
                                        <option value="Commissioning">Commissioning</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label-app" for="company">
                                        <span class="text-red-500">*</span> Perusahaan
                                    </label>
                                    <select id="company" class="form-input-app w-full p-3" required>
                                        <option value="">Select Company</option>
                                        <option value="Genetek Intratama">Genetek Intratama</option>
                                        <option value="Effrensindo Kencana">Effrensindo Kencana</option>
                                        <option value="PT Genetek">PT Genetek</option>
                                        <option value="PT Effrensindo">PT Effrensindo</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label-app" for="workType">
                                        <span class="text-red-500">*</span> Jenis Pekerjaan
                                    </label>
                                    <div class="relative">
                                        <input type="text" 
                                               id="workType" 
                                               class="form-input-app w-full p-3 pr-10"
                                               required
                                               placeholder="Enter work type">
                                        <button type="button" id="workTypeHistoryBtn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-600">
                                            <i class="fas fa-history"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label-app" for="personnel">
                                        Nama Personil
                                    </label>
                                    <select id="personnel" class="form-input-app w-full p-3">
                                        <option value="">Select Personnel</option>
                                        <option value="Husni">Husni</option>
                                        <option value="Heksi">Heksi</option>
                                        <option value="Indra Kurniawan">Indra Kurniawan</option>
                                        <option value="Putra">Putra</option>
                                        <option value="Wahyu Sujoko">Wahyu Sujoko</option>
                                        <option value="Yudiyono">Yudiyono</option>
                                        <option value="Edwin">Edwin</option>
                                        <option value="Fiki">Fiki</option>
                                        <option value="Harianto">Harianto</option>
                                        <option value="Haryo">Haryo</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Column 3 -->
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label class="form-label-app" for="startDate">
                                            <span class="text-red-500">*</span> Tanggal Mulai
                                        </label>
                                        <input type="date" 
                                               id="startDate" 
                                               class="form-input-app w-full p-3"
                                               required>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label-app" for="endDate">
                                            Tanggal Selesai
                                        </label>
                                        <input type="date" 
                                               id="endDate" 
                                               class="form-input-app w-full p-3">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label-app" for="estimatedTime">
                                        Estimasi Waktu (Jam)
                                    </label>
                                    <input type="number" 
                                           id="estimatedTime" 
                                           class="form-input-app w-full p-3"
                                           min="0"
                                           step="0.5"
                                           placeholder="e.g., 8">
                                </div>

                                <div class="form-group">
                                    <label class="form-label-app" for="status">
                                        <span class="text-red-500">*</span> Status
                                    </label>
                                    <select id="status" class="form-input-app w-full p-3" required>
                                        <option value="Running">Running</option>
                                        <option value="Done">Done</option>
                                        <option value="Close">Close</option>
                                        <option value="Pending">Pending</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label-app" for="priority">
                                        Priority
                                    </label>
                                    <select id="priority" class="form-input-app w-full p-3">
                                        <option value="Normal">Normal</option>
                                        <option value="High">High</option>
                                        <option value="Urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Man Power Section -->
                        <div class="mb-8">
                            <label class="form-label-app mb-3">Man Power</label>
                            <div class="bg-gray-50 rounded-xl p-4">
                                <div class="flex gap-3 mb-4">
                                    <div class="flex-1 relative">
                                        <input type="text" 
                                               id="manPowerInput" 
                                               class="form-input-app w-full p-3"
                                               placeholder="Enter man power name and press Enter">
                                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                            <i class="fas fa-user-plus"></i>
                                        </div>
                                    </div>
                                    <button type="button" 
                                            id="addManPowerBtn" 
                                            class="btn btn-primary whitespace-nowrap">
                                        <i class="fas fa-plus"></i>
                                        Add
                                    </button>
                                </div>
                                <div id="manPowerTags" class="manpower-tags">
                                    <!-- Tags will be added here -->
                                </div>
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div class="mb-8">
                            <label class="form-label-app mb-3" for="notes">
                                Notes
                                <span class="text-sm text-gray-500 ml-2">(Optional)</span>
                            </label>
                            <textarea id="notes" 
                                      class="form-input-app w-full p-3" 
                                      rows="4"
                                      placeholder="Add any additional notes or instructions..."></textarea>
                        </div>

                        <!-- Notes History Table -->
                        <div class="notes-section">
                            <h4 class="font-semibold text-gray-900 mb-4">Notes History</h4>
                            <table class="notes-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Note</th>
                                        <th>Created By</th>
                                    </tr>
                                </thead>
                                <tbody id="notesHistory">
                                    <!-- Notes history will be displayed here -->
                                </tbody>
                            </table>
                        </div>

                        <div class="flex justify-end gap-3 pt-8 mt-8 border-t">
                            <button type="button" 
                                    id="cancelWorkOrderBtn" 
                                    class="btn btn-secondary">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Save Work Order
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="workorderDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="bg-white rounded-xl shadow-2xl modal-content-enter" id="workorderDetailModalContent">
                <div class="sticky top-0 bg-white z-10 border-b">
                    <div class="flex justify-between items-center p-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900" id="workorderDetailTitle">Work Order Details</h2>
                            <div class="flex items-center gap-3 mt-2">
                                <span id="detailStatusBadge" class="status-badge"></span>
                                <span class="text-sm text-gray-600">Created: <span id="detailCreatedDate"></span></span>
                            </div>
                        </div>
                        <button id="closeDetailModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6 overflow-y-auto max-h-[60vh] custom-scrollbar">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="space-y-4">
                            <div class="detail-item">
                                <label class="text-sm font-medium text-gray-500">Work Order Number</label>
                                <p id="detailWorkOrderNumber" class="text-lg font-semibold text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <label class="text-sm font-medium text-gray-500">SO Number</label>
                                <p id="detailSONumber" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <label class="text-sm font-medium text-gray-500">Customer</label>
                                <p id="detailCustomer" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <label class="text-sm font-medium text-gray-500">Building</label>
                                <p id="detailBuilding" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <label class="text-sm font-medium text-gray-500">Work Type</label>
                                <p id="detailWorkType" class="text-gray-900"></p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="detail-item">
                                <label class="text-sm font-medium text-gray-500">Division</label>
                                <p id="detailDivision" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <label class="text-sm font-medium text-gray-500">Company</label>
                                <p id="detailCompany" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <label class="text-sm font-medium text-gray-500">Personnel</label>
                                <p id="detailPersonnel" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <label class="text-sm font-medium text-gray-500">Timeline</label>
                                <p class="text-gray-900">
                                    <span id="detailStartDate"></span> 
                                    <span class="mx-2"></span>
                                    <span id="detailEndDate"></span>
                                </p>
                                <p class="text-sm text-gray-600">Estimated: <span id="detailEstimatedTime"></span> hours</p>
                            </div>
                            <div class="detail-item">
                                <label class="text-sm font-medium text-gray-500">Priority</label>
                                <p id="detailPriority" class="text-gray-900"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Man Power Section -->
                    <div class="mb-6">
                        <label class="text-sm font-medium text-gray-500 mb-2 block">Man Power</label>
                        <div id="detailManPower" class="manpower-tags">
                            <!-- Man power tags will be displayed here -->
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="mb-6">
                        <label class="text-sm font-medium text-gray-500 mb-2 block">Notes</label>
                        <div id="detailNotes" class="bg-gray-50 rounded-lg p-4 text-gray-700"></div>
                    </div>

                    <!-- Notes History -->
                    <div class="notes-section">
                        <h4 class="font-semibold text-gray-900 mb-4">Notes History</h4>
                        <div id="detailNotesHistory" class="space-y-3">
                            <!-- Notes history will be displayed here -->
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-6 mt-6 border-t">
                        <button type="button" 
                                id="closeDetailBtn" 
                                class="btn btn-secondary">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                        <button type="button" 
                                id="editDetailBtn" 
                                class="btn btn-primary">
                            <i class="fas fa-edit"></i>
                            Edit Work Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Search Modal -->
    <div id="advancedSearchModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="w-full max-w-2xl">
            <div class="bg-white rounded-xl shadow-2xl modal-content-enter" id="advancedSearchModalContent">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold text-gray-900">Advanced Search</h3>
                    <p class="text-gray-600 mt-1">Filter work orders by multiple criteria</p>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label-app">Status</label>
                            <select id="filterStatus" class="form-input-app w-full p-3">
                                <option value="">All Status</option>
                                <option value="Running">Running</option>
                                <option value="Done">Done</option>
                                <option value="Close">Close</option>
                                <option value="Pending">Pending</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label-app">Division</label>
                            <select id="filterDivision" class="form-input-app w-full p-3">
                                <option value="">All Divisions</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Testcom">Testcom</option>
                                <option value="Installation">Installation</option>
                                <option value="Commissioning">Commissioning</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label-app">Company</label>
                            <select id="filterCompany" class="form-input-app w-full p-3">
                                <option value="">All Companies</option>
                                <option value="Genetek Intratama">Genetek Intratama</option>
                                <option value="Effrensindo Kencana">Effrensindo Kencana</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label-app">Personnel</label>
                            <select id="filterPersonnel" class="form-input-app w-full p-3">
                                <option value="">All Personnel</option>
                                <option value="Husni">Husni</option>
                                <option value="Heksi">Heksi</option>
                                <option value="Indra Kurniawan">Indra Kurniawan</option>
                            </select>
                        </div>
                        
                        <div class="form-group md:col-span-2">
                            <label class="form-label-app">Date Range</label>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="date" id="filterStartDate" class="form-input-app p-3">
                                <input type="date" id="filterEndDate" class="form-input-app p-3">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" id="resetFiltersBtn" class="btn btn-secondary">
                            Reset Filters
                        </button>
                        <button type="button" id="applyFiltersBtn" class="btn btn-primary">
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] hidden">
        <div class="bg-white rounded-xl p-8 shadow-2xl flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
            <p class="text-gray-700 font-medium">Loading...</p>
        </div>
    </div>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        let db, auth, workordersCollection, dropdownOptionsCollection, activitiesCollection, usersCollection;
        let workorders = [];
        let filteredWorkorders = [];
        let currentUser = null;
        let currentUserRole = 'user';
        let charts = {};
        let currentView = 'card';
        let currentTab = 'all';
        let activeFilters = {};
        
        // Unique values for history
        let uniqueCustomers = new Set();
        let uniqueBuildings = new Set();
        let uniqueWorkTypes = new Set();
        let uniqueManPower = new Set();
        let uniquePersonnel = new Set([
            'Husni', 'Heksi', 'Indra Kurniawan', 'Putra', 'Wahyu Sujoko',
            'Yudiyono', 'Edwin', 'Fiki', 'Harianto', 'Haryo'
        ]);

        // Test users for Firebase Auth (should be created in Firebase Console)
        const testUsers = {
            'admin@genetek.com': { password: 'Admin123!', role: 'admin' },
            'manager@genetek.com': { password: 'Manager123!', role: 'manager' },
            'user@genetek.com': { password: 'User123!', role: 'user' }
        };

        // ==================== INITIALIZE FIREBASE ====================
        function initializeFirebase() {
            try {
                // Check if Firebase is available
                if (typeof firebase === 'undefined') {
                    console.error('Firebase SDK not loaded');
                    return false;
                }

                // Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyAwXNGrJsBqQ2RslAkdWWPSOubUw13QcRI",
                    authDomain: "workorder-mon.firebaseapp.com",
                    projectId: "workorder-mon",
                    storageBucket: "workorder-mon.firebasestorage.app",
                    messagingSenderId: "226391173482",
                    appId: "1:226391173482:web:9ea9c68c1e31c84f50dd13"
                };

                // Initialize Firebase
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore(app);
                auth = firebase.auth(app);
                
                // Initialize collections
                workordersCollection = db.collection('workorders');
                dropdownOptionsCollection = db.collection('dropdownOptions');
                activitiesCollection = db.collection('activities');
                usersCollection = db.collection('users');
                
                console.log('Firebase initialized successfully');
                return true;
                
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                return false;
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatDate(date, includeTime = false) {
            if (!date) return '-';
            try {
                if (date.toDate) {
                    date = date.toDate();
                }
                const options = {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                };
                if (includeTime) {
                    options.hour = '2-digit';
                    options.minute = '2-digit';
                }
                return date.toLocaleDateString('id-ID', options);
            } catch (e) {
                return '-';
            }
        }

        function formatDateTime(date) {
            return formatDate(date, true);
        }

        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${getToastIcon(type)}"></i>
                <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function getToastIcon(type) {
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            return icons[type] || 'fa-info-circle';
        }

        function showLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
        }

        function capitalizeFirst(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // ==================== AUTH STATE OBSERVER ====================
        function setupAuthStateObserver() {
            if (!auth) return;
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    await getUserRoleFromFirestore(user.uid);
                    
                    // Show app page
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('appPage').classList.remove('hidden');
                    
                    // Update user info
                    document.getElementById('userWelcome').textContent = user.email;
                    document.getElementById('userRole').textContent = capitalizeFirst(currentUserRole);
                    
                    // Initialize app
                    initApp();
                    showToast('Login successful!', 'success');
                } else {
                    // User is signed out
                    currentUser = null;
                    currentUserRole = 'user';
                    document.getElementById('appPage').classList.add('hidden');
                    document.getElementById('loginPage').classList.remove('hidden');
                    
                    // Reset login form
                    const loginForm = document.getElementById('loginForm');
                    if (loginForm) loginForm.reset();
                }
            });
        }

        // ==================== LOGIN FUNCTIONS ====================
        function initLogin() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleLogin();
                });
            }
        }

        async function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            // Hide any previous error
            if (errorDiv) errorDiv.classList.add('hidden');

            // Basic validation
            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }

            // Email format validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showError('Please enter a valid email address');
                return;
            }

            try {
                showLoading();
                
                // Sign in with Firebase Auth
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // Success - auth state observer will handle the rest
                console.log('Login successful:', userCredential.user.email);
                
            } catch (error) {
                console.error('Login error:', error);
                
                let errorMessage = 'Login failed. Please try again.';
                switch(error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password. Please try again.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email format.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many failed attempts. Please try again later.';
                        break;
                }
                
                showError(errorMessage);
            } finally {
                hideLoading();
            }
        }

        async function getUserRoleFromFirestore(userId) {
            try {
                const userDoc = await usersCollection.doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role || 'user';
                    
                    // Update user info in UI
                    document.getElementById('userRole').textContent = capitalizeFirst(currentUserRole);
                } else {
                    // Create user document if it doesn't exist
                    await usersCollection.doc(userId).set({
                        email: currentUser.email,
                        role: 'user',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    currentUserRole = 'user';
                }
            } catch (error) {
                console.error('Error getting user role:', error);
                currentUserRole = 'user';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorMessage = document.getElementById('errorMessage');
            if (errorDiv && errorMessage) {
                errorMessage.textContent = message;
                errorDiv.classList.remove('hidden');
                
                // Add shake animation
                errorDiv.style.animation = 'none';
                setTimeout(() => {
                    errorDiv.style.animation = 'shake 0.5s';
                }, 10);
            }
        }

        function logout() {
            if (auth && currentUser) {
                auth.signOut().then(() => {
                    showToast('Logged out successfully', 'success');
                }).catch(error => {
                    console.error('Error signing out:', error);
                    showToast('Error signing out', 'error');
                });
            } else {
                // Fallback logout
                currentUser = null;
                currentUserRole = 'user';
                document.getElementById('appPage').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                showToast('Logged out successfully', 'success');
            }
        }

        // ==================== DROPDOWN OPTIONS ====================
        async function loadDropdownOptions() {
            try {
                const doc = await dropdownOptionsCollection.doc('options').get();
                if (doc.exists) {
                    const data = doc.data();
                    if (data.customers) uniqueCustomers = new Set(data.customers);
                    if (data.buildings) uniqueBuildings = new Set(data.buildings);
                    if (data.workTypes) uniqueWorkTypes = new Set(data.workTypes);
                    if (data.manPower) uniqueManPower = new Set(data.manPower);
                }
            } catch (error) {
                console.error('Error loading dropdown options:', error);
            }
        }

        async function saveDropdownOptions() {
            try {
                await dropdownOptionsCollection.doc('options').set({
                    customers: Array.from(uniqueCustomers),
                    buildings: Array.from(uniqueBuildings),
                    workTypes: Array.from(uniqueWorkTypes),
                    manPower: Array.from(uniqueManPower),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error saving dropdown options:', error);
            }
        }

        // ==================== WORK ORDER FUNCTIONS ====================
        async function loadWorkOrders() {
            showLoading();
            try {
                const querySnapshot = await workordersCollection.orderBy('createdAt', 'desc').get();
                workorders = [];
                uniqueCustomers.clear();
                uniqueBuildings.clear();
                uniqueWorkTypes.clear();
                uniqueManPower.clear();

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const workorder = {
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt,
                        startDate: data.startDate,
                        endDate: data.endDate
                    };
                    workorders.push(workorder);

                    // Collect unique values
                    if (data.customer) uniqueCustomers.add(data.customer);
                    if (data.building) uniqueBuildings.add(data.building);
                    if (data.workType) uniqueWorkTypes.add(data.workType);
                    if (data.manPower && Array.isArray(data.manPower)) {
                        data.manPower.forEach(mp => uniqueManPower.add(mp));
                    }
                    if (data.personnel) uniquePersonnel.add(data.personnel);
                });

                filteredWorkorders = [...workorders];
                updateStats();
                applyFiltersAndRender();
                
                // Save unique values
                await saveDropdownOptions();
                
            } catch (error) {
                console.error('Error loading work orders:', error);
                showToast('Failed to load work orders', 'error');
            } finally {
                hideLoading();
            }
        }

        function updateStats() {
            const total = workorders.length;
            const completed = workorders.filter(wo => wo.status === 'Done').length;
            const running = workorders.filter(wo => wo.status === 'Running').length;
            const pending = workorders.filter(wo => wo.status === 'Pending').length;
            const closed = workorders.filter(wo => wo.status === 'Close').length;

            document.getElementById('totalWorkOrders').textContent = formatNumber(total);
            document.getElementById('completedWorkOrders').textContent = formatNumber(completed);
            document.getElementById('runningWorkOrders').textContent = formatNumber(running);
            document.getElementById('pendingWorkOrders').textContent = formatNumber(pending);

            // Update tab counts
            document.querySelectorAll('.tab').forEach(tab => {
                const tabType = tab.dataset.tab;
                let count = 0;
                switch(tabType) {
                    case 'all': count = total; break;
                    case 'completed': count = completed; break;
                    case 'running': count = running; break;
                    case 'closed': count = closed; break;
                }
                const badge = tab.querySelector('span:last-child');
                if (badge) badge.textContent = formatNumber(count);
            });
        }

        function applyFiltersAndRender() {
            let filtered = [...workorders];
            
            // Apply tab filter
            if (currentTab !== 'all') {
                filtered = filtered.filter(wo => wo.status === capitalizeFirst(currentTab));
            }
            
            // Apply search filter
            const searchTerm = document.getElementById('searchWorkOrders').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(wo => 
                    (wo.workOrderNumber && wo.workOrderNumber.toLowerCase().includes(searchTerm)) ||
                    (wo.customer && wo.customer.toLowerCase().includes(searchTerm)) ||
                    (wo.building && wo.building.toLowerCase().includes(searchTerm)) ||
                    (wo.personnel && wo.personnel.toLowerCase().includes(searchTerm)) ||
                    (wo.workType && wo.workType.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply advanced filters
            if (activeFilters.status) {
                filtered = filtered.filter(wo => wo.status === activeFilters.status);
            }
            if (activeFilters.division) {
                filtered = filtered.filter(wo => wo.division === activeFilters.division);
            }
            if (activeFilters.company) {
                filtered = filtered.filter(wo => wo.company === activeFilters.company);
            }
            if (activeFilters.personnel) {
                filtered = filtered.filter(wo => wo.personnel === activeFilters.personnel);
            }
            if (activeFilters.startDate || activeFilters.endDate) {
                filtered = filtered.filter(wo => {
                    const woDate = wo.startDate?.toDate();
                    if (!woDate) return false;
                    
                    if (activeFilters.startDate && woDate < new Date(activeFilters.startDate)) return false;
                    if (activeFilters.endDate && woDate > new Date(activeFilters.endDate)) return false;
                    return true;
                });
            }
            
            // Apply sorting
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;
            filtered.sort((a, b) => {
                let aVal = a[sortBy];
                let bVal = b[sortBy];
                
                if (sortBy === 'createdAt' || sortBy === 'startDate' || sortBy === 'endDate') {
                    aVal = aVal?.toDate?.() || new Date(0);
                    bVal = bVal?.toDate?.() || new Date(0);
                }
                
                if (sortOrder === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            filteredWorkorders = filtered;
            renderWorkOrders();
            updateWorkOrderCount();
        }

        function renderWorkOrders() {
            const container = document.getElementById('workorders-stage');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (filteredWorkorders.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-400">
                        <i class="fas fa-inbox text-5xl mb-4 opacity-30"></i>
                        <p class="text-lg font-medium">No work orders found</p>
                        <p class="text-sm mt-1">Try adjusting your search or filters</p>
                        <button id="createFirstWorkOrder" class="mt-6 btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Create First Work Order
                        </button>
                    </div>
                `;
                return;
            }
            
            if (currentView === 'card') {
                filteredWorkorders.forEach(workorder => {
                    const card = createWorkOrderCard(workorder);
                    container.appendChild(card);
                });
            } else if (currentView === 'list') {
                const table = createWorkOrderTable();
                container.appendChild(table);
            } else if (currentView === 'timeline') {
                renderTimelineView();
            }
        }

        function createWorkOrderCard(workorder) {
            const card = document.createElement('div');
            card.className = `workorder-card ${workorder.status.toLowerCase()} animate-slide-in`;
            card.dataset.id = workorder.id;
            
            const progressPercentage = calculateProgress(workorder);
            const priorityColor = getPriorityColor(workorder.priority);
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-bold text-gray-900 text-lg mb-1">${workorder.workOrderNumber || 'N/A'}</h3>
                        <p class="text-sm text-gray-600">${workorder.customer || 'No customer'}</p>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="status-badge ${workorder.status.toLowerCase()} mb-2">
                            ${workorder.status}
                        </span>
                        ${workorder.priority ? `
                        <span class="text-xs px-2 py-1 rounded-full ${priorityColor}">
                            ${workorder.priority}
                        </span>` : ''}
                    </div>
                </div>
                
                <div class="workorder-details space-y-2 mb-4">
                    <p>
                        <i class="fas fa-building text-gray-400"></i>
                        <span class="truncate">${workorder.building || 'No building'}</span>
                    </p>
                    <p>
                        <i class="fas fa-briefcase text-gray-400"></i>
                        <span class="truncate">${workorder.workType || 'No work type'}</span>
                    </p>
                    <p>
                        <i class="fas fa-user-tie text-gray-400"></i>
                        <span class="truncate">${workorder.personnel || 'Unassigned'}</span>
                    </p>
                    <p>
                        <i class="fas fa-calendar text-gray-400"></i>
                        <span>${formatDate(workorder.startDate)}</span>
                    </p>
                </div>
                
                ${progressPercentage > 0 ? `
                <div class="mb-4">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span>Progress</span>
                        <span>${progressPercentage}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                    </div>
                </div>` : ''}
                
                <div class="workorder-footer pt-4">
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-gray-500">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-layer-group"></i>
                                <span>${workorder.division || 'No division'}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 workorder-actions">
                            <button class="view-detail-btn p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="edit-workorder-btn p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${currentUserRole === 'admin' ? `
                            <button class="delete-workorder-btn p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        function createWorkOrderTable() {
            const table = document.createElement('table');
            table.className = 'list-view';
            
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>WO Number</th>
                    <th>Customer</th>
                    <th>Building</th>
                    <th>Work Type</th>
                    <th>Division</th>
                    <th>Personnel</th>
                    <th>Start Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            `;
            
            const tbody = document.createElement('tbody');
            filteredWorkorders.forEach(workorder => {
                const row = document.createElement('tr');
                row.className = 'animate-slide-in';
                row.dataset.id = workorder.id;
                
                const priorityColor = getPriorityColor(workorder.priority);
                
                row.innerHTML = `
                    <td>
                        <div class="font-semibold text-gray-900">${workorder.workOrderNumber}</div>
                        ${workorder.priority ? `
                        <div class="text-xs mt-1">
                            <span class="px-2 py-1 rounded-full ${priorityColor}">
                                ${workorder.priority}
                            </span>
                        </div>` : ''}
                    </td>
                    <td>${workorder.customer || '-'}</td>
                    <td>${workorder.building || '-'}</td>
                    <td>${workorder.workType || '-'}</td>
                    <td>${workorder.division || '-'}</td>
                    <td>${workorder.personnel || '-'}</td>
                    <td>${formatDate(workorder.startDate)}</td>
                    <td>
                        <span class="status-badge ${workorder.status.toLowerCase()}">
                            ${workorder.status}
                        </span>
                    </td>
                    <td>
                        <div class="flex gap-2 workorder-actions">
                            <button class="view-detail-btn p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="edit-workorder-btn p-2 text-green-600 hover:bg-green-50 rounded-lg">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${currentUserRole === 'admin' ? `
                            <button class="delete-workorder-btn p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            table.appendChild(thead);
            table.appendChild(tbody);
            return table;
        }

        function renderTimelineView() {
            const container = document.getElementById('workorders-stage');
            const timelineContainer = document.getElementById('timelineView');
            
            container.classList.add('hidden');
            timelineContainer.classList.remove('hidden');
            
            const timelineContent = document.getElementById('timelineContent');
            timelineContent.innerHTML = '';
            
            // Group by month
            const groupedByMonth = {};
            filteredWorkorders.forEach(workorder => {
                const date = workorder.startDate?.toDate() || new Date();
                const monthYear = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                
                if (!groupedByMonth[monthYear]) {
                    groupedByMonth[monthYear] = [];
                }
                groupedByMonth[monthYear].push(workorder);
            });
            
            // Sort months
            const sortedMonths = Object.keys(groupedByMonth).sort((a, b) => {
                return new Date(b) - new Date(a);
            });
            
            sortedMonths.forEach(monthYear => {
                const monthHeader = document.createElement('div');
                monthHeader.className = 'mb-6';
                monthHeader.innerHTML = `
                    <h4 class="text-lg font-bold text-gray-900 mb-4">${monthYear}</h4>
                `;
                timelineContent.appendChild(monthHeader);
                
                groupedByMonth[monthYear].forEach(workorder => {
                    const timelineItem = document.createElement('div');
                    timelineItem.className = 'timeline-item';
                    
                    timelineItem.innerHTML = `
                        <div class="timeline-date">${formatDate(workorder.startDate)}</div>
                        <div class="timeline-content">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h5 class="font-semibold text-gray-900">${workorder.workOrderNumber}</h5>
                                    <p class="text-sm text-gray-600 mt-1">${workorder.customer} - ${workorder.building}</p>
                                    <p class="text-sm text-gray-600">${workorder.workType}</p>
                                </div>
                                <span class="status-badge ${workorder.status.toLowerCase()}">
                                    ${workorder.status}
                                </span>
                            </div>
                            <div class="flex gap-4 mt-3 text-sm">
                                <span class="text-gray-600">
                                    <i class="fas fa-user-tie mr-1"></i>
                                    ${workorder.personnel || 'Unassigned'}
                                </span>
                                <span class="text-gray-600">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${workorder.estimatedTime || 'N/A'} hours
                                </span>
                            </div>
                        </div>
                    `;
                    
                    timelineContent.appendChild(timelineItem);
                });
            });
        }

        function updateWorkOrderCount() {
            const countElement = document.getElementById('workOrderCount');
            if (countElement) {
                countElement.textContent = `Showing ${filteredWorkorders.length} of ${workorders.length} work orders`;
            }
        }

        function calculateProgress(workorder) {
            if (workorder.status === 'Done' || workorder.status === 'Close') return 100;
            
            if (!workorder.startDate || !workorder.endDate) return 0;
            
            const start = workorder.startDate.toDate();
            const end = workorder.endDate.toDate();
            const now = new Date();
            
            if (now >= end) return 100;
            if (now <= start) return 0;
            
            const totalDuration = end - start;
            const elapsed = now - start;
            
            return Math.min(Math.round((elapsed / totalDuration) * 100), 100);
        }

        function getPriorityColor(priority) {
            switch(priority) {
                case 'High': return 'bg-orange-100 text-orange-800';
                case 'Urgent': return 'bg-red-100 text-red-800';
                default: return 'bg-blue-100 text-blue-800';
            }
        }

        // ==================== MODAL FUNCTIONS ====================
        function openWorkOrderModal(workorderId = null) {
            const modal = document.getElementById('workorderModal');
            const modalTitle = document.getElementById('modalTitle');
            
            resetModalForm();
            
            if (workorderId) {
                modalTitle.textContent = 'Edit Work Order';
                const workorder = workorders.find(wo => wo.id === workorderId);
                if (workorder) {
                    populateModalForm(workorder);
                }
            } else {
                modalTitle.textContent = 'Create New Work Order';
                // Set default values
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('startDate').value = today;
                document.getElementById('status').value = 'Running';
                document.getElementById('priority').value = 'Normal';
                document.getElementById('workOrderNumber').value = generateWorkOrderNumber();
            }
            
            modal.classList.remove('hidden');
        }

        function generateWorkOrderNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const count = workorders.filter(wo => {
                const woDate = wo.createdAt?.toDate();
                return woDate && woDate.getMonth() === now.getMonth() && woDate.getFullYear() === year;
            }).length + 1;
            return `WO-${year}${month}-${count.toString().padStart(3, '0')}`;
        }

        function closeWorkOrderModal() {
            const modal = document.getElementById('workorderModal');
            modal.classList.add('hidden');
        }

        function resetModalForm() {
            document.getElementById('workorderForm').reset();
            document.getElementById('workorderId').value = '';
            document.getElementById('manPowerTags').innerHTML = '';
            document.getElementById('notesHistory').innerHTML = '';
        }

        function populateModalForm(workorder) {
            document.getElementById('workorderId').value = workorder.id;
            document.getElementById('workOrderNumber').value = workorder.workOrderNumber || '';
            document.getElementById('soNumber').value = workorder.soNumber || '';
            document.getElementById('customer').value = workorder.customer || '';
            document.getElementById('building').value = workorder.building || '';
            document.getElementById('division').value = workorder.division || '';
            document.getElementById('company').value = workorder.company || '';
            document.getElementById('workType').value = workorder.workType || '';
            document.getElementById('personnel').value = workorder.personnel || '';
            document.getElementById('status').value = workorder.status || 'Running';
            document.getElementById('priority').value = workorder.priority || 'Normal';
            document.getElementById('estimatedTime').value = workorder.estimatedTime || '';
            document.getElementById('notes').value = workorder.notes || '';
            
            // Dates
            if (workorder.startDate) {
                const startDate = workorder.startDate.toDate();
                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            }
            if (workorder.endDate) {
                const endDate = workorder.endDate.toDate();
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            }
            
            // Man Power
            if (workorder.manPower && Array.isArray(workorder.manPower)) {
                workorder.manPower.forEach(mp => addManPowerTag(mp));
            }
            
            // Notes History
            if (workorder.notesHistory && Array.isArray(workorder.notesHistory)) {
                renderNotesHistory(workorder.notesHistory);
            }
        }

        function addManPowerTag(name) {
            if (!name.trim()) return;
            
            const container = document.getElementById('manPowerTags');
            const tagId = `tag-${Date.now()}`;
            
            const tag = document.createElement('div');
            tag.className = 'manpower-tag';
            tag.innerHTML = `
                ${name.trim()}
                <span class="remove-tag" onclick="removeManPowerTag(this)">
                    <i class="fas fa-times"></i>
                </span>
            `;
            
            container.appendChild(tag);
            document.getElementById('manPowerInput').value = '';
        }

        function removeManPowerTag(element) {
            element.closest('.manpower-tag').remove();
        }

        function renderNotesHistory(notesHistory) {
            const container = document.getElementById('notesHistory');
            container.innerHTML = '';
            
            notesHistory.forEach(note => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDateTime(note.timestamp)}</td>
                    <td>${note.note}</td>
                    <td>${note.createdBy || '-'}</td>
                `;
                container.appendChild(row);
            });
        }

        async function saveWorkOrder() {
            const form = document.getElementById('workorderForm');
            if (!form.checkValidity()) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            const workorderId = document.getElementById('workorderId').value;
            const isEdit = !!workorderId;
            
            const workorderData = {
                workOrderNumber: document.getElementById('workOrderNumber').value,
                soNumber: document.getElementById('soNumber').value,
                customer: document.getElementById('customer').value,
                building: document.getElementById('building').value,
                division: document.getElementById('division').value,
                company: document.getElementById('company').value,
                workType: document.getElementById('workType').value,
                personnel: document.getElementById('personnel').value,
                status: document.getElementById('status').value,
                priority: document.getElementById('priority').value,
                estimatedTime: parseFloat(document.getElementById('estimatedTime').value) || null,
                notes: document.getElementById('notes').value,
                manPower: Array.from(document.querySelectorAll('.manpower-tag'))
                    .map(tag => tag.textContent.trim().replace('', '')),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser.email
            };
            
            // Dates
            const startDate = document.getElementById('startDate').value;
            if (startDate) {
                workorderData.startDate = firebase.firestore.Timestamp.fromDate(new Date(startDate));
            }
            
            const endDate = document.getElementById('endDate').value;
            if (endDate) {
                workorderData.endDate = firebase.firestore.Timestamp.fromDate(new Date(endDate));
            }
            
            // Collect unique values
            if (workorderData.customer) uniqueCustomers.add(workorderData.customer);
            if (workorderData.building) uniqueBuildings.add(workorderData.building);
            if (workorderData.workType) uniqueWorkTypes.add(workorderData.workType);
            workorderData.manPower.forEach(mp => uniqueManPower.add(mp));
            
            try {
                showLoading();
                
                if (isEdit) {
                    // Get existing work order for notes history
                    const existingWorkorder = workorders.find(wo => wo.id === workorderId);
                    let notesHistory = existingWorkorder?.notesHistory || [];
                    
                    // Add new note to history if provided
                    if (workorderData.notes && workorderData.notes.trim()) {
                        notesHistory.push({
                            note: workorderData.notes.trim(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: currentUser.email
                        });
                    }
                    
                    workorderData.notesHistory = notesHistory;
                    await workordersCollection.doc(workorderId).update(workorderData);
                    showToast('Work order updated successfully', 'success');
                } else {
                    // For new work order
                    if (workorderData.notes && workorderData.notes.trim()) {
                        workorderData.notesHistory = [{
                            note: workorderData.notes.trim(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: currentUser.email
                        }];
                    } else {
                        workorderData.notesHistory = [];
                    }
                    
                    workorderData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    workorderData.createdBy = currentUser.email;
                    await workordersCollection.add(workorderData);
                    showToast('Work order created successfully', 'success');
                }
                
                // Save dropdown options
                await saveDropdownOptions();
                
                // Reload data
                await loadWorkOrders();
                closeWorkOrderModal();
                
                // Log activity
                await logActivity(
                    isEdit ? 'updated' : 'created',
                    'work order',
                    workorderData.workOrderNumber
                );
                
            } catch (error) {
                console.error('Error saving work order:', error);
                showToast('Failed to save work order', 'error');
            } finally {
                hideLoading();
            }
        }

        function openWorkOrderDetailModal(workorderId) {
            const modal = document.getElementById('workorderDetailModal');
            const workorder = workorders.find(wo => wo.id === workorderId);
            
            if (!workorder) {
                showToast('Work order not found', 'error');
                return;
            }
            
            // Populate details
            document.getElementById('workorderDetailTitle').textContent = 
                `Work Order: ${workorder.workOrderNumber}`;
            document.getElementById('detailWorkOrderNumber').textContent = workorder.workOrderNumber;
            document.getElementById('detailSONumber').textContent = workorder.soNumber || '-';
            document.getElementById('detailCustomer').textContent = workorder.customer || '-';
            document.getElementById('detailBuilding').textContent = workorder.building || '-';
            document.getElementById('detailWorkType').textContent = workorder.workType || '-';
            document.getElementById('detailDivision').textContent = workorder.division || '-';
            document.getElementById('detailCompany').textContent = workorder.company || '-';
            document.getElementById('detailPersonnel').textContent = workorder.personnel || '-';
            document.getElementById('detailPriority').textContent = workorder.priority || 'Normal';
            document.getElementById('detailStartDate').textContent = formatDate(workorder.startDate);
            document.getElementById('detailEndDate').textContent = workorder.endDate ? formatDate(workorder.endDate) : '-';
            document.getElementById('detailEstimatedTime').textContent = workorder.estimatedTime ? `${workorder.estimatedTime} hours` : '-';
            document.getElementById('detailCreatedDate').textContent = formatDate(workorder.createdAt);
            document.getElementById('detailNotes').textContent = workorder.notes || 'No notes';
            
            // Status badge
            const statusBadge = document.getElementById('detailStatusBadge');
            statusBadge.className = `status-badge ${workorder.status.toLowerCase()}`;
            statusBadge.textContent = workorder.status;
            
            // Man Power
            const manPowerContainer = document.getElementById('detailManPower');
            manPowerContainer.innerHTML = '';
            if (workorder.manPower && Array.isArray(workorder.manPower)) {
                workorder.manPower.forEach(mp => {
                    const tag = document.createElement('div');
                    tag.className = 'manpower-tag';
                    tag.textContent = mp;
                    manPowerContainer.appendChild(tag);
                });
            }
            
            // Notes History
            const notesHistoryContainer = document.getElementById('detailNotesHistory');
            notesHistoryContainer.innerHTML = '';
            if (workorder.notesHistory && Array.isArray(workorder.notesHistory)) {
                workorder.notesHistory.forEach(note => {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'bg-gray-50 rounded-lg p-4';
                    noteDiv.innerHTML = `
                        <p class="text-gray-700">${note.note}</p>
                        <p class="text-xs text-gray-500 mt-2">
                            ${formatDateTime(note.timestamp)} - ${note.createdBy || 'System'}
                        </p>
                    `;
                    notesHistoryContainer.appendChild(noteDiv);
                });
            }
            
            // Set edit button data-id
            document.getElementById('editDetailBtn').dataset.id = workorderId;
            
            modal.classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('workorderDetailModal').classList.add('hidden');
        }

        function openAnalyticsModal() {
            renderCharts();
            document.getElementById('analyticsModal').classList.remove('hidden');
        }

        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').classList.add('hidden');
        }

        function openActivityModal() {
            loadActivityFeed();
            document.getElementById('activityModal').classList.remove('hidden');
        }

        function closeActivityModal() {
            document.getElementById('activityModal').classList.add('hidden');
        }

        // ==================== CHARTS ====================
        function renderCharts() {
            renderStatusChart();
            renderDivisionChart();
            renderCompanyChart();
            renderTimelineChart();
        }

        function renderStatusChart() {
            const ctx = document.getElementById('statusChart')?.getContext('2d');
            if (!ctx) return;
            
            // Destroy existing chart
            if (charts.statusChart) charts.statusChart.destroy();
            
            const statusData = {
                'Running': 0,
                'Done': 0,
                'Close': 0,
                'Pending': 0
            };
            
            workorders.forEach(wo => {
                statusData[wo.status] = (statusData[wo.status] || 0) + 1;
            });
            
            charts.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusData),
                    datasets: [{
                        data: Object.values(statusData),
                        backgroundColor: [
                            '#3b82f6', // Running - blue
                            '#10b981', // Done - green
                            '#6b7280', // Close - gray
                            '#f59e0b'  // Pending - orange
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Work Orders by Status',
                            font: { size: 14 }
                        }
                    }
                }
            });
        }

        function renderDivisionChart() {
            const ctx = document.getElementById('divisionChart')?.getContext('2d');
            if (!ctx) return;
            
            if (charts.divisionChart) charts.divisionChart.destroy();
            
            const divisionData = {};
            workorders.forEach(wo => {
                divisionData[wo.division] = (divisionData[wo.division] || 0) + 1;
            });
            
            charts.divisionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(divisionData),
                    datasets: [{
                        label: 'Work Orders',
                        data: Object.values(divisionData),
                        backgroundColor: '#8b5cf6',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Work Orders by Division',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        function renderCompanyChart() {
            const ctx = document.getElementById('companyChart')?.getContext('2d');
            if (!ctx) return;
            
            if (charts.companyChart) charts.companyChart.destroy();
            
            const companyData = {};
            workorders.forEach(wo => {
                companyData[wo.company] = (companyData[wo.company] || 0) + 1;
            });
            
            charts.companyChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(companyData),
                    datasets: [{
                        data: Object.values(companyData),
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#8b5cf6',
                            '#ec4899'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Work Orders by Company',
                            font: { size: 14 }
                        }
                    }
                }
            });
        }

        function renderTimelineChart() {
            const ctx = document.getElementById('timelineChart')?.getContext('2d');
            if (!ctx) return;
            
            if (charts.timelineChart) charts.timelineChart.destroy();
            
            // Group by month
            const monthlyData = {};
            workorders.forEach(wo => {
                if (wo.createdAt) {
                    const date = wo.createdAt.toDate();
                    const monthYear = date.toLocaleDateString('id-ID', { month: 'short', year: '2-digit' });
                    monthlyData[monthYear] = (monthlyData[monthYear] || 0) + 1;
                }
            });
            
            // Sort by date
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                return new Date(a) - new Date(b);
            });
            
            charts.timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Work Orders Created',
                        data: sortedMonths.map(month => monthlyData[month]),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Work Orders Trend',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // ==================== ACTIVITY FEED ====================
        async function loadActivityFeed() {
            try {
                const querySnapshot = await activitiesCollection
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                const container = document.getElementById('activityFeed');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (querySnapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-inbox text-4xl mb-3 opacity-30"></i>
                            <p>No recent activity</p>
                        </div>
                    `;
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    const activity = doc.data();
                    const activityItem = document.createElement('div');
                    activityItem.className = 'flex items-start gap-3 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors';
                    
                    // Determine icon based on activity type
                    let icon = 'fa-history';
                    let iconColor = 'text-blue-600';
                    let bgColor = 'bg-blue-100';
                    
                    if (activity.type === 'work order') {
                        if (activity.message.includes('created')) {
                            icon = 'fa-plus-circle';
                            iconColor = 'text-green-600';
                            bgColor = 'bg-green-100';
                        } else if (activity.message.includes('updated')) {
                            icon = 'fa-edit';
                            iconColor = 'text-blue-600';
                            bgColor = 'bg-blue-100';
                        } else if (activity.message.includes('deleted')) {
                            icon = 'fa-trash';
                            iconColor = 'text-red-600';
                            bgColor = 'bg-red-100';
                        }
                    }
                    
                    activityItem.innerHTML = `
                        <div class="w-8 h-8 rounded-full ${bgColor} flex items-center justify-center flex-shrink-0">
                            <i class="fas ${icon} ${iconColor}"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-800">${activity.message}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="far fa-clock mr-1"></i>
                                ${formatDateTime(activity.timestamp)}
                            </p>
                        </div>
                    `;
                    
                    container.appendChild(activityItem);
                });
                
            } catch (error) {
                console.error('Error loading activity feed:', error);
                showToast('Failed to load activity feed', 'error');
            }
        }

        async function logActivity(action, type, itemName) {
            try {
                await activitiesCollection.add({
                    message: `${currentUser.email} ${action} a ${type}: ${itemName}`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userEmail: currentUser.email,
                    type: type
                });
                
                // Reload activity feed if modal is open
                if (!document.getElementById('activityModal').classList.contains('hidden')) {
                    loadActivityFeed();
                }
                
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }

        // ==================== EVENT LISTENERS ====================
        function initApp() {
            // Load initial data
            loadDropdownOptions();
            loadWorkOrders();
            loadActivityFeed();
            
            // Header buttons
            document.getElementById('newWorkOrderBtn').addEventListener('click', () => openWorkOrderModal());
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('analyticsBtn').addEventListener('click', openAnalyticsModal);
            document.getElementById('activityBtn').addEventListener('click', openActivityModal);
            document.getElementById('authButton').addEventListener('click', logout);
            
            // Search
            document.getElementById('searchWorkOrders').addEventListener('input', applyFiltersAndRender);
            document.getElementById('advancedSearchBtn').addEventListener('click', openAdvancedSearch);
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    applyFiltersAndRender();
                });
            });
            
            // View toggle
            document.getElementById('cardViewBtn').addEventListener('click', () => switchView('card'));
            document.getElementById('listViewBtn').addEventListener('click', () => switchView('list'));
            document.getElementById('timelineViewBtn').addEventListener('click', () => switchView('timeline'));
            
            // Sorting
            document.getElementById('sortBy').addEventListener('change', applyFiltersAndRender);
            document.getElementById('sortOrder').addEventListener('change', applyFiltersAndRender);
            
            // Modal buttons
            document.getElementById('closeWorkOrderModal').addEventListener('click', closeWorkOrderModal);
            document.getElementById('cancelWorkOrderBtn').addEventListener('click', closeWorkOrderModal);
            document.getElementById('workorderForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveWorkOrder();
            });
            
            // Man Power
            document.getElementById('addManPowerBtn').addEventListener('click', () => {
                const input = document.getElementById('manPowerInput');
                addManPowerTag(input.value);
            });
            
            document.getElementById('manPowerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addManPowerTag(e.target.value);
                }
            });
            
            // Detail modal
            document.getElementById('closeDetailModal').addEventListener('click', closeDetailModal);
            document.getElementById('closeDetailBtn').addEventListener('click', closeDetailModal);
            document.getElementById('editDetailBtn').addEventListener('click', function() {
                const workorderId = this.dataset.id;
                closeDetailModal();
                setTimeout(() => openWorkOrderModal(workorderId), 300);
            });
            
            // Analytics modal
            document.getElementById('closeAnalyticsModal').addEventListener('click', closeAnalyticsModal);
            document.getElementById('chartTimeRange').addEventListener('change', renderCharts);
            
            // Activity modal
            document.getElementById('closeActivityModal').addEventListener('click', closeActivityModal);
            
            // Advanced Search
            document.getElementById('applyFiltersBtn').addEventListener('click', applyAdvancedFilters);
            document.getElementById('resetFiltersBtn').addEventListener('click', resetAdvancedFilters);
            
            // Event delegation for dynamic elements
            document.addEventListener('click', function(e) {
                // View detail
                if (e.target.closest('.view-detail-btn')) {
                    const card = e.target.closest('.workorder-card, tr');
                    if (card) {
                        const workorderId = card.dataset.id;
                        openWorkOrderDetailModal(workorderId);
                    }
                }
                
                // Edit work order
                if (e.target.closest('.edit-workorder-btn')) {
                    const card = e.target.closest('.workorder-card, tr');
                    if (card) {
                        const workorderId = card.dataset.id;
                        openWorkOrderModal(workorderId);
                    }
                }
                
                // Delete work order (admin only)
                if (e.target.closest('.delete-workorder-btn') && currentUserRole === 'admin') {
                    const card = e.target.closest('.workorder-card, tr');
                    if (card) {
                        const workorderId = card.dataset.id;
                        deleteWorkOrder(workorderId);
                    }
                }
                
                // Create first work order
                if (e.target.closest('#createFirstWorkOrder')) {
                    openWorkOrderModal();
                }
            });
        }

        function switchView(view) {
            currentView = view;
            
            // Update active button
            document.getElementById('cardViewBtn').classList.toggle('active', view === 'card');
            document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
            document.getElementById('timelineViewBtn').classList.toggle('active', view === 'timeline');
            
            // Show/hide containers
            const workorderStage = document.getElementById('workorders-stage');
            const timelineView = document.getElementById('timelineView');
            
            if (view === 'timeline') {
                workorderStage.classList.add('hidden');
                timelineView.classList.remove('hidden');
                renderTimelineView();
            } else {
                workorderStage.classList.remove('hidden');
                timelineView.classList.add('hidden');
                applyFiltersAndRender();
            }
        }

        function openAdvancedSearch() {
            const modal = document.getElementById('advancedSearchModal');
            modal.classList.remove('hidden');
        }

        function closeAdvancedSearch() {
            document.getElementById('advancedSearchModal').classList.add('hidden');
        }

        function applyAdvancedFilters() {
            activeFilters = {
                status: document.getElementById('filterStatus').value || null,
                division: document.getElementById('filterDivision').value || null,
                company: document.getElementById('filterCompany').value || null,
                personnel: document.getElementById('filterPersonnel').value || null,
                startDate: document.getElementById('filterStartDate').value || null,
                endDate: document.getElementById('filterEndDate').value || null
            };
            
            applyFiltersAndRender();
            closeAdvancedSearch();
        }

        function resetAdvancedFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDivision').value = '';
            document.getElementById('filterCompany').value = '';
            document.getElementById('filterPersonnel').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            
            activeFilters = {};
            applyFiltersAndRender();
            closeAdvancedSearch();
        }

        async function deleteWorkOrder(workorderId) {
            if (!confirm('Are you sure you want to delete this work order?')) return;
            
            try {
                const workorder = workorders.find(wo => wo.id === workorderId);
                await workordersCollection.doc(workorderId).delete();
                
                showToast('Work order deleted successfully', 'success');
                await logActivity('deleted', 'work order', workorder.workOrderNumber);
                await loadWorkOrders();
                
            } catch (error) {
                console.error('Error deleting work order:', error);
                showToast('Failed to delete work order', 'error');
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        function exportToExcel() {
            if (currentUserRole !== 'admin') {
                showToast('Only admins can export data', 'warning');
                return;
            }
            
            try {
                // Create worksheet data
                const worksheetData = filteredWorkorders.map(wo => ({
                    'Work Order Number': wo.workOrderNumber,
                    'SO Number': wo.soNumber || '',
                    'Customer': wo.customer,
                    'Building': wo.building,
                    'Division': wo.division,
                    'Company': wo.company,
                    'Work Type': wo.workType,
                    'Personnel': wo.personnel || '',
                    'Man Power': Array.isArray(wo.manPower) ? wo.manPower.join(', ') : '',
                    'Start Date': formatDate(wo.startDate),
                    'End Date': formatDate(wo.endDate),
                    'Estimated Time': wo.estimatedTime || '',
                    'Status': wo.status,
                    'Priority': wo.priority || '',
                    'Notes': wo.notes || '',
                    'Created At': formatDateTime(wo.createdAt),
                    'Created By': wo.createdBy || ''
                }));
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(worksheetData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Work Orders');
                
                // Generate filename
                const date = new Date();
                const filename = `Work_Orders_${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}.xlsx`;
                
                // Export
                XLSX.writeFile(wb, filename);
                
                showToast('Data exported successfully', 'success');
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showToast('Failed to export data', 'error');
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Work Order Management System initializing...');
            
            // Initialize Firebase
            const firebaseInitialized = initializeFirebase();
            
            if (!firebaseInitialized) {
                console.log('Firebase initialization failed');
                showToast('Firebase initialization failed. Some features may not work.', 'warning');
            }
            
            // Initialize login and auth state observer
            initLogin();
            setupAuthStateObserver();
            
            // Add CSS animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                    20%, 40%, 60%, 80% { transform: translateX(5px); }
                }
                
                .view-toggle {
                    display: flex;
                    gap: 0.5rem;
                }
                
                .view-toggle-btn {
                    padding: 0.75rem 1.5rem;
                    border-radius: 8px;
                    background: #f8fafc;
                    border: 1px solid #e5e7eb;
                    cursor: pointer;
                    transition: all 0.3s;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.5rem;
                    font-weight: 500;
                }

                .view-toggle-btn.active {
                    background: var(--primary-color);
                    color: white;
                    border-color: var(--primary-color);
                }
                
                .chart-container {
                    background: white;
                    border-radius: 12px;
                    padding: 1.5rem;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
                }
                
                .detail-item {
                    margin-bottom: 1rem;
                }
                
                .detail-item label {
                    display: block;
                    margin-bottom: 0.25rem;
                }
                
                .detail-item p {
                    font-size: 0.95rem;
                    color: #1f2937;
                }
            `;
            document.head.appendChild(style);
        });

        // Expose function to global scope
        window.removeManPowerTag = removeManPowerTag;

    </script>
</body>
</html>
