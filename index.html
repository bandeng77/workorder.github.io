<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Order Management System</title>
    
    <!-- Load Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* ==================== VARIABLES ==================== */
        :root {
            /* Color Palette - Modern & Professional */
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
            
            --secondary-50: #fdf2f8;
            --secondary-100: #fce7f3;
            --secondary-200: #fbcfe8;
            --secondary-300: #f9a8d4;
            --secondary-400: #f472b6;
            --secondary-500: #ec4899;
            --secondary-600: #db2777;
            --secondary-700: #be185d;
            --secondary-800: #9d174d;
            --secondary-900: #831843;
            
            --accent-50: #f0fdf4;
            --accent-100: #dcfce7;
            --accent-200: #bbf7d0;
            --accent-300: #86efac;
            --accent-400: #4ade80;
            --accent-500: #22c55e;
            --accent-600: #16a34a;
            --accent-700: #15803d;
            --accent-800: #166534;
            --accent-900: #14532d;
            
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;
            
            /* Semantic Colors */
            --success-500: #10b981;
            --success-600: #059669;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            --danger-500: #ef4444;
            --danger-600: #dc2626;
            --info-500: #3b82f6;
            --info-600: #2563eb;
            
            /* Status Colors */
            --status-running: #3b82f6;
            --status-done: #10b981;
            --status-close: #94a3b8;
            
            /* Priority Colors */
            --priority-high: #f87171;
            --priority-urgent: #ef4444;
            --priority-normal: #3b82f6;
            --priority-low: #94a3b8;
            
            /* UI Variables */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ==================== BASE STYLES ==================== */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--neutral-50) 0%, #ffffff 100%);
            min-height: 100vh;
            color: var(--neutral-800);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ==================== GRADIENT BACKGROUNDS ==================== */
        .gradient-bg-primary {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-700) 100%);
        }

        .gradient-bg-secondary {
            background: linear-gradient(135deg, var(--secondary-500) 0%, var(--secondary-700) 100%);
        }

        .gradient-bg-accent {
            background: linear-gradient(135deg, var(--accent-500) 0%, var(--accent-700) 100%);
        }

        .gradient-bg-success {
            background: linear-gradient(135deg, var(--success-500) 0%, var(--success-700) 100%);
        }

        .gradient-bg-warning {
            background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-700) 100%);
        }

        .gradient-bg-danger {
            background: linear-gradient(135deg, var(--danger-500) 0%, var(--danger-700) 100%);
        }

        .gradient-bg-info {
            background: linear-gradient(135deg, var(--info-500) 0%, var(--info-700) 100%);
        }

        .gradient-bg-neutral {
            background: linear-gradient(135deg, var(--neutral-100) 0%, var(--neutral-50) 100%);
        }

        /* ==================== ELEGANT LOGIN PAGE ==================== */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        .login-bg-pattern {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
            z-index: 1;
        }

        .login-box {
            width: 100%;
            max-width: 440px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 10;
            overflow: hidden;
        }

        .login-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
            animation: gradient-shift 3s ease infinite;
            background-size: 400% 400%;
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .login-header {
            padding: 2.5rem 2.5rem 1.5rem;
            text-align: center;
        }

        .login-logo {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            color: white;
            font-size: 2rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .login-logo::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shine 3s infinite linear;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .login-title {
            font-weight: 700;
            font-size: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.025em;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: var(--neutral-600);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .login-body {
            padding: 0 2.5rem 2.5rem;
        }

        .form-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--neutral-700);
            font-size: 0.9rem;
            transition: var(--transition-fast);
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            background: white;
            transition: var(--transition-base);
            color: var(--neutral-800);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input-icon {
            position: absolute;
            left: 1rem;
            top: 2.5rem;
            transform: translateY(-50%);
            color: var(--neutral-400);
            transition: var(--transition-fast);
        }

        .form-input:focus + .form-input-icon {
            color: var(--primary-500);
        }

        .btn-login {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        .login-footer {
            padding: 1.5rem 2.5rem;
            border-top: 1px solid var(--neutral-200);
            text-align: center;
            color: var(--neutral-500);
            font-size: 0.85rem;
            background: var(--neutral-50);
        }

        /* ==================== MAIN APP STYLES ==================== */
        .app-header {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-800) 100%);
            color: white;
            padding: 1.5rem 0;
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        .app-logo {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .app-title {
            font-weight: 800;
            font-size: 2.25rem;
            letter-spacing: -0.025em;
            background: linear-gradient(135deg, #ffffff 0%, rgba(255,255,255,0.9) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .app-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            font-weight: 500;
        }

        /* ==================== COLORFUL BUTTONS ==================== */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            font-size: 0.875rem;
            transition: var(--transition-base);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-slow);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-500) 0%, var(--secondary-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-500) 0%, var(--accent-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-500) 0%, var(--danger-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-500) 0%, var(--info-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-500);
            color: var(--primary-600);
        }

        .btn-outline:hover {
            background: var(--primary-500);
            color: white;
        }

        /* ==================== COLORFUL CARDS ==================== */
        .card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--secondary-500), var(--accent-500));
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        .card-primary {
            border-top: 4px solid var(--primary-500);
        }

        .card-secondary {
            border-top: 4px solid var(--secondary-500);
        }

        .card-success {
            border-top: 4px solid var(--accent-500);
        }

        .card-warning {
            border-top: 4px solid var(--warning-500);
        }

        .card-danger {
            border-top: 4px solid var(--danger-500);
        }

        /* ==================== WORK ORDER CARDS ==================== */
        .workorder-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            transition: var(--transition-base);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .workorder-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            transition: var(--transition-base);
        }

        .workorder-card.running::before {
            background: linear-gradient(to bottom, var(--status-running), var(--primary-400));
        }

        .workorder-card.done::before {
            background: linear-gradient(to bottom, var(--status-done), var(--accent-400));
        }

        .workorder-card.close::before {
            background: linear-gradient(to bottom, var(--status-close), var(--neutral-400));
        }

        .workorder-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .workorder-card:hover::before {
            width: 8px;
        }

        /* ==================== COLORFUL BADGES ==================== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            white-space: nowrap;
        }

        .badge-primary {
            background: linear-gradient(135deg, var(--primary-100), var(--primary-50));
            color: var(--primary-700);
            border: 1px solid var(--primary-200);
        }

        .badge-secondary {
            background: linear-gradient(135deg, var(--secondary-100), var(--secondary-50));
            color: var(--secondary-700);
            border: 1px solid var(--secondary-200);
        }

        .badge-success {
            background: linear-gradient(135deg, var(--accent-100), var(--accent-50));
            color: var(--accent-700);
            border: 1px solid var(--accent-200);
        }

        .badge-warning {
            background: linear-gradient(135deg, #fef3c7, #fffbeb);
            color: var(--warning-700);
            border: 1px solid #fbbf24;
        }

        .badge-danger {
            background: linear-gradient(135deg, #fee2e2, #fef2f2);
            color: var(--danger-700);
            border: 1px solid #fca5a5;
        }

        .badge-info {
            background: linear-gradient(135deg, #dbeafe, #eff6ff);
            color: var(--info-700);
            border: 1px solid #93c5fd;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: white;
        }

        .status-running {
            background: linear-gradient(135deg, var(--status-running), var(--primary-400));
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .status-done {
            background: linear-gradient(135deg, var(--status-done), var(--accent-400));
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .status-close {
            background: linear-gradient(135deg, var(--status-close), var(--neutral-400));
            box-shadow: 0 2px 4px rgba(148, 163, 184, 0.3);
        }

        /* Priority Badges */
        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .priority-high {
            background: linear-gradient(135deg, #fecaca, #fee2e2);
            color: var(--danger-700);
            border: 1px solid #fca5a5;
        }

        .priority-urgent {
            background: linear-gradient(135deg, #fca5a5, #fecaca);
            color: #991b1b;
            border: 1px solid #f87171;
        }

        .priority-normal {
            background: linear-gradient(135deg, #bfdbfe, #dbeafe);
            color: var(--info-700);
            border: 1px solid #93c5fd;
        }

        .priority-low {
            background: linear-gradient(135deg, #e2e8f0, #f1f5f9);
            color: var(--neutral-700);
            border: 1px solid #cbd5e1;
        }

        /* ==================== COLORFUL TABS ==================== */
        .tabs {
            display: flex;
            gap: 0.5rem;
            background: white;
            padding: 0.5rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
        }

        .tab {
            flex: 1;
            padding: 0.875rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-base);
            font-weight: 600;
            color: var(--neutral-600);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .tab::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-500), var(--secondary-500));
            transform: translateY(100%);
            transition: var(--transition-base);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary-50), var(--secondary-50));
            color: var(--primary-700);
            box-shadow: var(--shadow-sm);
        }

        .tab.active::before {
            transform: translateY(0);
        }

        .tab:hover:not(.active) {
            background: var(--neutral-50);
            color: var(--neutral-700);
        }

        .tab-count {
            background: linear-gradient(135deg, var(--primary-100), var(--primary-200));
            color: var(--primary-700);
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            min-width: 1.5rem;
            text-align: center;
        }

        /* ==================== COLORFUL MODALS ==================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            max-width: 1400px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary-500), var(--secondary-500), var(--accent-500));
        }

        .modal-header {
            padding: 1.75rem 2rem;
            background: linear-gradient(135deg, var(--neutral-800), var(--neutral-900));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 2rem;
            right: 2rem;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, rgba(255,255,255,0.9));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            max-height: calc(90vh - 8rem);
        }

        /* ==================== FORM STYLES ==================== */
        .form-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            position: relative;
            overflow: hidden;
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-500), var(--secondary-500));
        }

        .form-section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-section-icon {
            width: 2.25rem;
            height: 2.25rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.125rem;
        }

        .form-section-icon-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        }

        .form-section-icon-secondary {
            background: linear-gradient(135deg, var(--secondary-500), var(--secondary-600));
        }

        .form-section-icon-success {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-600));
        }

        .form-section-icon-warning {
            background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
        }

        .form-section-icon-info {
            background: linear-gradient(135deg, var(--info-500), var(--info-600));
        }

        /* ==================== CAMERA STYLES ==================== */
        .camera-container {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: var(--radius-xl);
            overflow: hidden;
            background: #000;
        }

        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            position: absolute;
            bottom: 1rem;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 1rem;
            z-index: 10;
        }

        .camera-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-base);
            box-shadow: var(--shadow-lg);
        }

        .camera-btn:hover {
            transform: scale(1.1);
        }

        .camera-btn-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            width: 64px;
            height: 64px;
        }

        .camera-btn-danger {
            background: linear-gradient(135deg, var(--danger-500), var(--danger-600));
            color: white;
        }

        .camera-btn-success {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-600));
            color: white;
        }

        .camera-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-switch-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 10;
        }

        /* ==================== PHOTO PREVIEW STYLES ==================== */
        .photo-preview-container {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--neutral-50), var(--neutral-100));
            border-radius: var(--radius-xl);
            border: 2px dashed var(--neutral-300);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .photo-item {
            position: relative;
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: var(--transition-base);
        }

        .photo-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .photo-img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            cursor: pointer;
        }

        .photo-info {
            padding: 0.75rem;
            background: white;
        }

        .photo-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .photo-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-base);
            border: 1px solid var(--neutral-200);
        }

        .photo-action-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .photo-preview-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 1rem;
        }

        .photo-preview-content {
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            background: black;
            border-radius: var(--radius-xl);
            overflow: hidden;
            position: relative;
        }

        .photo-preview-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: black;
        }

        .preview-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 3rem;
            height: 3rem;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition-base);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .preview-close-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }

        /* ==================== CAPTURED PHOTO PREVIEW ==================== */
        .captured-photo-container {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--neutral-50), var(--neutral-100));
            border-radius: var(--radius-xl);
            border: 2px solid var(--primary-300);
        }

        .captured-photo {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: var(--radius-lg);
            background: #f8fafc;
            margin-bottom: 1rem;
        }

        .capture-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .capture-timestamp {
            font-size: 0.875rem;
            color: var(--neutral-600);
        }

        /* ==================== AUTCOMPLETE STYLES ==================== */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition-fast);
            border-bottom: 1px solid var(--neutral-100);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.active {
            background: var(--primary-50);
        }

        .autocomplete-info {
            font-size: 0.75rem;
            color: var(--neutral-500);
            margin-top: 0.25rem;
        }

        .highlight {
            background-color: rgba(59, 130, 246, 0.2);
            padding: 0 2px;
            border-radius: 2px;
            font-weight: 600;
        }

        /* ==================== TOAST NOTIFICATIONS ==================== */
        .toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            background: white;
            color: var(--neutral-800);
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 320px;
            transform: translateX(100%);
            opacity: 0;
            transition: var(--transition-base);
            border-left: 4px solid var(--primary-500);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left-color: var(--accent-500);
        }

        .toast.warning {
            border-left-color: var(--warning-500);
        }

        .toast.error {
            border-left-color: var(--danger-500);
        }

        .toast.info {
            border-left-color: var(--info-500);
        }

        .toast-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .toast-icon.success {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-600));
        }

        .toast-icon.warning {
            background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
        }

        .toast-icon.error {
            background: linear-gradient(135deg, var(--danger-500), var(--danger-600));
        }

        .toast-icon.info {
            background: linear-gradient(135deg, var(--info-500), var(--info-600));
        }

        /* ==================== LOADING OVERLAY ==================== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .loading-spinner {
            width: 5rem;
            height: 5rem;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-500);
            animation: spin 1s linear infinite;
            position: relative;
        }

        .loading-spinner::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: var(--secondary-500);
            animation: spin 1.5s linear infinite reverse;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== CUSTOM SCROLLBAR ==================== */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--neutral-100);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, var(--primary-400), var(--secondary-400));
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, var(--primary-500), var(--secondary-500));
        }

        /* ==================== ANIMATIONS ==================== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-slide-in-right {
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* ==================== UTILITY CLASSES ==================== */
        .hidden {
            display: none !important;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .text-gradient {
            background: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ==================== PERSONNEL SELECT STYLES ==================== */
        .personnel-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .personnel-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-100), var(--primary-50));
            color: var(--primary-700);
            border: 1px solid var(--primary-200);
        }

        .personnel-search-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .personnel-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            background: white;
        }

        .personnel-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition-fast);
            border-bottom: 1px solid var(--neutral-100);
        }

        .personnel-result-item:last-child {
            border-bottom: none;
        }

        .personnel-result-item:hover {
            background: var(--primary-50);
        }

        .personnel-result-item.selected {
            background: linear-gradient(135deg, var(--primary-100), var(--primary-50));
            border-left: 3px solid var(--primary-500);
        }

        /* ==================== USER CARD STYLES ==================== */
        .user-card {
            background: white !important;
            border: 1px solid white !important;
            border-radius: var(--radius-lg);
            padding: 0.75rem 1rem;
            box-shadow: var(--shadow-sm);
            display: inline-block;
        }

        /* ==================== RESPONSIVE DESIGN ==================== */
        @media (max-width: 1024px) {
            .workorder-card {
                width: calc(50% - 1rem);
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 calc(50% - 0.5rem);
            }

            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .camera-container {
                height: 350px;
            }
        }

        @media (max-width: 768px) {
            .workorder-card {
                width: 100%;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                flex: none;
            }
            
            .app-title {
                font-size: 1.75rem;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
            
            .form-section {
                padding: 1.5rem;
            }

            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .camera-container {
                height: 300px;
            }

            .camera-controls {
                gap: 0.5rem;
            }
        }

        @media (max-width: 640px) {
            .login-box {
                max-width: 90%;
                margin: 1rem;
            }
            
            .login-header, .login-body {
                padding: 1.5rem;
            }
            
            .btn {
                padding: 0.75rem 1rem;
            }
            
            .card {
                padding: 1.25rem;
            }

            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .camera-container {
                height: 250px;
            }
        }

        /* ==================== PHOTO THUMBNAIL GRID ==================== */
        .photo-thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .photo-thumbnail-item {
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-base);
            aspect-ratio: 1/1;
        }

        .photo-thumbnail-item:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .photo-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumbnail-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            padding: 0.5rem;
            color: white;
            font-size: 0.7rem;
            opacity: 0;
            transition: var(--transition-base);
        }

        .photo-thumbnail-item:hover .thumbnail-overlay {
            opacity: 1;
        }

        .view-photos-btn {
            margin-top: 1rem;
            width: 100%;
        }

        /* ==================== SEARCH BOX ==================== */
        .search-box {
            position: relative;
            width: 100%;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--neutral-400);
            z-index: 10;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-xl);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 1rem;
            transition: var(--transition-base);
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        /* ==================== USER AVATAR ==================== */
        .user-avatar {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-avatar.admin {
            background: linear-gradient(135deg, var(--secondary-500), var(--secondary-700));
        }

        .user-avatar.manager {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
        }

        .user-avatar.user {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-700));
        }

        /* ==================== DETAIL ITEM ==================== */
        .detail-item {
            margin-bottom: 1.25rem;
        }

        /* ==================== CHART STYLES ==================== */
        .chart-container {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            height: 400px;
            position: relative;
        }

        .chart-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--neutral-800);
        }

        .chart-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.125rem;
        }

        .chart-icon-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        }

        .chart-icon-secondary {
            background: linear-gradient(135deg, var(--secondary-500), var(--secondary-600));
        }

        .chart-icon-success {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-600));
        }

        .chart-icon-warning {
            background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
        }

        /* ==================== REQUIRED FIELD ==================== */
        .required-field::after {
            content: " *";
            color: var(--danger-500);
        }

        /* ==================== VIEW TOGGLE BUTTONS ==================== */
        .view-toggle-btn {
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            font-size: 0.875rem;
            transition: var(--transition-base);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            border: 2px solid var(--primary-500);
            background: transparent;
            color: var(--primary-600);
        }

        .view-toggle-btn.active {
            background: var(--primary-500);
            color: white;
        }

        .view-toggle-btn:hover:not(.active) {
            background: var(--primary-50);
        }

        /* ==================== STATUS CONTROL POPUP ==================== */
        .status-control-popup {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 300px;
            z-index: 1000;
            display: none;
        }

        .status-control-popup.show {
            display: block;
        }

        .status-control-header {
            padding: 1rem;
            border-bottom: 1px solid var(--neutral-200);
            background: var(--neutral-50);
        }

        .status-control-body {
            padding: 1.5rem;
        }

        .status-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-base);
            margin-bottom: 0.5rem;
        }

        .status-option:hover {
            background: var(--neutral-50);
        }

        .status-option.active {
            background: var(--primary-50);
            border: 2px solid var(--primary-500);
        }

        .status-option-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .status-option-icon.working {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        }

        .status-option-icon.available {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-600));
        }

        .status-option-icon.leave {
            background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
        }

        .status-option-icon.absent {
            background: linear-gradient(135deg, var(--danger-500), var(--danger-600));
        }

        .status-option-icon.auto {
            background: linear-gradient(135deg, var(--neutral-500), var(--neutral-600));
        }

        .status-option-info {
            flex: 1;
        }

        .status-option-title {
            font-weight: 600;
            color: var(--neutral-900);
        }

        .status-option-desc {
            font-size: 0.875rem;
            color: var(--neutral-600);
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-bg-pattern"></div>
        
        <div class="login-box animate-fade-in">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <h1 class="login-title">Work Order Pro</h1>
                <p class="login-subtitle">Professional Management System</p>
            </div>
            
            <div class="login-body">
                <form id="loginForm" class="space-y-6">
                    <div class="form-group">
                        <label class="form-label" for="email">
                            <i class="fas fa-envelope mr-2"></i>
                            Email Address
                        </label>
                        <input type="email" 
                               id="email" 
                               class="form-input"
                               placeholder="admin@genetek.co.id"
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="password">
                            <i class="fas fa-lock mr-2"></i>
                            Password
                        </label>
                        <input type="password" 
                               id="password" 
                               class="form-input"
                               placeholder="Enter your password"
                               required>
                    </div>
                    
                    <div id="loginError" class="hidden">
                        <div class="card-danger p-4 flex items-center gap-3">
                            <i class="fas fa-exclamation-triangle text-red-500 text-lg"></i>
                            <span id="errorMessage" class="text-red-700 font-medium">Invalid credentials</span>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-login">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Sign In to Dashboard</span>
                    </button>
                </form>
            </div>
            
            <div class="login-footer">
                <p class="flex items-center justify-center gap-2">
                    <i class="fas fa-shield-alt text-purple-500"></i>
                    <span>Secure Enterprise Platform</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application Page (Hidden Initially) -->
    <div id="appPage" class="hidden">
        <!-- App Header -->
        <div class="app-header">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-8">
                    <div class="flex-1">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="app-logo">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <div>
                                <h1 class="app-title">Work Order Pro</h1>
                                <p class="app-subtitle">Manage, Track & Analyze Work Orders</p>
                            </div>
                        </div>
                        
                        <!-- User Info Card -->
                        <div class="user-card inline-block">
                            <div class="flex items-center gap-4">
                                <div class="user-avatar user" id="userAvatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm text-purple-600 font-medium mb-1">Welcome back</p>
                                    <p id="userWelcome" class="font-semibold text-gray-900 truncate"></p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="userRoleBadge" class="badge-primary">
                                        <i class="fas fa-user-tag"></i>
                                        <span>User</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-2" id="actionButtons">
                        <button id="newWorkOrderBtn" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i>
                            <span>New Work Order</span>
                        </button>
                        <button id="exportExcelBtn" class="btn btn-success hidden">
                            <i class="fas fa-file-excel"></i>
                            <span>Export Excel</span>
                        </button>
                        <button id="analyticsBtn" class="btn btn-info hidden">
                            <i class="fas fa-chart-bar"></i>
                            <span>Analytics</span>
                        </button>
                        <button id="activityBtn" class="btn btn-secondary hidden">
                            <i class="fas fa-history"></i>
                            <span>Activity</span>
                        </button>
                        <button id="statusHistoryBtn" class="btn btn-warning hidden">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Status History</span>
                        </button>
                        <!-- Documentation Button -->
                        <button id="documentationBtn" class="btn btn-info">
                            <i class="fas fa-camera"></i>
                            <span>Ambil Gambar</span>
                        </button>
                        <!-- Pipelines Button -->
                        <button id="pipelinesBtn" class="btn btn-primary">
                            <i class="fas fa-project-diagram"></i>
                            <span>Pipelines</span>
                        </button>
                        <!-- Personnel List Button -->
                        <button id="personnelListBtn" class="btn btn-primary">
                            <i class="fas fa-users"></i>
                            <span>Personnel List</span>
                        </button>
                        <button id="authButton" class="btn btn-danger">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
                
                <!-- Search Box -->
                <div class="mb-8">
                    <div class="search-box">
                        <i class="search-icon fas fa-search"></i>
                        <input type="text" 
                               id="searchWorkOrders" 
                               placeholder="Search work orders by number, customer, PIC..."
                               class="search-input">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 py-8">
            <!-- Tabs Navigation -->
            <div class="tabs mb-8">
                <button class="tab active" data-tab="all">
                    <i class="fas fa-layer-group"></i>
                    <span>All Work Orders</span>
                    <span class="tab-count">0</span>
                </button>
                <button class="tab" data-tab="running">
                    <i class="fas fa-sync-alt"></i>
                    <span>Running</span>
                    <span class="tab-count">0</span>
                </button>
                <button class="tab" data-tab="done">
                    <i class="fas fa-check-circle"></i>
                    <span>Done</span>
                    <span class="tab-count">0</span>
                </button>
                <button class="tab" data-tab="close">
                    <i class="fas fa-times-circle"></i>
                    <span>Closed</span>
                    <span class="tab-count">0</span>
                </button>
            </div>
            
            <!-- View Controls -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                <div class="flex flex-wrap gap-2">
                    <button id="cardViewBtn" class="btn btn-outline active view-toggle-btn">
                        <i class="fas fa-th-large"></i>
                        <span>Card View</span>
                    </button>
                    <button id="listViewBtn" class="btn btn-outline view-toggle-btn">
                        <i class="fas fa-list"></i>
                        <span>List View</span>
                    </button>
                    <button id="timelineViewBtn" class="btn btn-outline view-toggle-btn">
                        <i class="fas fa-stream"></i>
                        <span>Timeline</span>
                    </button>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <select id="sortBy" class="form-input w-48">
                        <option value="createdAt">Sort by Date</option>
                        <option value="workOrderNumber">Sort by WO Number</option>
                        <option value="status">Sort by Status</option>
                        <option value="customer">Sort by Customer</option>
                        <option value="priority">Sort by Priority</option>
                    </select>
                    <select id="sortOrder" class="form-input w-40">
                        <option value="desc">Newest First</option>
                        <option value="asc">Oldest First</option>
                    </select>
                </div>
            </div>
            
            <!-- Card View Container -->
            <div id="cardViewContainer" class="animate-fade-in">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Work Orders</h3>
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <i class="fas fa-info-circle text-blue-500"></i>
                            <span id="workOrderCount">Loading work orders...</span>
                        </div>
                    </div>
                    
                    <div id="workorders-stage" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 custom-scrollbar" style="max-height: 600px; overflow-y: auto;">
                        <!-- Work orders will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- List View Container -->
            <div id="listViewContainer" class="hidden">
                <div class="card">
                    <h3 class="text-xl font-bold text-gray-900 mb-6">Work Orders List View</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">WO Number</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Building</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PIC</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="listViewContent" class="bg-white divide-y divide-gray-200">
                                <!-- List items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Timeline View -->
            <div id="timelineViewContainer" class="hidden">
                <div class="card">
                    <h3 class="text-xl font-bold text-gray-900 mb-6">Work Order Timeline</h3>
                    <div class="timeline" id="timelineContent">
                        <!-- Timeline items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-6xl">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Work Order Analytics</h2>
                    <p class="text-gray-300 mt-1">Comprehensive analysis and insights</p>
                </div>
                <button id="closeAnalyticsModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body custom-scrollbar">
                <div class="flex justify-between items-center mb-8">
                    <select id="chartTimeRange" class="form-input w-48">
                        <option value="week">Last Week</option>
                        <option value="month" selected>Last Month</option>
                        <option value="quarter">Last Quarter</option>
                        <option value="year">Last Year</option>
                        <option value="all">All Time</option>
                    </select>
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        Data updated: <span id="dataUpdatedTime"></span>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="chart-container">
                        <div class="chart-title">
                            <div class="chart-icon chart-icon-primary">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <span>Status Distribution</span>
                        </div>
                        <canvas id="statusChart"></canvas>
                        <div class="mt-4" id="statusChartInfo"></div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">
                            <div class="chart-icon chart-icon-secondary">
                                <i class="fas fa-sitemap"></i>
                            </div>
                            <span>Division-wise Distribution</span>
                        </div>
                        <canvas id="divisionChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">
                            <div class="chart-icon chart-icon-success">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <span>Monthly Trend</span>
                        </div>
                        <canvas id="monthlyTrendChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">
                            <div class="chart-icon chart-icon-warning">
                                <i class="fas fa-building"></i>
                            </div>
                            <span>Company Distribution</span>
                        </div>
                        <canvas id="companyChart"></canvas>
                    </div>
                    
                    <div class="chart-container lg:col-span-2" style="height: 450px;">
                        <div class="chart-title">
                            <div class="chart-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <span>Completion Time Analysis</span>
                        </div>
                        <canvas id="completionTimeChart"></canvas>
                        <div class="mt-4" id="completionTimeInfo"></div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">
                        <div class="chart-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <span>Analytics Summary</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                        <div class="text-center p-4 bg-blue-50 rounded-xl">
                            <div class="text-2xl font-bold text-blue-700" id="avgCompletionTime">0</div>
                            <div class="text-sm text-blue-600 mt-1">Avg. Completion (Days)</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-xl">
                            <div class="text-2xl font-bold text-purple-700" id="mostActiveDivision">-</div>
                            <div class="text-sm text-purple-600 mt-1">Most Active Division</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-xl">
                            <div class="text-2xl font-bold text-green-700" id="completionRate">0%</div>
                            <div class="text-sm text-green-600 mt-1">Completion Rate</div>
                        </div>
                        <div class="text-center p-4 bg-pink-50 rounded-xl">
                            <div class="text-2xl font-bold text-pink-700" id="topCustomer">-</div>
                            <div class="text-sm text-pink-600 mt-1">Top Customer</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Modal -->
    <div id="activityModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-4xl">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Recent Activity</h2>
                    <p class="text-gray-300 mt-1">Latest system activities and changes</p>
                </div>
                <button id="closeActivityModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="activityFeed" class="space-y-4">
                    <!-- Activity items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Status History Modal -->
    <div id="statusHistoryModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-4xl">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Status Change History</h2>
                    <p class="text-gray-300 mt-1">Track all status changes across work orders</p>
                </div>
                <button id="closeStatusHistoryModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <div class="relative flex-1">
                        <select id="statusHistoryFilter" class="form-input w-full">
                            <option value="all">All Status Changes</option>
                            <option value="Running">Running Only</option>
                            <option value="Done">Done Only</option>
                            <option value="Close">Closed Only</option>
                        </select>
                        <i class="fas fa-filter absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <input type="text" 
                           id="statusHistorySearch" 
                           placeholder="Search by WO Number..." 
                           class="form-input flex-1">
                </div>
                
                <div id="statusHistoryFeed" class="space-y-4">
                    <!-- Status history items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Documentation Modal (Now: Ambil Gambar Modal) -->
    <div id="documentationModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-7xl">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Ambil Gambar Dokumen</h2>
                    <p class="text-gray-300 mt-1">Gunakan kamera untuk mengambil gambar dokumentasi</p>
                </div>
                <button id="closeDocumentationModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body custom-scrollbar">
                <!-- Step 1: Search and Select Work Order -->
                <div class="form-section mb-8">
                    <div class="form-section-title">
                        <div class="form-section-icon form-section-icon-primary">
                            <i class="fas fa-search"></i>
                        </div>
                        <span>Pilih Work Order</span>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="form-label required-field" for="docWorkOrderSearch">
                                Cari Work Order
                            </label>
                            <div class="autocomplete-container">
                                <input type="text" 
                                       id="docWorkOrderSearch" 
                                       class="form-input"
                                       placeholder="Ketik nomor work order atau nama customer..."
                                       required>
                                <div id="workOrderAutocomplete" class="autocomplete-dropdown"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Mulai mengetik untuk mencari work order yang ada
                            </p>
                        </div>
                        
                        <!-- Selected Work Order Info -->
                        <div id="selectedWorkOrderInfo" class="hidden">
                            <div class="card card-primary p-4">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h4 id="docWorkOrderNumber" class="font-bold text-gray-900 text-lg"></h4>
                                        <p id="docCustomer" class="text-gray-600"></p>
                                    </div>
                                    <div id="docStatusBadge" class="status-badge"></div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500">Gedung</p>
                                        <p id="docBuilding" class="font-medium text-gray-900"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Jenis Pekerjaan</p>
                                        <p id="docWorkType" class="font-medium text-gray-900"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Divisi</p>
                                        <p id="docDivision" class="font-medium text-gray-900"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">PIC</p>
                                        <p id="docPIC" class="font-medium text-gray-900"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Camera Section -->
                <div id="cameraSection" class="hidden">
                    <div class="form-section mb-8">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-success">
                                <i class="fas fa-camera"></i>
                            </div>
                            <span>Ambil Gambar dengan Kamera</span>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="form-label" for="photoCategory">
                                    Kategori Gambar
                                </label>
                                <select id="photoCategory" class="form-input">
                                    <option value="Before Work">Sebelum Pekerjaan</option>
                                    <option value="During Work">Saat Pekerjaan</option>
                                    <option value="After Work">Setelah Pekerjaan</option>
                                    <option value="Issue/Problem">Masalah/Kendala</option>
                                    <option value="Solution">Solusi</option>
                                    <option value="Completion">Penyelesaian</option>
                                    <option value="Other">Lainnya</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="form-label" for="photoDescription">
                                    Deskripsi Gambar
                                </label>
                                <input type="text" 
                                       id="photoDescription" 
                                       class="form-input"
                                       placeholder="Deskripsikan apa yang ditunjukkan oleh gambar ini...">
                            </div>
                            
                            <!-- Camera Container -->
                            <div class="camera-container" id="cameraContainer">
                                <video id="cameraVideo" class="camera-video" autoplay playsinline></video>
                                <canvas id="cameraCanvas" class="hidden"></canvas>
                                <img id="photoPreview" class="camera-preview hidden">
                                
                                <!-- Camera Controls -->
                                <div class="camera-controls" id="cameraControls">
                                    <button id="switchCameraBtn" class="camera-btn" title="Switch Camera">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button id="capturePhotoBtn" class="camera-btn camera-btn-primary" title="Ambil Gambar">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                    <button id="retakePhotoBtn" class="camera-btn camera-btn-danger hidden" title="Ambil Ulang">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                    <button id="savePhotoBtn" class="camera-btn camera-btn-success hidden" title="Simpan Gambar">
                                        <i class="fas fa-save"></i>
                                    </button>
                                </div>
                                
                                <!-- Camera Switch Button -->
                                <button id="cameraSwitchFrontBack" class="camera-btn camera-switch-btn" title="Ganti Kamera">
                                    <i class="fas fa-camera-retro"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                    
                <!-- Uploaded Photos -->
                <div id="uploadedPhotosSection" class="hidden">
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-info">
                                <i class="fas fa-images"></i>
                            </div>
                            <span>Gambar yang Telah Disimpan</span>
                        </div>
                        
                        <div id="uploadedPhotos" class="photo-preview-container">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-semibold text-gray-900">Gambar untuk work order ini</h4>
                                <span id="photoCount" class="badge badge-primary">0 gambar</span>
                            </div>
                            
                            <div id="photoGrid" class="photo-grid">
                                <!-- Photos will be loaded here -->
                            </div>
                            
                            <div id="noPhotosMessage" class="text-center py-8">
                                <div class="w-20 h-20 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-camera text-2xl text-blue-400"></i>
                                </div>
                                <p class="text-gray-600 font-medium mb-2">Belum ada gambar yang diambil</p>
                                <p class="text-gray-500 text-sm">Gunakan kamera di atas untuk mengambil gambar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Preview Modal -->
    <div id="photoPreviewModal" class="photo-preview-modal hidden">
        <div class="photo-preview-content">
            <button id="closePhotoPreview" class="preview-close-btn">
                <i class="fas fa-times"></i>
            </button>
            <img id="previewImage" class="photo-preview-img" src="" alt="Photo Preview">
        </div>
    </div>

    <!-- Work Order Modal -->
    <div id="workorderModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-7xl">
            <div class="modal-header">
                <div class="flex items-center gap-4">
                    <button id="closeWorkOrderModal" class="text-gray-300 hover:text-white p-2 rounded-lg hover:bg-white/10 transition-colors">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <div>
                        <h2 class="modal-title" id="modalTitle">Create New Work Order</h2>
                        <p class="text-gray-300 mt-1">Fill in all required information below</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="cancelWorkOrderBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" form="workorderForm" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Save Work Order
                    </button>
                </div>
            </div>
            
            <div class="modal-body custom-scrollbar">
                <form id="workorderForm" class="space-y-8">
                    <input type="hidden" id="workorderId">
                    <input type="hidden" id="originalStatus">
                    
                    <!-- Section 1: Basic Information -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-primary">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <span>Basic Information</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label required-field" for="workOrderNumber">
                                    No Work Order
                                </label>
                                <div class="relative">
                                    <input type="text" 
                                           id="workOrderNumber" 
                                           class="form-input"
                                           required
                                           placeholder="Auto-generated"
                                           readonly>
                                    <button type="button" 
                                            id="refreshWorkOrderNumber" 
                                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-blue-600 hover:text-blue-800 bg-transparent border-0 transition-colors">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">
                                    Format: 001/GI-GEN/FAS/I/2025
                                </p>
                            </div>
                            
                            <div>
                                <label class="form-label" for="soNumber">
                                    Nomor SO
                                </label>
                                <input type="text" 
                                       id="soNumber" 
                                       class="form-input"
                                       placeholder="SO-2024-001">
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="customer">
                                    Customer
                                </label>
                                <div class="autocomplete-container">
                                    <input type="text" 
                                           id="customer" 
                                           class="form-input"
                                           required
                                           placeholder="Type to search or add new">
                                    <div id="customerAutocomplete" class="autocomplete-dropdown"></div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="building">
                                    Gedung
                                </label>
                                <div class="autocomplete-container">
                                    <input type="text" 
                                           id="building" 
                                           class="form-input"
                                           required
                                           placeholder="Type to search or add new">
                                    <div id="buildingAutocomplete" class="autocomplete-dropdown"></div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="workType">
                                    Jenis Pekerjaan
                                </label>
                                <div class="autocomplete-container">
                                    <input type="text" 
                                           id="workType" 
                                           class="form-input"
                                           required
                                           placeholder="Type to search or add new">
                                    <div id="workTypeAutocomplete" class="autocomplete-dropdown"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 2: Organization & Personnel -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-secondary">
                                <i class="fas fa-sitemap"></i>
                            </div>
                            <span>Organization & Personnel</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="form-label required-field" for="division">
                                    Divisi
                                </label>
                                <select id="division" class="form-input" required>
                                    <option value="">Select Division</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Testcom">Testcom</option>
                                    <option value="Project">Project</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="form-label required-field" for="company">
                                    Perusahaan
                                </label>
                                <select id="company" class="form-input" required>
                                    <option value="">Select Company</option>
                                    <option value="Genetek Intratama">Genetek Intratama</option>
                                    <option value="Effrensindo Kencana">Effrensindo Kencana</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <label class="form-label" for="pic">
                                    Nama PIC
                                </label>
                                <select id="pic" class="form-input">
                                    <option value="">Select PIC</option>
                                    <option value="Husni">Husni</option>
                                    <option value="Heksi">Heksi</option>
                                    <option value="Indra Kurniawan">Indra Kurniawan</option>
                                    <option value="Putra">Putra</option>
                                    <option value="Wahyu Sujoko">Wahyu Sujoko</option>
                                    <option value="Fiki">Fiki</option>
                                    <option value="Edwin">Edwin</option>
                                    <option value="Yudiono">Yudiono</option>
                                    <option value="Harianto">Harianto</option>
                                    <option value="Haryo">Haryo</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="form-label">
                                    Nama Personil
                                    <span class="text-xs text-gray-500 ml-2">(Search and add personnel)</span>
                                </label>
                                
                                <div class="personnel-multi-select">
                                    <div id="selectedPersonnelTags" class="personnel-tags"></div>
                                    
                                    <div class="personnel-search-container">
                                        <input type="text" 
                                               id="personnelSearch" 
                                               class="form-input flex-1"
                                               placeholder="Search personnel by name...">
                                        <button type="button" 
                                                id="addPersonnelBtn" 
                                                class="btn btn-primary whitespace-nowrap">
                                            <i class="fas fa-plus"></i>
                                            Tambah
                                        </button>
                                    </div>
                                    
                                    <div id="personnelResults" class="personnel-results"></div>
                                </div>
                                
                                <input type="hidden" id="personnel" name="personnel">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 3: Timeline & Status -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-success">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <span>Timeline & Status</span>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <div>
                                <label class="form-label required-field" for="startDate">
                                    Tanggal Mulai
                                </label>
                                <input type="date" 
                                       id="startDate" 
                                       class="form-input"
                                       required>
                            </div>
                            
                            <div>
                                <label class="form-label" for="endDate">
                                    Tanggal Selesai
                                </label>
                                <input type="date" 
                                       id="endDate" 
                                       class="form-input">
                            </div>
                            
                            <div>
                                <label class="form-label" for="estimatedTime">
                                    Estimasi Waktu (Hari)
                                </label>
                                <input type="number" 
                                       id="estimatedTime" 
                                       class="form-input"
                                       min="0"
                                       step="0.5"
                                       placeholder="e.g., 3.5 (untuk 3 hari setengah)">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label required-field" for="status">
                                    Status
                                </label>
                                <select id="status" class="form-input" required>
                                    <option value="Running">Running</option>
                                    <option value="Done">Done</option>
                                    <option value="Close">Close</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="form-label" for="priority">
                                    Priority
                                </label>
                                <select id="priority" class="form-input">
                                    <option value="Normal">Normal</option>
                                    <option value="High">High</option>
                                    <option value="Urgent">Urgent</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 4: Notes -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <div class="form-section-icon form-section-icon-info">
                                <i class="fas fa-sticky-note"></i>
                            </div>
                            <span>Notes</span>
                        </div>
                        
                        <div>
                            <label class="form-label" for="notes">
                                Additional Notes
                                <span class="text-xs text-gray-500 ml-2">(Optional)</span>
                            </label>
                            <textarea id="notes" 
                                      class="form-input" 
                                      rows="6"
                                      placeholder="Add any additional notes or instructions..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="workorderDetailModal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-4xl">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title" id="workorderDetailTitle">Work Order Details</h2>
                    <div class="flex items-center gap-4 mt-2">
                        <span id="detailStatusBadge" class="status-badge"></span>
                        <span class="text-gray-300">Created: <span id="detailCreatedDate"></span></span>
                    </div>
                </div>
                <button id="closeDetailModal" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body custom-scrollbar">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="space-y-6">
                        <div class="detail-item">
                            <label class="text-sm font-medium text-gray-500">Work Order Number</label>
                            <p id="detailWorkOrderNumber" class="text-xl font-semibold text-gray-900"></p>
                        </div>
                        <div class="detail-item">
                            <label class="text-sm font-medium text-gray-500">SO Number</label>
                            <p id="detailSONumber" class="text-gray-900"></p>
                        </div>
                        <div class="detail-item">
                            <label class="text-sm font-medium text-gray-500">Customer</label>
                            <p id="detailCustomer" class="text-gray-900"></p>
                        </div>
                        <div class="detail-item">
                            <label class="text-sm font-medium text-gray-500">Building</label>
                            <p id="detailBuilding" class="text-gray-900"></p>
                        </div>
                        <div class="detail-item">
                            <label class="text-sm font-medium text-gray-500">Work Type</label>
                            <p id="detailWorkType" class="text-gray-900"></p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="detail-item">
                            <label class="text-sm font-medium text-gray-500">Division</label>
                            <p id="detailDivision" class="text-gray-900"></p>
                        </div>
                        <div class="detail-item">
                            <label class="text-sm font-medium text-gray-500">Company</label>
                            <p id="detailCompany" class="text-gray-900"></p>
                        </div>
                        <div class="detail-item">
                            <label class="text-sm font-medium text-gray-500">PIC</label>
                            <p id="detailPIC" class="text-gray-900"></p>
                        </div>
                        <div class="detail-item">
                            <label class="text-sm font-medium text-gray-500">Personnel</label>
                            <div id="detailPersonnel" class="personnel-list"></div>
                        </div>
                        <div class="detail-item">
                            <label class="text-sm font-medium text-gray-500">Timeline</label>
                            <p class="text-gray-900">
                                <span id="detailStartDate"></span> 
                                <span class="mx-2"></span>
                                <span id="detailEndDate"></span>
                            </p>
                            <p class="text-sm text-gray-600 mt-1">Estimated: <span id="detailEstimatedTime"></span> days</p>
                        </div>
                        <div class="detail-item">
                            <label class="text-sm font-medium text-gray-500">Priority</label>
                            <p id="detailPriority" class="text-gray-900"></p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-8">
                    <label class="text-sm font-medium text-gray-500 mb-3 block">Notes</label>
                    <div id="detailNotes" class="bg-gray-50 rounded-lg p-4 text-gray-700 border border-gray-200"></div>
                </div>
                
                <div class="mb-8">
                    <label class="text-sm font-medium text-gray-500 mb-3 block">Status History</label>
                    <div id="detailStatusHistory" class="space-y-3"></div>
                </div>

                <!-- Photo Documentation Section -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-sm font-medium text-gray-500">Photo Documentation</label>
                        <span id="detailPhotoCount" class="badge badge-primary">0 photos</span>
                    </div>
                    
                    <div id="detailPhotosContainer" class="hidden">
                        <div class="photo-thumbnail-grid" id="detailPhotoThumbnails">
                            <!-- Photo thumbnails will be loaded here -->
                        </div>
                        <button id="viewAllPhotosBtn" class="btn btn-info view-photos-btn">
                            <i class="fas fa-images mr-2"></i>
                            View All Photos
                        </button>
                    </div>
                    
                    <div id="noPhotosMessageDetail" class="text-center py-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-camera text-xl text-blue-400"></i>
                        </div>
                        <p class="text-gray-600 font-medium mb-2">No photos available</p>
                        <p class="text-gray-500 text-sm">Use the camera feature to add documentation photos</p>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-6 border-t">
                    <button id="closeDetailBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                    <button id="editDetailBtn" class="btn btn-primary">
                        <i class="fas fa-edit"></i>
                        Edit Work Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Control Popup -->
    <div id="statusControlPopup" class="status-control-popup hidden">
        <div class="status-control-header">
            <h3 class="font-bold text-gray-900">Status Control</h3>
            <p class="text-sm text-gray-600 mt-1">Update personnel status</p>
        </div>
        <div class="status-control-body">
            <div class="space-y-3">
                <div class="status-option" data-status="working">
                    <div class="status-option-icon working">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <div class="status-option-info">
                        <div class="status-option-title">Working</div>
                        <div class="status-option-desc">Currently assigned to work orders</div>
                    </div>
                    <i class="fas fa-check text-green-500 hidden"></i>
                </div>
                <div class="status-option" data-status="available">
                    <div class="status-option-icon available">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="status-option-info">
                        <div class="status-option-title">Available</div>
                        <div class="status-option-desc">Ready for new assignments</div>
                    </div>
                    <i class="fas fa-check text-green-500 hidden"></i>
                </div>
                <div class="status-option" data-status="leave">
                    <div class="status-option-icon leave">
                        <i class="fas fa-umbrella-beach"></i>
                    </div>
                    <div class="status-option-info">
                        <div class="status-option-title">On Leave</div>
                        <div class="status-option-desc">On vacation or leave</div>
                    </div>
                    <i class="fas fa-check text-green-500 hidden"></i>
                </div>
                <div class="status-option" data-status="absent">
                    <div class="status-option-icon absent">
                        <i class="fas fa-user-times"></i>
                    </div>
                    <div class="status-option-info">
                        <div class="status-option-title">Absent</div>
                        <div class="status-option-desc">Unexpected absence</div>
                    </div>
                    <i class="fas fa-check text-green-500 hidden"></i>
                </div>
                <div class="status-option" data-status="auto">
                    <div class="status-option-icon auto">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="status-option-info">
                        <div class="status-option-title">Auto Mode</div>
                        <div class="status-option-desc">Let system manage status</div>
                    </div>
                    <i class="fas fa-check text-green-500 hidden"></i>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-200">
                <button id="saveStatusBtn" class="btn btn-primary w-full">
                    <i class="fas fa-save mr-2"></i>
                    Save Status
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-white text-lg font-medium">Loading...</p>
        </div>
    </div>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        let db, auth, storage, workordersCollection, activitiesCollection, usersCollection, statusHistoryCollection, dataHistoryCollection, personnelCollection;
        let currentUser = null;
        let currentUserRole = 'user';
        let workorders = [];
        let filteredWorkorders = [];
        let currentView = 'card';
        let currentTab = 'all';
        let activeFilters = {};
        let charts = {};
        let dataHistory = {
            customer: [],
            building: [],
            workType: [],
            personnel: []
        };
        let allPersonnel = [];
        
        // Documentation variables
        let selectedWorkOrderId = null;
        let selectedWorkOrderData = null;
        let uploadedPhotos = [];
        
        // Camera variables
        let cameraStream = null;
        let isFrontCamera = false;
        let capturedPhotoData = null;
        let mediaDevices = [];
        let currentCameraIndex = 0;
        
        // Daftar personil yang tersedia
        const availablePersonnel = [
            "Husni",
            "Heksi",
            "Indra Kurniawan",
            "Putra",
            "Wahyu Sujoko",
            "Fiki",
            "Edwin",
            "Yudiono",
            "Harianto",
            "Haryo"
        ];
        
        // Selected personnel for current form
        let selectedPersonnel = [];
        
        // Realtime listeners
        let workOrdersListener = null;
        let personnelListener = null;

        // ==================== INITIALIZE FIREBASE ====================
        function initializeFirebase() {
            try {
                console.log('Initializing Firebase...');
                
                const firebaseConfig = {
                    apiKey: "AIzaSyAwXNGrJsBqQ2RslAkdWWPSOubUw13QcRI",
                    authDomain: "workorder-mon.firebaseapp.com",
                    projectId: "workorder-mon",
                    storageBucket: "workorder-mon.firebasestorage.app",
                    messagingSenderId: "226391173482",
                    appId: "1:226391173482:web:9ea9c68c1e31c84f50dd13"
                };

                // Initialize Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                db = firebase.firestore();
                auth = firebase.auth();
                storage = firebase.storage();
                
                workordersCollection = db.collection('workorders');
                activitiesCollection = db.collection('activities');
                usersCollection = db.collection('users');
                statusHistoryCollection = db.collection('statusHistory');
                dataHistoryCollection = db.collection('dataHistory');
                personnelCollection = db.collection('personnel');
                
                console.log('Firebase initialized successfully');
                return true;
                
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                showToast('Firebase initialization failed. Please check console.', 'error');
                return false;
            }
        }

        // ==================== REALTIME LISTENERS ====================
        function setupRealtimeListeners() {
            console.log('Setting up realtime listeners...');
            
            // Clean up existing listeners
            if (workOrdersListener) {
                workOrdersListener();
            }
            if (personnelListener) {
                personnelListener();
            }
            
            // Setup work orders realtime listener
            workOrdersListener = workordersCollection
                .orderBy('createdAt', 'desc')
                .onSnapshot({
                    next: (querySnapshot) => {
                        console.log('Work orders updated in realtime');
                        workorders = [];
                        
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            workorders.push({
                                id: doc.id,
                                ...data,
                                createdAt: data.createdAt || firebase.firestore.Timestamp.now(),
                                updatedAt: data.updatedAt || data.createdAt || firebase.firestore.Timestamp.now()
                            });
                        });

                        filteredWorkorders = [...workorders];
                        updateStats();
                        renderWorkOrders();
                        updateWorkOrderCount();
                        
                        // Update personnel statuses based on work orders
                        updatePersonnelStatusesFromWorkOrders();
                        
                        console.log('Work orders updated:', workorders.length);
                    },
                    error: (error) => {
                        console.error('Error in work orders listener:', error);
                        showToast('Failed to update work orders', 'error');
                    }
                });
            
            // Setup personnel realtime listener
            personnelListener = personnelCollection
                .where('isActive', '==', true)
                .onSnapshot({
                    next: (querySnapshot) => {
                        console.log('Personnel updated in realtime');
                        allPersonnel = [];
                        
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            allPersonnel.push({
                                id: doc.id,
                                ...data
                            });
                        });
                        
                        console.log('Personnel updated:', allPersonnel.length);
                        
                        // Update available personnel list for forms
                        updateAvailablePersonnelList();
                    },
                    error: (error) => {
                        console.error('Error in personnel listener:', error);
                        showToast('Failed to update personnel data', 'error');
                    }
                });
        }

        // ==================== PERSONNEL STATUS MANAGEMENT ====================
        async function updatePersonnelStatusesFromWorkOrders() {
            try {
                const updates = [];
                const now = new Date();
                
                for (const person of allPersonnel) {
                    // Skip if manual mode
                    if (person.statusMode === 'manual') {
                        continue;
                    }
                    
                    const calculatedStatus = calculateAutoStatus(person, workorders);
                    const newStatus = calculatedStatus.status;
                    
                    // Only update if status changed
                    if (person.status !== newStatus) {
                        updates.push({
                            id: person.id,
                            oldStatus: person.status,
                            newStatus: newStatus,
                            reason: calculatedStatus.reason
                        });
                        
                        // Update in database
                        await personnelCollection.doc(person.id).update({
                            status: newStatus,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastStatusUpdate: now.toISOString(),
                            statusReason: calculatedStatus.reason
                        });
                        
                        // Update local data
                        person.status = newStatus;
                        person.lastStatusUpdate = now;
                        person.statusReason = calculatedStatus.reason;
                    }
                }
                
                if (updates.length > 0) {
                    console.log('Auto-updated personnel statuses:', updates.length);
                }
                
            } catch (error) {
                console.error('Error updating personnel statuses:', error);
            }
        }

        function calculateAutoStatus(person, workOrders) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // If manual mode, return current status
            if (person.statusMode === 'manual') {
                return {
                    status: person.status,
                    reason: 'Manual Mode'
                };
            }
            
            // Get personnel's work orders
            const personnelWorkOrders = getPersonnelWorkOrders(person.name, workOrders);
            
            // Check if person has work orders for today
            const todaysWorkOrders = personnelWorkOrders.filter(wo => {
                if (!wo.startDate) return false;
                
                try {
                    const startDate = wo.startDate.toDate ? wo.startDate.toDate() : new Date(wo.startDate);
                    const startDateOnly = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                    
                    // Check if work order is active today based on start date and estimated time
                    if (startDateOnly <= today) {
                        if (wo.estimatedTime) {
                            const endDate = new Date(startDate);
                            endDate.setDate(startDate.getDate() + wo.estimatedTime);
                            const endDateOnly = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
                            return today <= endDateOnly;
                        }
                        return true;
                    }
                    return false;
                } catch (e) {
                    return false;
                }
            }).filter(wo => wo.status === 'Running');
            
            // If person has work orders for today, status is "working"
            if (todaysWorkOrders.length > 0) {
                return {
                    status: 'working',
                    reason: `Assigned to ${todaysWorkOrders.length} work order(s) today`
                };
            }
            
            // Check for upcoming work orders (next 3 days)
            const upcomingWorkOrders = personnelWorkOrders.filter(wo => {
                if (!wo.startDate || wo.status !== 'Running') return false;
                
                try {
                    const startDate = wo.startDate.toDate ? wo.startDate.toDate() : new Date(wo.startDate);
                    const startDateOnly = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                    const daysUntil = Math.ceil((startDateOnly - today) / (1000 * 60 * 60 * 24));
                    
                    return daysUntil > 0 && daysUntil <= 3;
                } catch (e) {
                    return false;
                }
            });
            
            if (upcomingWorkOrders.length > 0) {
                return {
                    status: 'available',
                    reason: `Has ${upcomingWorkOrders.length} upcoming work order(s)`
                };
            }
            
            // Default to available
            return {
                status: 'available',
                reason: 'No assigned work orders'
            };
        }

        function getPersonnelWorkOrders(personnelName, workOrders = workorders) {
            if (!personnelName || !workOrders) return [];
            
            return workOrders.filter(wo => {
                if (!wo.personnel) return false;
                
                if (Array.isArray(wo.personnel)) {
                    return wo.personnel.includes(personnelName);
                } else if (typeof wo.personnel === 'string') {
                    try {
                        const personnelArray = JSON.parse(wo.personnel);
                        return Array.isArray(personnelArray) && personnelArray.includes(personnelName);
                    } catch (e) {
                        return wo.personnel === personnelName;
                    }
                }
                return false;
            });
        }

        function updateAvailablePersonnelList() {
            // Update the available personnel array with current data
            const updatedPersonnel = [...new Set([
                ...availablePersonnel,
                ...allPersonnel.map(p => p.name)
            ])];
            
            // Sort alphabetically
            updatedPersonnel.sort((a, b) => a.localeCompare(b));
            
            // Clear and update the array
            availablePersonnel.length = 0;
            availablePersonnel.push(...updatedPersonnel);
            
            console.log('Updated available personnel list:', availablePersonnel.length);
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatDate(date) {
            if (!date) return '-';
            try {
                if (date.toDate) {
                    date = date.toDate();
                }
                return date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            } catch (e) {
                return '-';
            }
        }

        function formatDateTime(date) {
            if (!date) return '-';
            try {
                if (date.toDate) {
                    date = date.toDate();
                }
                return date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return '-';
            }
        }

        function formatTimeAgo(date) {
            if (!date) return 'Just now';
            try {
                if (date.toDate) {
                    date = date.toDate();
                }
                const now = new Date();
                const diffMs = now - date;
                const diffSec = Math.floor(diffMs / 1000);
                const diffMin = Math.floor(diffSec / 60);
                const diffHour = Math.floor(diffMin / 60);
                const diffDay = Math.floor(diffHour / 24);
                
                if (diffSec < 60) return 'Just now';
                if (diffMin < 60) return `${diffMin}m ago`;
                if (diffHour < 24) return `${diffHour}h ago`;
                if (diffDay < 7) return `${diffDay}d ago`;
                return formatDate(date);
            } catch (e) {
                return 'Some time ago';
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            console.log(`Toast [${type}]:`, message);
            
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const colors = {
                success: 'linear-gradient(135deg, var(--accent-500), var(--accent-600))',
                error: 'linear-gradient(135deg, var(--danger-500), var(--danger-600))',
                warning: 'linear-gradient(135deg, var(--warning-500), var(--warning-600))',
                info: 'linear-gradient(135deg, var(--info-500), var(--info-600))'
            };
            
            toast.innerHTML = `
                <div class="toast-icon ${type}" style="background: ${colors[type] || colors.info}">
                    <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
                </div>
                <div>
                    <p class="font-medium">${message}</p>
                    <p class="text-sm text-gray-600 mt-1">${new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}</p>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
        }

        // ==================== WORK ORDER FUNCTIONS ====================
        async function loadWorkOrders() {
            console.log('Loading work orders...');
            
            showLoading();
            try {
                const querySnapshot = await workordersCollection.orderBy('createdAt', 'desc').get();
                workorders = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    workorders.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt || firebase.firestore.Timestamp.now(),
                        updatedAt: data.updatedAt || data.createdAt || firebase.firestore.Timestamp.now()
                    });
                });

                filteredWorkorders = [...workorders];
                updateStats();
                renderWorkOrders();
                updateWorkOrderCount();
                
                console.log('Work orders loaded:', workorders.length);
                
            } catch (error) {
                console.error('Error loading work orders:', error);
                showToast('Failed to load work orders', 'error');
            } finally {
                hideLoading();
            }
        }

        function updateStats() {
            const total = workorders.length;
            const completed = workorders.filter(wo => wo.status === 'Done').length;
            const running = workorders.filter(wo => wo.status === 'Running').length;
            const closed = workorders.filter(wo => wo.status === 'Close').length;

            document.querySelectorAll('.tab').forEach(tab => {
                const tabType = tab.dataset.tab;
                let count = 0;
                switch(tabType) {
                    case 'all': count = total; break;
                    case 'done': count = completed; break;
                    case 'running': count = running; break;
                    case 'close': count = closed; break;
                }
                const badge = tab.querySelector('.tab-count');
                if (badge) badge.textContent = count;
            });
        }

        function updateWorkOrderCount() {
            const countElement = document.getElementById('workOrderCount');
            if (countElement) {
                countElement.textContent = `Showing ${filteredWorkorders.length} of ${workorders.length} work orders`;
            }
        }

        function applyFiltersAndRender() {
            let filtered = [...workorders];
            
            if (currentTab !== 'all') {
                filtered = filtered.filter(wo => wo.status === currentTab.charAt(0).toUpperCase() + currentTab.slice(1));
            }
            
            const searchTerm = document.getElementById('searchWorkOrders').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(wo => 
                    (wo.workOrderNumber && wo.workOrderNumber.toLowerCase().includes(searchTerm)) ||
                    (wo.customer && wo.customer.toLowerCase().includes(searchTerm)) ||
                    (wo.building && wo.building.toLowerCase().includes(searchTerm)) ||
                    (wo.pic && wo.pic.toLowerCase().includes(searchTerm)) ||
                    (wo.personnel && JSON.stringify(wo.personnel).toLowerCase().includes(searchTerm)) ||
                    (wo.workType && wo.workType.toLowerCase().includes(searchTerm)) ||
                    (wo.division && wo.division.toLowerCase().includes(searchTerm))
                );
            }
            
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;
            filtered.sort((a, b) => {
                let aVal = a[sortBy];
                let bVal = b[sortBy];
                
                if (sortBy === 'createdAt' || sortBy === 'startDate' || sortBy === 'endDate') {
                    aVal = aVal?.toDate?.() || new Date(0);
                    bVal = bVal?.toDate?.() || new Date(0);
                }
                
                if (sortOrder === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            filteredWorkorders = filtered;
            renderWorkOrders();
            updateWorkOrderCount();
        }

        function renderWorkOrders() {
            if (currentView === 'card') {
                renderCardView();
            } else if (currentView === 'list') {
                renderListView();
            } else if (currentView === 'timeline') {
                renderTimelineView();
            }
        }

        function renderCardView() {
            const container = document.getElementById('workorders-stage');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (filteredWorkorders.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-16 text-gray-400">
                        <div class="w-24 h-24 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-inbox text-4xl text-blue-400"></i>
                        </div>
                        <p class="text-xl font-medium mb-2 text-gray-600">No work orders found</p>
                        <p class="text-gray-500 mb-8">Try adjusting your search or filters</p>
                        ${canCreateWorkOrder() ? `
                        <button id="createFirstWorkOrder" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i>
                            Create First Work Order
                        </button>` : ''}
                    </div>
                `;
                
                const createBtn = document.getElementById('createFirstWorkOrder');
                if (createBtn) {
                    createBtn.addEventListener('click', createNewWorkOrder);
                }
                
                return;
            }
            
            filteredWorkorders.forEach(workorder => {
                const card = createWorkOrderCard(workorder);
                container.appendChild(card);
            });
            
            // Add event listeners for action buttons
            setTimeout(() => {
                document.querySelectorAll('.view-detail-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        let workorderId;
                        if (this.closest('.workorder-card')) {
                            workorderId = this.closest('.workorder-card').dataset.id;
                        }
                        if (workorderId) {
                            openWorkOrderDetailModal(workorderId);
                        }
                    });
                });
                
                document.querySelectorAll('.edit-workorder-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        let workorderId;
                        if (this.closest('.workorder-card')) {
                            workorderId = this.closest('.workorder-card').dataset.id;
                        }
                        if (workorderId) {
                            openWorkOrderModal(workorderId);
                        }
                    });
                });
                
                document.querySelectorAll('.delete-workorder-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        let workorderId;
                        if (this.closest('.workorder-card')) {
                            workorderId = this.closest('.workorder-card').dataset.id;
                        }
                        if (workorderId) {
                            deleteWorkOrder(workorderId);
                        }
                    });
                });
            }, 100);
        }

        function renderListView() {
            const container = document.getElementById('listViewContent');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (filteredWorkorders.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <div class="w-16 h-16 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-inbox text-2xl text-blue-400"></i>
                                </div>
                                <p class="font-medium text-gray-600 mb-2">No work orders found</p>
                                <p class="text-sm text-gray-500">Try adjusting your search or filters</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredWorkorders.forEach(workorder => {
                const row = createListRow(workorder);
                container.appendChild(row);
            });
        }

        function renderTimelineView() {
            const container = document.getElementById('timelineContent');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (filteredWorkorders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <div class="w-20 h-20 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-stream text-3xl text-blue-400"></i>
                        </div>
                        <p class="text-lg font-medium text-gray-600 mb-2">No work orders found</p>
                        <p class="text-gray-500">Try adjusting your search or filters</p>
                    </div>
                `;
                return;
            }
            
            // Group by date
            const groupedByDate = {};
            filteredWorkorders.forEach(wo => {
                const date = formatDate(wo.createdAt);
                if (!groupedByDate[date]) {
                    groupedByDate[date] = [];
                }
                groupedByDate[date].push(wo);
            });
            
            // Create timeline items
            Object.keys(groupedByDate).forEach(date => {
                const dateHeader = document.createElement('div');
                dateHeader.className = 'mb-4';
                dateHeader.innerHTML = `
                    <h4 class="text-lg font-bold text-gray-900 mb-2">${date}</h4>
                `;
                container.appendChild(dateHeader);
                
                const timelineItems = document.createElement('div');
                timelineItems.className = 'space-y-4 mb-8';
                
                groupedByDate[date].forEach(wo => {
                    const timelineItem = createTimelineItem(wo);
                    timelineItems.appendChild(timelineItem);
                });
                
                container.appendChild(timelineItems);
            });
        }

        function createWorkOrderCard(workorder) {
            const card = document.createElement('div');
            card.className = `workorder-card ${workorder.status.toLowerCase()} animate-slide-in-right`;
            card.dataset.id = workorder.id;
            
            const priorityClass = getPriorityClass(workorder.priority);
            let personnelArray = [];
            if (workorder.personnel) {
                if (Array.isArray(workorder.personnel)) {
                    personnelArray = workorder.personnel;
                } else if (typeof workorder.personnel === 'string') {
                    try {
                        personnelArray = JSON.parse(workorder.personnel);
                    } catch (e) {
                        personnelArray = [workorder.personnel];
                    }
                }
            }
            
            // Check if workorder has photos
            const hasPhotos = workorder.photos && workorder.photos.length > 0;
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="font-bold text-gray-900 text-lg mb-1">${workorder.workOrderNumber || 'N/A'}</h3>
                        <p class="text-sm text-gray-600">${workorder.customer || 'No customer'}</p>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="status-badge status-${workorder.status.toLowerCase()} mb-2">
                            ${workorder.status}
                        </span>
                        ${workorder.priority ? `
                        <span class="priority-badge ${priorityClass}">
                            ${workorder.priority}
                        </span>` : ''}
                        ${hasPhotos ? `
                        <span class="badge badge-info mt-1">
                            <i class="fas fa-camera mr-1"></i>
                            ${workorder.photos.length} photos
                        </span>` : ''}
                    </div>
                </div>
                
                <div class="space-y-3 mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600">
                            <i class="fas fa-building text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${workorder.building || 'No building'}</p>
                            <p class="text-xs text-gray-500">Building</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                            <i class="fas fa-briefcase text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${workorder.workType || 'No work type'}</p>
                            <p class="text-xs text-gray-500">Work Type</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center text-green-600">
                            <i class="fas fa-user-tie text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${workorder.pic || 'No PIC'}</p>
                            <p class="text-xs text-gray-500">PIC</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-yellow-100 flex items-center justify-center text-yellow-600">
                            <i class="fas fa-users text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="personnel-list">
                                ${personnelArray.length > 0 ? 
                                    personnelArray.slice(0, 2).map(person => 
                                        `<span class="badge badge-primary">${person}</span>`
                                    ).join('') : 
                                    '<span class="text-sm text-gray-500">No personnel</span>'
                                }
                                ${personnelArray.length > 2 ? 
                                    `<span class="badge badge-secondary">+${personnelArray.length - 2} more</span>` : ''
                                }
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Personnel</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600">
                            <i class="fas fa-calendar text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900">${formatDate(workorder.startDate)}</p>
                            <p class="text-xs text-gray-500">Start Date</p>
                        </div>
                    </div>
                    
                    ${workorder.estimatedTime ? `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center text-orange-600">
                            <i class="fas fa-clock text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900">${workorder.estimatedTime} days</p>
                            <p class="text-xs text-gray-500">Estimated Duration</p>
                        </div>
                    </div>` : ''}
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="badge badge-info">
                                <i class="fas fa-layer-group text-xs"></i>
                                <span>${workorder.division || 'No division'}</span>
                            </span>
                        </div>
                        <div class="flex gap-2">
                            <button class="view-detail-btn w-10 h-10 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 flex items-center justify-center transition-colors">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${canEditWorkOrder() ? `
                            <button class="edit-workorder-btn w-10 h-10 rounded-full bg-green-100 text-green-600 hover:bg-green-200 flex items-center justify-center transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>` : ''}
                            ${canDeleteWorkOrder() ? `
                            <button class="delete-workorder-btn w-10 h-10 rounded-full bg-red-100 text-red-600 hover:bg-red-200 flex items-center justify-center transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        function createListRow(workorder) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.dataset.id = workorder.id;
            
            let personnelArray = [];
            if (workorder.personnel) {
                if (Array.isArray(workorder.personnel)) {
                    personnelArray = workorder.personnel;
                } else if (typeof workorder.personnel === 'string') {
                    try {
                        personnelArray = JSON.parse(workorder.personnel);
                    } catch (e) {
                        personnelArray = [workorder.personnel];
                    }
                }
            }
            
            row.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap">
                    <div class="font-medium text-gray-900">${workorder.workOrderNumber || 'N/A'}</div>
                </td>
                <td class="px-4 py-3">
                    <div class="text-sm text-gray-900">${workorder.customer || '-'}</div>
                </td>
                <td class="px-4 py-3">
                    <div class="text-sm text-gray-900">${workorder.building || '-'}</div>
                </td>
                <td class="px-4 py-3">
                    <span class="status-badge status-${workorder.status.toLowerCase()}">
                        ${workorder.status}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <div class="text-sm text-gray-900">${workorder.pic || '-'}</div>
                </td>
                <td class="px-4 py-3">
                    <div class="text-sm text-gray-900">${formatDate(workorder.startDate)}</div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <div class="flex gap-2">
                        <button class="view-detail-btn w-8 h-8 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 flex items-center justify-center transition-colors">
                            <i class="fas fa-eye text-sm"></i>
                        </button>
                        ${canEditWorkOrder() ? `
                        <button class="edit-workorder-btn w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-200 flex items-center justify-center transition-colors">
                            <i class="fas fa-edit text-sm"></i>
                        </button>` : ''}
                        ${canDeleteWorkOrder() ? `
                        <button class="delete-workorder-btn w-8 h-8 rounded-full bg-red-100 text-red-600 hover:bg-red-200 flex items-center justify-center transition-colors">
                            <i class="fas fa-trash text-sm"></i>
                        </button>` : ''}
                    </div>
                </td>
            `;
            
            return row;
        }

        function createTimelineItem(workorder) {
            const item = document.createElement('div');
            item.className = 'card animate-slide-in-right';
            item.dataset.id = workorder.id;
            
            let personnelArray = [];
            if (workorder.personnel) {
                if (Array.isArray(workorder.personnel)) {
                    personnelArray = workorder.personnel;
                } else if (typeof workorder.personnel === 'string') {
                    try {
                        personnelArray = JSON.parse(workorder.personnel);
                    } catch (e) {
                        personnelArray = [workorder.personnel];
                    }
                }
            }
            
            item.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-bold text-gray-900">${workorder.workOrderNumber || 'N/A'}</h4>
                        <p class="text-sm text-gray-600">${workorder.customer || 'No customer'}</p>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="status-badge status-${workorder.status.toLowerCase()}">
                                ${workorder.status}
                            </span>
                            <span class="text-xs text-gray-500">
                                <i class="fas fa-building mr-1"></i>${workorder.building || '-'}
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-user-tie mr-1"></i>${workorder.pic || 'No PIC'} | 
                            <i class="fas fa-users mr-1 ml-2"></i>${personnelArray.length} personnel
                        </p>
                    </div>
                    <div class="flex gap-2">
                        ${canEditWorkOrder() ? `
                        <button class="edit-workorder-btn w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-200 flex items-center justify-center transition-colors">
                            <i class="fas fa-edit text-sm"></i>
                        </button>` : ''}
                        ${canDeleteWorkOrder() ? `
                        <button class="delete-workorder-btn w-8 h-8 rounded-full bg-red-100 text-red-600 hover:bg-red-200 flex items-center justify-center transition-colors">
                            <i class="fas fa-trash text-sm"></i>
                        </button>` : ''}
                    </div>
                </div>
            `;
            
            return item;
        }

        function getPriorityClass(priority) {
            switch(priority) {
                case 'High': return 'priority-high';
                case 'Urgent': return 'priority-urgent';
                case 'Low': return 'priority-low';
                default: return 'priority-normal';
            }
        }

        // ==================== CAMERA FUNCTIONS ====================
        async function openDocumentationModal() {
            console.log('Opening camera documentation modal');
            
            const modal = document.getElementById('documentationModal');
            modal.classList.remove('hidden');
            
            resetDocumentationForm();
            setupDocumentationSearch();
        }

        function closeDocumentationModal() {
            stopCamera();
            document.getElementById('documentationModal').classList.add('hidden');
            resetDocumentationForm();
        }

        function resetDocumentationForm() {
            selectedWorkOrderId = null;
            selectedWorkOrderData = null;
            capturedPhotoData = null;
            uploadedPhotos = [];
            
            document.getElementById('docWorkOrderSearch').value = '';
            document.getElementById('selectedWorkOrderInfo').classList.add('hidden');
            document.getElementById('cameraSection').classList.add('hidden');
            document.getElementById('uploadedPhotosSection').classList.add('hidden');
            document.getElementById('photoCategory').value = 'Before Work';
            document.getElementById('photoDescription').value = '';
            
            // Reset camera UI
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('cameraVideo').classList.remove('hidden');
            document.getElementById('capturePhotoBtn').classList.remove('hidden');
            document.getElementById('retakePhotoBtn').classList.add('hidden');
            document.getElementById('savePhotoBtn').classList.add('hidden');
        }

        async function setupCamera() {
            try {
                if (!selectedWorkOrderId) {
                    showToast('Pilih work order terlebih dahulu', 'warning');
                    return;
                }
                
                // Show camera section
                document.getElementById('cameraSection').classList.remove('hidden');
                
                // Request camera permission and start camera
                const constraints = {
                    video: {
                        facingMode: 'environment', // Default to back camera
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };
                
                // Try to get camera stream
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const videoElement = document.getElementById('cameraVideo');
                videoElement.srcObject = cameraStream;
                
                // Set up camera controls
                setupCameraControls();
                
                showToast('Kamera siap digunakan', 'success');
                
            } catch (error) {
                console.error('Error setting up camera:', error);
                
                if (error.name === 'NotAllowedError') {
                    showToast('Izin kamera ditolak. Silakan izinkan akses kamera.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showToast('Tidak ada kamera yang ditemukan', 'error');
                } else if (error.name === 'NotReadableError') {
                    showToast('Kamera sedang digunakan oleh aplikasi lain', 'error');
                } else {
                    showToast('Gagal mengakses kamera: ' + error.message, 'error');
                }
            }
        }

        function setupCameraControls() {
            const switchCameraBtn = document.getElementById('cameraSwitchFrontBack');
            const capturePhotoBtn = document.getElementById('capturePhotoBtn');
            const retakePhotoBtn = document.getElementById('retakePhotoBtn');
            const savePhotoBtn = document.getElementById('savePhotoBtn');
            
            // Switch camera button
            switchCameraBtn.addEventListener('click', switchCamera);
            
            // Capture photo button
            capturePhotoBtn.addEventListener('click', capturePhoto);
            
            // Retake photo button
            retakePhotoBtn.addEventListener('click', retakePhoto);
            
            // Save photo button
            savePhotoBtn.addEventListener('click', savePhoto);
        }

        async function switchCamera() {
            try {
                stopCamera();
                
                // Get available video devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length < 2) {
                    showToast('Hanya satu kamera yang tersedia', 'warning');
                    await startCamera(isFrontCamera ? 'user' : 'environment');
                    return;
                }
                
                // Toggle between front and back camera
                isFrontCamera = !isFrontCamera;
                const facingMode = isFrontCamera ? 'user' : 'environment';
                
                await startCamera(facingMode);
                
                showToast(`Beralih ke kamera ${isFrontCamera ? 'depan' : 'belakang'}`, 'info');
                
            } catch (error) {
                console.error('Error switching camera:', error);
                showToast('Gagal mengganti kamera', 'error');
            }
        }

        async function startCamera(facingMode = 'environment') {
            try {
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const videoElement = document.getElementById('cameraVideo');
                videoElement.srcObject = cameraStream;
                
            } catch (error) {
                console.error('Error starting camera:', error);
                throw error;
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => {
                    track.stop();
                });
                cameraStream = null;
            }
            
            const videoElement = document.getElementById('cameraVideo');
            if (videoElement) {
                videoElement.srcObject = null;
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const photoPreview = document.getElementById('photoPreview');
            
            if (!video || !canvas) return;
            
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw current video frame to canvas
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Get image data as data URL (base64)
            capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8); // 0.8 quality untuk ukuran lebih kecil
            
            // Show preview
            photoPreview.src = capturedPhotoData;
            photoPreview.classList.remove('hidden');
            video.classList.add('hidden');
            
            // Show capture controls
            document.getElementById('capturePhotoBtn').classList.add('hidden');
            document.getElementById('retakePhotoBtn').classList.remove('hidden');
            document.getElementById('savePhotoBtn').classList.remove('hidden');
            
            // Stop camera temporarily
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            
            showToast('Gambar berhasil diambil', 'success');
        }

        function retakePhoto() {
            // Restart camera
            startCamera(isFrontCamera ? 'user' : 'environment');
            
            // Reset UI
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('cameraVideo').classList.remove('hidden');
            document.getElementById('capturePhotoBtn').classList.remove('hidden');
            document.getElementById('retakePhotoBtn').classList.add('hidden');
            document.getElementById('savePhotoBtn').classList.add('hidden');
            
            capturedPhotoData = null;
            showToast('Ambil gambar ulang', 'info');
        }

        async function savePhoto() {
            if (!capturedPhotoData || !selectedWorkOrderId) {
                showToast('Tidak ada gambar yang akan disimpan', 'warning');
                return;
            }
            
            const category = document.getElementById('photoCategory').value;
            const description = document.getElementById('photoDescription').value.trim() || 'Tidak ada deskripsi';
            
            try {
                showLoading();
                
                // Create photo object with base64 data
                const photoData = {
                    id: Date.now().toString(),
                    imageData: capturedPhotoData, // Simpan sebagai base64
                    category: category,
                    description: description,
                    capturedBy: currentUser.email,
                    capturedAt: new Date().toISOString(),
                    cameraType: isFrontCamera ? 'front' : 'back'
                };
                
                // Get current work order
                const workorderDoc = await workordersCollection.doc(selectedWorkOrderId).get();
                if (!workorderDoc.exists) {
                    showToast('Work order tidak ditemukan', 'error');
                    return;
                }
                
                const workorderData = workorderDoc.data();
                const currentPhotos = workorderData.photos || [];
                
                // Add new photo
                currentPhotos.push(photoData);
                
                // Update work order with new photos array
                await workordersCollection.doc(selectedWorkOrderId).update({
                    photos: currentPhotos,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.email
                });
                
                // Clear form and reset
                document.getElementById('photoDescription').value = '';
                retakePhoto(); // Reset camera view
                
                // Reload uploaded photos in modal
                await loadUploadedPhotos();
                
                showToast(`Gambar berhasil disimpan untuk ${workorderData.workOrderNumber}!`, 'success');
                logActivity('capture_documentation', `Mengambil gambar untuk work order ${workorderData.workOrderNumber}`, selectedWorkOrderId);
                
                // Show notification about preview availability
                showToast('Gambar sudah bisa dilihat di detail work order', 'info');
                
            } catch (error) {
                console.error('Error saving photo:', error);
                showToast('Gagal menyimpan gambar: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ==================== DOCUMENTATION FUNCTIONS ====================
        function setupDocumentationSearch() {
            const searchInput = document.getElementById('docWorkOrderSearch');
            const dropdown = document.getElementById('workOrderAutocomplete');
            
            if (!searchInput || !dropdown) return;
            
            searchInput.addEventListener('input', function() {
                const value = this.value.trim();
                if (value.length < 2) {
                    hideAutocomplete('workOrder');
                    return;
                }
                
                showWorkOrderAutocomplete(value);
            });
            
            searchInput.addEventListener('focus', function() {
                const value = this.value.trim();
                if (value.length >= 2) {
                    showWorkOrderAutocomplete(value);
                }
            });
            
            searchInput.addEventListener('blur', function() {
                setTimeout(() => {
                    hideAutocomplete('workOrder');
                }, 200);
            });
        }

        function showWorkOrderAutocomplete(searchTerm) {
            const dropdown = document.getElementById('workOrderAutocomplete');
            if (!dropdown) return;
            
            const filtered = workorders.filter(wo => 
                (wo.workOrderNumber && wo.workOrderNumber.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (wo.customer && wo.customer.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (wo.building && wo.building.toLowerCase().includes(searchTerm.toLowerCase()))
            ).slice(0, 10);
            
            if (filtered.length === 0) {
                dropdown.innerHTML = `
                    <div class="autocomplete-item">
                        <div class="text-gray-500 text-sm">Tidak ada work order yang ditemukan</div>
                        <div class="autocomplete-info">Coba kata kunci yang berbeda</div>
                    </div>
                `;
            } else {
                dropdown.innerHTML = filtered.map(wo => {
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    const highlightedNumber = wo.workOrderNumber.replace(regex, '<span class="highlight">$1</span>');
                    const highlightedCustomer = wo.customer.replace(regex, '<span class="highlight">$1</span>');
                    return `
                        <div class="autocomplete-item" data-id="${wo.id}">
                            <div class="text-sm font-medium">${highlightedNumber}</div>
                            <div class="text-xs text-gray-600">${highlightedCustomer}  ${wo.building}</div>
                            <div class="autocomplete-info">${wo.workType}  ${wo.division}</div>
                        </div>
                    `;
                }).join('');
            }
            
            dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    const workorderId = this.dataset.id;
                    if (workorderId) {
                        selectWorkOrderForDocumentation(workorderId);
                    }
                });
            });
            
            dropdown.classList.add('show');
        }

        async function selectWorkOrderForDocumentation(workorderId) {
            try {
                showLoading();
                
                selectedWorkOrderId = workorderId;
                selectedWorkOrderData = workorders.find(wo => wo.id === workorderId);
                
                if (!selectedWorkOrderData) {
                    const doc = await workordersCollection.doc(workorderId).get();
                    if (doc.exists) {
                        selectedWorkOrderData = { id: doc.id, ...doc.data() };
                    } else {
                        showToast('Work order tidak ditemukan', 'error');
                        return;
                    }
                }
                
                updateSelectedWorkOrderInfo();
                setupCamera();
                loadUploadedPhotos();
                
                hideAutocomplete('workOrder');
                
            } catch (error) {
                console.error('Error selecting work order:', error);
                showToast('Gagal memuat work order', 'error');
            } finally {
                hideLoading();
            }
        }

        function updateSelectedWorkOrderInfo() {
            const wo = selectedWorkOrderData;
            const infoSection = document.getElementById('selectedWorkOrderInfo');
            
            document.getElementById('docWorkOrderNumber').textContent = wo.workOrderNumber;
            document.getElementById('docCustomer').textContent = wo.customer || '-';
            document.getElementById('docBuilding').textContent = wo.building || '-';
            document.getElementById('docWorkType').textContent = wo.workType || '-';
            document.getElementById('docDivision').textContent = wo.division || '-';
            document.getElementById('docPIC').textContent = wo.pic || '-';
            
            const statusBadge = document.getElementById('docStatusBadge');
            statusBadge.className = `status-badge status-${wo.status.toLowerCase()}`;
            statusBadge.textContent = wo.status;
            
            infoSection.classList.remove('hidden');
        }

        async function loadUploadedPhotos() {
            if (!selectedWorkOrderId) return;
            
            try {
                const workorderDoc = await workordersCollection.doc(selectedWorkOrderId).get();
                if (!workorderDoc.exists) {
                    showToast('Work order tidak ditemukan', 'error');
                    return;
                }
                
                const workorderData = workorderDoc.data();
                uploadedPhotos = workorderData.photos || [];
                
                displayUploadedPhotos();
                
            } catch (error) {
                console.error('Error loading photos:', error);
                showToast('Gagal memuat gambar', 'error');
            }
        }

        function displayUploadedPhotos() {
            const photoGrid = document.getElementById('photoGrid');
            const noPhotosMessage = document.getElementById('noPhotosMessage');
            const photoCount = document.getElementById('photoCount');
            const uploadedPhotosSection = document.getElementById('uploadedPhotosSection');
            
            photoCount.textContent = `${uploadedPhotos.length} gambar${uploadedPhotos.length !== 1 ? '' : ''}`;
            
            if (uploadedPhotos.length === 0) {
                photoGrid.innerHTML = '';
                noPhotosMessage.classList.remove('hidden');
                uploadedPhotosSection.classList.add('hidden');
                return;
            }
            
            uploadedPhotosSection.classList.remove('hidden');
            noPhotosMessage.classList.add('hidden');
            photoGrid.innerHTML = '';
            
            uploadedPhotos.forEach(photo => {
                const photoItem = createPhotoItem(photo);
                photoGrid.appendChild(photoItem);
            });
        }

        function createPhotoItem(photo) {
            const item = document.createElement('div');
            item.className = 'photo-item';
            item.dataset.id = photo.id;
            
            const timeAgo = formatTimeAgo(new Date(photo.capturedAt));
            const cameraIcon = photo.cameraType === 'front' ? 'fa-camera' : 'fa-camera-retro';
            const cameraTitle = photo.cameraType === 'front' ? 'Kamera Depan' : 'Kamera Belakang';
            
            item.innerHTML = `
                <img src="${photo.imageData}" 
                     alt="${photo.description}" 
                     class="photo-img"
                     loading="lazy"
                     onclick="openPhotoPreview('${photo.imageData}', '${photo.description}')">
                
                <div class="photo-actions">
                    <div class="photo-action-btn" onclick="openPhotoPreview('${photo.imageData}', '${photo.description}')" title="Lihat">
                        <i class="fas fa-eye text-blue-600"></i>
                    </div>
                    <div class="photo-action-btn" onclick="deletePhoto('${photo.id}')" title="Hapus">
                        <i class="fas fa-trash text-red-600"></i>
                    </div>
                </div>
                
                <div class="photo-info">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded">
                            ${photo.category}
                        </span>
                        <span class="text-xs text-gray-500">${timeAgo}</span>
                    </div>
                    <p class="text-sm text-gray-700 truncate" title="${photo.description}">
                        ${photo.description}
                    </p>
                    <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                        <i class="fas ${cameraIcon}" title="${cameraTitle}"></i>
                        <span>${photo.capturedBy || 'Unknown'}</span>
                    </p>
                </div>
            `;
            
            return item;
        }

        async function loadWorkOrderPhotos(workorderId) {
            try {
                const workorderDoc = await workordersCollection.doc(workorderId).get();
                if (!workorderDoc.exists) {
                    return [];
                }
                
                const workorderData = workorderDoc.data();
                return workorderData.photos || [];
            } catch (error) {
                console.error('Error loading work order photos:', error);
                return [];
            }
        }

        function displayWorkOrderPhotos(photos) {
            const container = document.getElementById('detailPhotosContainer');
            const thumbnails = document.getElementById('detailPhotoThumbnails');
            const noPhotosMessage = document.getElementById('noPhotosMessageDetail');
            const photoCount = document.getElementById('detailPhotoCount');
            
            photoCount.textContent = `${photos.length} photo${photos.length !== 1 ? 's' : ''}`;
            
            if (photos.length === 0) {
                container.classList.add('hidden');
                noPhotosMessage.classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            noPhotosMessage.classList.add('hidden');
            thumbnails.innerHTML = '';
            
            // Display thumbnails (limit to 6 for thumbnail view)
            photos.slice(0, 6).forEach((photo, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'photo-thumbnail-item';
                thumbnail.innerHTML = `
                    <img src="${photo.imageData}" 
                         alt="${photo.description}" 
                         class="photo-thumbnail"
                         onclick="openPhotoPreview('${photo.imageData}', '${photo.description}')">
                    <div class="thumbnail-overlay">
                        ${photo.category}
                    </div>
                `;
                thumbnails.appendChild(thumbnail);
            });
            
            // Setup view all photos button
            const viewAllBtn = document.getElementById('viewAllPhotosBtn');
            viewAllBtn.onclick = function() {
                openDocumentationModal();
                // Auto-select the work order
                setTimeout(() => {
                    if (selectedWorkOrderData && selectedWorkOrderData.workOrderNumber) {
                        document.getElementById('docWorkOrderSearch').value = selectedWorkOrderData.workOrderNumber;
                        selectWorkOrderForDocumentation(selectedWorkOrderData.id);
                    }
                }, 500);
            };
        }

        function openPhotoPreview(imageData, description) {
            const modal = document.getElementById('photoPreviewModal');
            const previewImage = document.getElementById('previewImage');
            
            previewImage.src = imageData;
            previewImage.alt = description;
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closePhotoPreview() {
            document.getElementById('photoPreviewModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Clear image source
            document.getElementById('previewImage').src = '';
        }

        async function deletePhoto(photoId) {
            if (!selectedWorkOrderId || !photoId) return;
            
            if (!confirm('Apakah Anda yakin ingin menghapus gambar ini?')) return;
            
            try {
                showLoading();
                
                // Get current work order
                const workorderDoc = await workordersCollection.doc(selectedWorkOrderId).get();
                if (!workorderDoc.exists) {
                    showToast('Work order tidak ditemukan', 'error');
                    return;
                }
                
                const workorderData = workorderDoc.data();
                const currentPhotos = workorderData.photos || [];
                
                // Filter out the photo to delete
                const updatedPhotos = currentPhotos.filter(photo => photo.id !== photoId);
                
                // Update work order
                await workordersCollection.doc(selectedWorkOrderId).update({
                    photos: updatedPhotos,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.email
                });
                
                // Update local array
                uploadedPhotos = updatedPhotos;
                
                // Update UI
                displayUploadedPhotos();
                
                showToast('Gambar berhasil dihapus', 'success');
                logActivity('delete_documentation', `Menghapus gambar dari work order ${workorderData.workOrderNumber}`, selectedWorkOrderId);
                
            } catch (error) {
                console.error('Error deleting photo:', error);
                showToast('Gagal menghapus gambar', 'error');
            } finally {
                hideLoading();
            }
        }

        // ==================== WORK ORDER NUMBER FUNCTIONS ====================
        async function getNextIntegratedSequenceNumber(year) {
            try {
                const startOfYear = new Date(year, 0, 1);
                const endOfYear = new Date(year, 11, 31, 23, 59, 59);
                
                const querySnapshot = await workordersCollection
                    .where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(startOfYear))
                    .where('createdAt', '<=', firebase.firestore.Timestamp.fromDate(endOfYear))
                    .orderBy('createdAt', 'desc')
                    .limit(1)
                    .get();
                
                if (querySnapshot.empty) {
                    return 1;
                }
                
                const lastWorkOrder = querySnapshot.docs[0].data();
                const woNumber = lastWorkOrder.workOrderNumber;
                const match = woNumber.match(/^(\d{3})\//);
                
                if (match) {
                    return parseInt(match[1]) + 1;
                }
                
                return 1;
                
            } catch (error) {
                console.error('Error getting integrated sequence number:', error);
                return 1;
            }
        }

        async function generateIntegratedWorkOrderNumber(startDate, company) {
            try {
                let companyPrefix = 'GI-GEN';
                if (company === 'Effrensindo Kencana') {
                    companyPrefix = 'GI-EFK';
                }
                
                const date = startDate ? new Date(startDate) : new Date();
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const romanMonths = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X', 'XI', 'XII'];
                const romanMonth = romanMonths[month - 1];
                
                const sequence = await getNextIntegratedSequenceNumber(year);
                
                return `${sequence.toString().padStart(3, '0')}/${companyPrefix}/FAS/${romanMonth}/${year}`;
            } catch (error) {
                console.error('Error generating integrated work order number:', error);
                return `001/${company === 'Effrensindo Kencana' ? 'GI-EFK' : 'GI-GEN'}/FAS/I/${new Date().getFullYear()}`;
            }
        }

        // ==================== DATA HISTORY FUNCTIONS ====================
        async function loadDataHistory() {
            try {
                const querySnapshot = await dataHistoryCollection.get();
                if (querySnapshot.empty) {
                    await initializeDefaultDataHistory();
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    dataHistory[data.type] = data.values || [];
                });
                
                console.log('Data history loaded:', dataHistory);
                
            } catch (error) {
                console.error('Error loading data history:', error);
            }
        }

        async function initializeDefaultDataHistory() {
            try {
                const defaultData = {
                    customer: ['Customer A', 'Customer B', 'Customer C'],
                    building: ['Building X', 'Building Y', 'Building Z'],
                    workType: ['Installation', 'Maintenance', 'Repair'],
                    personnel: availablePersonnel
                };
                
                for (const [type, values] of Object.entries(defaultData)) {
                    await dataHistoryCollection.doc(type).set({
                        type: type,
                        values: values,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    dataHistory[type] = values;
                }
                
                console.log('Default data history initialized');
                
            } catch (error) {
                console.error('Error initializing default data:', error);
            }
        }

        async function saveToDataHistory(type, value) {
            try {
                if (!value || value.trim() === '') return;
                
                value = value.trim();
                
                const doc = await dataHistoryCollection.doc(type).get();
                let currentValues = [];
                
                if (doc.exists) {
                    currentValues = doc.data().values || [];
                }
                
                if (!currentValues.includes(value)) {
                    currentValues.unshift(value);
                    if (currentValues.length > 20) {
                        currentValues = currentValues.slice(0, 20);
                    }
                    
                    await dataHistoryCollection.doc(type).set({
                        type: type,
                        values: currentValues,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    dataHistory[type] = currentValues;
                    console.log(`Saved to ${type} history:`, value);
                }
                
            } catch (error) {
                console.error(`Error saving to ${type} history:`, error);
            }
        }

        // ==================== PERSONNEL MULTI-SELECT FUNCTIONS (SEARCH-BASED) ====================
        function setupPersonnelMultiSelect() {
            const personnelSearch = document.getElementById('personnelSearch');
            const selectedPersonnelTags = document.getElementById('selectedPersonnelTags');
            const personnelResults = document.getElementById('personnelResults');
            const addPersonnelBtn = document.getElementById('addPersonnelBtn');
            const personnelHiddenInput = document.getElementById('personnel');
            
            // Reset selected personnel
            selectedPersonnel = [];
            updateSelectedPersonnelTags();
            updatePersonnelHiddenInput();
            
            // Search functionality
            personnelSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                renderPersonnelResults(searchTerm);
            });
            
            // Add personnel button
            addPersonnelBtn.addEventListener('click', function() {
                const personnelName = personnelSearch.value.trim();
                if (personnelName && !selectedPersonnel.includes(personnelName)) {
                    selectedPersonnel.push(personnelName);
                    updateSelectedPersonnelTags();
                    updatePersonnelHiddenInput();
                    personnelSearch.value = '';
                    renderPersonnelResults('');
                    showToast(`Personil "${personnelName}" berhasil ditambahkan`, 'success');
                    
                    // Save to history if it's a new personnel
                    if (!availablePersonnel.includes(personnelName)) {
                        availablePersonnel.push(personnelName);
                        saveToDataHistory('personnel', personnelName);
                    }
                }
            });
            
            // Allow pressing Enter to add
            personnelSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addPersonnelBtn.click();
                }
            });
            
            function renderPersonnelResults(searchTerm = '') {
                personnelResults.innerHTML = '';
                
                // Filter available personnel based on search term
                const filtered = availablePersonnel.filter(person => 
                    searchTerm === '' || person.toLowerCase().includes(searchTerm)
                );
                
                if (filtered.length === 0) {
                    personnelResults.innerHTML = `
                        <div class="text-center py-4 text-gray-500 text-sm">
                            <i class="fas fa-search mr-2"></i>
                            Tidak ditemukan personil. Ketik nama dan klik "Tambah"
                        </div>
                    `;
                    return;
                }
                
                filtered.forEach(person => {
                    const div = document.createElement('div');
                    div.className = 'personnel-result-item';
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-700">${person}</span>
                            <button class="text-blue-600 hover:text-blue-800 add-personnel-btn" data-person="${person}">
                                <i class="fas fa-plus-circle"></i>
                            </button>
                        </div>
                    `;
                    personnelResults.appendChild(div);
                });
                
                // Add event listeners to add buttons
                personnelResults.querySelectorAll('.add-personnel-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const person = this.dataset.person;
                        if (!selectedPersonnel.includes(person)) {
                            selectedPersonnel.push(person);
                            updateSelectedPersonnelTags();
                            updatePersonnelHiddenInput();
                            showToast(`Personil "${person}" berhasil ditambahkan`, 'success');
                        }
                    });
                });
            }
            
            function updateSelectedPersonnelTags() {
                selectedPersonnelTags.innerHTML = '';
                
                selectedPersonnel.forEach(person => {
                    const tag = document.createElement('div');
                    tag.className = 'personnel-tag';
                    tag.innerHTML = `
                        <span>${person}</span>
                        <button type="button" class="ml-2 text-red-500 hover:text-red-700 remove-tag" data-person="${person}">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    `;
                    selectedPersonnelTags.appendChild(tag);
                });
                
                // Add event listeners to remove buttons
                selectedPersonnelTags.querySelectorAll('.remove-tag').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const personToRemove = this.dataset.person;
                        selectedPersonnel = selectedPersonnel.filter(p => p !== personToRemove);
                        updateSelectedPersonnelTags();
                        updatePersonnelHiddenInput();
                    });
                });
            }
            
            function updatePersonnelHiddenInput() {
                personnelHiddenInput.value = JSON.stringify(selectedPersonnel);
            }
            
            function loadExistingPersonnel(personnelArray) {
                if (!personnelArray || !Array.isArray(personnelArray)) return;
                
                selectedPersonnel = [...personnelArray];
                updateSelectedPersonnelTags();
                updatePersonnelHiddenInput();
                renderPersonnelResults('');
            }
            
            return { loadExistingPersonnel };
        }

        // ==================== AUTOCOMPLETE FUNCTIONS ====================
        function setupAutocomplete(type) {
            const input = document.getElementById(type);
            const dropdown = document.getElementById(`${type}Autocomplete`);
            
            if (!input || !dropdown) return;
            
            input.addEventListener('input', function() {
                const value = this.value.trim();
                if (value.length < 2) {
                    hideAutocomplete(type);
                    return;
                }
                
                showAutocomplete(type, value);
            });
            
            input.addEventListener('focus', function() {
                const value = this.value.trim();
                if (value.length >= 2) {
                    showAutocomplete(type, value);
                }
            });
            
            input.addEventListener('blur', function() {
                setTimeout(() => {
                    hideAutocomplete(type);
                }, 200);
            });
        }

        function showAutocomplete(type, searchTerm) {
            const dropdown = document.getElementById(`${type}Autocomplete`);
            if (!dropdown) return;
            
            const values = dataHistory[type] || [];
            const filtered = values.filter(value => 
                value.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            if (filtered.length === 0) {
                dropdown.innerHTML = `
                    <div class="autocomplete-item">
                        <div class="text-gray-500 text-sm">Tidak ditemukan</div>
                        <div class="autocomplete-info">Tekan Enter untuk menambahkan baru</div>
                    </div>
                `;
            } else {
                dropdown.innerHTML = filtered.map(value => {
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    const highlighted = value.replace(regex, '<span class="highlight">$1</span>');
                    return `
                        <div class="autocomplete-item" data-value="${value.replace(/"/g, '&quot;')}">
                            <div class="text-sm">${highlighted}</div>
                            <div class="autocomplete-info">Klik untuk memilih</div>
                        </div>
                    `;
                }).join('');
            }
            
            dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    const input = document.getElementById(type);
                    if (input && this.dataset.value) {
                        input.value = this.dataset.value;
                        hideAutocomplete(type);
                    }
                });
            });
            
            dropdown.classList.add('show');
        }

        function hideAutocomplete(type) {
            const dropdown = document.getElementById(`${type}Autocomplete`);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        // ==================== USER ROLE FUNCTIONS ====================
        async function fixUserRoleIfNeeded(userId, userEmail) {
            try {
                const userDoc = await usersCollection.doc(userId).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    let correctRole = 'user';
                    
                    console.log('Checking email for role fix:', userEmail);
                    
                    if (userEmail === 'admin@genetek.co.id') {
                        correctRole = 'admin';
                    } else if (userEmail === 'm_husni@genetek.co.id') {
                        correctRole = 'manager';
                    } else if (userEmail === 'galih@genetek.co.id') {
                        correctRole = 'user';
                    }
                    
                    console.log('Current role:', userData.role, 'Correct role:', correctRole);
                    
                    if (userData.role !== correctRole) {
                        console.log(`Fixing role for ${userEmail}: from ${userData.role} to ${correctRole}`);
                        
                        await usersCollection.doc(userId).update({
                            role: correctRole,
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        currentUserRole = correctRole;
                        console.log('Role fixed successfully');
                        return correctRole;
                    } else {
                        currentUserRole = userData.role;
                        return userData.role;
                    }
                }
                return null;
            } catch (error) {
                console.error('Error fixing user role:', error);
                return null;
            }
        }

        // ==================== ROLE-BASED ACCESS CONTROL ====================
        function setupUserRolePermissions() {
            console.log('Setting up permissions for role:', currentUserRole);
            
            const exportBtn = document.getElementById('exportExcelBtn');
            const newWorkOrderBtn = document.getElementById('newWorkOrderBtn');
            const analyticsBtn = document.getElementById('analyticsBtn');
            const activityBtn = document.getElementById('activityBtn');
            const statusHistoryBtn = document.getElementById('statusHistoryBtn');
            const pipelinesBtn = document.getElementById('pipelinesBtn');
            const documentationBtn = document.getElementById('documentationBtn');
            const personnelListBtn = document.getElementById('personnelListBtn');
            
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.className = 'user-avatar';
                if (currentUserRole === 'admin') {
                    userAvatar.classList.add('admin');
                } else if (currentUserRole === 'manager') {
                    userAvatar.classList.add('manager');
                } else {
                    userAvatar.classList.add('user');
                }
            }
            
            const roleBadge = document.getElementById('userRoleBadge');
            if (roleBadge) {
                roleBadge.className = `badge badge-${currentUserRole === 'admin' ? 'secondary' : currentUserRole === 'manager' ? 'primary' : 'info'}`;
                roleBadge.innerHTML = `<i class="fas fa-user-tag"></i><span>${currentUserRole.charAt(0).toUpperCase() + currentUserRole.slice(1)}</span>`;
            }
            
            // Hide all buttons first
            if (exportBtn) exportBtn.classList.add('hidden');
            if (newWorkOrderBtn) newWorkOrderBtn.classList.add('hidden');
            if (analyticsBtn) analyticsBtn.classList.add('hidden');
            if (activityBtn) activityBtn.classList.add('hidden');
            if (statusHistoryBtn) statusHistoryBtn.classList.add('hidden');
            if (pipelinesBtn) pipelinesBtn.classList.add('hidden');
            if (documentationBtn) documentationBtn.classList.add('hidden');
            if (personnelListBtn) personnelListBtn.classList.add('hidden');
            
            switch(currentUserRole) {
                case 'admin':
                    if (exportBtn) exportBtn.classList.remove('hidden');
                    if (newWorkOrderBtn) newWorkOrderBtn.classList.remove('hidden');
                    if (analyticsBtn) analyticsBtn.classList.remove('hidden');
                    if (activityBtn) activityBtn.classList.remove('hidden');
                    if (statusHistoryBtn) statusHistoryBtn.classList.remove('hidden');
                    if (pipelinesBtn) pipelinesBtn.classList.remove('hidden');
                    if (documentationBtn) documentationBtn.classList.remove('hidden');
                    if (personnelListBtn) personnelListBtn.classList.remove('hidden');
                    break;
                    
                case 'manager':
                    if (newWorkOrderBtn) newWorkOrderBtn.classList.remove('hidden');
                    if (analyticsBtn) analyticsBtn.classList.remove('hidden');
                    if (activityBtn) activityBtn.classList.remove('hidden');
                    if (statusHistoryBtn) statusHistoryBtn.classList.remove('hidden');
                    if (pipelinesBtn) pipelinesBtn.classList.remove('hidden');
                    if (documentationBtn) documentationBtn.classList.remove('hidden');
                    if (personnelListBtn) personnelListBtn.classList.remove('hidden');
                    break;
                    
                case 'user':
                    if (pipelinesBtn) pipelinesBtn.classList.remove('hidden');
                    if (documentationBtn) documentationBtn.classList.remove('hidden');
                    if (personnelListBtn) personnelListBtn.classList.remove('hidden');
                    break;
                    
                default:
                    break;
            }
            
            console.log('Permissions set for role:', currentUserRole);
        }

        function canCreateWorkOrder() {
            return currentUserRole === 'admin' || currentUserRole === 'manager';
        }

        function canEditWorkOrder() {
            return currentUserRole === 'admin' || currentUserRole === 'manager';
        }

        function canDeleteWorkOrder() {
            return currentUserRole === 'admin';
        }

        function canExportData() {
            return currentUserRole === 'admin';
        }

        function canViewAnalytics() {
            return currentUserRole === 'admin' || currentUserRole === 'manager';
        }

        function canViewActivity() {
            return currentUserRole === 'admin' || currentUserRole === 'manager';
        }

        function canViewStatusHistory() {
            return currentUserRole === 'admin' || currentUserRole === 'manager';
        }

        function canViewDocumentation() {
            return currentUserRole === 'admin' || currentUserRole === 'manager' || currentUserRole === 'user';
        }

        // ==================== AUTH FUNCTIONS ====================
        function setupAuthStateObserver() {
            if (!auth) {
                console.error('Auth not available');
                return;
            }

            console.log('Setting up auth state observer...');
            
            auth.onAuthStateChanged(async (user) => {
                console.log('Auth state changed:', user ? 'User logged in' : 'User logged out');
                
                if (user) {
                    currentUser = user;
                    
                    try {
                        const fixedRole = await fixUserRoleIfNeeded(user.uid, user.email);
                        
                        if (fixedRole) {
                            currentUserRole = fixedRole;
                            console.log('Role after fix:', currentUserRole);
                        } else {
                            await getUserRoleFromFirestore(user.uid);
                        }
                        
                        document.getElementById('userWelcome').textContent = user.email;
                        setupUserRolePermissions();
                        document.getElementById('loginPage').classList.add('hidden');
                        document.getElementById('appPage').classList.remove('hidden');
                        initApp();
                        showToast('Login successful! Welcome back.', 'success');
                        logActivity('login', `User logged in: ${user.email}`);
                        
                    } catch (error) {
                        console.error('Error in auth observer:', error);
                        showToast('Error loading user data', 'error');
                    }
                } else {
                    console.log('User signed out');
                    currentUser = null;
                    currentUserRole = 'user';
                    document.getElementById('appPage').classList.add('hidden');
                    document.getElementById('loginPage').classList.remove('hidden');
                    
                    const loginForm = document.getElementById('loginForm');
                    if (loginForm) {
                        loginForm.reset();
                    }
                    
                    const errorDiv = document.getElementById('loginError');
                    if (errorDiv) errorDiv.classList.add('hidden');
                }
            }, (error) => {
                console.error('Auth observer error:', error);
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            if (errorDiv) errorDiv.classList.add('hidden');

            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }

            try {
                showLoading();
                console.log('Attempting login with email:', email);
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Login successful:', userCredential.user.email);
                
            } catch (error) {
                console.error('Login error:', error);
                
                let errorMessage = 'Login failed. Please try again.';
                switch(error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password. Please try again.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email format.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many failed attempts. Please try again later.';
                        break;
                }
                
                showError(errorMessage);
            } finally {
                hideLoading();
            }
        }

        async function getUserRoleFromFirestore(userId) {
            console.log('Getting user role for:', userId);
            console.log('Current user email:', currentUser?.email);
            
            try {
                const userDoc = await usersCollection.doc(userId).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role || 'user';
                    console.log('User role from Firestore:', currentUserRole);
                    
                    await usersCollection.doc(userId).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    console.log('Creating new user document...');
                    let defaultRole = 'user';
                    const userEmail = currentUser.email;
                    
                    console.log('Checking email for role assignment:', userEmail);
                    
                    if (userEmail === 'admin@genetek.co.id') {
                        defaultRole = 'admin';
                        console.log('Setting role to admin for', userEmail);
                    } else if (userEmail === 'm_husni@genetek.co.id') {
                        defaultRole = 'manager';
                        console.log('Setting role to manager for', userEmail);
                    } else if (userEmail === 'galih@genetek.co.id') {
                        defaultRole = 'user';
                        console.log('Setting role to user for', userEmail);
                    } else {
                        console.log('Default role user for unknown email:', userEmail);
                    }
                    
                    await usersCollection.doc(userId).set({
                        email: userEmail,
                        role: defaultRole,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    currentUserRole = defaultRole;
                    console.log('Created new user with role:', currentUserRole);
                }
                
                return currentUserRole;
                
            } catch (error) {
                console.error('Error getting user role:', error);
                currentUserRole = 'user';
                return 'user';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorMessage = document.getElementById('errorMessage');
            if (errorDiv && errorMessage) {
                errorMessage.textContent = message;
                errorDiv.classList.remove('hidden');
            }
        }

        function logout() {
            console.log('Logging out...');
            
            if (auth && currentUser) {
                auth.signOut().then(() => {
                    console.log('Logout successful');
                    showToast('Logged out successfully', 'success');
                }).catch(error => {
                    console.error('Logout error:', error);
                    showToast('Error signing out', 'error');
                });
            } else {
                currentUser = null;
                currentUserRole = 'user';
                document.getElementById('appPage').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                showToast('Logged out successfully', 'success');
            }
        }

        // ==================== ACTIVITY & STATUS HISTORY FUNCTIONS ====================
        async function logActivity(action, details, workorderId = null) {
            try {
                if (!currentUser) return;
                
                const activityData = {
                    userEmail: currentUser.email,
                    userRole: currentUserRole,
                    action: action,
                    details: details,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    workorderId: workorderId
                };
                
                await activitiesCollection.add(activityData);
                
                if (!document.getElementById('activityModal').classList.contains('hidden')) {
                    loadRecentActivities();
                }
                
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }

        async function logStatusChange(workorderId, workOrderNumber, oldStatus, newStatus) {
            try {
                if (!currentUser) return;
                
                const statusChangeData = {
                    workorderId: workorderId,
                    workOrderNumber: workOrderNumber,
                    oldStatus: oldStatus,
                    newStatus: newStatus,
                    changedBy: currentUser.email,
                    userRole: currentUserRole,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await statusHistoryCollection.add(statusChangeData);
                
                if (!document.getElementById('statusHistoryModal').classList.contains('hidden')) {
                    loadStatusHistory();
                }
                
            } catch (error) {
                console.error('Error logging status change:', error);
            }
        }

        async function loadRecentActivities() {
            try {
                const querySnapshot = await activitiesCollection
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                const activityFeed = document.getElementById('activityFeed');
                if (!activityFeed) return;
                
                activityFeed.innerHTML = '';
                
                if (querySnapshot.empty) {
                    activityFeed.innerHTML = `
                        <div class="text-center py-12 text-gray-400">
                            <div class="w-20 h-20 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-history text-3xl text-blue-400"></i>
                            </div>
                            <p class="text-lg font-medium text-gray-600 mb-2">No activity recorded yet</p>
                            <p class="text-gray-500">Activities will appear here</p>
                        </div>
                    `;
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const activity = doc.data();
                    const activityItem = createActivityItem(activity);
                    activityFeed.appendChild(activityItem);
                });
                
            } catch (error) {
                console.error('Error loading activities:', error);
                document.getElementById('activityFeed').innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gradient-to-br from-red-100 to-pink-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-exclamation-circle text-3xl text-red-400"></i>
                        </div>
                        <p class="text-lg font-medium text-gray-600 mb-2">Failed to load activities</p>
                        <p class="text-gray-500">Please try again later</p>
                    </div>
                `;
            }
        }

        async function loadStatusHistory(filter = 'all', searchTerm = '') {
            try {
                let query = statusHistoryCollection.orderBy('timestamp', 'desc').limit(50);
                
                if (filter !== 'all') {
                    query = query.where('newStatus', '==', filter);
                }
                
                const querySnapshot = await query.get();
                const statusHistoryFeed = document.getElementById('statusHistoryFeed');
                
                if (!statusHistoryFeed) return;
                
                statusHistoryFeed.innerHTML = '';
                
                if (querySnapshot.empty) {
                    statusHistoryFeed.innerHTML = `
                        <div class="text-center py-12 text-gray-400">
                            <div class="w-20 h-20 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-exchange-alt text-3xl text-blue-400"></i>
                            </div>
                            <p class="text-lg font-medium text-gray-600 mb-2">No status change history</p>
                            <p class="text-gray-500">Status changes will appear here</p>
                        </div>
                    `;
                    return;
                }
                
                let filteredItems = [];
                querySnapshot.forEach((doc) => {
                    const statusChange = doc.data();
                    
                    if (searchTerm && !statusChange.workOrderNumber.toLowerCase().includes(searchTerm.toLowerCase())) {
                        return;
                    }
                    
                    filteredItems.push(statusChange);
                });
                
                if (filteredItems.length === 0) {
                    statusHistoryFeed.innerHTML = `
                        <div class="text-center py-12 text-gray-400">
                            <div class="w-20 h-20 bg-gradient-to-br from-yellow-100 to-orange-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-search text-3xl text-yellow-400"></i>
                            </div>
                            <p class="text-lg font-medium text-gray-600 mb-2">No matching results</p>
                            <p class="text-gray-500">Try different search criteria</p>
                        </div>
                    `;
                    return;
                }
                
                filteredItems.forEach((statusChange) => {
                    const statusItem = createStatusHistoryItem(statusChange);
                    statusHistoryFeed.appendChild(statusItem);
                });
                
            } catch (error) {
                console.error('Error loading status history:', error);
                document.getElementById('statusHistoryFeed').innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gradient-to-br from-red-100 to-pink-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-exclamation-circle text-3xl text-red-400"></i>
                        </div>
                        <p class="text-lg font-medium text-gray-600 mb-2">Failed to load status history</p>
                        <p class="text-gray-500">Please try again later</p>
                    </div>
                `;
            }
        }

        async function loadWorkOrderStatusHistory(workorderId) {
            try {
                const querySnapshot = await statusHistoryCollection
                    .where('workorderId', '==', workorderId)
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const container = document.getElementById('detailStatusHistory');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (querySnapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-6 text-gray-500 text-sm">
                            <i class="fas fa-info-circle mr-2"></i>
                            No status change history available
                        </div>
                    `;
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const statusChange = doc.data();
                    const statusItem = createWorkOrderStatusHistoryItem(statusChange);
                    container.appendChild(statusItem);
                });
                
            } catch (error) {
                console.error('Error loading work order status history:', error);
            }
        }

        function createActivityItem(activity) {
            const item = document.createElement('div');
            item.className = 'card animate-slide-in-right';
            
            const icon = getActivityIcon(activity.action);
            const timeAgo = formatTimeAgo(activity.timestamp);
            
            item.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center flex-shrink-0">
                        <i class="fas ${icon} text-blue-600 text-lg"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-900">${activity.details}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <span class="text-sm text-gray-500">
                                <i class="fas fa-user mr-1"></i>
                                ${activity.userEmail}  ${activity.userRole}
                            </span>
                            <span class="text-sm text-gray-500">
                                <i class="far fa-clock mr-1"></i>
                                ${timeAgo}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            return item;
        }

        function createStatusHistoryItem(statusChange) {
            const item = document.createElement('div');
            item.className = 'card animate-slide-in-right';
            
            const timeAgo = formatTimeAgo(statusChange.timestamp);
            
            const statusColors = {
                'Running': 'bg-blue-100 text-blue-700',
                'Done': 'bg-green-100 text-green-700',
                'Close': 'bg-gray-100 text-gray-700'
            };
            
            item.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-100 to-orange-100 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-exchange-alt text-yellow-600 text-lg"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-900">
                            Status changed from 
                            <span class="font-bold ${statusColors[statusChange.oldStatus] || 'text-gray-700'}">${statusChange.oldStatus}</span>
                            to
                            <span class="font-bold ${statusColors[statusChange.newStatus] || 'text-gray-700'}">${statusChange.newStatus}</span>
                        </p>
                        <p class="text-gray-600 mt-1">Work Order: ${statusChange.workOrderNumber}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <span class="text-sm text-gray-500">
                                <i class="fas fa-user mr-1"></i>
                                ${statusChange.changedBy}  ${statusChange.userRole}
                            </span>
                            <span class="text-sm text-gray-500">
                                <i class="far fa-clock mr-1"></i>
                                ${timeAgo}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            return item;
        }

        function createWorkOrderStatusHistoryItem(statusChange) {
            const item = document.createElement('div');
            item.className = `card card-${statusChange.newStatus.toLowerCase()}`;
            
            const timeAgo = formatTimeAgo(statusChange.timestamp);
            
            item.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <span class="font-medium text-gray-900">Status changed to <span class="font-bold">${statusChange.newStatus}</span></span>
                        <p class="text-sm text-gray-600 mt-1">Changed by: ${statusChange.changedBy} (${statusChange.userRole})</p>
                    </div>
                    <span class="text-sm text-gray-500">${timeAgo}</span>
                </div>
            `;
            
            return item;
        }

        function getActivityIcon(action) {
            const icons = {
                'create': 'fa-plus-circle',
                'update': 'fa-edit',
                'delete': 'fa-trash',
                'login': 'fa-sign-in-alt',
                'logout': 'fa-sign-out-alt',
                'export': 'fa-file-export',
                'view': 'fa-eye',
                'status_change': 'fa-exchange-alt',
                'capture_documentation': 'fa-camera',
                'delete_documentation': 'fa-trash-alt'
            };
            return icons[action.toLowerCase()] || 'fa-history';
        }

        // ==================== ANALYTICS FUNCTIONS ====================
        async function loadAnalytics() {
            console.log('Loading analytics data...');
            showLoading();
            
            try {
                const querySnapshot = await workordersCollection.get();
                const allWorkOrders = [];
                querySnapshot.forEach((doc) => {
                    allWorkOrders.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                document.getElementById('dataUpdatedTime').textContent = new Date().toLocaleString('id-ID');
                generateStatusChart(allWorkOrders);
                generateDivisionChart(allWorkOrders);
                generateMonthlyTrendChart(allWorkOrders);
                generateCompanyChart(allWorkOrders);
                generateCompletionTimeChart(allWorkOrders);
                updateAnalyticsSummary(allWorkOrders);
                
                showToast('Analytics data loaded successfully', 'success');
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showToast('Failed to load analytics data', 'error');
            } finally {
                hideLoading();
            }
        }

        function generateStatusChart(workOrders) {
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;
            
            if (charts.statusChart) {
                charts.statusChart.destroy();
            }
            
            const statusCounts = {
                'Running': 0,
                'Done': 0,
                'Close': 0
            };
            
            workOrders.forEach(wo => {
                if (statusCounts[wo.status] !== undefined) {
                    statusCounts[wo.status]++;
                }
            });
            
            const total = workOrders.length;
            const completionRate = total > 0 ? Math.round((statusCounts['Done'] / total) * 100) : 0;
            
            document.getElementById('statusChartInfo').innerHTML = `
                <div class="grid grid-cols-3 gap-3 text-sm">
                    <div class="text-center">
                        <div class="font-semibold text-blue-600">${statusCounts['Running']}</div>
                        <div class="text-gray-500 text-xs">Running</div>
                    </div>
                    <div class="text-center">
                        <div class="font-semibold text-green-600">${statusCounts['Done']}</div>
                        <div class="text-gray-500 text-xs">Done</div>
                    </div>
                    <div class="text-center">
                        <div class="font-semibold text-gray-600">${statusCounts['Close']}</div>
                        <div class="text-gray-500 text-xs">Closed</div>
                    </div>
                </div>
            `;
            
            charts.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Running', 'Done', 'Closed'],
                    datasets: [{
                        data: [statusCounts['Running'], statusCounts['Done'], statusCounts['Close']],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.9)',
                            'rgba(16, 185, 129, 0.9)',
                            'rgba(148, 163, 184, 0.9)'
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(16, 185, 129)',
                            'rgb(148, 163, 184)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 15
                            }
                        },
                        title: {
                            display: true,
                            text: `Completion Rate: ${completionRate}%`,
                            font: {
                                size: 14
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
        }

        function generateDivisionChart(workOrders) {
            const ctx = document.getElementById('divisionChart');
            if (!ctx) return;
            
            if (charts.divisionChart) {
                charts.divisionChart.destroy();
            }
            
            const divisionCounts = {};
            workOrders.forEach(wo => {
                if (wo.division) {
                    divisionCounts[wo.division] = (divisionCounts[wo.division] || 0) + 1;
                }
            });
            
            const sortedDivisions = Object.entries(divisionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            const colors = generateColors(sortedDivisions.length);
            
            charts.divisionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedDivisions.map(d => d[0]),
                    datasets: [{
                        label: 'Work Orders',
                        data: sortedDivisions.map(d => d[1]),
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.9', '1')),
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Work Orders',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateMonthlyTrendChart(workOrders) {
            const ctx = document.getElementById('monthlyTrendChart');
            if (!ctx) return;
            
            if (charts.monthlyTrendChart) {
                charts.monthlyTrendChart.destroy();
            }
            
            const monthlyData = {};
            workOrders.forEach(wo => {
                if (wo.createdAt) {
                    const date = wo.createdAt.toDate();
                    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    monthlyData[monthYear] = (monthlyData[monthYear] || 0) + 1;
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const last6Months = sortedMonths.slice(-6);
            
            charts.monthlyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last6Months.map(m => {
                        const [year, month] = m.split('-');
                        return `${month}/${year.slice(2)}`;
                    }),
                    datasets: [{
                        label: 'Work Orders Created',
                        data: last6Months.map(m => monthlyData[m] || 0),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.15)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: 'white',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Work Orders',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateCompanyChart(workOrders) {
            const ctx = document.getElementById('companyChart');
            if (!ctx) return;
            
            if (charts.companyChart) {
                charts.companyChart.destroy();
            }
            
            const companyCounts = {};
            workOrders.forEach(wo => {
                if (wo.company) {
                    companyCounts[wo.company] = (companyCounts[wo.company] || 0) + 1;
                }
            });
            
            const colors = generateColors(Object.keys(companyCounts).length);
            
            charts.companyChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(companyCounts),
                    datasets: [{
                        data: Object.values(companyCounts),
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.9', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        function generateCompletionTimeChart(workOrders) {
            const ctx = document.getElementById('completionTimeChart');
            if (!ctx) return;
            
            if (charts.completionTimeChart) {
                charts.completionTimeChart.destroy();
            }
            
            const completionTimes = [];
            workOrders.forEach(wo => {
                if (wo.status === 'Done' && wo.startDate && wo.endDate) {
                    const start = wo.startDate.toDate();
                    const end = wo.endDate.toDate();
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    completionTimes.push(diffDays);
                }
            });
            
            const timeGroups = {
                '0-1 days': 0,
                '2-3 days': 0,
                '4-7 days': 0,
                '1-2 weeks': 0,
                '2+ weeks': 0
            };
            
            completionTimes.forEach(days => {
                if (days <= 1) timeGroups['0-1 days']++;
                else if (days <= 3) timeGroups['2-3 days']++;
                else if (days <= 7) timeGroups['4-7 days']++;
                else if (days <= 14) timeGroups['1-2 weeks']++;
                else timeGroups['2+ weeks']++;
            });
            
            const avgCompletionTime = completionTimes.length > 0 
                ? Math.round(completionTimes.reduce((a, b) => a + b, 0) / completionTimes.length * 10) / 10
                : 0;
            
            document.getElementById('completionTimeInfo').innerHTML = `
                <div class="text-center">
                    <div class="font-semibold text-blue-600 text-sm">Average Completion Time: ${avgCompletionTime} days</div>
                    <div class="text-xs text-gray-500 mt-1">Based on ${completionTimes.length} completed work orders</div>
                </div>
            `;
            
            charts.completionTimeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(timeGroups),
                    datasets: [{
                        label: 'Number of Work Orders',
                        data: Object.values(timeGroups),
                        backgroundColor: 'rgba(59, 130, 246, 0.9)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Work Orders',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateColors(count) {
            const baseColors = [
                'rgba(59, 130, 246, 0.9)',
                'rgba(139, 92, 246, 0.9)',
                'rgba(16, 185, 129, 0.9)',
                'rgba(245, 158, 11, 0.9)',
                'rgba(239, 68, 68, 0.9)',
                'rgba(14, 165, 233, 0.9)',
                'rgba(251, 191, 36, 0.9)',
                'rgba(34, 197, 94, 0.9)'
            ];
            
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            return colors;
        }

        function updateAnalyticsSummary(workOrders) {
            const completedOrders = workOrders.filter(wo => wo.status === 'Done');
            const completionTimes = [];
            completedOrders.forEach(wo => {
                if (wo.startDate && wo.endDate) {
                    const start = wo.startDate.toDate();
                    const end = wo.endDate.toDate();
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    completionTimes.push(diffDays);
                }
            });
            
            const avgCompletionTime = completionTimes.length > 0 
                ? Math.round(completionTimes.reduce((a, b) => a + b, 0) / completionTimes.length * 10) / 10
                : 0;
            
            const divisionCounts = {};
            workOrders.forEach(wo => {
                if (wo.division) {
                    divisionCounts[wo.division] = (divisionCounts[wo.division] || 0) + 1;
                }
            });
            
            let mostActiveDivision = '-';
            let maxCount = 0;
            Object.entries(divisionCounts).forEach(([division, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    mostActiveDivision = division;
                }
            });
            
            const totalOrders = workOrders.length;
            const completedCount = completedOrders.length;
            const completionRate = totalOrders > 0 ? Math.round((completedCount / totalOrders) * 100) : 0;
            
            const customerCounts = {};
            workOrders.forEach(wo => {
                if (wo.customer) {
                    customerCounts[wo.customer] = (customerCounts[wo.customer] || 0) + 1;
                }
            });
            
            let topCustomer = '-';
            let topCustomerCount = 0;
            Object.entries(customerCounts).forEach(([customer, count]) => {
                if (count > topCustomerCount) {
                    topCustomerCount = count;
                    topCustomer = customer;
                }
            });
            
            document.getElementById('avgCompletionTime').textContent = avgCompletionTime;
            document.getElementById('mostActiveDivision').textContent = mostActiveDivision;
            document.getElementById('completionRate').textContent = `${completionRate}%`;
            document.getElementById('topCustomer').textContent = topCustomer;
        }

        // ==================== MODAL FUNCTIONS ====================
        function createNewWorkOrder() {
            console.log('Creating new work order');
            
            if (!canCreateWorkOrder()) {
                showToast('You do not have permission to create work orders', 'warning');
                return;
            }
            
            openWorkOrderModal();
        }

        async function openWorkOrderModal(workorderId = null) {
            console.log('Opening work order modal:', workorderId ? 'edit' : 'create');
            
            const modal = document.getElementById('workorderModal');
            const modalTitle = document.getElementById('modalTitle');
            
            document.getElementById('workorderForm').reset();
            document.getElementById('workorderId').value = '';
            document.getElementById('originalStatus').value = '';
            
            if (workorderId && !canEditWorkOrder()) {
                showToast('You do not have permission to edit work orders', 'warning');
                return;
            }
            
            setupAutocomplete('customer');
            setupAutocomplete('building');
            setupAutocomplete('workType');
            
            const personnelManager = setupPersonnelMultiSelect();
            
            if (workorderId) {
                modalTitle.textContent = 'Edit Work Order';
                const workorder = workorders.find(wo => wo.id === workorderId);
                if (workorder) {
                    populateModalForm(workorder);
                    document.getElementById('originalStatus').value = workorder.status;
                    
                    if (workorder.personnel) {
                        let personnelArray = [];
                        if (Array.isArray(workorder.personnel)) {
                            personnelArray = workorder.personnel;
                        } else if (typeof workorder.personnel === 'string') {
                            try {
                                personnelArray = JSON.parse(workorder.personnel);
                            } catch (e) {
                                personnelArray = [workorder.personnel];
                            }
                        }
                        personnelManager.loadExistingPersonnel(personnelArray);
                    }
                }
            } else {
                modalTitle.textContent = 'Create New Work Order';
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('startDate').value = today;
                document.getElementById('status').value = 'Running';
                document.getElementById('priority').value = 'Normal';
                await updateIntegratedWorkOrderNumber();
            }
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        async function updateIntegratedWorkOrderNumber() {
            try {
                const startDate = document.getElementById('startDate').value;
                const company = document.getElementById('company').value;
                
                if (startDate && company) {
                    const woNumber = await generateIntegratedWorkOrderNumber(startDate, company);
                    document.getElementById('workOrderNumber').value = woNumber;
                } else {
                    document.getElementById('workOrderNumber').value = '001/GI-GEN/FAS/I/2025';
                }
            } catch (error) {
                console.error('Error updating integrated work order number:', error);
                document.getElementById('workOrderNumber').value = '001/GI-GEN/FAS/I/2025';
            }
        }

        function closeWorkOrderModal() {
            document.getElementById('workorderModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function populateModalForm(workorder) {
            document.getElementById('workorderId').value = workorder.id;
            document.getElementById('workOrderNumber').value = workorder.workOrderNumber || '';
            document.getElementById('soNumber').value = workorder.soNumber || '';
            document.getElementById('customer').value = workorder.customer || '';
            document.getElementById('building').value = workorder.building || '';
            document.getElementById('division').value = workorder.division || '';
            document.getElementById('company').value = workorder.company || '';
            document.getElementById('workType').value = workorder.workType || '';
            document.getElementById('pic').value = workorder.pic || '';
            document.getElementById('status').value = workorder.status || 'Running';
            document.getElementById('priority').value = workorder.priority || 'Normal';
            document.getElementById('estimatedTime').value = workorder.estimatedTime || '';
            document.getElementById('notes').value = workorder.notes || '';
            
            if (workorder.startDate) {
                const startDate = workorder.startDate.toDate();
                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            }
            if (workorder.endDate) {
                const endDate = workorder.endDate.toDate();
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            }
        }

        async function saveWorkOrder() {
            const form = document.getElementById('workorderForm');
            if (!form.checkValidity()) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            const workorderId = document.getElementById('workorderId').value;
            const originalStatus = document.getElementById('originalStatus').value;
            const isEdit = !!workorderId;
            
            const customer = document.getElementById('customer').value.trim();
            const building = document.getElementById('building').value.trim();
            const workType = document.getElementById('workType').value.trim();
            
            const personnelJSON = document.getElementById('personnel').value;
            let personnelArray = [];
            if (personnelJSON) {
                try {
                    personnelArray = JSON.parse(personnelJSON);
                } catch (e) {
                    personnelArray = [];
                }
            }
            
            const workorderData = {
                workOrderNumber: document.getElementById('workOrderNumber').value,
                soNumber: document.getElementById('soNumber').value || '',
                customer: customer,
                building: building,
                division: document.getElementById('division').value,
                company: document.getElementById('company').value,
                workType: workType,
                pic: document.getElementById('pic').value || '',
                personnel: personnelArray,
                status: document.getElementById('status').value,
                priority: document.getElementById('priority').value || 'Normal',
                estimatedTime: parseFloat(document.getElementById('estimatedTime').value) || 0,
                notes: document.getElementById('notes').value || '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser.email
            };
            
            const startDate = document.getElementById('startDate').value;
            if (startDate) {
                workorderData.startDate = firebase.firestore.Timestamp.fromDate(new Date(startDate));
            }
            
            const endDate = document.getElementById('endDate').value;
            if (endDate) {
                workorderData.endDate = firebase.firestore.Timestamp.fromDate(new Date(endDate));
            }
            
            try {
                showLoading();
                
                if (isEdit) {
                    await workordersCollection.doc(workorderId).update(workorderData);
                    
                    const newStatus = workorderData.status;
                    if (originalStatus !== newStatus) {
                        const workOrderNumber = workorderData.workOrderNumber;
                        await logStatusChange(workorderId, workOrderNumber, originalStatus, newStatus);
                        logActivity('status_change', `Status changed from ${originalStatus} to ${newStatus} for ${workOrderNumber}`, workorderId);
                    }
                    
                    showToast('Work order updated successfully', 'success');
                    logActivity('update', `Updated work order ${workorderData.workOrderNumber}`, workorderId);
                } else {
                    workorderData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    workorderData.createdBy = currentUser.email;
                    workorderData.photos = []; // Initialize empty photos array
                    const result = await workordersCollection.add(workorderData);
                    
                    await logStatusChange(result.id, workorderData.workOrderNumber, 'New', workorderData.status);
                    
                    showToast('Work order created successfully', 'success');
                    logActivity('create', `Created new work order ${workorderData.workOrderNumber}`, result.id);
                }
                
                await saveToDataHistory('customer', customer);
                await saveToDataHistory('building', building);
                await saveToDataHistory('workType', workType);
                
                personnelArray.forEach(async person => {
                    await saveToDataHistory('personnel', person);
                });
                
                closeWorkOrderModal();
                
            } catch (error) {
                console.error('Error saving work order:', error);
                showToast('Failed to save work order', 'error');
            } finally {
                hideLoading();
            }
        }

        async function openWorkOrderDetailModal(workorderId) {
            console.log('Opening detail modal for:', workorderId);
            
            const modal = document.getElementById('workorderDetailModal');
            const workorder = workorders.find(wo => wo.id === workorderId);
            
            if (!workorder) {
                showToast('Work order not found', 'error');
                return;
            }
            
            let personnelArray = [];
            if (workorder.personnel) {
                if (Array.isArray(workorder.personnel)) {
                    personnelArray = workorder.personnel;
                } else if (typeof workorder.personnel === 'string') {
                    try {
                        personnelArray = JSON.parse(workorder.personnel);
                    } catch (e) {
                        personnelArray = [workorder.personnel];
                    }
                }
            }
            
            document.getElementById('workorderDetailTitle').textContent = 
                `Work Order: ${workorder.workOrderNumber}`;
            document.getElementById('detailWorkOrderNumber').textContent = workorder.workOrderNumber;
            document.getElementById('detailSONumber').textContent = workorder.soNumber || '-';
            document.getElementById('detailCustomer').textContent = workorder.customer || '-';
            document.getElementById('detailBuilding').textContent = workorder.building || '-';
            document.getElementById('detailWorkType').textContent = workorder.workType || '-';
            document.getElementById('detailDivision').textContent = workorder.division || '-';
            document.getElementById('detailCompany').textContent = workorder.company || '-';
            document.getElementById('detailPIC').textContent = workorder.pic || '-';
            const detailPersonnel = document.getElementById('detailPersonnel');
            detailPersonnel.innerHTML = '';
            if (personnelArray.length > 0) {
                personnelArray.forEach(person => {
                    const span = document.createElement('span');
                    span.className = 'badge badge-primary';
                    span.textContent = person;
                    detailPersonnel.appendChild(span);
                });
            } else {
                detailPersonnel.innerHTML = '<span class="text-gray-500 text-sm">No personnel assigned</span>';
            }
            document.getElementById('detailPriority').textContent = workorder.priority || 'Normal';
            document.getElementById('detailStartDate').textContent = formatDate(workorder.startDate);
            document.getElementById('detailEndDate').textContent = workorder.endDate ? formatDate(workorder.endDate) : '-';
            document.getElementById('detailEstimatedTime').textContent = workorder.estimatedTime ? `${workorder.estimatedTime} days` : '-';
            document.getElementById('detailCreatedDate').textContent = formatDate(workorder.createdAt);
            document.getElementById('detailNotes').textContent = workorder.notes || 'No notes';
            
            const statusBadge = document.getElementById('detailStatusBadge');
            statusBadge.className = `status-badge status-${workorder.status.toLowerCase()}`;
            statusBadge.textContent = workorder.status;
            
            const editBtn = document.getElementById('editDetailBtn');
            editBtn.dataset.id = workorderId;
            
            if (!canEditWorkOrder()) {
                editBtn.style.display = 'none';
            } else {
                editBtn.style.display = 'inline-flex';
            }
            
            // Load status history
            loadWorkOrderStatusHistory(workorderId);
            
            // Load photos for this work order
            const photos = await loadWorkOrderPhotos(workorderId);
            displayWorkOrderPhotos(photos);
            
            modal.classList.remove('hidden');
            
            logActivity('view', `Viewed work order ${workorder.workOrderNumber}`, workorderId);
        }

        function closeDetailModal() {
            document.getElementById('workorderDetailModal').classList.add('hidden');
        }

        function openAnalyticsModal() {
            console.log('Opening analytics modal');
            
            if (!canViewAnalytics()) {
                showToast('You do not have permission to view analytics', 'warning');
                return;
            }
            
            document.getElementById('analyticsModal').classList.remove('hidden');
            loadAnalytics();
        }

        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').classList.add('hidden');
            
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
        }

        function openActivityModal() {
            console.log('Opening activity modal');
            
            if (!canViewActivity()) {
                showToast('You do not have permission to view activity logs', 'warning');
                return;
            }
            
            document.getElementById('activityModal').classList.remove('hidden');
            loadRecentActivities();
        }

        function closeActivityModal() {
            document.getElementById('activityModal').classList.add('hidden');
        }

        function openStatusHistoryModal() {
            console.log('Opening status history modal');
            
            if (!canViewStatusHistory()) {
                showToast('You do not have permission to view status history', 'warning');
                return;
            }
            
            document.getElementById('statusHistoryModal').classList.remove('hidden');
            loadStatusHistory();
        }

        function closeStatusHistoryModal() {
            document.getElementById('statusHistoryModal').classList.add('hidden');
        }

        // ==================== PERSONNEL STATUS CONTROL FUNCTIONS ====================
        let selectedPersonnelForStatus = null;

        function setupStatusControl() {
            const statusControlBtn = document.createElement('button');
            statusControlBtn.id = 'statusControlBtn';
            statusControlBtn.className = 'btn btn-info hidden';
            statusControlBtn.innerHTML = '<i class="fas fa-user-cog mr-2"></i><span>Status Control</span>';
            
            // Tambahkan button ke action buttons
            const actionButtons = document.getElementById('actionButtons');
            actionButtons.appendChild(statusControlBtn);
            
            // Setup event listener
            statusControlBtn.addEventListener('click', function() {
                openStatusControlPopup();
            });
            
            // Setup event listener untuk save button di popup
            document.getElementById('saveStatusBtn').addEventListener('click', savePersonnelStatus);
        }

        function showStatusControlButton(show) {
            const btn = document.getElementById('statusControlBtn');
            if (btn) {
                if (show) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            }
        }

        function openStatusControlPopup() {
            console.log('Opening status control popup');
            
            const popup = document.getElementById('statusControlPopup');
            const person = findPersonnelByUserEmail(currentUser.email);
            
            if (!person) {
                showToast('Personnel data not found', 'warning');
                return;
            }
            
            selectedPersonnelForStatus = person;
            
            // Reset semua checkmarks
            document.querySelectorAll('.status-option .fa-check').forEach(check => {
                check.classList.add('hidden');
            });
            
            // Hilangkan semua active class
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Set active berdasarkan status saat ini
            const currentStatus = person.status || 'available';
            const currentOption = document.querySelector(`.status-option[data-status="${currentStatus}"]`);
            if (currentOption) {
                currentOption.classList.add('active');
                const check = currentOption.querySelector('.fa-check');
                if (check) check.classList.remove('hidden');
            }
            
            // Tampilkan popup
            popup.classList.add('show');
            
            // Setup click handlers untuk status options
            document.querySelectorAll('.status-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Hilangkan semua active class dan checkmarks
                    document.querySelectorAll('.status-option').forEach(opt => {
                        opt.classList.remove('active');
                        const check = opt.querySelector('.fa-check');
                        if (check) check.classList.add('hidden');
                    });
                    
                    // Set active untuk yang diklik
                    this.classList.add('active');
                    const check = this.querySelector('.fa-check');
                    if (check) check.classList.remove('hidden');
                });
            });
        }

        function closeStatusControlPopup() {
            document.getElementById('statusControlPopup').classList.remove('show');
            selectedPersonnelForStatus = null;
        }

        async function savePersonnelStatus() {
            if (!selectedPersonnelForStatus) return;
            
            const selectedOption = document.querySelector('.status-option.active');
            if (!selectedOption) {
                showToast('Please select a status', 'warning');
                return;
            }
            
            const newStatus = selectedOption.dataset.status;
            
            try {
                showLoading();
                
                await personnelCollection.doc(selectedPersonnelForStatus.id).update({
                    status: newStatus,
                    statusMode: newStatus === 'auto' ? 'auto' : 'manual',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastStatusUpdate: new Date().toISOString(),
                    statusReason: `Manually set to ${newStatus} by ${currentUser.email}`
                });
                
                showToast(`Status updated to ${newStatus}`, 'success');
                logActivity('status_update', `Updated personnel status to ${newStatus}`, null);
                
                closeStatusControlPopup();
                
            } catch (error) {
                console.error('Error saving personnel status:', error);
                showToast('Failed to update status', 'error');
            } finally {
                hideLoading();
            }
        }

        function findPersonnelByUserEmail(email) {
            if (!email || !allPersonnel.length) return null;
            
            // Cari berdasarkan email atau nama yang cocok
            const person = allPersonnel.find(p => 
                p.email === email || 
                p.name.toLowerCase().includes(email.split('@')[0].toLowerCase())
            );
            
            return person || null;
        }

        // ==================== PIPELINES FUNCTION ====================
        function openPipelines() {
            console.log('Opening pipelines...');
            
            // Redirect to pipelines.html
            window.open('pipelines.html', '_blank');
        }

        async function deleteWorkOrder(workorderId) {
            if (!canDeleteWorkOrder()) {
                showToast('You do not have permission to delete work orders', 'warning');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this work order?')) return;
            
            try {
                const workorder = workorders.find(wo => wo.id === workorderId);
                await workordersCollection.doc(workorderId).delete();
                showToast('Work order deleted successfully', 'success');
                logActivity('delete', `Deleted work order ${workorder?.workOrderNumber || workorderId}`, workorderId);
            } catch (error) {
                console.error('Error deleting work order:', error);
                showToast('Failed to delete work order', 'error');
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        function exportToExcel() {
            console.log('Exporting to Excel');
            
            if (!canExportData()) {
                showToast('Only admins can export data', 'warning');
                return;
            }
            
            try {
                if (filteredWorkorders.length === 0) {
                    showToast('No data to export', 'warning');
                    return;
                }
                
                const worksheetData = filteredWorkorders.map(wo => {
                    let personnelArray = [];
                    if (wo.personnel) {
                        if (Array.isArray(wo.personnel)) {
                            personnelArray = wo.personnel;
                        } else if (typeof wo.personnel === 'string') {
                            try {
                                personnelArray = JSON.parse(wo.personnel);
                            } catch (e) {
                                personnelArray = [wo.personnel];
                            }
                        }
                    }
                    
                    return {
                        'Work Order Number': wo.workOrderNumber,
                        'SO Number': wo.soNumber || '',
                        'Customer': wo.customer,
                        'Building': wo.building,
                        'Division': wo.division,
                        'Company': wo.company,
                        'Work Type': wo.workType,
                        'PIC': wo.pic || '',
                        'Personnel': personnelArray.join(', '),
                        'Start Date': formatDate(wo.startDate),
                        'End Date': formatDate(wo.endDate),
                        'Estimated Time': wo.estimatedTime ? `${wo.estimatedTime} days` : '',
                        'Status': wo.status,
                        'Priority': wo.priority || '',
                        'Notes': wo.notes || '',
                        'Created At': formatDateTime(wo.createdAt),
                        'Created By': wo.createdBy || '',
                        'Last Updated': formatDateTime(wo.updatedAt),
                        'Updated By': wo.updatedBy || ''
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(worksheetData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Work Orders');
                
                const date = new Date();
                const filename = `Work_Orders_${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                showToast('Data exported successfully', 'success');
                logActivity('export', 'Exported work orders to Excel');
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showToast('Failed to export data', 'error');
            }
        }

        // ==================== EVENT LISTENERS ====================
        function initApp() {
            console.log('Initializing app...');
            
            setupRealtimeListeners();
            loadDataHistory();
            setupStatusControl();
            
            // Setup event listeners for all buttons
            document.getElementById('newWorkOrderBtn').addEventListener('click', createNewWorkOrder);
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('analyticsBtn').addEventListener('click', openAnalyticsModal);
            document.getElementById('activityBtn').addEventListener('click', openActivityModal);
            document.getElementById('statusHistoryBtn').addEventListener('click', openStatusHistoryModal);
            document.getElementById('documentationBtn').addEventListener('click', openDocumentationModal);
            document.getElementById('pipelinesBtn').addEventListener('click', openPipelines);
            document.getElementById('personnelListBtn').addEventListener('click', openPersonnelList);
            document.getElementById('authButton').addEventListener('click', logout);
            
            document.getElementById('refreshWorkOrderNumber').addEventListener('click', updateIntegratedWorkOrderNumber);
            
            document.getElementById('startDate').addEventListener('change', updateIntegratedWorkOrderNumber);
            document.getElementById('company').addEventListener('change', updateIntegratedWorkOrderNumber);
            
            document.getElementById('searchWorkOrders').addEventListener('input', applyFiltersAndRender);
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentTab = this.dataset.tab;
                    applyFiltersAndRender();
                });
            });
            
            // View toggle buttons
            document.getElementById('cardViewBtn').addEventListener('click', function() {
                switchView('card');
            });
            
            document.getElementById('listViewBtn').addEventListener('click', function() {
                switchView('list');
            });
            
            document.getElementById('timelineViewBtn').addEventListener('click', function() {
                switchView('timeline');
            });
            
            document.getElementById('sortBy').addEventListener('change', applyFiltersAndRender);
            document.getElementById('sortOrder').addEventListener('change', applyFiltersAndRender);
            
            // Work Order Modal
            document.getElementById('closeWorkOrderModal').addEventListener('click', closeWorkOrderModal);
            document.getElementById('cancelWorkOrderBtn').addEventListener('click', closeWorkOrderModal);
            document.getElementById('workorderForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveWorkOrder();
            });
            
            // Detail Modal
            document.getElementById('closeDetailModal').addEventListener('click', closeDetailModal);
            document.getElementById('closeDetailBtn').addEventListener('click', closeDetailModal);
            document.getElementById('editDetailBtn').addEventListener('click', function() {
                const workorderId = this.dataset.id;
                closeDetailModal();
                setTimeout(() => openWorkOrderModal(workorderId), 300);
            });
            
            // Analytics Modal
            document.getElementById('closeAnalyticsModal').addEventListener('click', closeAnalyticsModal);
            
            // Activity Modal
            document.getElementById('closeActivityModal').addEventListener('click', closeActivityModal);
            
            // Status History Modal
            document.getElementById('closeStatusHistoryModal').addEventListener('click', closeStatusHistoryModal);
            
            document.getElementById('statusHistoryFilter').addEventListener('change', function() {
                const filter = this.value;
                const searchTerm = document.getElementById('statusHistorySearch').value;
                loadStatusHistory(filter, searchTerm);
            });
            
            document.getElementById('statusHistorySearch').addEventListener('input', function() {
                const filter = document.getElementById('statusHistoryFilter').value;
                const searchTerm = this.value;
                loadStatusHistory(filter, searchTerm);
            });
            
            // Documentation Modal
            document.getElementById('closeDocumentationModal').addEventListener('click', closeDocumentationModal);
            
            // Photo Preview Modal
            document.getElementById('closePhotoPreview').addEventListener('click', closePhotoPreview);
            
            // Status Control Popup
            document.addEventListener('click', function(e) {
                const popup = document.getElementById('statusControlPopup');
                const statusControlBtn = document.getElementById('statusControlBtn');
                
                if (popup.classList.contains('show') && 
                    !popup.contains(e.target) && 
                    !statusControlBtn.contains(e.target)) {
                    closeStatusControlPopup();
                }
            });
            
            // Update status control button visibility based on role
            if (currentUserRole === 'admin' || currentUserRole === 'manager' || currentUserRole === 'user') {
                showStatusControlButton(true);
            }
            
            console.log('App initialization complete');
        }

        // ==================== PERSONNEL LIST FUNCTION ====================
        function openPersonnelList() {
            console.log('Opening personnel list...');
            
            // Redirect to personnel list page
            window.open('personnellist.html', '_blank');
        }
        
        function switchView(view) {
            currentView = view;
            
            // Update active button
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (view === 'card') {
                document.getElementById('cardViewBtn').classList.add('active');
                document.getElementById('cardViewContainer').classList.remove('hidden');
                document.getElementById('listViewContainer').classList.add('hidden');
                document.getElementById('timelineViewContainer').classList.add('hidden');
                renderCardView();
            } else if (view === 'list') {
                document.getElementById('listViewBtn').classList.add('active');
                document.getElementById('cardViewContainer').classList.add('hidden');
                document.getElementById('listViewContainer').classList.remove('hidden');
                document.getElementById('timelineViewContainer').classList.add('hidden');
                renderListView();
                
                // Add event listeners for list view buttons
                setTimeout(() => {
                    document.querySelectorAll('.view-detail-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const workorderId = this.closest('tr').dataset.id;
                            if (workorderId) {
                                openWorkOrderDetailModal(workorderId);
                            }
                        });
                    });
                    
                    document.querySelectorAll('.edit-workorder-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const workorderId = this.closest('tr').dataset.id;
                            if (workorderId) {
                                openWorkOrderModal(workorderId);
                            }
                        });
                    });
                    
                    document.querySelectorAll('.delete-workorder-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const workorderId = this.closest('tr').dataset.id;
                            if (workorderId) {
                                deleteWorkOrder(workorderId);
                            }
                        });
                    });
                }, 100);
            } else if (view === 'timeline') {
                document.getElementById('timelineViewBtn').classList.add('active');
                document.getElementById('cardViewContainer').classList.add('hidden');
                document.getElementById('listViewContainer').classList.add('hidden');
                document.getElementById('timelineViewContainer').classList.remove('hidden');
                renderTimelineView();
                
                // Add event listeners for timeline view buttons (no view details button)
                setTimeout(() => {
                    document.querySelectorAll('.edit-workorder-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const workorderId = this.closest('.card').dataset.id;
                            if (workorderId) {
                                openWorkOrderModal(workorderId);
                            }
                        });
                    });
                    
                    document.querySelectorAll('.delete-workorder-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const workorderId = this.closest('.card').dataset.id;
                            if (workorderId) {
                                deleteWorkOrder(workorderId);
                            }
                        });
                    });
                }, 100);
            }
        }

        // ==================== GLOBAL FUNCTIONS FOR DOCUMENTATION ====================
        window.openPhotoPreview = openPhotoPreview;
        window.deletePhoto = deletePhoto;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Work Order Management System initializing...');
            
            const firebaseInitialized = initializeFirebase();
            
            if (!firebaseInitialized) {
                showToast('Firebase initialization failed. Please check console.', 'error');
                return;
            }
            
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            setupAuthStateObserver();
            
            console.log('System initialization complete');
        });
    </script>
</body>
</html>
